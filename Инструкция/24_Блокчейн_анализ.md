# Блокчейн-анализ

Мониторинг транзакций TON/Jetton, верификация кошельков и зачёт в eligibility. Данные — в нашей БД; TonAPI — источник событий.

---

## Архитектура мониторинга

```
TonAPI (события кошельков)
       ↓
monitor_wallets() — запуск по расписанию (напр. каждые 5 мин)
       ↓
process_transaction(tx) — парсинг, верификация, сохранение
       ↓
token_transactions
```

---

## Обработка транзакций

`process_transaction()` для каждой транзакции:

- Парсинг sender, recipient, типа (TON / Jetton), суммы, комментария
- Сохранение в `token_transactions`: tx_hash, user_id, wallet_address, amount, direction, block_timestamp
- Поиск user_id: по комментарию или по адресу отправителя

---

## Верификация кошельков

Транзакции на адрес проекта (`PROJECT_WALLET_ADDRESS`) обрабатываются для верификации:

| Условие | Действие |
|---------|----------|
| Комментарий `verify:<user_id>` | Привязка кошелька отправителя к user_id |
| Комментарий `ref:<user_id>` | Аналогично для реферальных платежей |
| Сумма TON ≥ 0.1 | Зачёт верификации (привязка кошелька) |

Верификация и привязка выполняются автоматически при обработке транзакции.

---

## Таблица token_transactions

| Поле | Назначение |
|------|------------|
| tx_hash | Хеш транзакции |
| user_id | Пользователь (если определён) |
| wallet_address | Адрес кошелька (sender/recipient) |
| amount | Сумма |
| direction | Направление (in/out) |
| block_timestamp | Время в блоке |

---

## Связь с eligibility и выводом

- **Покупки/держание токена** на блокчейне — источник для правила 10% вывода ([08_Вывод_и_антихалява.md](08_Вывод_и_антихалява.md)).
- Данные из `token_transactions` используются в `withdraw_gating`, `token_compliance`.
- Верифицированные кошельки — условие для вывода (привязка кошелька).

Подробнее: [08](08_Вывод_и_антихалява.md), [23_Вывод_через_iCryptoCheck.md](23_Вывод_через_iCryptoCheck.md).
