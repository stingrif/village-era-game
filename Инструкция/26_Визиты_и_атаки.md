# Визиты и атаки

## Визит

Визит = открытие поля другого игрока (только чтение) + возможность одной атаки (ограбление).

- **GET** `/api/game/field/{target_telegram_id}` — публичное поле цели (здания и уровни; слоты с чужими реликвиями при необходимости маскируются или не отдаются).

## Атака

- **POST** `/api/game/attack/{target_telegram_id}` — body: `building_slot_indexes` (массив до 2 слотов).
- Выбор до 2 зданий цели; за каждое здание — один грабёж раз в час (отдельный кулдаун на пару атакующий–цель–здание).
- Общий кулдаун на атаку по одной цели: **30 минут** (сокращается рекламой, алмазами, артефактами).

## Грабёж здания

- **50%** шанс забрать часть накопленных (ещё не собранных) ресурсов в выбранном здании.
- Забираемый процент (например 10–25%) задаётся в конфиге.
- Накопление по зданиям хранится в `building_pending_income`; при сборе дохода (`field/collect`) pending обнуляется по слотам и зачисляется в economy_ledger. Схема данных — [18_Dev_таблицы_и_формулы.md](18_Dev_таблицы_и_формулы.md).

## Логи и уведомления

- При визите/атаке пишется запись в `visit_log` и в общую ленту событий: кто посетил, когда, что сделал (просмотр / ограбление), сколько забрал.
- Обе стороны видят: «Игрок X посетил вас и забрал N монет из постройки Y» и «Вы посетили игрока Z и забрали …».
- **GET** `/api/game/visit-log` — история визитов/атак для текущего пользователя (как гость и как цель).
- **GET** `/api/game/history/logs` — полные логи (доступ только при наличии предмета «История всей игры»).

## Предмет «История всей игры»

- Один предмет в `item_defs` (например `item_type=special`, key `full_history_access`). Покупка за STARS/DIAMONDS через shop_offers.
- При владении предметом — доступ к экрану «Полные логи»: кто к кому ходил, что делал, сколько забрал (чтение из `visit_log` и при необходимости `game_events`).

## Защита от воров (артефакт эры)

- Предмет (редкий/премиум): −50% удачи ворам при ограблении, +50% удачи владельцу при расчёте шанса/процента. Цена в shop или за STARS/DIAMONDS. Добавлен в `item_defs` и shop_offers.

## Сокращение отката атаки (30 мин)

- **Реклама:** просмотр рекламы уменьшает кулдаун (например −15 мин).
- **Алмазы:** опция «сократить cooldown за DIAMONDS».
- **Артефакты:** предметы с эффектом «сокращение cooldown атаки» при активации уменьшают откат.

Таблицы и формулы — [18_Dev_таблицы_и_формулы.md](18_Dev_таблицы_и_формулы.md).
