# Рынок и P2P

## Покупка из казны

В маркете доступен фиксированный список предметов, которые можно купить за COINS или STARS (не только P2P-ордера).

- **Таблица:** `shop_offers` — см. [18_Dev_таблицы_и_формулы.md](18_Dev_таблицы_и_формулы.md).
- **Поля предложения:** item_def_id, pay_currency (COINS|STARS), pay_amount, stock_type (unlimited|limited), max_per_user_per_era (опционально), sort_order.
- **API:** GET `/api/game/shop/offers`, POST `/api/game/shop/purchase` (body: offer_id, quantity). Лимиты и цены задаются в сидах/конфиге.

## Типы сделок

- **Sell Order** — предмет(ы) за COINS/STARS/DIAMONDS (TON только offchain intent)
- **Trade Offer** — N↔M предметы, опционально доплата валютой
- **Direct Buy (TON)** — только системные товары (пачки, амулеты)

## Escrow

При выставлении ордера предметы уходят в **escrow** (state=listed/locked). При отмене/истечении — unlock_escrow_items().

## Таблицы

- **market_orders** — seller_id, status (open|filled|canceled|expired), pay_currency, pay_amount, expires_at
- **market_order_items** — order_id, user_item_id
- **escrow_items** — user_item_id, owner_id, lock_type (market_order|trade_offer), lock_id
- **trade_offers** — maker_id, status, taker_id (опционально), want_currency, want_amount, expires_at
- **trade_offer_items** — offer_id, side (maker|taker), user_item_id

## Комиссии

| Тип | Значение |
|-----|----------|
| Продажа | 5% с продавца, минимум 1 |
| Swap | 60 stars с каждой стороны (или 1% от оценки) |
| Листинг | 20 stars за создание ордера (сгорают) |

```
fee_sell = max(1, floor(price * 0.05))
seller_get = price - fee_sell
```

## Антиспам

- max_listings = 20 (watch=10, restricted=0)
- max_swaps = 10
- min_price = 5 coins

## Функции

- create_market_order(), fill_market_order_coins(), cancel_market_order()
- create_trade_offer(), accept_trade_offer(), cancel_trade_offer()
- lock_item_to_escrow(), unlock_escrow_items()

## Правила Trade

- offer / want задаются целиком; частичное исполнение запрещено.
