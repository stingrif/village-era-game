# Стейкинг токена

Механика стейкинга токена PHOEX/PHXPW в Village Era. iCryptoCheck — платёжный шлюз; логика стейкинга на нашей стороне (БД, крон-джобы).

---

## Архитектура

**iCryptoCheck** — только платёжный шлюз; **вся логика стейкинга** реализована в нашем бэкенде:

- БД для хранения стейков и наград
- Крон-джобы для расчёта и начисления наград
- Логика блокировки и разблокировки
- Автореинвестирование

iCryptoCheck используется для: приёма платежей, хранения средств на балансе приложения, переводов пользователям (Telegram ID или TON-адрес).

Связь с игрой: стейкинг — отдельная механика токена PHOEX/PHXPW; env: `STAKING_POOL_WALLET_ID`, `ICRYPTOCHECK_TOKEN_SYMBOL`. См. [23_Вывод_через_iCryptoCheck.md](23_Вывод_через_iCryptoCheck.md).

---

## Фазы стейкинга

| Фаза | Статус | Описание |
|------|--------|----------|
| Накопление | `ACCUMULATING` | Начисления наград идут; вывод стейка переводит в LOCKED |
| Блокировка | `LOCKED` | Начисления прекращены; таймер до разблокировки |
| Разблокировка | `UNSTAKED` | Можно вывести стейк + накопленные награды (до LOCKED) |

**Критично:** награды начисляются **только** при `status = ACCUMULATING`. В момент перехода в `LOCKED` начисления прекращаются. Таймер обратного отсчёта — с `lock_requested_at`.

---

## Периоды блокировки

90 / 180 / 360 дней. Пользователь выбирает при старте стейка и при запросе вывода.

---

## Формула наград

```
reward = staked_amount * (APY / (365 * 24 * 3600)) * seconds_elapsed
```

Только при `status = ACCUMULATING`. Крон-джоб выполняется каждый час.

---

## Комиссия вывода

6%. Вычитается в нашей логике перед переводом через iCryptoCheck. Распределение:

- холдеры
- проект
- burn
- charity

---

## Таблицы БД

| Таблица | Назначение |
|---------|------------|
| `staking_sessions` | Сессии стейка: user_id, staked_amount, accrued_rewards, status, lock_until, plan_id, payment_address, lock_requested_at |
| `staking_reward_history` | История начислений: session_id, reward_amount, calculated_at |

Ключевые поля: `payment_address` (адрес депозита), `lock_requested_at` (момент начала обратного отсчёта).

---

## Крон-джобы

| Задача | Расписание | Действие |
|--------|------------|----------|
| Начисление наград | Каждый час | Только для `status = ACCUMULATING` |
| Разблокировка | Каждый час | `LOCKED` и `lock_until <= now` → `UNSTAKED` |
| Автореинвест | Раз в сутки | 94% accrued_rewards → staked_amount; accrued_rewards = 0 |

---

## Поток работы (кратко)

1. Создание стейка → payment address через iCryptoCheck; статус `PENDING`.
2. Подтверждение депозита (blockchain monitor) → `ACCUMULATING`, `staked_amount`.
3. Пользователь нажимает «Вывести» → `LOCKED`, `lock_requested_at`, начисления прекращаются.
4. По истечении периода → крон меняет на `UNSTAKED`.
5. Вывод через iCryptoCheck (POST /app/transfer или /app/withdrawal) с учётом 6% комиссии.

Подробнее: [23_Вывод_через_iCryptoCheck.md](23_Вывод_через_iCryptoCheck.md).
