# Статус и задачи

Документ обновляется по мере выполнения. Показывает: что уже сделано, что в работе, что планируется. Единый источник по текущему состоянию проекта.

---

## Выполнено

### Игровые механики (план «маркет, атаки, печки, фамильяры, логи»)

| Задача | Где описано |
|--------|-------------|
| Магазин из казны (shop_offers, покупка за COINS/STARS) | [11_Рынок_и_P2P.md](11_Рынок_и_P2P.md), [18_Dev](18_Dev_таблицы_и_формулы.md) |
| Визиты и атаки (поле цели, ограбление до 2 построек, кулдауны, логи, защита эры, предмет «история игры») | [26_Визиты_и_атаки.md](26_Визиты_и_атаки.md) |
| Накопление дохода по зданиям, сбор (building_pending_income, field/collect) | [18_Dev](18_Dev_таблицы_и_формулы.md) |
| Шахта: дроп STARS 1–5000, дроп печек (6 цветов), бонус доната на улучшенную печку | [03_Шахта_и_яйца.md](03_Шахта_и_яйца.md) |
| Печки по цвету, вылупление (1 печка + 3 яйца / 1 редкое), фамильяры, пул исходов (egg_hatch_pool) | [27_Печки_и_фамильяры.md](27_Печки_и_фамильяры.md) |
| Мастерская: апгрейд печки (2 печки + реклама + предмет) | [27_Печки_и_фамильяры.md](27_Печки_и_фамильяры.md) |
| Доли пула шахта/магазин в конфиге | [07_Экономика_и_пулы.md](07_Экономика_и_пулы.md) |
| БД: shop_offers, visit_log, building_pending_income, rob_cooldown, familiars_def, user_familiars, egg_hatch_pool, furnace_bonus_until | [18_Dev](18_Dev_таблицы_и_формулы.md) |

### Фаза 0 (стабилизация, план реализации)

| Задача | Где |
|--------|-----|
| API POST /api/game/mine/dig — в ответе поле opened_cells (контракт с e2e-тестом) | core/checkin_mine.py |
| Все тесты бэкенда зелёные, без предупреждений (PytestReturnNotNoneWarning, test_withdraw_request_stub 403) | tests/test_game_api_e2e.py |
| Проверка работоспособности: health, config, checkin, mine (smoke) | pytest smoke-набор |
| План реализации: План/00_Общий_план_реализации.md, ссылка в 00_ОГЛАВЛЕНИЕ | Инструкция/План |

### Фазы 5–6 (Тигрит: tigrit_shared, веб-API, деплой)

| Задача | Где |
|--------|-----|
| tigrit_shared: db.py (пул asyncpg), read.py (get_village_row, get_top_users, get_recent_events) | кабзда/tigrit_shared |
| Бот Тигрит: пул и чтение через tigrit_shared; db_async — ensure_user, ensure_tigrit_profile, запись | кабзда/tigrit_village, deploy/tigrit_bot |
| Веб-API Тигрит: async, PostgreSQL через tigrit_shared; /api/village, /api/users, /api/events | кабзда/tigrit_web/backend, deploy/tigrit_api |
| Фронт Тигрит: API_URL = /api (или VITE_API_BASE) | кабзда/tigrit_web/frontend |
| Деплой: tigrit_api, tigrit_web (Dockerfile), docker-compose, nginx server tigrit.stakingphxpw.com | deploy/tigrit_api, deploy/tigrit_web, docker-compose.149.yml, nginx-docker.conf, README_DOCKER_149.md |

### Инфраструктура и деплой

| Задача | Где |
|--------|-----|
| CORS на ответах 500 + логирование исключений (main.py) | бэкенд/api/main.py |
| CORS для Telegram (web.telegram.org, t.me) | бэкенд/api/main.py |
| Деплой на stakingphxpw.com: config.js, .env CORS, nginx | [../deploy/README.md](../deploy/README.md) |
| Раздача с ПК: nginx + uvicorn, certbot | [../deploy/RUN_FROM_PC.md](../deploy/RUN_FROM_PC.md) |
| Docker: один `docker compose up` — сайт + API (nginx + app) | [../бэкенд/docker/README.md](../бэкенд/docker/README.md) |
| Тестовая страница в браузере (?tg= для тестового ID) | Игра/test.html |
| Уведомление при сбое загрузки API в игре | village-era-game-final.html |

### Обновлённые и новые файлы инструкций

| Файл | Изменение |
|------|-----------|
| [00_ОГЛАВЛЕНИЕ.md](00_ОГЛАВЛЕНИЕ.md) | Добавлены пункты 26, 27; диапазон 01–27 |
| [11_Рынок_и_P2P.md](11_Рынок_и_P2P.md) | Раздел «Покупка из казны», ссылка на 18_Dev |
| [03_Шахта_и_яйца.md](03_Шахта_и_яйца.md) | Дроп токенов, печек, вылупление в печке, фамильяры |
| [07_Экономика_и_пулы.md](07_Экономика_и_пулы.md) | Доли пула шахта/магазин |
| [18_Dev_таблицы_и_формулы.md](18_Dev_таблицы_и_формулы.md) | Таблицы shop_offers, visit_log, building_pending_income, rob_cooldown, familiars_def, user_familiars, egg_hatch_pool; user_profile.last_collected_at, furnace_bonus_until |
| [26_Визиты_и_атаки.md](26_Визиты_и_атаки.md) | **Новый** — визиты, атака, ограбление, кулдауны, логи, защита, предмет истории |
| [27_Печки_и_фамильяры.md](27_Печки_и_фамильяры.md) | **Новый** — печки, вылупление, фамильяры, апгрейд в мастерской, донат-бонус |

### Файлы вне Инструкция (деплой, Docker)

| Путь | Назначение |
|------|------------|
| Игра/deploy/README.md | Чек-лист деплоя stakingphxpw.com, nginx, SSL, Telegram Web App |
| Игра/deploy/nginx-stakingphxpw.conf | Nginx для домена (сервер) |
| Игра/deploy/nginx-from-pc.conf | Nginx для раздачи с ПК (путь к Игра на Mac) |
| Игра/deploy/RUN_FROM_PC.md | Пошагово: nginx + certbot с этого ПК |
| Игра/бэкенд/docker/docker-compose.yml | app + web (nginx) + redis + postgres (profile db) |
| Игра/бэкенд/docker/Dockerfile.backend | Образ бэкенда (uvicorn) |
| Игра/бэкенд/docker/nginx.conf | Nginx в Docker: статика + /api → app:8000 |
| Игра/test.html | Тестовый запуск в браузере с выбором Telegram ID |
| Игра/config.js | GAME_API_BASE для stakingphxpw.com (или localhost) |

---

## В работе / на проверке

- Открытие игры в Telegram Web App по https://stakingphxpw.com (DNS → 87.70.179.193, роутер → 192.168.1.247, Docker на ПК).
- При необходимости: HTTPS через certbot на ПК (см. RUN_FROM_PC.md).

---

## Планируется (при необходимости)

- Уточнение цен и баланса: предмет защиты эры, «история игры», предложения магазина (shop_offers).
- Перенос раздачи с ПК на отдельный сервер (те же конфиги nginx + бэкенд, смена проброса портов и пути root).
- Доп. правки по логам 500 (причина в БД/сериализации) — по логам бэкенда после воспроизведения.

---

## Как обновлять этот файл

При завершении задачи добавляйте её в блок «Выполнено» и при необходимости в «Обновлённые и новые файлы». Текущие работы — в «В работе». Планы — в «Планируется». Дату последнего обновления можно дописывать в конец файла.
