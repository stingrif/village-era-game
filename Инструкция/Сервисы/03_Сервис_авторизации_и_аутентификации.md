# Сервис авторизации и аутентификации

Единственный сервис, который решает «кто пользователь»: проверяет токен (Telegram initData, JWT или иной), возвращает user_id или 401. Не хранит сессии; не знает о приложениях Игра/Тигрит — только идентификация. Ключи для проверки подписи запрашивает у сервиса секретов.

---

## Назначение

- Валидация входящих данных: Telegram Web App initData (подпись и данные), либо внутренний JWT, либо другой согласованный формат.
- Извлечение или определение user_id (например из payload после проверки подписи; при первом входе — вызов ensure_user к бэкенду Игра по internal API и возврат user_id).
- Ответ вызывающему: `{"user_id": int}` при успехе или 401 при невалидных данных.

Сервис не создаёт и не продлевает сессии — этим занимается сервис сессий. Не хранит пароли и не управляет ролями приложений.

---

## Контракт API (эндпоинты)

Базовый URL задаётся в конфигурации вызывающих (env).

| Метод | Путь | Назначение | Тело запроса | Ответ |
|-------|------|------------|--------------|--------|
| POST | /verify | Проверить токен и вернуть user_id | `{"init_data": str}` (Telegram) или `{"token": str}` (JWT) | `{"user_id": int}` или 401 |

Допустимые форматы тела и имена полей уточняются при реализации (например `init_data` для Mini App, `token` для JWT). Ответ 401 — без тела или с `{"error": "unauthorized"}`. 400 — неверный формат запроса.

Проверка подписи Telegram: по документации Telegram Web App; секрет (bot token или выданный ключ) сервис авторизации запрашивает у сервиса секретов, не хранит в своём env (или хранит только ссылку на ключ в Secrets).

---

## Зависимость от сервиса секретов

- Для проверки подписи Telegram initData или подписи JWT сервис запрашивает у Secrets значение по ключу (например `TELEGRAM_BOT_TOKEN` или `JWT_SECRET`).
- Вызов только по внутренней сети или с внутренним токеном, согласно контракту сервиса секретов.

---

## Кто вызывает

- **Бэкенд Игра (app):** проверка initData от Mini App перед созданием сессии или перед защищёнными действиями.
- **Бот Тигрит:** при необходимости веб-проверки пользователя.
- **Tigrit API:** проверка токена для доступа к данным от имени пользователя.

Вызывающие после успешного ответа получают user_id и при необходимости сами обращаются к сервису сессий для создания/проверки сессии.

---

## Папка в репозитории

Один сервис — одна папка. Например: `Игра/сервисы/auth/` или `Игра/deploy/auth/`. Внутри: код приложения, Dockerfile, requirements.txt, env. Обращения только к сервису секретов (по HTTP) и при необходимости к internal API Игра (ensure-user) для резолва user_id по telegram_id; без доступа к БД сессий и без вызова сервиса сессий.

---

## Переменные окружения (env)

- `SECRETS_SERVICE_URL` — базовый URL сервиса секретов.
- `INTERNAL_TOKEN` или аналог — для вызова сервиса секретов (если требуется).
- `GAME_API_BASE` и `INTERNAL_API_SECRET` — только если сервис сам вызывает ensure-user; иначе вызывающий передаёт уже user_id или получает его иначе.
- Порт приложения (например `PORT=8001`).

Детали (какие ключи запрашивать у Secrets) фиксируются в реализации и при необходимости дополняют этот документ.
