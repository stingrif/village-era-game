# Реферальная система и связка аккаунтов

## Реферал

- Игрок приглашает по реферальной ссылке. Награды за регистрацию/активность — из env (REFERRAL_REWARD_AMOUNT, MIN_STAKING_FOR_REFERRAL, MIN_HOLDING_DAYS и т.д.).

## Роли и доступ

- **admin_users** — admin_id (telegram_id), role (owner|admin|mod|support|analyst), is_enabled  
- **access_policy** — action, allowed_roles[]  
  - view_links: owner, admin, analyst  
  - link_accounts: owner, admin  
  - unlink_accounts: owner  
  - view_sensitive: owner, admin  

- **can_admin(admin_id, action)** — проверка, входит ли role в allowed_roles.

## Идентичности

- **user_identities** — user_id, kind (telegram|wallet|device|ip|cookie|ref), value_hash, first_seen_at, last_seen_at, confidence, meta.  
- Raw IP/устройство не храним, только hash.

## Связка аккаунтов

- **account_links** — root_user_id, linked_user_id, link_type (manual|auto|suspected), reason (wallet_match|device_match|ip_pattern|admin_merge|user_request), confidence, is_active, created_by (admin_id), created_at.  
- Уникальность по (root_user_id, linked_user_id) где is_active.

## Функции

- **link_accounts_manual**(admin_id, root_user_id, linked_user_id, reason, confidence) — только при can_admin('link_accounts').  
- **unlink_accounts**(admin_id, root_user_id, linked_user_id, note) — только owner, is_active=false + meta.  
- **get_account_links**(admin_id, user_id) — при can_admin('view_links') возвращает список связок.  
- **auto_link_by_identity**(user_id, kind, value_hash, reason, confidence) — при событиях (логин, кошелёк и т.д.) ищет других с тем же value_hash и создаёт account_links с link_type=auto.

## Ограничения

- Мультиакки повышают risk_score. При restricted/banned — ограничения выводов и маркета.
