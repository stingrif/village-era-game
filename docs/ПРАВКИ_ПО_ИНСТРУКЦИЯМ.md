# Все правки в код по инструкциям

Сводка изменений по плану и инструкциям (15, 17, 22, 14). Собрано по файлам для удобства правок.

---

## Оглавление

1. [Краткая сводка](#краткая-сводка)
2. [По файлам — визуал](#по-файлам--визуал-village-era-game-finalhtml)
3. [По файлам — бэкенд](#по-файлам--бэкенд)
4. [Документация](#документация)
5. [Соответствие инструкциям](#соответствие-инструкциям)

---

## Краткая сводка

- **Визуал:** нижнее меню (Деревня, Шахта, Инвентарь, Маркет, Профиль, **PnL**); верхнее меню (Рейтинг, Награды, Правила, О проекте, Поддержка, Уведомления); кнопки по экранам по 15; маркет — 3 вкладки; стейкинг/покупка — экран PnL; квест ФЕНИКС — буквы из API, сбор слова, отправка со списанием букв, бейдж «Букварь».
- **Бэкенд:** CORS (явные origins); квест ФЕНИКС: таблица слова, буквы в `user_items`, API word/letters/submit, burn добавляет букву.
- **Документация:** аудит по 15, обновлены 17 и 15.

**Источники:** план (визуал + ФЕНИКС + приоритет финансов), **15_Карта_меню_и_UI**, **17_Скрытый_квест_ФЕНИКС**, 22/14 (PnL).

---

## По файлам — визуал (village-era-game-final.html)

Файл: **`village-era-game-final.html`** (или `Игра/village-era-game-final.html`).

### HTML-разметка

| Что сделано | Элементы / блок |
|-------------|------------------|
| Нижнее меню: 5 вкладок + PnL | `.nav.nav-six` → 6 пунктов: village, mine, inventory, market, profile, **pnl** |
| Экраны: Деревня, Шахта, Маркет, Профиль | `#villageScreen`, `#mineScreen`, `#marketScreen`, `#profileScreen` |
| Новый экран Инвентарь | `#inventoryScreen` — табы Реликвии/Амулеты/Бафы/Порчи/Яйца, кнопки действий |
| Новый экран PnL | `#pnlScreen` — два блока (Стейкинг, Покупка) |
| Деревня: 5 кнопок | В `#villageScreen`: Постройки, Улучшить, Реликвии в здания, Снести, Сводка |
| Шахта: блок История | В `#mineScreen`: `#mineHistoryList`, кнопка «Обновить» |
| Маркет: только 3 вкладки | В `#marketScreen`: `#tabRelics`, `#tabAmulets`, `#tabDiamonds`; контент `#marketRelics`, `#marketAmulets`, `#marketDiamonds` |
| Профиль: кнопки и бейдж | В `#profileScreen`: Привязать кошелёк, Вывод TON, Реклама, Смотреть рекламу, Вклад, Настройки; `#profilePhoenixBadge` |
| Верхнее меню | В `.header`: кнопки Рейтинг, Награды, Правила, О проекте, Поддержка, Уведомления, Обучение |
| Рейтинг: Эра/Неделя/Месяц | В `#ratingScreen`: `#ratingTabEra`, `#ratingTabWeek`, `#ratingTabMonth` |

### Стили

| Что сделано | Селектор |
|-------------|----------|
| Нижняя панель на 6 колонок | `.nav-six { grid-template-columns: repeat(6, 1fr) }` |

### JavaScript — объект G

| Что сделано | Свойство / метод |
|-------------|-------------------|
| История копок в состоянии | `d.mineHistory: []` |
| При копании — запись в историю | В `dig()`: `d.mineHistory.push({ t, r })` |
| При открытии шахты — обновить историю | В `showScreen('mine')`: `this.refreshMineHistory()` |
| Деревня: заглушки кнопок | `openBuildingsCatalog`, `openUpgradeBuilding`, `openRelicsInBuildings`, `openDemolish`, `openVillageSummary` |
| Шахта: история | `refreshMineHistory()` — заполняет `#mineHistoryList` из `d.mineHistory` |
| Маркет: только 3 вкладки | При открытии маркета вызывается только `switchTab('relics')` |
| Защита при отсутствии старых табов маркета | В `switchMarketTab()`: если нет `#tabMarketSell` → `switchTab('relics')` и return |
| Инвентарь: табы и действия | `switchInvTab()`, `invUse`, `invPutInBuilding`, `invMerge`, `invDestroy`, `invSell`, `invPlaceOrder` |
| Профиль: заглушки | `toggleAds`, `watchAd`, `openProfileContribution`, `openSettings` |
| Верхнее меню | `openRules`, `openSupport`, `openNotifications` |
| Рейтинг: период | `ratingPeriod`, `switchRatingPeriod(p)` |
| PnL | `PNL_STAKING_URL`, `PNL_SWAP_URL`, `openPnlStaking()`, `openPnlBuy()` |
| Квест ФЕНИКС: состояние и запросы | `phoenixSelectedIds`, `phoenixSelectedWord`, `phoenixLetterItems`, `phoenixWordHint`; в `showInvLetters()` — fetch `/phoenix/word`, `/phoenix/letters` |
| Квест: сбор и отправка слова | `phoenixAddLetter()`, `phoenixClearWord()`, `phoenixSubmitWord()` — POST `/phoenix/submit` |
| Квест: сжигание без дубля букв при API | В `burnRelic()`: в `d.letters` пушим только если `!this.API_BASE` |
| Квест: текст в обучении | В `openHelp()` — обновлённый блок про ФЕНИКС |
| Профиль: отрисовка бейджа | В `renderProfile()`: заполнение `#profilePhoenixBadge` при `d.phoenixQuestCompleted` |
| Инвентарь → Продать | `invSell()`: `showScreen('market')`, `switchTab('relics')` |
| Исправление синтаксиса | В `showInvLetters`: добавлена `}` перед `document.getElementById('invmc')` (закрытие внешнего `else`) |
| Защита от null | Перед `phoenixBuiltWord.textContent`: `const pw = document.getElementById('phoenixBuiltWord'); if (pw) pw.textContent = ...` |

---

## По файлам — бэкенд

### api/main.py

| Что сделано | Детали |
|-------------|--------|
| CORS: явные origins | Список `CORS_ORIGINS`: localhost:8080, 127.0.0.1:8080, localhost:8000, 127.0.0.1:8000, https-варианты |
| CORS: доп. origins из env | Импорт `CORS_ORIGINS_EXTRA` из config; `CORS_ORIGINS = [...базовые...] + list(CORS_ORIGINS_EXTRA)` |
| Подключение CORS | `CORSMiddleware(allow_origins=CORS_ORIGINS, allow_credentials=True, allow_methods=["*"], allow_headers=["*"], expose_headers=["*"])` |

### config.py

| Что сделано | Детали |
|-------------|--------|
| Доп. CORS origins | Переменная `CORS_ORIGINS` (env); `CORS_ORIGINS_EXTRA` — список из строки по запятой |

### api/routes.py

| Что сделано | Детали |
|-------------|--------|
| Импорты для ФЕНИКС и CORS | `RUS_ALPHABET`, `add_letter_to_user`, `get_phoenix_quest_state`, `get_user_letter_items`, `phoenix_submit_word`; `random` |
| Burn → буква в инвентарь | После `apply_burn`: `ensure_user(telegram_id)`, `add_letter_to_user(user_id, random.choice(RUS_ALPHABET))` (в try/except) |
| GET /api/game/phoenix/word | Эндпоинт `api_phoenix_word()` — подсказка, длина слова, submissions_count, max_submissions |
| GET /api/game/phoenix/letters | Эндпоинт `api_phoenix_letters()` — X-Telegram-User-Id, ответ `get_user_letter_items(user_id)` |
| POST /api/game/phoenix/submit | Эндпоинт `api_phoenix_submit()` — body word, letter_item_ids; вызов `phoenix_submit_word()`; при badge_granted — add_pending_payout, notify_admin_phoenix_quest |

### infrastructure/database.py

| Что сделано | Детали |
|-------------|--------|
| Таблица phoenix_quest_state | CREATE TABLE (id=1, current_word, submissions_count, word_index, updated_at); INSERT по умолчанию |
| user_profile.badges | ALTER TABLE ADD COLUMN badges JSONB DEFAULT '[]' |
| item_defs: тип letter | В _seed_item_defs_and_eggs(): INSERT key='letter', item_type='letter' |
| add_user_item с meta | Параметр `meta` (dict), запись в user_items.meta |
| Функции букв и квеста | `get_letter_item_def_id`, `add_letter_to_user`, `get_phoenix_quest_state`, `advance_phoenix_word`, `get_user_letter_items`, `consume_letter_items`, `add_user_badge`, `has_user_badge`, `phoenix_submit_word` |
| Список слов для смены | `PHOENIX_WORDS_LIST` (например: ФЕНИКС, СЛОВО, ОГОНЬ, …) |

---

## Документация

| Файл | Что сделано |
|------|-------------|
| **docs/АУДИТ_ВИЗУАЛ_ПО_15.md** | Создан: таблицы «по инструкции / в HTML / не хватает» по разделам 15 |
| **Инструкция/17_Скрытый_квест_ФЕНИКС.md** | Переписан: буквы из инвентаря, сжигание при сдаче, бейдж, 5 победителей, смена слова, ежемесячный приз, бэкенд/API |
| **Инструкция/15_Карта_меню_и_UI.md** | Добавлен блок «Приоритет этапа (финансовая система)»: приоритет — балансы, продажи, вывод, привязка кошелька; стейкинг и выплаты в Telegram — вне этапа |

---

## Соответствие инструкциям

- **15_Карта_меню_и_UI:** нижнее меню (Деревня, Шахта, Инвентарь, Маркет, Профиль, PnL), верхнее меню (Рейтинг, Награды, Правила, О проекте, Поддержка, Уведомления), кнопки по экранам; маркет — 3 вкладки; стейкинг/покупка — в PnL.
- **17_Скрытый_квест_ФЕНИКС:** буквы только из инвентаря, сжигание при отправке слова, бейдж «Букварь», 5 победителей на слово, смена слова после отгадывания, ежемесячный приз; бэкенд: слово, счётчик, буквы в user_items, API word/letters/submit.
- **План:** приоритет финансовой системы зафиксирован; стейкинг и отправка наград в Telegram в этом этапе не делались.
