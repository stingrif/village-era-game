# üìä MEGA AUDIT REPORT ‚Äî –ò–≥—Ä–∞ (Village Era)

**–ü—Ä–æ–µ–∫—Ç:** Village Era Game API (–±—ç–∫–µ–Ω–¥)  
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –∫–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª–Ω—ã–π –ø—Ä–æ–µ–∫—Ç, —á–µ–∫–ª–∏—Å—Ç –ø—Ä–æ–≤–µ—Ä–æ–∫ –∏ –∑–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤.

---

## üìà –°–≤–æ–¥–∫–∞

| –ö–∞—Ç–µ–≥–æ—Ä–∏—è | –û–ø–∏—Å–∞–Ω–∏–µ |
|-----------|----------|
| **–¢–∏–ø —Ç–µ—Å—Ç–æ–≤** | E2E –ø–æ HTTP API (FastAPI TestClient) |
| **–û—Ö–≤–∞—Ç** | –ö–æ–Ω—Ñ–∏–≥, —á–µ–∫–∏–Ω, —à–∞—Ö—Ç–∞, –±–∞–ª–∞–Ω—Å—ã, –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å, –ø–æ–ª–µ, –∑–¥–∞–Ω–∏—è, –∫—Ä–∞—Ñ—Ç, —Ä—ã–Ω–æ–∫, –≤—ã–≤–æ–¥, —Å—Ç–µ–π–∫–∏–Ω–≥, –ª–∏–¥–µ—Ä–±–æ—Ä–¥—ã |
| **–ó–∞–ø—É—Å–∫** | –ò–∑ –∫–æ—Ä–Ω—è –±—ç–∫–µ–Ω–¥–∞: `pytest tests/ -v` –∏–ª–∏ `python -m pytest tests/test_game_api_e2e.py -v` |

---

## üöÄ –ö–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å

### 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞

- –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (–≤ —Ç.—á. –¥–ª—è —Ç–µ—Å—Ç–æ–≤):
  ```bash
  cd –±—ç–∫–µ–Ω–¥
  pip install -r requirements.txt
  pip install pytest httpx  # –¥–ª—è —Ç–µ—Å—Ç–æ–≤
  ```
- –ë–î: —Ç–µ—Å—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç —Ç—É –∂–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é, —á—Ç–æ –∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é SQLite –≤ `data/game.db` –∏–ª–∏ –∏–∑ env). –î–ª—è –∏–∑–æ–ª—è—Ü–∏–∏ –º–æ–∂–Ω–æ –∑–∞–¥–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—É—é –ë–î –¥–ª—è —Ç–µ—Å—Ç–æ–≤ (—Å–º. `tests/conftest.py` –ø—Ä–∏ –ø–æ—è–≤–ª–µ–Ω–∏–∏).

### 2. –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö E2E —Ç–µ—Å—Ç–æ–≤ API

```bash
cd –±—ç–∫–µ–Ω–¥
python -m pytest tests/test_game_api_e2e.py -v
```

–ï—Å–ª–∏ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –Ω–µ—Å–æ–≤–º–µ—Å—Ç–∏–º–æ —Å `TestClient` (—Å—Ç–∞—Ä—ã–µ starlette/httpx) –∏–ª–∏ –ë–î –±–ª–æ–∫–∏—Ä—É–µ—Ç –ø–æ–¥–Ω—è—Ç–∏–µ —Å–µ—Ä–≤–µ—Ä–∞ –≤ —Å—É–±–ø—Ä–æ—Ü–µ—Å—Å–µ, –∑–∞–ø—É—Å—Ç–∏—Ç–µ API –≤—Ä—É—á–Ω—É—é –∏ –∑–∞–¥–∞–π—Ç–µ `TEST_API_BASE_URL=http://127.0.0.1:8000` –ø–µ—Ä–µ–¥ pytest (—Å–º. `–±—ç–∫–µ–Ω–¥/tests/README_TESTS.md`).

–ò–ª–∏ —Ç–æ–ª—å–∫–æ –ø–æ–º–µ—á–µ–Ω–Ω—ã–µ –∫–∞–∫ ¬´–¥—ã–º–æ–≤—ã–µ¬ª:

```bash
python -m pytest tests/test_game_api_e2e.py -v -m smoke
```

### 3. –ó–∞–ø—É—Å–∫ —Å –≤—ã–≤–æ–¥–æ–º print/log

```bash
python -m pytest tests/test_game_api_e2e.py -v -s
```

### 4. –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏ —Ä—É—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ (curl/Postman)

```bash
cd –±—ç–∫–µ–Ω–¥
uvicorn api.main:app --reload --host 0.0.0.0 --port 8000
```

–î–∞–ª–µ–µ –ø—Ä–æ–≤–µ—Ä—è—Ç—å —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã —Å –∑–∞–≥–æ–ª–æ–≤–∫–æ–º `X-Telegram-User-Id: 12345` (–∏–ª–∏ `X-User-Id`).

---

## ‚úÖ –ß–µ–∫–ª–∏—Å—Ç –ø—Ä–æ–≤–µ—Ä–æ–∫ (—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ 25_–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞, 18_Dev)

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç—Ç–æ—Ç —Å–ø–∏—Å–æ–∫ –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –∏–ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∞—É–¥–∏—Ç–∞.

### –ö–æ–Ω—Ñ–∏–≥ –∏ –∑–¥–æ—Ä–æ–≤—å–µ

| –ü—Ä–æ–≤–µ—Ä–∫–∞ | –≠–Ω–¥–ø–æ–∏–Ω—Ç | –û–∂–∏–¥–∞–Ω–∏–µ |
|----------|-----------|----------|
| Health | GET /health | 200, `{"status":"ok"}` |
| –ü—É–±–ª–∏—á–Ω—ã–π –∫–æ–Ω—Ñ–∏–≥ | GET /api/game/config | 200, –ø–æ–ª—è `field`, `mine`, `eggs` |

### –ß–µ–∫–∏–Ω –∏ –ø–æ–ø—ã—Ç–∫–∏

| –ü—Ä–æ–≤–µ—Ä–∫–∞ | –≠–Ω–¥–ø–æ–∏–Ω—Ç | –û–∂–∏–¥–∞–Ω–∏–µ |
|----------|----------|----------|
| –ß–µ–∫–∏–Ω | POST /api/game/checkin | 200, `granted_attempts`, `next_checkin_at` |
| –°–æ—Å—Ç–æ—è–Ω–∏–µ —á–µ–∫–∏–Ω–∞ | GET /api/game/checkin-state | 200, `next_checkin_at`, `streak` |
| –ë–∞–ª–∞–Ω—Å –ø–æ–ø—ã—Ç–æ–∫ | GET /api/game/attempts | 200, `attempts` (—á–∏—Å–ª–æ) |

### –®–∞—Ö—Ç–∞

| –ü—Ä–æ–≤–µ—Ä–∫–∞ | –≠–Ω–¥–ø–æ–∏–Ω—Ç | –û–∂–∏–¥–∞–Ω–∏–µ |
|----------|----------|----------|
| –°–æ–∑–¥–∞—Ç—å —à–∞—Ö—Ç—É | POST /api/game/mine/create | 200, `mine_id` |
| –ö–æ–ø–∞—Ç—å —è—á–µ–π–∫—É | POST /api/game/mine/dig | body: `mine_id`, `cell_index`; 200, –µ—Å—Ç—å `opened_cells`, –≤–æ–∑–º–æ–∂–Ω–æ `drop` |
| –ü–æ–ª—É—á–∏—Ç—å —Å–µ—Å—Å–∏—é | GET /api/game/mine/{id} | 200, `grid_size`, `opened_cells` (–ø—Ä–∏–∑–æ–≤—ã–µ –Ω–µ —Ä–∞—Å–∫—Ä—ã—Ç—ã) |

### –ë–∞–ª–∞–Ω—Å—ã –∏ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å

| –ü—Ä–æ–≤–µ—Ä–∫–∞ | –≠–Ω–¥–ø–æ–∏–Ω—Ç | –û–∂–∏–¥–∞–Ω–∏–µ |
|----------|----------|----------|
| –ë–∞–ª–∞–Ω—Å—ã | GET /api/game/balances | 200, `balances` (COINS, STARS, DIAMONDS –∏ —Ç.–¥.) |
| –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å | GET /api/game/inventory | 200, —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å –ø—Ä–µ–¥–º–µ—Ç–∞–º–∏ –∏ —è–π—Ü–∞–º–∏ |

### –ü–æ–ª–µ –∏ –∑–¥–∞–Ω–∏—è

| –ü—Ä–æ–≤–µ—Ä–∫–∞ | –≠–Ω–¥–ø–æ–∏–Ω—Ç | –û–∂–∏–¥–∞–Ω–∏–µ |
|----------|----------|----------|
| –ü–æ–ª–µ –∏–≥—Ä–æ–∫–∞ | GET /api/game/field | 200, —Å–ª–æ—Ç—ã 1..9, –∑–¥–∞–Ω–∏—è |
| –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –∑–¥–∞–Ω–∏–π | GET /api/game/buildings/def | 200, —Å–ø–∏—Å–æ–∫ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–π |
| –ü–æ—Å—Ç–∞–≤–∏—Ç—å –∑–¥–∞–Ω–∏–µ | POST /api/game/field/place | body: `slot_index`, `building_key`; 200 |
| –°–Ω–µ—Å—Ç–∏ | POST /api/game/field/demolish | body: `slot_index`; 200 |
| –£–ª—É—á—à–∏—Ç—å | POST /api/game/field/upgrade | body: `slot_index`, `cost`; 200 |
| –°–ª–æ—Ç—ã –∑–¥–∞–Ω–∏—è | GET /api/game/field/slots/{building_key} | 200 |
| –≠–∫–∏–ø–∏—Ä–æ–≤–∞—Ç—å/—Å–Ω—è—Ç—å —Ä–µ–ª–∏–∫–≤–∏—é | POST /api/game/field/equip, unequip | 200 |
| –°–æ–±—Ä–∞—Ç—å –¥–æ—Ö–æ–¥ | POST /api/game/field/collect | 200 |

### –ö—Ä–∞—Ñ—Ç

| –ü—Ä–æ–≤–µ—Ä–∫–∞ | –≠–Ω–¥–ø–æ–∏–Ω—Ç | –û–∂–∏–¥–∞–Ω–∏–µ |
|----------|----------|----------|
| Merge | POST /api/game/craft/merge | body –ø–æ —Å—Ö–µ–º–µ; 200 –∏–ª–∏ 400 |
| Upgrade | POST /api/game/craft/upgrade | body –ø–æ —Å—Ö–µ–º–µ; 200 –∏–ª–∏ 400 |
| Reroll | POST /api/game/craft/reroll | body –ø–æ —Å—Ö–µ–º–µ; 200 –∏–ª–∏ 400 |

### –†—ã–Ω–æ–∫ –∏ P2P

| –ü—Ä–æ–≤–µ—Ä–∫–∞ | –≠–Ω–¥–ø–æ–∏–Ω—Ç | –û–∂–∏–¥–∞–Ω–∏–µ |
|----------|----------|----------|
| –°–ø–∏—Å–æ–∫ –æ—Ä–¥–µ—Ä–æ–≤ | GET /api/game/market/orders | 200 |
| –°–æ–∑–¥–∞—Ç—å –æ—Ä–¥–µ—Ä | POST /api/game/market/orders | body; 200 –∏–ª–∏ 400 |
| –ò—Å–ø–æ–ª–Ω–∏—Ç—å/–æ—Ç–º–µ–Ω–∏—Ç—å –æ—Ä–¥–µ—Ä | POST .../fill, .../cancel | 200 –∏–ª–∏ 400 |
| –û—Ñ—Ñ–µ—Ä—ã | POST /api/game/market/trade-offers, .../accept, .../cancel | 200 –∏–ª–∏ 400 |

### –í—ã–≤–æ–¥ –∏ –¥–æ–Ω–∞—Ç—ã

| –ü—Ä–æ–≤–µ—Ä–∫–∞ | –≠–Ω–¥–ø–æ–∏–Ω—Ç | –û–∂–∏–¥–∞–Ω–∏–µ |
|----------|----------|----------|
| Eligibility | GET /api/game/withdraw/eligibility | 200, —Ñ–ª–∞–≥–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è |
| –ó–∞–ø—Ä–æ—Å –≤—ã–≤–æ–¥–∞ | POST /api/game/withdraw/request | 200 –∏–ª–∏ –∑–∞–≥–ª—É—à–∫–∞ ¬´iCryptoCheck not configured¬ª |
| –†–µ–∫–ª–∞–º–∞ | POST /api/game/ads/view | 200 |
| –î–æ–Ω–∞—Ç | POST /api/game/donate | body; 200 –∏–ª–∏ 400 |

### –°—Ç–µ–π–∫–∏–Ω–≥ –∏ –ª–∏–¥–µ—Ä–±–æ—Ä–¥—ã

| –ü—Ä–æ–≤–µ—Ä–∫–∞ | –≠–Ω–¥–ø–æ–∏–Ω—Ç | –û–∂–∏–¥–∞–Ω–∏–µ |
|----------|----------|----------|
| –°–µ—Å—Å–∏–∏ —Å—Ç–µ–π–∫–∏–Ω–≥–∞ | GET /api/game/staking/sessions | 200, —Å–ø–∏—Å–æ–∫ (–º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç–æ–π) |
| –°–æ–∑–¥–∞—Ç—å —Å—Ç–µ–π–∫–∏–Ω–≥ | POST /api/game/staking/create | 200 –∏–ª–∏ –∑–∞–≥–ª—É—à–∫–∞ |
| –õ–∏–¥–µ—Ä–±–æ—Ä–¥—ã | GET /api/game/leaderboards | 200, —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ª–∏–¥–µ—Ä–±–æ—Ä–¥–æ–≤ |

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è

| –ü—Ä–æ–≤–µ—Ä–∫–∞ | –û–∂–∏–¥–∞–Ω–∏–µ |
|----------|----------|
| –ó–∞–ø—Ä–æ—Å –±–µ–∑ X-Telegram-User-Id / X-User-Id | 401 –¥–ª—è —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤, —Ç—Ä–µ–±—É—é—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è |
| –ù–µ–≤–∞–ª–∏–¥–Ω—ã–π mine_id / cell_index | 400 |
| –ü–æ–≤—Ç–æ—Ä–Ω—ã–π —á–µ–∫–∏–Ω –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è CD | 200, –Ω–æ `granted_attempts: 0` –∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ CD |

---

## üìÅ –§–∞–π–ª—ã —Ç–µ—Å—Ç–æ–≤

| –§–∞–π–ª | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|------|------------|
| `–±—ç–∫–µ–Ω–¥/tests/test_game_api_e2e.py` | –ü–æ–ª–Ω—ã–π E2E –ø—Ä–æ–≥–æ–Ω –ø–æ –≤—Å–µ–º –æ—Å–Ω–æ–≤–Ω—ã–º —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞–º API |
| `–±—ç–∫–µ–Ω–¥/tests/README_TESTS.md` | –ö—Ä–∞—Ç–∫–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∑–∞–ø—É—Å–∫—É —Ç–µ—Å—Ç–æ–≤ |

---

## üîß –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ (–∫–∞–∫ –≤ —ç—Ç–∞–ª–æ–Ω–Ω–æ–º MEGA AUDIT)

1. **–ü–µ—Ä–µ–¥ —Ä–µ–ª–∏–∑–æ–º:** –≤—ã–ø–æ–ª–Ω–∏—Ç—å `pytest tests/ -v` –∏ —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –≤—Å–µ —Ç–µ—Å—Ç—ã –∑–µ–ª—ë–Ω—ã–µ.
2. **–ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ API:** –¥–æ–±–∞–≤–∏—Ç—å –∏–ª–∏ –æ–±–Ω–æ–≤–∏—Ç—å –∫–µ–π—Å—ã –≤ `test_game_api_e2e.py`.
3. **–ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤:** –≤–Ω–µ—Å—Ç–∏ –ø—Ä–æ–≤–µ—Ä–∫—É –≤ —á–µ–∫–ª–∏—Å—Ç –≤—ã—à–µ –∏ –≤ —Ç–µ—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª.
4. **–°–µ–∫—Ä–µ—Ç—ã:** –Ω–µ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –∏ –Ω–µ –∫–æ–º–º–∏—Ç–∏—Ç—å –∫–ª—é—á–∏/—Ç–æ–∫–µ–Ω—ã; –≤ —Ç–µ—Å—Ç–∞—Ö –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ –≤–Ω–µ—à–Ω–∏–µ —Å–µ—Ä–≤–∏—Å—ã (iCryptoCheck, TonAPI) –±–µ–∑ –º–æ–∫–æ–≤.

---

**–î–∞—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞:** 2026-02-07  
**–≠—Ç–∞–ª–æ–Ω:** –ù–û–í–´–ô/docs/MEGA_AUDIT_REPORT.md (—Ñ–æ—Ä–º–∞—Ç –∏ –ø–æ–¥—Ö–æ–¥ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é)
