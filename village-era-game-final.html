<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–≠—Ä–∞ –î–µ—Ä–µ–≤–Ω–∏ - Village Era</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="config.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Segoe UI',Arial,sans-serif;background:#0a0a0a;background:linear-gradient(135deg,#1a0000 0%,#0a0a0a 50%,#1a0600 100%);min-height:100vh;color:#fff;overflow-x:hidden}
.app{max-width:600px;margin:0 auto;padding-bottom:80px}
.header{background:rgba(0,0,0,.9);padding:10px 15px;display:flex;justify-content:space-between;align-items:center;backdrop-filter:blur(10px);position:sticky;top:0;z-index:100;flex-wrap:wrap;gap:8px;border-bottom:2px solid #ff4500;box-shadow:0 0 20px rgba(255,69,0,.3)}
.res{display:flex;gap:6px;flex-wrap:wrap;font-size:12px}
.r{display:flex;align-items:center;gap:3px;background:linear-gradient(135deg,rgba(255,69,0,.2),rgba(255,140,0,.2));padding:3px 8px;border-radius:12px;font-weight:700;border:1px solid rgba(255,69,0,.4);box-shadow:0 0 10px rgba(255,69,0,.2)}
.online-badge{display:flex;align-items:center;gap:5px;font-size:11px;background:linear-gradient(135deg,rgba(0,255,0,.2),rgba(0,200,0,.2));padding:4px 10px;border-radius:15px;border:1px solid rgba(0,255,0,.4)}
.online-dot{width:8px;height:8px;background:#00ff00;border-radius:50%;animation:blink 2s infinite;box-shadow:0 0 10px #00ff00}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.4}}
.screen{display:none;padding:15px;animation:fadeIn .3s}
.screen.active{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.warn{background:linear-gradient(135deg,#ff0000,#8b0000);padding:15px;border-radius:15px;margin:15px;text-align:center;animation:pulse 1.5s infinite;border:3px solid #ff4500;display:none;box-shadow:0 0 30px rgba(255,0,0,.5)}
.warn.active{display:block}
@keyframes pulse{0%,100%{transform:scale(1);box-shadow:0 0 20px rgba(255,0,0,.5)}50%{transform:scale(1.02);box-shadow:0 0 40px rgba(255,0,0,.8)}}
.era-info{background:rgba(255,69,0,.15);padding:12px;border-radius:12px;margin:15px;border:2px solid #ff4500;box-shadow:0 0 15px rgba(255,69,0,.3)}
.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin:15px 0}
.card{background:linear-gradient(135deg,rgba(20,20,20,.9),rgba(40,20,0,.9));border-radius:12px;padding:10px;text-align:center;cursor:pointer;transition:all .3s;border:2px solid rgba(255,69,0,.3);min-height:130px;box-shadow:0 4px 15px rgba(0,0,0,.5)}
.card:hover{transform:translateY(-3px);box-shadow:0 0 25px rgba(255,69,0,.6);border-color:#ff4500}
.card.dmg{border-color:#ff0000;background:linear-gradient(135deg,rgba(139,0,0,.9),rgba(70,0,0,.9));animation:damage 1s infinite}
@keyframes damage{0%,100%{box-shadow:0 0 15px rgba(255,0,0,.5)}50%{box-shadow:0 0 30px rgba(255,0,0,.8)}}
.ic{font-size:35px;margin-bottom:6px;text-shadow:0 0 10px rgba(255,69,0,.5)}
.nm{font-size:12px;font-weight:700;margin-bottom:4px;color:#ffa500}
.lv{font-size:11px;opacity:.8;margin-bottom:4px}
.inc{font-size:10px;color:#ff8c00;font-weight:700;text-shadow:0 0 5px rgba(255,140,0,.5)}
.loss{font-size:10px;color:#ff0000;font-weight:700;text-shadow:0 0 5px rgba(255,0,0,.5)}
.mine-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:5px;margin:15px 0}
.mb{aspect-ratio:1;background:linear-gradient(135deg,#2a2a2a,#1a1a1a);border-radius:6px;border:2px solid rgba(255,69,0,.3);cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center;font-size:20px;position:relative;box-shadow:0 2px 10px rgba(0,0,0,.5)}
.mb:hover:not(.clr):not(.locked){transform:scale(1.05);box-shadow:0 0 20px rgba(255,69,0,.6);border-color:#ff4500}
.mb.clr{background:linear-gradient(135deg,rgba(255,140,0,.3),rgba(255,69,0,.3));cursor:default;border-color:#ff8c00}
.mb.locked{opacity:.3;cursor:not-allowed}
.mb.epic{background:linear-gradient(135deg,#9b59b6,#8e44ad);animation:shimmer 2s infinite;border:2px solid #9b59b6}
.mb.magic{background:linear-gradient(135deg,#3498db,#2980b9);animation:shimmer 2s infinite;border:2px solid #3498db}
.mb.tsy{background:linear-gradient(135deg,#2ecc71,#27ae60);animation:shimmer 2s infinite;border:2px solid #2ecc71}
.mb.yan{background:linear-gradient(135deg,#f39c12,#e67e22);animation:shimmer 2s infinite;border:2px solid #f39c12}
.mb.yin{background:linear-gradient(135deg,#34495e,#2c3e50);animation:shimmer 2s infinite;border:2px solid #7f8c8d}
.mb.fire{background:linear-gradient(135deg,#ff0000,#ff4500);animation:shimmer 2s infinite;border:2px solid #ff0000}
@keyframes shimmer{0%,100%{box-shadow:0 0 15px currentColor}50%{box-shadow:0 0 30px currentColor}}
.btn{background:linear-gradient(135deg,#ff4500,#ff8c00);border:none;padding:10px 20px;border-radius:20px;color:#fff;font-size:14px;font-weight:700;cursor:pointer;transition:all .3s;margin:4px;box-shadow:0 4px 15px rgba(255,69,0,.4);text-shadow:0 1px 2px rgba(0,0,0,.5)}
.btn:hover{transform:translateY(-2px);box-shadow:0 0 25px rgba(255,69,0,.8)}
.btn:disabled{opacity:.5;cursor:not-allowed}
.btn-success{background:linear-gradient(135deg,#ff8c00,#ffa500)}
.btn-danger{background:linear-gradient(135deg,#8b0000,#ff0000)}
.btn-warning{background:linear-gradient(135deg,#ffa500,#ff4500)}
.btn-small{padding:6px 12px;font-size:12px}
.btn-big{padding:15px 40px;font-size:18px;font-weight:900;box-shadow:0 6px 25px rgba(255,69,0,.6)}
.nav{position:fixed;bottom:0;left:0;right:0;background:rgba(0,0,0,.95);backdrop-filter:blur(10px);display:grid;grid-template-columns:repeat(5,1fr);padding:8px 0;z-index:1000;max-width:600px;margin:0 auto;border-top:2px solid #ff4500;box-shadow:0 -5px 20px rgba(255,69,0,.3)}
.ni{text-align:center;padding:6px;cursor:pointer;transition:all .3s;border-radius:8px;margin:0 3px}
.ni.active{background:linear-gradient(135deg,rgba(255,69,0,.4),rgba(255,140,0,.4));box-shadow:0 0 15px rgba(255,69,0,.5)}
.ni:hover{background:rgba(255,69,0,.2)}
.nic{font-size:20px;margin-bottom:3px;text-shadow:0 0 10px rgba(255,140,0,.5)}
.nil{font-size:10px}
.modal{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.95);z-index:2000;align-items:center;justify-content:center;padding:20px;overflow-y:auto}
.modal.active{display:flex}
.mc{background:linear-gradient(135deg,#1a1a1a,#2a1a0a);border-radius:20px;padding:25px;max-width:500px;width:100%;max-height:85vh;overflow-y:auto;position:relative;border:2px solid #ff4500;box-shadow:0 0 40px rgba(255,69,0,.5)}
.mcl{position:absolute;top:15px;right:15px;background:linear-gradient(135deg,rgba(255,69,0,.5),rgba(255,140,0,.5));border:none;width:35px;height:35px;border-radius:50%;color:#fff;font-size:22px;cursor:pointer;transition:all .3s;box-shadow:0 2px 10px rgba(255,69,0,.5)}
.mcl:hover{background:linear-gradient(135deg,#ff4500,#ff8c00);transform:rotate(90deg);box-shadow:0 0 20px rgba(255,69,0,.8)}
.mt{font-size:22px;font-weight:700;margin-bottom:20px;text-align:center;color:#ffa500;text-shadow:0 0 15px rgba(255,140,0,.5)}
.notif{position:fixed;top:70px;left:50%;transform:translateX(-50%);background:linear-gradient(135deg,rgba(255,140,0,.95),rgba(255,69,0,.95));padding:12px 20px;border-radius:10px;font-weight:700;z-index:3000;animation:slideDown .3s;display:none;max-width:90%;text-align:center;border:2px solid #ffa500;box-shadow:0 0 25px rgba(255,140,0,.7)}
.notif.show{display:block}
.notif.error{background:linear-gradient(135deg,rgba(139,0,0,.95),rgba(255,0,0,.95));border-color:#ff0000;box-shadow:0 0 25px rgba(255,0,0,.7)}
@keyframes slideDown{from{opacity:0;transform:translate(-50%,-20px)}to{opacity:1;transform:translate(-50%,0)}}
.info{background:linear-gradient(135deg,rgba(30,30,30,.9),rgba(50,25,0,.9));border-radius:12px;padding:15px;margin:10px 0;border:1px solid rgba(255,69,0,.3);box-shadow:0 4px 15px rgba(0,0,0,.5)}
.ir{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid rgba(255,69,0,.2)}
.ir:last-child{border-bottom:none}
.lb{background:linear-gradient(135deg,rgba(30,30,30,.9),rgba(50,25,0,.9));border-radius:12px;padding:12px;margin:8px 0;display:flex;align-items:center;gap:12px;border:1px solid rgba(255,69,0,.3);box-shadow:0 4px 15px rgba(0,0,0,.5);position:relative}
.lb.me{border:2px solid #ffa500;box-shadow:0 0 20px rgba(255,165,0,.6)}
.rank{font-size:20px;font-weight:700;min-width:35px;text-align:center}
.rank.gold{color:#ffd700;text-shadow:0 0 15px #ffd700}
.rank.silver{color:#c0c0c0;text-shadow:0 0 15px #c0c0c0}
.rank.bronze{color:#cd7f32;text-shadow:0 0 15px #cd7f32}
.checkin-card{background:linear-gradient(135deg,rgba(255,69,0,.2),rgba(255,140,0,.2));border-radius:15px;padding:20px;margin:0 0 15px 0;border:2px solid #ff4500;box-shadow:0 0 25px rgba(255,69,0,.5);text-align:center}
.checkin-btn{padding:15px 40px;font-size:18px;font-weight:900;background:linear-gradient(135deg,#ff4500,#ff8c00);border:3px solid #ffa500;border-radius:25px;box-shadow:0 6px 25px rgba(255,140,0,.7);cursor:pointer;transition:all .3s;color:#fff}
.checkin-btn:hover:not(:disabled){transform:scale(1.05);box-shadow:0 8px 35px rgba(255,140,0,1)}
.checkin-btn:disabled{opacity:.5;cursor:not-allowed}
.digs-left{background:linear-gradient(135deg,rgba(255,69,0,.3),rgba(255,140,0,.3));padding:15px;border-radius:12px;margin:15px 0;text-align:center;border:2px solid #ff4500;box-shadow:0 0 20px rgba(255,69,0,.5)}
.digs-count{font-size:48px;font-weight:900;color:#ffa500;text-shadow:0 0 20px rgba(255,140,0,.8);margin:10px 0}
.rc{background:linear-gradient(135deg,rgba(30,30,30,.9),rgba(50,25,0,.9));border-radius:12px;padding:12px;margin:8px 0;border:2px solid;cursor:pointer;transition:all .3s;box-shadow:0 4px 15px rgba(0,0,0,.5)}
.rc:hover{transform:translateY(-3px);box-shadow:0 0 25px rgba(255,69,0,.6)}
.inv-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin:15px 0}
.inv-item{background:linear-gradient(135deg,rgba(30,30,30,.9),rgba(50,25,0,.9));border-radius:12px;padding:15px;text-align:center;border:2px solid rgba(255,69,0,.3);box-shadow:0 4px 15px rgba(0,0,0,.5);transition:all .3s}
.inv-item:hover{transform:translateY(-3px);box-shadow:0 0 25px rgba(255,69,0,.6)}
.inv-qty{font-size:14px;font-weight:700;color:#ff8c00;margin-top:8px}
.tx-input{width:100%;padding:10px;border-radius:10px;background:rgba(30,30,30,.9);border:2px solid rgba(255,69,0,.5);color:#ffa500;font-size:14px;margin:10px 0;box-shadow:inset 0 2px 10px rgba(0,0,0,.5)}
.tx-input:focus{outline:none;border-color:#ff8c00;box-shadow:inset 0 2px 10px rgba(0,0,0,.5),0 0 15px rgba(255,140,0,.5)}
.help-section{margin:14px 0;padding:12px;background:rgba(30,30,30,.6);border-radius:10px;border-left:4px solid #ff4500}
.help-section h4{color:#ffa500;font-size:14px;margin-bottom:6px}
.help-section p{font-size:13px;line-height:1.45;opacity:.95}
.help-title{font-size:18px;color:#ffa500;margin-bottom:4px}
@media (max-width:400px){.grid{grid-template-columns:repeat(2,1fr)}.mine-grid{grid-template-columns:repeat(5,1fr)}.nil{display:none}}
</style>
</head>
<body>
<div class="app">
<div class="header">
<div class="res">
<div class="online-badge"><div class="online-dot"></div><span id="onlineCount">152</span> –æ–Ω–ª–∞–π–Ω</div>
<div class="r">üíé <span id="gems">0</span></div>
<div class="r">ü™ô <span id="coins">1000</span></div>
<div class="r">‚≠ê <span id="points">0</span></div>
<div class="r">ü™µ <span id="wood">100</span></div>
<div class="r">ü™® <span id="stone">100</span></div>
</div>
<div style="font-size:12px;display:flex;align-items:center;gap:8px">
<div class="online-dot" style="width:6px;height:6px"></div>
<span id="playerName">–ò–≥—Ä–æ–∫</span>
<button type="button" class="btn btn-small" style="padding:4px 10px;font-size:16px" onclick="G.openHelp()" title="–û–±—É—á–µ–Ω–∏–µ">üìñ</button>
</div>
</div>

<div class="warn" id="skyFallWarning">
<h3>‚ö†Ô∏è –ü–ê–î–ï–ù–ò–ï –ù–ï–ë–ê ‚ö†Ô∏è</h3>
<p>–í—Å–µ –ø–æ—Å—Ç—Ä–æ–π–∫–∏ –Ω–µ—Å—É—Ç —É–±—ã—Ç–∫–∏!</p>
<p>–£–±—ã—Ç–æ–∫: <span id="lossMultiplier">1.0x</span></p>
</div>

<div class="era-info">
<div style="display:flex;justify-content:space-between">
<div><strong>–≠—Ä–∞ <span id="currentEra">1</span>/4</strong><div style="font-size:12px;opacity:.8">–î–æ –∫–æ–Ω—Ü–∞: <span id="eraTimer">7–¥ 0—á</span></div></div>
<div style="text-align:right"><div>–î–µ—Ä–µ–≤–Ω—è: –£—Ä.<span id="villageLevel">1</span></div></div>
</div>
</div>

<div id="villageScreen" class="screen active">
<h2 style="text-align:center;margin-bottom:15px;color:#ffa500;text-shadow:0 0 15px rgba(255,140,0,.5)">üèòÔ∏è –ú–æ—è –î–µ—Ä–µ–≤–Ω—è</h2>
<div class="info">
<div class="ir"><span>–î–æ—Ö–æ–¥ –≤ —á–∞—Å:</span><span style="color:#ff8c00" id="totalIncome">+0 ü™ô</span></div>
<div class="ir"><span>–†–∞—Å—Ö–æ–¥—ã –≤ —á–∞—Å:</span><span style="color:#ff0000" id="totalExpenses">-0 ü™ô</span></div>
</div>
<div class="grid" id="villageGrid"></div>
<div style="text-align:center;margin-top:15px">
<button class="btn btn-success" onclick="G.collectResources()">üì¶ –°–æ–±—Ä–∞—Ç—å –†–µ—Å—É—Ä—Å—ã</button>
</div>
</div>

<div id="mineScreen" class="screen">
<h2 style="text-align:center;margin-bottom:15px;color:#ffa500;text-shadow:0 0 15px rgba(255,140,0,.5)">‚õèÔ∏è –®–∞—Ö—Ç–∞</h2>

<div class="digs-left">
<div style="font-size:18px;font-weight:700;color:#ffa500;margin-bottom:10px">‚õèÔ∏è –ü–æ–ø—ã—Ç–∫–∏ –∫–æ–ø–∞–Ω–∏—è</div>
<div class="digs-count" id="digsLeft">5</div>
<div style="font-size:14px;opacity:.8">–∏–∑ 5 –¥–æ—Å—Ç—É–ø–Ω–æ</div>
<div style="font-size:12px;opacity:.7;margin-top:10px">–í–æ—Å—Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è —á–µ—Ä–µ–∑: <span id="digsTimer">--:--</span></div>
</div>

<div class="info">
<div class="ir"><span>–í—Å–µ–≥–æ –Ω–∞–π–¥–µ–Ω–æ —Ä–µ–ª–∏–∫–≤–∏–π:</span><span id="relicsFound">0</span></div>
</div>
<div class="mine-grid" id="mineGrid"></div>
<div style="text-align:center;margin-top:15px">
<button class="btn" onclick="G.newMine()">üîÑ –ù–æ–≤–∞—è –®–∞—Ö—Ç–∞</button>
</div>
<div class="info" style="margin-top:15px">
<div style="font-size:14px;font-weight:700;color:#ffa500;margin-bottom:10px">üíé –ó–∞ –∫—Ä–∏—Å—Ç–∞–ª–ª—ã</div>
<div style="display:flex;flex-wrap:wrap;gap:8px;justify-content:center">
<button class="btn btn-small" onclick="G.buyDigsForGems()">+5 –ø–æ–ø—ã—Ç–æ–∫ (10üíé)</button>
<button class="btn btn-small" onclick="G.reduceCheckinForGems()">–ß–µ–∫–∏–Ω —Å–µ–π—á–∞—Å (15üíé)</button>
<button class="btn btn-small" onclick="G.buyMineHint()">–ü–æ–¥—Å–∫–∞–∑–∫–∞ 1 —è—á–µ–π–∫–∏ (5üíé)</button>
<button class="btn btn-small" onclick="G.buyFullScan()">–ü–æ–ª–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ (15üíé)</button>
<button class="btn btn-small" onclick="G.buyPhoenixEye()">–§–µ–Ω–∏–∫—Å –ì–ª–∞–∑ ‚Äî –ø—Ä–∏–∑—ã (25üíé)</button>
<button class="btn btn-small" onclick="G.buyExpForGems()">+100 –æ–ø—ã—Ç–∞ (20üíé)</button>
</div>
</div>
</div>

<div id="marketScreen" class="screen">
<h2 style="text-align:center;margin-bottom:15px;color:#ffa500;text-shadow:0 0 15px rgba(255,140,0,.5)">üè™ –ú–∞—Ä–∫–µ—Ç</h2>
<div style="text-align:center;margin:15px 0">
<button class="btn" id="tabRelics" onclick="G.switchTab('relics')">‚ú® –†–µ–ª–∏–∫–≤–∏–∏</button>
<button class="btn" id="tabAmulets" onclick="G.switchTab('amulets')">üîÆ –ê–º—É–ª–µ—Ç—ã</button>
<button class="btn" id="tabDiamonds" onclick="G.switchTab('diamonds')">üíé –ê–ª–º–∞–∑—ã</button>
</div>
<div id="marketRelics"><div id="marketRelicsList"></div></div>
<div id="marketAmulets" style="display:none"><div id="marketAmuletsList"></div></div>
<div id="marketDiamonds" style="display:none"><div id="marketDiamondsList"></div></div>
</div>

<div id="profileScreen" class="screen">
<h2 style="text-align:center;margin-bottom:15px;color:#ffa500;text-shadow:0 0 15px rgba(255,140,0,.5)">üë§ –ü—Ä–æ—Ñ–∏–ª—å</h2>
<div class="info">
<div style="text-align:center;margin-bottom:15px">
<div style="font-size:60px;margin-bottom:10px">üî•</div>
<div style="font-size:20px;font-weight:700;color:#ffa500" id="profileName">–ò–≥—Ä–æ–∫</div>
<div style="font-size:14px;opacity:.8">–£—Ä–æ–≤–µ–Ω—å –¥–µ—Ä–µ–≤–Ω–∏: <span id="profileLevel">1</span></div>
</div>
<div class="ir"><span>–í—Å–µ–≥–æ –º–æ–Ω–µ—Ç:</span><span id="profileCoins">0</span></div>
<div class="ir"><span>–í—Å–µ–≥–æ –∞–ª–º–∞–∑–æ–≤:</span><span id="profileGems">0</span></div>
<div class="ir"><span>–ù–∞–π–¥–µ–Ω–æ —Ä–µ–ª–∏–∫–≤–∏–π:</span><span id="profileRelics">0</span></div>
<div class="ir"><span>–≠—Ä–∞:</span><span id="profileEra">1</span></div>
<div class="ir"><span>–ü–æ–∏–Ω—Ç—ã:</span><span id="profilePoints">0</span></div>
</div>
<div style="text-align:center;margin-top:15px">
<button class="btn btn-warning" onclick="G.openWithdraw()">üì§ Withdraw (weekly batch)</button>
</div>
<div class="info" style="margin-top:15px">
<div style="font-size:14px;font-weight:700;color:#ffa500;margin-bottom:8px">üèÖ –ú–µ–¥–∞–ª–∏ —ç—Ä (–Ω–∞—à–∏–≤–∫–∏)</div>
<div id="profileEraMedals" style="min-height:24px;opacity:.9"></div>
<div id="profileBurnMedal" style="margin-top:8px;font-size:13px;opacity:.9"></div>
<div style="margin-top:10px;font-size:12px;opacity:.8">–ó–∞ –∫–∞–∂–¥—É—é —ç—Ä—É —É—á–∞—Å—Ç–Ω–∏–∫–∞–º –≤—ã–¥–∞—ë—Ç—Å—è –º–µ–¥–∞–ª—å. –í—ã–≤–æ–¥ –Ω–∞ –∫–æ—à–µ–ª—ë–∫ (SBT) ‚Äî –∫–Ω–æ–ø–∫–∞ –Ω–∏–∂–µ.</div>
<button class="btn btn-small" style="margin-top:8px" onclick="G.exportSBT()">–í—ã–≤–æ–¥ –º–µ–¥–∞–ª–µ–π –Ω–∞ –∫–æ—à–µ–ª—ë–∫ (SBT)</button>
</div>

<h3 style="margin:20px 0;color:#ffa500">üì¶ –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</h3>
<div class="inv-grid">
<div class="inv-item">
<div style="font-size:40px;margin-bottom:8px">‚ú®</div>
<div style="font-weight:700;margin-bottom:5px">–†–µ–ª–∏–∫–≤–∏–∏</div>
<div style="font-size:20px;color:#ff8c00" id="invRelics">0</div>
<button class="btn btn-small btn-success" onclick="G.showInvRelics()" style="margin-top:10px">–û—Ç–∫—Ä—ã—Ç—å</button>
</div>
<div class="inv-item">
<div style="font-size:40px;margin-bottom:8px">üîÆ</div>
<div style="font-weight:700;margin-bottom:5px">–ê–º—É–ª–µ—Ç—ã</div>
<div style="font-size:20px;color:#ff8c00" id="invAmulets">0</div>
<button class="btn btn-small btn-success" onclick="G.showInvAmulets()" style="margin-top:10px">–û—Ç–∫—Ä—ã—Ç—å</button>
</div>
<div class="inv-item">
<div style="font-size:40px;margin-bottom:8px">üî§</div>
<div style="font-weight:700;margin-bottom:5px">–ë—É–∫–≤—ã</div>
<div style="font-size:20px;color:#ff8c00" id="invLetters">0</div>
<button class="btn btn-small btn-success" onclick="G.showInvLetters()" style="margin-top:10px">–û—Ç–∫—Ä—ã—Ç—å</button>
</div>
<div class="inv-item">
<div style="font-size:40px;margin-bottom:8px">‚ö°</div>
<div style="font-weight:700;margin-bottom:5px">–ë–∞—Ñ—ã</div>
<div style="font-size:20px;color:#ff8c00" id="invBuffs">0</div>
<button class="btn btn-small" onclick="G.showInvBuffs()" style="margin-top:10px">–°–º–æ—Ç—Ä–µ—Ç—å</button>
</div>
<div class="inv-item">
<div style="font-size:40px;margin-bottom:8px">üèÜ</div>
<div style="font-weight:700;margin-bottom:5px">–ü–æ–∑–∏—Ü–∏—è</div>
<div style="font-size:20px;color:#ff8c00" id="invRank">-</div>
<button class="btn btn-small" onclick="G.showScreen('rating')" style="margin-top:10px">–†–µ–π—Ç–∏–Ω–≥</button>
</div>
</div>
</div>

<div id="tasksScreen" class="screen">
<h2 style="text-align:center;margin-bottom:15px;color:#ffa500;text-shadow:0 0 15px rgba(255,140,0,.5)">üìã –ó–∞–¥–∞–Ω–∏—è</h2>

<div class="checkin-card">
<div style="font-size:20px;font-weight:700;color:#ffa500;margin-bottom:15px">‚è∞ –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –ß–µ–∫–∏–Ω</div>
<div style="font-size:14px;margin-bottom:10px">–ü–æ–ª—É—á–∞–π –ø–æ–ø—ã—Ç–∫–∏ –∫–æ–ø–∞–Ω–∏—è –∫–∞–∂–¥—ã–µ 10 —á–∞—Å–æ–≤!</div>
<div style="font-size:16px;font-weight:700;margin:15px 0">–ü–æ–ø—ã—Ç–æ–∫: <span id="checkinDigs">5</span>/5</div>
<div style="font-size:14px;margin-bottom:15px" id="checkinTimer">–î–æ—Å—Ç—É–ø–Ω–æ —Å–µ–π—á–∞—Å!</div>
<div style="background:rgba(0,0,0,.3);padding:15px;border-radius:10px;margin:15px 0">
<div style="font-size:14px;font-weight:700;color:#ffa500;margin-bottom:10px">üìä –í–∞—à–∞ –ø–æ–∑–∏—Ü–∏—è</div>
<div style="font-size:24px;font-weight:900;color:#ff8c00;margin:10px 0">–ú–µ—Å—Ç–æ: <span id="myRank">-</span></div>
<div style="font-size:12px;opacity:.8">–∏–∑ <span id="totalPlayers">152</span> –∏–≥—Ä–æ–∫–æ–≤</div>
</div>
<button class="checkin-btn" id="checkinBtn" onclick="G.doCheckin()">‚úÖ –ü–û–õ–£–ß–ò–¢–¨ –ü–û–ü–´–¢–ö–ò</button>
</div>

<div class="checkin-card" style="margin-top:20px">
<div style="font-size:18px;font-weight:700;color:#ffa500;margin-bottom:12px">üì¢ –ü–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ –∫–∞–Ω–∞–ª—ã</div>
<div style="font-size:12px;opacity:.8;margin-bottom:12px">–ü–æ–¥–ø–∏—à–∏—Ç–µ—Å—å –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–ü—Ä–æ–≤–µ—Ä–∏—Ç—å¬ª –¥–ª—è –Ω–∞–≥—Ä–∞–¥—ã</div>
<div id="subsTasksList"></div>
</div>

<div class="checkin-card" style="margin-top:20px">
<div style="font-size:18px;font-weight:700;color:#ffa500;margin-bottom:12px">üîó –ü—Ä–∏–≤—è–∑–∫–∞ –∫–æ—à–µ–ª—å–∫–∞ TON Keeper</div>
<div style="font-size:12px;opacity:.8;margin-bottom:10px">–û—Ç–ø—Ä–∞–≤—å—Ç–µ 0.1 TON —Å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–º –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤–∞—à–µ–≥–æ –∫–æ—à–µ–ª—å–∫–∞</div>
<div id="walletBindStatus" style="margin:10px 0;font-weight:700"></div>
<button class="btn btn-warning" id="walletBindBtn" onclick="G.openWalletBind()">üì§ –ü–µ—Ä–µ–π—Ç–∏ –≤ TON Keeper (0.1 TON + –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π)</button>
<div style="margin-top:10px"><button class="btn btn-small" onclick="G.verifyWalletBind()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∏–≤—è–∑–∫—É</button></div>
</div>
</div>

<div id="ratingScreen" class="screen">
<h2 style="text-align:center;margin-bottom:15px;color:#ffa500;text-shadow:0 0 15px rgba(255,140,0,.5)">üèÜ –†–µ–π—Ç–∏–Ω–≥ –≠—Ä—ã</h2>
<div class="info"><div class="ir"><span>–ü—Ä–∏–∑–æ–≤–æ–π —Ñ–æ–Ω–¥ (weekly cap):</span><span style="color:#ffa500;font-weight:700" id="prizePool">0 TON</span></div></div>
<div style="text-align:center;margin:15px 0">
<button class="btn btn-success" onclick="G.showFullLeaderboard()">üìã –ü–æ–ª–Ω—ã–π –õ–∏–¥–µ—Ä–±–æ—Ä–¥</button>
</div>
<div id="leaderboard"></div>
</div>

<div class="nav">
<div class="ni active" onclick="G.showScreen('village')"><div class="nic">üèòÔ∏è</div><div class="nil">–î–µ—Ä–µ–≤–Ω—è</div></div>
<div class="ni" onclick="G.showScreen('mine')"><div class="nic">‚õèÔ∏è</div><div class="nil">–®–∞—Ö—Ç–∞</div></div>
<div class="ni" onclick="G.showScreen('market')"><div class="nic">üè™</div><div class="nil">–ú–∞—Ä–∫–µ—Ç</div></div>
<div class="ni" onclick="G.showScreen('tasks')"><div class="nic">üìã</div><div class="nil">–ó–∞–¥–∞–Ω–∏—è</div></div>
<div class="ni" onclick="G.showScreen('profile')"><div class="nic">üë§</div><div class="nil">–ü—Ä–æ—Ñ–∏–ª—å</div></div>
</div>
</div>

<div id="buildingModal" class="modal"><div class="mc"><button class="mcl" onclick="G.closeM('buildingModal')">√ó</button><div class="mt" id="bmt">–ü–æ—Å—Ç—Ä–æ–π–∫–∞</div><div id="bmc"></div></div></div>
<div id="mergeModal" class="modal"><div class="mc"><button class="mcl" onclick="G.closeM('mergeModal')">√ó</button><div class="mt">üîÆ –°–ª–∏—è–Ω–∏–µ –†–µ–ª–∏–∫–≤–∏–π</div><div id="mmc"></div></div></div>
<div id="invModal" class="modal"><div class="mc"><button class="mcl" onclick="G.closeM('invModal')">√ó</button><div class="mt" id="invmt">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</div><div id="invmc"></div></div></div>
<div id="txModal" class="modal"><div class="mc"><button class="mcl" onclick="G.closeM('txModal')">√ó</button><div class="mt" id="txmt">–ü–æ–∫—É–ø–∫–∞</div><div id="txmc"></div></div></div>
<div id="leaderboardModal" class="modal"><div class="mc"><button class="mcl" onclick="G.closeM('leaderboardModal')">√ó</button><div class="mt">üèÜ –ü–æ–ª–Ω—ã–π –õ–∏–¥–µ—Ä–±–æ—Ä–¥</div><div id="lbmc"></div></div></div>
<div id="rewardModal" class="modal"><div class="mc"><button class="mcl" onclick="G.closeM('rewardModal')">√ó</button><div class="mt" id="rwmt">–ù–∞–≥—Ä–∞–¥–∞!</div><div id="rwmc"></div></div></div>
<div id="helpModal" class="modal"><div class="mc" style="max-width:520px"><button class="mcl" onclick="G.closeM('helpModal')">√ó</button><div class="mt">üìñ –û–±—É—á–µ–Ω–∏–µ</div><div id="helpmc"></div></div></div>

<div id="notif" class="notif"></div>

<script>
const G={
d:{
gems:0,coins:1000,wood:100,stone:100,era:1,eraStart:Date.now(),vLevel:1,skyFall:false,skyStart:null,lossMult:1,buildings:[],mineBlocks:[],relicsFound:0,relics:[],amulets:[],buffs:[],digsLeft:5,lastCheckin:null,
exp:0,level:0,createdAt:Date.now(),actions:0,weekId:null,weeklyScore:0,withdrawsThisWeek:0,lock:{active:false,amount:0,until:0},kyc:{verified:false},sellDay:null,sellsToday:0,
walletBound:false,walletVerifyCode:null,subscribedChannels:{phxpw:false,ludoman:false,kriptobratv:false},points:0,eraMedals:[],mineHintIndices:[],mineScanActive:false,phoenixEyeActive:false,
burnedCount:0,letters:[],phoenixQuestCompleted:false
},
PHOENIX_WORD:'–§–ï–ù–ò–ö–°',
RUS_ALPHABET:'–ê–ë–í–ì–î–ï–Å–ñ–ó–ò–ô–ö–õ–ú–ù–û–ü–†–°–¢–£–§–•–¶–ß–®–©–™–´–¨–≠–Æ–Ø',
tonWallet:'UQD6RieTjAKQckERVNlCtSlGOgdfsmCAgLI2abAVz_tl3nuz',
walletBindAmountTON:0.1,
subsChannels:[
{id:'phxpw',name:'PHOENIX PHXPW',url:'https://t.me/PHXPW',reward:{gems:5,points:50}},
{id:'ludoman',name:'THE1000LUDOMAN',url:'https://t.me/ludoman_1000',reward:{gems:5,points:50}},
{id:'kriptobratv',name:'CHIP GROOP',url:'https://t.me/kriptobratv',reward:{gems:5,points:50}}
],
gemsCosts:{digs5:10,checkinNow:15,hint:5,fullScan:15,phoenixEye:25,exp100:20},
POINTS_PER_TON:10,
pointsPerCoin:10,
myPlayerId:null,
API_BASE:(typeof window.GAME_API_BASE!=='undefined'?window.GAME_API_BASE:''),
allPlayers:[],

raritySystem:{
epic:{name:'–≠–ø–∏—á–µ—Å–∫–∏–π',color:'#9b59b6',chance:0.01,items:[]},
magic:{name:'–ú–∞–≥–∏—á–µ—Å–∫–∏–π',color:'#3498db',chance:0.05,items:[]},
tsy:{name:'–¶—ã',color:'#2ecc71',chance:0.15,items:[]},
yan:{name:'–Ø–Ω—å',color:'#f39c12',chance:0.25,items:[]},
yin:{name:'–ò–Ω—å',color:'#7f8c8d',chance:0.30,items:[]},
fire:{name:'–ê–ª—ã–π –û–≥–æ–Ω—å',color:'#ff4500',chance:0.24,items:[]}
},

buildingTypes:{
townhall:{n:'–†–∞—Ç—É—à–∞',i:'üèõÔ∏è',inc:0,c:{wood:50,stone:50,coins:100}},
house:{n:'–î–æ–º',i:'üè†',inc:5,c:{wood:20,stone:10,coins:50}},
farm:{n:'–§–µ—Ä–º–∞',i:'üåæ',inc:3,c:{wood:30,stone:15,coins:75}},
lumbermill:{n:'–õ–µ—Å–æ–ø–∏–ª–∫–∞',i:'ü™µ',inc:2,c:{wood:25,stone:20,coins:100}},
quarry:{n:'–ö–∞–º–µ–Ω–æ–ª–æ–º–Ω—è',i:'ü™®',inc:2,c:{wood:20,stone:25,coins:100}},
market:{n:'–†—ã–Ω–æ–∫',i:'üè™',inc:10,c:{wood:40,stone:30,coins:200}},
temple:{n:'–•—Ä–∞–º',i:'‚õ™',inc:0,c:{wood:50,stone:50,coins:300}},
barracks:{n:'–ö–∞–∑–∞—Ä–º—ã',i:'‚öîÔ∏è',inc:0,c:{wood:60,stone:40,coins:250}},
workshop:{n:'–ú–∞—Å—Ç–µ—Ä—Å–∫–∞—è',i:'üî®',inc:8,c:{wood:35,stone:35,coins:150}},
tavern:{n:'–¢–∞–≤–µ—Ä–Ω–∞',i:'üç∫',inc:12,c:{wood:30,stone:20,coins:180}}
},

selectedMerge:[],

economy:{
levels:{
0:{name:'–ù–æ–≤–∏—á–æ–∫',canWithdraw:false,sell:{tax:0.25,perDay:2,maxValue:80}},
1:{name:'–£—á–µ–Ω–∏–∫',canWithdraw:false,sell:{tax:0.20,perDay:4,maxValue:150}},
2:{name:'–û–ø—ã—Ç–Ω—ã–π',canWithdraw:false,sell:{tax:0.15,perDay:7,maxValue:300}},
3:{name:'–í–µ—Ç–µ—Ä–∞–Ω',canWithdraw:true,sell:{tax:0.12,perDay:10,maxValue:800}}
},
withdraw:{perUserCapTON:5,globalCapTON:50,minAmountTON:0.5,kycUsdThreshold:100,firstLockTON:10,firstLockDays:14},
scoring:{relicWeight:120,villageWeight:80,actionWeight:1,expWeight:2},
prize:{playerPaymentsShare:0.60,marketShare:0.40,projectCapShareOfNet:0.10}
},

getWeekId(ts=Date.now()){
const d=new Date(ts);
const target=new Date(d.valueOf());
const day=(d.getDay()+6)%7;
target.setDate(target.getDate()-day+3);
const firstThu=new Date(target.getFullYear(),0,4);
const firstDay=(firstThu.getDay()+6)%7;
firstThu.setDate(firstThu.getDate()-firstDay+3);
const week=Math.round((target-firstThu)/604800000)+1;
return `${target.getFullYear()}-${String(week).padStart(2,'0')}`;
},

ensureWeek(){
const w=this.getWeekId();
if(this.d.weekId!==w){
this.d.weekId=w;
this.d.withdrawsThisWeek=0;
}
},

addExp(x){
this.ensureWeek();
this.d.exp=(this.d.exp||0)+x;
const e=this.d.exp;
this.d.level=(e>=2500)?3:(e>=1200)?2:(e>=400)?1:0;
},

calcWeeklyScore(){
const s=this.economy.scoring;
const relics=this.d.relicsFound||0;
const village=this.d.vLevel||1;
const actions=this.d.actions||0;
const exp=this.d.exp||0;
return Math.floor(relics*s.relicWeight+village*s.villageWeight+actions*s.actionWeight+exp*s.expWeight);
},

canWithdrawTON(amountTON){
this.ensureWeek();
const lvl=this.d.level||0;
const rules=this.economy.withdraw;
const checks={levelOk:lvl>=3,amountMin:amountTON>=rules.minAmountTON,perUserCap:amountTON<=rules.perUserCapTON,weeklyCount:(this.d.withdrawsThisWeek||0)<1,lockOk:!this.d.lock?.active||Date.now()>=this.d.lock.until};
const ok=Object.values(checks).every(Boolean);
return {ok,checks};
},

startFirstLockIfNeeded(){
const rules=this.economy.withdraw;
if(!this.d.lock||!this.d.lock.active){
this.d.lock={active:true,amount:rules.firstLockTON,until:Date.now()+rules.firstLockDays*24*60*60*1000};
}
},

renderSubsTasks(){
const el=document.getElementById('subsTasksList');
if(!el)return;
let h='';
this.subsChannels.forEach(ch=>{
const done=!!this.d.subscribedChannels[ch.id];
h+=`<div class="info" style="margin-bottom:8px"><div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px"><div><a href="${ch.url}" target="_blank" rel="noopener" style="color:#ffa500;font-weight:700">${ch.name}</a><div style="font-size:11px;opacity:.8">–ù–∞–≥—Ä–∞–¥–∞: ${ch.reward.gems} üíé, ${ch.reward.points} –ø–æ–∏–Ω—Ç–æ–≤</div></div><button class="btn btn-small ${done?'btn-success':''}" ${done?'disabled':''} onclick="G.openChannelAndVerify('${ch.id}')">${done?'‚úì –í—ã–ø–æ–ª–Ω–µ–Ω–æ':'–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è'}</button><button class="btn btn-small" onclick="G.verifySubscription('${ch.id}')" style="margin-left:4px">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button></div></div>`;
});
el.innerHTML=h||'<div style="opacity:.7">–ù–µ—Ç –∑–∞–¥–∞–Ω–∏–π</div>';
},

openChannelAndVerify(chId){
const ch=this.subsChannels.find(c=>c.id===chId);
if(!ch)return;
if(window.Telegram&&window.Telegram.WebApp&&window.Telegram.WebApp.openTelegramLink){
window.Telegram.WebApp.openTelegramLink(ch.url);
}else{
window.open(ch.url,'_blank');
}
this.notify('–ü–æ–¥–ø–∏—à–∏—Ç–µ—Å—å –Ω–∞ –∫–∞–Ω–∞–ª, –∑–∞—Ç–µ–º –Ω–∞–∂–º–∏—Ç–µ ¬´–ü—Ä–æ–≤–µ—Ä–∏—Ç—å¬ª');
},

verifySubscription(chId){
const ch=this.subsChannels.find(c=>c.id===chId);
if(!ch)return;
if(this.d.subscribedChannels[ch.id]){ this.notify('–£–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ'); return; }
this.notify('–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏... (–Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ)');
setTimeout(()=>{
this.d.subscribedChannels[ch.id]=true;
this.d.gems=(this.d.gems||0)+ch.reward.gems;
this.d.points=(this.d.points||0)+ch.reward.points;
this.notify(`–ü–æ–¥–ø–∏—Å–∫–∞ –∑–∞—Å—á–∏—Ç–∞–Ω–∞! +${ch.reward.gems} üíé, +${ch.reward.points} –ø–æ–∏–Ω—Ç–æ–≤`);
this.renderSubsTasks();
this.updateUI();
this.save();
},1500);
},

getWalletBindUrl(){
const code='VE_'+(this.myPlayerId||this.d.playerId||Date.now());
this.d.walletVerifyCode=code;
const amountNano=Math.floor(this.walletBindAmountTON*1e9);
return `ton://transfer/${this.tonWallet}?amount=${amountNano}&text=${encodeURIComponent(code)}`;
},

openWalletBind(){
const url=this.getWalletBindUrl();
if(window.Telegram&&window.Telegram.WebApp&&window.Telegram.WebApp.openLink){
window.Telegram.WebApp.openLink(url);
}else{
window.location.href=url;
}
this.notify('–û—Ç–∫—Ä–æ–π—Ç–µ TON Keeper, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—É–º–º—É 0.1 TON –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π, –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–µ—Ä–µ–≤–æ–¥. –ó–∞—Ç–µ–º –Ω–∞–∂–º–∏—Ç–µ ¬´–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∏–≤—è–∑–∫—É¬ª.');
},

updateWalletBindUI(){
const st=document.getElementById('walletBindStatus');
const btn=document.getElementById('walletBindBtn');
if(st) st.textContent=this.d.walletBound?'‚úÖ –ö–æ—à–µ–ª—ë–∫ –ø—Ä–∏–≤—è–∑–∞–Ω':'–ö–æ—à–µ–ª—ë–∫ –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω';
if(btn) btn.style.display=this.d.walletBound?'none':'block';
},

verifyWalletBind(){
this.notify('–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø—Ä–∏–≤—è–∑–∫–∏... (–≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ). –†–µ–∞–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ.');
},

init(){
const done=()=>{
this.initTG();
this.initRaritySystem();
if(this.d.buildings.length===0)this.d.buildings.push({t:'townhall',lv:1,last:Date.now()});
this.newMine();
this.initPlayers();
this.updateUI();
this.startTimers();
};
if(this.API_BASE){
this.loadGame().then(done).catch(()=>done());
}else{
this.loadGame();
done();
}
},

initTG(){
if(window.Telegram?.WebApp){
const tg=window.Telegram.WebApp;
tg.ready();tg.expand();
const u=tg.initDataUnsafe?.user;
if(u){
const n=u.first_name||'–ò–≥—Ä–æ–∫';
this.myPlayerId=u.id||Math.floor(Math.random()*1000000);
document.getElementById('playerName').textContent=n;
document.getElementById('profileName').textContent=n;
}else{
this.myPlayerId=Math.floor(Math.random()*1000000);
}
}else{
this.myPlayerId=Math.floor(Math.random()*1000000);
}
},

initRaritySystem(){
this.raritySystem.epic.items=[
{id:'ruling_amulet',n:'–ê–º—É–ª–µ—Ç –ü—Ä–∞–≤–ª–µ–Ω–∏—è',i:'üëë',type:'amulet',e:'immunity',ton:10},
{id:'immortal_amulet',n:'–ë–µ—Å—Å–º–µ—Ä—Ç–∏–µ',i:'üí´',type:'amulet',e:'no_loss',ton:12},
{id:'phoenix_relic',n:'–§–µ–Ω–∏–∫—Å –í–æ–∑—Ä–æ–∂–¥–µ–Ω–∏—è',i:'üî¥',type:'relic',ev:500}
];

this.raritySystem.magic.items=[
{id:'freeze_amulet',n:'–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –í—Ä–µ–º–µ–Ω–∏',i:'‚è∏Ô∏è',type:'amulet',e:'freeze',ton:8},
{id:'prosperity_amulet',n:'–ü—Ä–æ—Ü–≤–µ—Ç–∞–Ω–∏–µ',i:'üí∞',type:'amulet',e:'income_x3',ton:5},
{id:'fortune_amulet',n:'–£–¥–∞—á–∞',i:'üçÄ',type:'amulet',e:'relic_x2',ton:4},
{id:'dragon_relic',n:'–î—Ä–∞–∫–æ–Ω –°–∏–ª—ã',i:'üü£',type:'relic',ev:300},
{id:'titan_relic',n:'–¢–∏—Ç–∞–Ω –ú–æ—â–∏',i:'üü£',type:'relic',ev:280},
{id:'wisdom_relic',n:'–ú—É–¥—Ä–æ—Å—Ç—å –í–µ–∫–æ–≤',i:'üü£',type:'relic',ev:250},
{id:'eternal_relic',n:'–í–µ—á–Ω–æ—Å—Ç—å',i:'üü£',type:'relic',ev:270}
];

const tsyNames=['–ò–∑—É–º—Ä—É–¥','–°–∞–ø—Ñ–∏—Ä','–†—É–±–∏–Ω','–¢–æ–ø–∞–∑','–ê–º–µ—Ç–∏—Å—Ç','–û–ø–∞–ª','–ñ–µ–º—á—É–≥','–Ø–Ω—Ç–∞—Ä—å','–ö–æ—Ä–∞–ª–ª','–û–±—Å–∏–¥–∏–∞–Ω','–ö–≤–∞—Ä—Ü','–õ—É–Ω–Ω—ã–π –ö–∞–º–µ–Ω—å','–ê–≥–∞—Ç','–û–Ω–∏–∫—Å','–¢—É—Ä–º–∞–ª–∏–Ω','–ù–µ—Ñ—Ä–∏—Ç','–Ø—à–º–∞','–ú–∞–ª–∞—Ö–∏—Ç','–ì—Ä–∞–Ω–∞—Ç','–¶–∏—Ç—Ä–∏–Ω','–ë–µ—Ä–∏–ª–ª','–ê–ª–µ–∫—Å–∞–Ω–¥—Ä–∏—Ç','–ü–µ—Ä–∏–¥–æ—Ç','–ê–∫–≤–∞–º–∞—Ä–∏–Ω','–¢–∞–Ω–∑–∞–Ω–∏—Ç','–®–ø–∏–Ω–µ–ª—å','–¶–∏—Ä–∫–æ–Ω','–¢–æ–ø–∞–∑','–†–æ–¥–æ–ª–∏—Ç','–¢—É—Ä–º–∞–ª–∏–Ω'];
tsyNames.forEach((n,i)=>{
this.raritySystem.tsy.items.push({id:`tsy${i}`,n:`–ö–∞–º–µ–Ω—å ${n}`,i:'üü¢',type:'relic',ev:100+Math.floor(Math.random()*100)});
});

const yanNames=['–°–æ–ª–Ω—Ü–µ','–õ—É–Ω–∞','–ó–≤–µ–∑–¥–∞','–ö–æ–º–µ—Ç–∞','–ó–∞—Ä—è','–ó–∞–∫–∞—Ç','–†–∞—Å—Å–≤–µ—Ç','–ü–æ–ª–¥–µ–Ω—å','–ü–æ–ª–Ω–æ—á—å','–°—É–º–µ—Ä–∫–∏'];
yanNames.forEach((n,i)=>{
this.raritySystem.yan.items.push({id:`yan${i}`,n:`${n} –í–æ—Å—Ç–æ–∫–∞`,i:'üü°',type:'relic',ev:50+Math.floor(Math.random()*70)});
});

const yinNames=['–¢–µ–Ω—å','–¢—É–º–∞–Ω','–î—ã–º','–ú–≥–ª–∞','–ü–µ–ø–µ–ª','–ü—Ä–∞—Ö','–°–∞–∂–∞','–£–≥–æ–ª—å','–ü—ã–ª—å','–ü–µ—Å–æ–∫','–í–µ—Ç–µ—Ä','–î–æ–∂–¥—å','–°–Ω–µ–≥','–õ–µ–¥','–ì—Ä–∞–¥'];
yinNames.forEach((n,i)=>{
this.raritySystem.yin.items.push({id:`yin${i}`,n:`${n} –ó–∞–ø–∞–¥–∞`,i:'‚ö´',type:'relic',ev:30+Math.floor(Math.random()*50)});
});

const fireNames=['–ü–ª–∞–º—è','–ò—Å–∫—Ä–∞','–ñ–∞—Ä','–ó–Ω–æ–π','–¢–µ–ø–ª–æ','–û–≥–æ–Ω—å','–í—Å–ø—ã—à–∫–∞','–í–∑—Ä—ã–≤','–§–∞–∫–µ–ª','–ö–æ—Å—Ç–µ—Ä','–ü–æ–∂–∞—Ä','–ì–æ—Ä–µ–Ω–∏–µ','–ñ–∞—Ä–∞','–£–≥–ª–∏','–õ–∞–≤–∞','–ú–∞–≥–º–∞','–í—É–ª–∫–∞–Ω','–ü–µ—á—å','–ì–æ—Ä–Ω','–ö—É–∑–Ω—è','–ñ–∞—Ä–æ–≤–Ω—è','–û—á–∞–≥'];
fireNames.forEach((n,i)=>{
this.raritySystem.fire.items.push({id:`fire${i}`,n:`${n} –Æ–≥–∞`,i:'üî•',type:'relic',ev:20+Math.floor(Math.random()*40)});
});
},

initPlayers(){
const names=['–î—Ä–∞–∫–æ–Ω','–§–µ–Ω–∏–∫—Å','–¢–∏—Ç–∞–Ω','–í–æ–∏–Ω','–ú–∞–≥','–†—ã—Ü–∞—Ä—å','–û—Ö–æ—Ç–Ω–∏–∫','–°—Ç—Ä–∞–Ω–Ω–∏–∫','–ì–µ—Ä–æ–π','–õ–µ–≥–µ–Ω–¥–∞'];
this.allPlayers=[];
for(let i=0;i<150;i++){
this.allPlayers.push({
id:1000+i,
name:names[Math.floor(Math.random()*names.length)]+Math.floor(Math.random()*1000),
score:Math.floor(Math.random()*10000)+500,
relics:Math.floor(Math.random()*50),
coins:Math.floor(Math.random()*50000)+1000,
level:Math.floor(Math.random()*10)+1,
online:Math.random()>.7
});
}
this.ensureWeek();
this.allPlayers.push({
id:this.myPlayerId,
name:document.getElementById('playerName').textContent,
score:this.calcWeeklyScore(),
relics:this.d.relicsFound,
coins:this.d.coins,
level:this.d.vLevel,
online:true
});
this.allPlayers.sort((a,b)=>b.score-a.score);
},

updateOnlineCount(){
const online=this.allPlayers.filter(p=>p.online).length;
document.getElementById('onlineCount').textContent=online;
},

renderVillage(){
const g=document.getElementById('villageGrid');
g.innerHTML='';
let ti=0,te=0;
this.d.buildings.forEach((b,idx)=>{
const t=this.buildingTypes[b.t];
const c=document.createElement('div');
c.className='card';
if(this.d.skyFall)c.classList.add('dmg');
const inc=t.inc*b.lv;
let di='';
if(this.d.skyFall){
const l=Math.floor(inc*this.d.lossMult);
te+=l;
di=`<div class="loss">-${l}/—á</div>`;
}else if(inc>0){
ti+=inc;
di=`<div class="inc">+${inc}/—á</div>`;
}
c.innerHTML=`<div class="ic">${t.i}</div><div class="nm">${t.n}</div><div class="lv">–£—Ä. ${b.lv}/10</div>${di}`;
c.onclick=()=>this.showBuild(idx);
g.appendChild(c);
});
for(let i=this.d.buildings.length;i<9;i++){
const c=document.createElement('div');
c.className='card';
c.style.opacity='0.5';
c.innerHTML='<div class="ic">‚ûï</div><div class="nm">–ù–æ–≤–∞—è</div>';
c.onclick=()=>this.showNew();
g.appendChild(c);
}
document.getElementById('totalIncome').textContent=`+${ti} ü™ô`;
document.getElementById('totalExpenses').textContent=`-${te} ü™ô`;
},

showBuild(idx){
const b=this.d.buildings[idx];
const t=this.buildingTypes[b.t];
const uc=this.getUpgCost(b);
const can=b.lv<10&&this.d.wood>=uc.wood&&this.d.stone>=uc.stone&&this.d.coins>=uc.coins;
let h=`<div class="info"><div class="ir"><span>–£—Ä–æ–≤–µ–Ω—å:</span><span>${b.lv}/10</span></div><div class="ir"><span>–î–æ—Ö–æ–¥:</span><span style="color:#ff8c00">+${t.inc*b.lv}/—á</span></div>`;
if(b.lv<10){
h+=`<div class="ir"><span>–°–ª–µ–¥. —É—Ä.:</span><span style="color:#ffa500">+${t.inc*(b.lv+1)}/—á</span></div><div style="margin-top:15px"><strong>–°—Ç–æ–∏–º–æ—Å—Ç—å:</strong><div style="margin-top:8px">ü™µ ${uc.wood} | ü™® ${uc.stone} | ü™ô ${uc.coins}</div></div>`;
}
h+=`</div>`;
if(b.lv<10){
h+=`<div style="text-align:center;margin-top:15px"><button class="btn btn-success" ${!can?'disabled':''} onclick="G.upgBuild(${idx})">‚¨ÜÔ∏è –î–æ —É—Ä–æ–≤–Ω—è ${b.lv+1}</button></div>`;
}
if(b.t!=='townhall'){
h+=`<div style="text-align:center;margin-top:10px"><button class="btn btn-danger btn-small" onclick="G.demoBuild(${idx})">üóëÔ∏è –°–Ω–µ—Å—Ç–∏</button></div>`;
}
document.getElementById('bmt').textContent=t.n;
document.getElementById('bmc').innerHTML=h;
this.openM('buildingModal');
},

getUpgCost(b){
const t=this.buildingTypes[b.t];
const m=Math.pow(1.5,b.lv);
return{wood:Math.floor(t.c.wood*m),stone:Math.floor(t.c.stone*m),coins:Math.floor(t.c.coins*m)};
},

upgBuild(idx){
this.d.actions++;this.addExp(15);
const b=this.d.buildings[idx];
const c=this.getUpgCost(b);
if(this.d.wood>=c.wood&&this.d.stone>=c.stone&&this.d.coins>=c.coins){
this.d.wood-=c.wood;this.d.stone-=c.stone;this.d.coins-=c.coins;b.lv++;
this.notify(`${this.buildingTypes[b.t].n} —É–ª—É—á—à–µ–Ω–∞ –¥–æ ${b.lv}!`);
this.closeM('buildingModal');this.renderVillage();this.updateUI();this.save();
}else this.notify('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ!','error');
},

demoBuild(idx){
if(confirm('–°–Ω–µ—Å—Ç–∏?')){
const b=this.d.buildings[idx];
const c=this.getUpgCost(b);
this.d.wood+=Math.floor(c.wood*.5);this.d.stone+=Math.floor(c.stone*.5);this.d.coins+=Math.floor(c.coins*.3);
this.d.buildings.splice(idx,1);
this.notify('–°–Ω–µ—Å–µ–Ω–æ. –†–µ—Å—É—Ä—Å—ã –≤–æ–∑–≤—Ä–∞—â–µ–Ω—ã.');
this.closeM('buildingModal');this.renderVillage();this.updateUI();this.save();
}
},

showNew(){
let h='<div style="max-height:400px;overflow-y:auto">';
Object.entries(this.buildingTypes).forEach(([k,t])=>{
if(k==='townhall')return;
const can=this.d.wood>=t.c.wood&&this.d.stone>=t.c.stone&&this.d.coins>=t.c.coins;
h+=`<div class="info" style="margin-bottom:10px"><div style="display:flex;align-items:center;gap:15px;margin-bottom:10px"><div style="font-size:40px">${t.i}</div><div style="flex:1"><strong>${t.n}</strong><div style="font-size:12px;opacity:.8">+${t.inc}/—á</div></div></div><div style="font-size:12px;margin-bottom:8px">ü™µ ${t.c.wood} | ü™® ${t.c.stone} | ü™ô ${t.c.coins}</div><button class="btn btn-success btn-small" ${!can?'disabled':''} onclick="G.buildNew('${k}')">–ü–æ—Å—Ç—Ä–æ–∏—Ç—å</button></div>`;
});
h+='</div>';
document.getElementById('bmt').textContent='–ù–æ–≤–∞—è –ø–æ—Å—Ç—Ä–æ–π–∫–∞';
document.getElementById('bmc').innerHTML=h;
this.openM('buildingModal');
},

buildNew(t){
this.d.actions++;this.addExp(20);
const bt=this.buildingTypes[t];
const c=bt.c;
if(this.d.wood>=c.wood&&this.d.stone>=c.stone&&this.d.coins>=c.coins){
this.d.wood-=c.wood;this.d.stone-=c.stone;this.d.coins-=c.coins;
this.d.buildings.push({t:t,lv:1,last:Date.now()});
this.notify(`${bt.n} –ø–æ—Å—Ç—Ä–æ–µ–Ω–∞!`);
this.closeM('buildingModal');this.renderVillage();this.updateUI();this.save();
}else this.notify('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ!','error');
},

collectResources(){
this.d.actions++;this.addExp(5);
const now=Date.now();
let col={coins:0};
this.d.buildings.forEach(b=>{
const t=this.buildingTypes[b.t];
const h=(now-b.last)/(1000*60*60);
const inc=t.inc*b.lv*h;
if(this.d.skyFall){
const l=Math.floor(inc*this.d.lossMult);
this.d.coins=Math.max(0,this.d.coins-l);
}else{
col.coins+=Math.floor(inc);
}
b.last=now;
});
if(!this.d.skyFall){
this.d.coins+=col.coins;
this.notify(`–°–æ–±—Ä–∞–Ω–æ: ü™ô${col.coins}`);
}else this.notify('–í–æ –≤—Ä–µ–º—è –ü–∞–¥–µ–Ω–∏—è –Ω–µ–ª—å–∑—è —Å–æ–±–∏—Ä–∞—Ç—å!','error');
this.updateUI();this.save();
},

newMine(){
this.d.mineHintIndices=[];
this.d.mineScanActive=false;
this.d.phoenixEyeActive=false;
this.d.mineBlocks=[];
const sz=36;
const prizeCount=Math.max(1,Math.floor(sz*0.05));
const prizeIndices=[];
while(prizeIndices.length<prizeCount){
const idx=Math.floor(Math.random()*sz);
if(!prizeIndices.includes(idx))prizeIndices.push(idx);
}
for(let i=0;i<sz;i++){
if(prizeIndices.includes(i)){
const rarity=this.rollRarity();
this.d.mineBlocks.push({cl:false,rarity:rarity,reward:this.getReward(rarity),hasPrize:true});
}else{
this.d.mineBlocks.push({cl:false,rarity:'empty',reward:{type:'empty'},hasPrize:false});
}
}
this.renderMine();
},

rollRarity(){
const rand=Math.random();
let cumulative=0;
for(const[key,data]of Object.entries(this.raritySystem)){
cumulative+=data.chance;
if(rand<=cumulative)return key;
}
return 'fire';
},

getReward(rarity){
if(rarity==='empty')return{type:'empty'};
const items=this.raritySystem[rarity].items;
if(items.length===0)return{type:'coins',amount:Math.floor(Math.random()*50)+10};
const item=items[Math.floor(Math.random()*items.length)];
return{...item,rarity:rarity};
},

renderMine(){
const g=document.getElementById('mineGrid');
if(!g)return;
g.innerHTML='';
const hintIdx=this.d.mineHintIndices||[];
const scan=!!this.d.mineScanActive;
const eye=!!this.d.phoenixEyeActive;
this.d.mineBlocks.forEach((b,idx)=>{
const c=document.createElement('div');
c.className='mb';
if(b.cl){
c.classList.add('clr');
if(b.hasPrize){
c.classList.add(b.rarity);
if(b.reward.type==='relic'||b.reward.type==='amulet'){
c.textContent='‚ú®';
}else{
c.textContent='üí∞';
}
}else{
c.textContent='‚ùå';
c.style.opacity='0.5';
}
}else{
if(this.d.digsLeft<=0){
c.classList.add('locked');
c.textContent='üîí';
}else{
c.onclick=()=>this.dig(idx);
if(hintIdx.indexOf(idx)>=0){
c.textContent='?';
c.style.fontSize='22px';
c.style.color='#ffa500';
c.style.fontWeight='bold';
c.classList.add(b.rarity);
}else if(eye&&b.hasPrize){
if(b.reward.type==='relic'||b.reward.type==='amulet') c.textContent='‚ú®';
else c.textContent='üí∞';
c.classList.add(b.rarity);
c.style.opacity='0.95';
}else if(scan&&b.hasPrize){
c.textContent='‚Ä¢';
c.style.fontSize='24px';
c.style.color='#ffd700';
}else{
c.textContent='‚õ∞Ô∏è';
}
}
}
g.appendChild(c);
});
document.getElementById('digsLeft').textContent=this.d.digsLeft;
const rf=document.getElementById('relicsFound');
if(rf) rf.textContent=this.d.relicsFound;
},

buyDigsForGems(){
const cost=this.gemsCosts.digs5;
if((this.d.gems||0)<cost){ this.notify('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫—Ä–∏—Å—Ç–∞–ª–ª–æ–≤','error'); return; }
this.d.gems-=cost;
this.d.digsLeft=(this.d.digsLeft||0)+5;
this.notify('+5 –ø–æ–ø—ã—Ç–æ–∫ –∫–æ–ø–∞–Ω–∏—è!');
this.updateUI(); this.renderMine(); this.save();
},

reduceCheckinForGems(){
const cost=this.gemsCosts.checkinNow;
if((this.d.gems||0)<cost){ this.notify('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫—Ä–∏—Å—Ç–∞–ª–ª–æ–≤','error'); return; }
this.d.gems-=cost;
this.d.lastCheckin=null;
this.notify('–ß–µ–∫–∏–Ω –¥–æ—Å—Ç—É–ø–µ–Ω! –ù–∞–∂–º–∏—Ç–µ ¬´–ü–û–õ–£–ß–ò–¢–¨ –ü–û–ü–´–¢–ö–ò¬ª');
this.updateCheckinUI(); this.updateUI(); this.save();
},

buyMineHint(){
const cost=this.gemsCosts.hint;
if((this.d.gems||0)<cost){ this.notify('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫—Ä–∏—Å—Ç–∞–ª–ª–æ–≤','error'); return; }
const hintIdx=this.d.mineHintIndices||[];
const prizeIdx=[];
this.d.mineBlocks.forEach((b,i)=>{ if(!b.cl&&b.hasPrize&&hintIdx.indexOf(i)<0) prizeIdx.push(i); });
if(prizeIdx.length===0){ this.notify('–í—Å–µ –ø—Ä–∏–∑–æ–≤—ã–µ —è—á–µ–π–∫–∏ —É–∂–µ –æ—Ç–º–µ—á–µ–Ω—ã –ø–æ–¥—Å–∫–∞–∑–∫–∞–º–∏ –∏–ª–∏ –ø—Ä–∏–∑–æ–≤ –Ω–µ—Ç.','error'); return; }
this.d.gems-=cost;
this.d.mineHintIndices=this.d.mineHintIndices||[];
this.d.mineHintIndices.push(prizeIdx[Math.floor(Math.random()*prizeIdx.length)]);
this.notify('–ü–æ–¥—Å–∫–∞–∑–∫–∞: –æ–¥–Ω–∞ —è—á–µ–π–∫–∞ —Å –ø—Ä–∏–∑–æ–º –æ—Ç–º–µ—á–µ–Ω–∞ ¬´?¬ª');
this.updateUI(); this.renderMine(); this.save();
},

buyFullScan(){
const cost=this.gemsCosts.fullScan;
if((this.d.gems||0)<cost){ this.notify('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫—Ä–∏—Å—Ç–∞–ª–ª–æ–≤','error'); return; }
this.d.gems-=cost;
this.d.mineScanActive=true;
this.notify('–ü–æ–ª–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ: —è—á–µ–π–∫–∏ —Å –ø—Ä–∏–∑–∞–º–∏ –æ—Ç–º–µ—á–µ–Ω—ã —Ç–æ—á–∫–æ–π');
this.updateUI(); this.renderMine(); this.save();
},

buyPhoenixEye(){
const cost=this.gemsCosts.phoenixEye;
if((this.d.gems||0)<cost){ this.notify('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫—Ä–∏—Å—Ç–∞–ª–ª–æ–≤','error'); return; }
this.d.gems-=cost;
this.d.phoenixEyeActive=true;
this.notify('–§–µ–Ω–∏–∫—Å –ì–ª–∞–∑: –≤–∏–¥–Ω—ã —Ç–∏–ø—ã –ø—Ä–∏–∑–æ–≤. –ù–µ –ø–æ–Ω—Ä–∞–≤–∏–ª–æ—Å—å ‚Äî –æ–±–Ω–æ–≤–∏—Ç–µ —à–∞—Ö—Ç—É.');
this.updateUI(); this.renderMine(); this.save();
},

buyExpForGems(){
const cost=this.gemsCosts.exp100||20;
if((this.d.gems||0)<cost){ this.notify('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫—Ä–∏—Å—Ç–∞–ª–ª–æ–≤','error'); return; }
this.d.gems-=cost;
this.addExp(100);
this.notify('+100 –æ–ø—ã—Ç–∞!');
this.updateUI(); this.save();
},

dig(idx){
const b=this.d.mineBlocks[idx];
if(b.cl)return;
if(this.d.digsLeft<=0){
this.notify('–ù–µ—Ç –ø–æ–ø—ã—Ç–æ–∫! –ü–æ–ª—É—á–∏—Ç–µ –∏—Ö –≤ –∑–∞–¥–∞–Ω–∏—è—Ö —á–µ—Ä–µ–∑ —á–µ–∫–∏–Ω.','error');
return;
}
this.d.digsLeft--;
this.d.actions++;this.addExp(10);
b.cl=true;
if(!b.hasPrize){
this.notify('–ü—É—Å—Ç–æ... üòî');
this.renderMine();
this.updateUI();
this.save();
return;
}
const rw=b.reward;
if(rw.type==='amulet'){
this.d.amulets.push({...rw,obt:Date.now()});
this.showReward(rw,b.rarity);
}else if(rw.type==='relic'){
this.d.relics.push({...rw,id:`ri${Date.now()}_${Math.random()}`});
this.d.relicsFound++;
this.showReward(rw,b.rarity);
}else if(rw.type==='coins'){
this.d.coins+=rw.amount||50;
this.notify(`üí∞ +${rw.amount||50} ü™ô`);
}
this.renderMine();
this.updateUI();this.save();
},

showReward(rw,rarity){
const rd=this.raritySystem[rarity];
document.getElementById('rwmt').textContent='üéâ –ù–∞–≥—Ä–∞–¥–∞!';
let h=`<div style="text-align:center"><div style="font-size:80px;margin-bottom:15px">${rw.i}</div><h2 style="color:${rd.color}">${rw.n}</h2><div style="background:${rd.color};color:#fff;padding:5px 15px;border-radius:20px;display:inline-block;margin:15px 0;font-weight:700">${rd.name}</div></div>`;
if(rw.type==='amulet'){
h+=`<div class="info"><p style="text-align:center">–ê–º—É–ª–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å!</p></div>`;
}else if(rw.type==='relic'){
h+=`<div class="info"><p style="text-align:center">–†–µ–ª–∏–∫–≤–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å!<br>–≠—Ñ—Ñ–µ–∫—Ç: +${rw.ev}%</p></div>`;
}
h+=`<div style="text-align:center;margin-top:20px"><button class="btn btn-success btn-big" onclick="G.closeM('rewardModal')">–û—Ç–ª–∏—á–Ω–æ!</button></div>`;
document.getElementById('rwmc').innerHTML=h;
this.openM('rewardModal');
},

doCheckin(){
const now=Date.now();
if(this.d.lastCheckin){
const elapsed=now-this.d.lastCheckin;
const tenHours=10*60*60*1000;
if(elapsed<tenHours){
const left=tenHours-elapsed;
const h=Math.floor(left/(60*60*1000));
const m=Math.floor((left%(60*60*1000))/(60*1000));
this.notify(`–ü–æ–¥–æ–∂–¥–∏—Ç–µ ${h}—á ${m}–º –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —á–µ–∫–∏–Ω–∞`,'error');
return;
}
}
this.d.actions++;this.addExp(10);
this.d.digsLeft=5;
this.d.lastCheckin=now;
this.notify('‚úÖ –ü–æ–ª—É—á–µ–Ω–æ 5 –ø–æ–ø—ã—Ç–æ–∫ –∫–æ–ø–∞–Ω–∏—è!');
this.updateCheckinUI();
this.renderMine();
this.save();
},

updateCheckinUI(){
const btn=document.getElementById('checkinBtn');
const timer=document.getElementById('checkinTimer');
document.getElementById('checkinDigs').textContent=this.d.digsLeft;
if(!this.d.lastCheckin){
btn.disabled=false;
timer.textContent='–î–æ—Å—Ç—É–ø–Ω–æ —Å–µ–π—á–∞—Å!';
return;
}
const now=Date.now();
const elapsed=now-this.d.lastCheckin;
const tenHours=10*60*60*1000;
if(elapsed>=tenHours){
btn.disabled=false;
timer.textContent='–î–æ—Å—Ç—É–ø–Ω–æ —Å–µ–π—á–∞—Å!';
}else{
btn.disabled=true;
const left=tenHours-elapsed;
const h=Math.floor(left/(60*60*1000));
const m=Math.floor((left%(60*60*1000))/(60*1000));
const s=Math.floor((left%(60*1000))/1000);
timer.textContent=`–°–ª–µ–¥—É—é—â–∏–π —á–µ—Ä–µ–∑: ${h}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
}
const myIdx=this.allPlayers.findIndex(p=>p.id===this.myPlayerId);
document.getElementById('myRank').textContent=myIdx>=0?(myIdx+1):'-';
document.getElementById('totalPlayers').textContent=this.allPlayers.length;
},

updateDigsTimer(){
if(!this.d.lastCheckin){
document.getElementById('digsTimer').textContent='–ì–æ—Ç–æ–≤–æ!';
return;
}
const now=Date.now();
const elapsed=now-this.d.lastCheckin;
const tenHours=10*60*60*1000;
if(elapsed<tenHours){
const left=tenHours-elapsed;
const h=Math.floor(left/(60*60*1000));
const m=Math.floor((left%(60*60*1000))/(60*1000));
const s=Math.floor((left%(60*1000))/1000);
document.getElementById('digsTimer').textContent=`${h}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
}else{
document.getElementById('digsTimer').textContent='–ì–æ—Ç–æ–≤–æ!';
}
},

switchTab(t){
['Relics','Amulets','Diamonds'].forEach(x=>{
document.getElementById('market'+x).style.display='none';
document.getElementById('tab'+x).className='btn';
});
document.getElementById('market'+t.charAt(0).toUpperCase()+t.slice(1)).style.display='block';
document.getElementById('tab'+t.charAt(0).toUpperCase()+t.slice(1)).className='btn btn-success';
if(t==='relics')this.renderMarketRelics();
if(t==='amulets')this.renderMarketAmulets();
if(t==='diamonds')this.renderMarketDiamonds();
},

renderMarketRelics(){
const l=document.getElementById('marketRelicsList');
l.innerHTML='';
if(this.d.relics.length===0){
l.innerHTML='<div class="info" style="text-align:center;opacity:.7">–£ –≤–∞—Å –Ω–µ—Ç —Ä–µ–ª–∏–∫–≤–∏–π –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏</div>';
return;
}
const groups={};
this.d.relics.forEach((r,idx)=>{
const key=`${r.n}|${r.ev}|${r.rarity||'fire'}`;
if(!groups[key]) groups[key]={r,indices:[]};
groups[key].indices.push(idx);
});
Object.keys(groups).forEach(key=>{
const g=groups[key];
const r=g.r;
const firstIdx=g.indices[0];
const qty=g.indices.length;
const p=r.ev*10||100;
const pPts=Math.ceil(p/10);
const c=document.createElement('div');
c.className='rc';
c.style.borderColor=this.raritySystem[r.rarity||'fire'].color;
c.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><div><span style="font-size:20px;margin-right:8px">${r.i}</span><span style="color:#ffa500;font-weight:700">${r.n}</span></div></div><div style="font-size:12px;opacity:.9;margin-bottom:6px">–≠—Ñ—Ñ–µ–∫—Ç: +${r.ev}%</div>${qty>1?`<div class="inv-qty">√ó ${qty}</div>`:''}<div style="font-size:11px;opacity:.85;margin-bottom:4px">${p} ü™ô (${pPts} ‚≠ê –ø–æ–∏–Ω—Ç–æ–≤)</div><div style="display:flex;gap:5px;margin-top:8px"><button class="btn btn-small btn-success" onclick="G.sellR(${firstIdx})">–ü—Ä–æ–¥–∞—Ç—å –∑–∞ ${p}ü™ô</button><button class="btn btn-small btn-warning" onclick="G.showMerge()">–°–ª–∏—è–Ω–∏–µ</button></div>`;
l.appendChild(c);
});
},

renderMarketAmulets(){
const l=document.getElementById('marketAmuletsList');
l.innerHTML='';
const amulets=[];
Object.values(this.raritySystem).forEach(r=>{
r.items.forEach(item=>{
if(item.type==='amulet')amulets.push(item);
});
});
amulets.forEach((a)=>{
const c=document.createElement('div');
c.className='info';
c.style.marginBottom='10px';
c.innerHTML=`<div style="display:flex;align-items:center;gap:15px;margin-bottom:10px"><div style="font-size:50px">${a.i}</div><div style="flex:1"><strong style="color:#ffa500">${a.n}</strong><div style="font-size:12px;opacity:.8;margin-top:5px">–≠—Ñ—Ñ–µ–∫—Ç: ${a.e}</div></div></div><div style="display:flex;justify-content:space-between;align-items:center"><div style="font-size:18px;color:#ffa500;font-weight:700">${a.ton} TON</div><button class="btn btn-warning btn-small" onclick="G.buyAmulet('${a.id}')">–ö—É–ø–∏—Ç—å</button></div>`;
l.appendChild(c);
});
},

renderMarketDiamonds(){
const l=document.getElementById('marketDiamondsList');
l.innerHTML='';
const packs=[
{gems:100,ton:10,bonus:0},
{gems:500,ton:45,bonus:50},
{gems:1000,ton:85,bonus:150},
{gems:5000,ton:400,bonus:1000}
];
const ptsPerTon=this.POINTS_PER_TON;
packs.forEach((pk,idx)=>{
const pts=Math.ceil(pk.ton*ptsPerTon);
const c=document.createElement('div');
c.className='info';
c.style.marginBottom='15px';
c.innerHTML=`<div style="text-align:center"><div style="font-size:60px;margin-bottom:10px">üíé</div><div style="font-size:24px;font-weight:700;color:#ffa500;margin-bottom:5px">${pk.gems} ${pk.bonus?'+'+pk.bonus:''} –ê–ª–º–∞–∑–æ–≤</div>${pk.bonus?`<div style="font-size:12px;color:#ff8c00;margin-bottom:10px">üéÅ –ë–æ–Ω—É—Å: +${pk.bonus}</div>`:`<div style="margin-bottom:10px"></div>`}<div style="font-size:20px;color:#ffa500;font-weight:700;margin-bottom:8px">${pk.ton} TON</div><div style="font-size:14px;opacity:.9;margin-bottom:12px">–∏–ª–∏ ${pts} ‚≠ê –ø–æ–∏–Ω—Ç–æ–≤</div><button class="btn btn-warning" onclick="G.buyDiamonds(${idx})">–ö—É–ø–∏—Ç—å TON</button> <button class="btn btn-success" onclick="G.buyDiamondsForPoints(${idx})">–ö—É–ø–∏—Ç—å –∑–∞ –ø–æ–∏–Ω—Ç—ã</button></div>`;
l.appendChild(c);
});
},

buyDiamondsForPoints(idx){
const packs=[{gems:100,ton:10,bonus:0},{gems:500,ton:45,bonus:50},{gems:1000,ton:85,bonus:150},{gems:5000,ton:400,bonus:1000}];
const pk=packs[idx];
const ptsNeed=Math.ceil(pk.ton*this.POINTS_PER_TON);
if((this.d.points||0)<ptsNeed){ this.notify('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø–æ–∏–Ω—Ç–æ–≤','error'); return; }
this.d.points-=ptsNeed;
this.d.gems+=pk.gems+(pk.bonus||0);
this.notify(`–ö—É–ø–ª–µ–Ω–æ ${pk.gems}+${pk.bonus||0} üíé –∑–∞ ${ptsNeed} –ø–æ–∏–Ω—Ç–æ–≤!`);
this.updateUI(); this.save();
},

buyAmulet(id){
const amulets=[];
Object.values(this.raritySystem).forEach(r=>{
r.items.forEach(item=>{
if(item.type==='amulet')amulets.push(item);
});
});
const a=amulets.find(x=>x.id===id);
this.showTxModal({type:'amulet',item:a,amount:a.ton});
},

buyDiamonds(idx){
const packs=[
{gems:100,ton:10,bonus:0},
{gems:500,ton:45,bonus:50},
{gems:1000,ton:85,bonus:150},
{gems:5000,ton:400,bonus:1000}
];
const pk=packs[idx];
this.showTxModal({type:'diamonds',item:pk,amount:pk.ton});
},

showTxModal(data){
document.getElementById('txmt').textContent=data.type==='amulet'?'–ö—É–ø–∏—Ç—å –ê–º—É–ª–µ—Ç':'–ö—É–ø–∏—Ç—å –ê–ª–º–∞–∑—ã';
const txid=`${Date.now()}_${Math.random().toString(36).substr(2,9)}`;
let h=`<div class="info"><div style="text-align:center;margin-bottom:15px">`;
if(data.type==='amulet'){
h+=`<div style="font-size:60px;margin-bottom:10px">${data.item.i}</div><div style="font-size:20px;font-weight:700;color:#ffa500;margin-bottom:10px">${data.item.n}</div>`;
}else{
h+=`<div style="font-size:60px;margin-bottom:10px">üíé</div><div style="font-size:20px;font-weight:700;color:#ffa500;margin-bottom:10px">${data.item.gems}${data.item.bonus?' +'+data.item.bonus:''} –ê–ª–º–∞–∑–æ–≤</div>`;
}
h+=`</div><div class="ir"><span>–°—Ç–æ–∏–º–æ—Å—Ç—å:</span><span style="color:#ffa500;font-weight:700">${data.amount} TON</span></div></div>`;
h+=`<div style="margin:20px 0"><div style="font-size:14px;font-weight:700;margin-bottom:10px;color:#ffa500">–ê–¥—Ä–µ—Å –∫–æ—à–µ–ª—å–∫–∞:</div><input type="text" class="tx-input" value="${this.tonWallet}" readonly onclick="this.select()"><div style="font-size:12px;opacity:.7;margin-top:5px">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è</div></div>`;
h+=`<div style="margin:20px 0"><div style="font-size:14px;font-weight:700;margin-bottom:10px;color:#ffa500">ID —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (–≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π):</div><input type="text" class="tx-input" value="${txid}" readonly onclick="this.select()"><div style="font-size:12px;opacity:.7;margin-top:5px">–£–∫–∞–∂–∏—Ç–µ —ç—Ç–æ—Ç ID –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∫ –ø–µ—Ä–µ–≤–æ–¥—É</div></div>`;
h+=`<div style="text-align:center;margin-top:20px"><div style="font-size:12px;opacity:.8;margin-bottom:15px">–ü–æ—Å–ª–µ –ø–µ—Ä–µ–≤–æ–¥–∞ –Ω–∞–∂–º–∏—Ç–µ "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å"</div><button class="btn btn-warning btn-big" onclick='G.checkTx("${txid}",${JSON.stringify(data).replace(/"/g,"&quot;")})'>–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é</button></div>`;
document.getElementById('txmc').innerHTML=h;
this.openM('txModal');
},

checkTx(txid,data){
this.notify('–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏... (–≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ). –†–µ–∞–ª—å–Ω—ã–µ –≤—ã–ø–ª–∞—Ç—ã –Ω–µ –ø—Ä–æ–∏–∑–≤–æ–¥—è—Ç—Å—è.','error');
},

sellR(idx){
const lvl=this.d.level||0;
const sell=this.economy.levels[lvl].sell;
const today=new Date().toDateString();
if(this.d.sellDay!==today){ this.d.sellDay=today; this.d.sellsToday=0; }
this.d.sellsToday=this.d.sellsToday||0;
const r=this.d.relics[idx];
const raw=r.ev*10||100;
if(this.d.sellsToday>=sell.perDay){
this.notify('–õ–∏–º–∏—Ç –ø—Ä–æ–¥–∞–∂ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è –∏—Å—á–µ—Ä–ø–∞–Ω.','error');return;
}
if(raw>sell.maxValue){
this.notify('–≠—Ç–∞ –ø—Ä–æ–¥–∞–∂–∞ –ø—Ä–µ–≤—ã—à–∞–µ—Ç –ª–∏–º–∏—Ç –ø–æ —É—Ä–æ–≤–Ω—é.','error');return;
}
const tax=Math.floor(raw*sell.tax);
const net=Math.max(0,raw-tax);
if(confirm(`–ü—Ä–æ–¥–∞—Ç—å ${r.n} –∑–∞ ${raw} ü™ô? –ù–∞–ª–æ–≥: ${tax} ü™ô, –ø–æ–ª—É—á–∏—Ç–µ: ${net} ü™ô`)){
this.d.coins+=net;
this.d.relics.splice(idx,1);
this.d.sellsToday++;
this.addExp(20);
this.notify(`–ü—Ä–æ–¥–∞–Ω–æ: +${net} ü™ô (–Ω–∞–ª–æ–≥ ${tax})`);
this.switchTab('relics');
this.updateUI();this.save();
}
},

openWithdraw(){
const lvl=this.d.level||0;
if(lvl<3){ this.notify('–í—ã–≤–æ–¥ –¥–æ—Å—Ç—É–ø–µ–Ω —Å —É—Ä–æ–≤–Ω—è L3.','error'); return; }
const max=this.economy.withdraw.perUserCapTON;
const h=`<div class="info">
<div class="ir"><span>–í–∞—à —É—Ä–æ–≤–µ–Ω—å:</span><span>${this.economy.levels[lvl].name} (L${lvl})</span></div>
<div class="ir"><span>–õ–∏–º–∏—Ç/–Ω–µ–¥–µ–ª—é:</span><span>${max} TON</span></div>
<div class="ir"><span>–í—ã–≤–æ–¥–æ–≤ –Ω–∞ –Ω–µ–¥–µ–ª–µ:</span><span>${this.d.withdrawsThisWeek||0}/1</span></div>
</div>
<div style="margin:15px 0">
<div style="font-size:14px;font-weight:700;color:#ffa500;margin-bottom:10px">–°—É–º–º–∞ (TON):</div>
<input id="wdAmt" class="tx-input" type="number" min="0.5" step="0.1" value="0.5">
<button class="btn btn-warning btn-big" onclick="G.requestWithdraw()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å</button>
<div style="font-size:12px;opacity:.7;margin-top:10px">–í—ã–¥–∞—á–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç weekly batch. –í –¥–µ–º–æ ‚Äî –±–µ–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö –≤—ã–ø–ª–∞—Ç.</div>
</div>`;
document.getElementById('txmt').textContent='Withdraw (demo)';
document.getElementById('txmc').innerHTML=h;
this.openM('txModal');
},

requestWithdraw(){
const amt=parseFloat(document.getElementById('wdAmt').value||'0');
const res=this.canWithdrawTON(amt);
if(!res.ok){
this.notify('–í—ã–≤–æ–¥ –æ—Ç–∫–ª–æ–Ω—ë–Ω: –ø—Ä–æ–≤–µ—Ä—å —É—Å–ª–æ–≤–∏—è.','error');
return;
}
if(!(this.d.lock&&this.d.lock.active)){
this.startFirstLockIfNeeded();
this.notify('–ó–∞–ø—Ä–æ—Å –ø—Ä–∏–Ω—è—Ç. –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω lock 10 TON –Ω–∞ 14 –¥–Ω–µ–π (demo).','error');
}else{
this.notify('–ó–∞–ø—Ä–æ—Å –ø—Ä–∏–Ω—è—Ç –≤ weekly batch (demo).');
}
this.d.withdrawsThisWeek=(this.d.withdrawsThisWeek||0)+1;
this.addExp(50);
this.closeM('txModal');
this.save();
},

showMerge(){
if(this.d.relics.length<2){this.notify('–ù—É–∂–Ω–æ 2+ —Ä–µ–ª–∏–∫–≤–∏–∏!','error');return}
let h='<div class="info"><p style="text-align:center;margin-bottom:15px">–í—ã–±–µ—Ä–∏—Ç–µ 2-3 —Ä–µ–ª–∏–∫–≤–∏–∏. –†–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã—à–µ —Ä–µ–¥–∫–æ—Å—Ç–∏!</p></div><div id="mergeSel"></div><div style="text-align:center;margin-top:15px"><button class="btn btn-warning btn-big" onclick="G.doMerge()">üîÆ –û–±—ä–µ–¥–∏–Ω–∏—Ç—å</button></div>';
document.getElementById('mmc').innerHTML=h;
const sel=document.getElementById('mergeSel');
this.d.relics.forEach((r,idx)=>{
const c=document.createElement('div');
c.className='rc';
c.style.borderColor=this.raritySystem[r.rarity||'fire'].color;
c.style.cursor='pointer';
c.onclick=()=>this.togMerge(idx);
c.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><div><span style="font-size:20px;margin-right:8px">${r.i}</span><span style="color:#ffa500;font-weight:700">${r.n}</span></div></div><div style="font-size:12px">–≠—Ñ—Ñ–µ–∫—Ç: +${r.ev}%</div><div id="mc${idx}" style="text-align:center;margin-top:8px;display:none"><span style="color:#ff8c00;font-size:20px">‚úì –í—ã–±—Ä–∞–Ω–æ</span></div>`;
sel.appendChild(c);
});
this.openM('mergeModal');
},

togMerge(idx){
const ce=document.getElementById(`mc${idx}`);
if(this.selectedMerge.includes(idx)){
this.selectedMerge=this.selectedMerge.filter(i=>i!==idx);
ce.style.display='none';
}else{
if(this.selectedMerge.length<3){
this.selectedMerge.push(idx);
ce.style.display='block';
}else this.notify('–ú–∞–∫—Å 3!','error');
}
},

doMerge(){
this.d.actions++;this.addExp(25);
if(this.selectedMerge.length<2){this.notify('–í—ã–±–µ—Ä–∏—Ç–µ 2+!','error');return}
const sr=this.selectedMerge.map(i=>this.d.relics[i]);
const avgEv=sr.reduce((s,r)=>s+(r.ev||50),0)/sr.length;
const newEv=Math.floor(avgEv*1.5);
const nr={
id:`ri${Date.now()}_${Math.random()}`,
n:'–°–ª–∏—Ç–∞—è –†–µ–ª–∏–∫–≤–∏—è –°–∏–ª—ã',
i:'üîÆ',
ev:newEv,
type:'relic',
rarity:'magic'
};
this.selectedMerge.sort((a,b)=>b-a).forEach(i=>this.d.relics.splice(i,1));
this.d.relics.push(nr);
this.selectedMerge=[];
this.notify(`üéâ –°–æ–∑–¥–∞–Ω–∞ —Ä–µ–ª–∏–∫–≤–∏—è —Å —ç—Ñ—Ñ–µ–∫—Ç–æ–º +${newEv}%!`);
this.closeM('mergeModal');
this.updateUI();this.save();
},

showInvRelics(){
document.getElementById('invmt').textContent='‚ú® –†–µ–ª–∏–∫–≤–∏–∏';
let h='';
if(this.d.relics.length===0){
h='<div class="info" style="text-align:center;opacity:.7">–†–µ–ª–∏–∫–≤–∏–π –Ω–µ—Ç</div>';
}else{
const groups={};
this.d.relics.forEach((r,idx)=>{
const key=`${r.n}|${r.ev}|${r.rarity||'fire'}`;
if(!groups[key]) groups[key]={r,indices:[]};
groups[key].indices.push(idx);
});
Object.keys(groups).forEach(key=>{
const g=groups[key];
const r=g.r;
const firstIdx=g.indices[0];
const qty=g.indices.length;
h+=`<div class="rc" style="margin-bottom:10px;border-color:${this.raritySystem[r.rarity||'fire'].color}"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><div><span style="font-size:20px;margin-right:8px">${r.i}</span><span style="color:#ffa500;font-weight:700">${r.n}</span></div></div><div style="font-size:12px">–≠—Ñ—Ñ–µ–∫—Ç: +${r.ev}%</div>${qty>1?`<div class="inv-qty">√ó ${qty}</div>`:''}<div style="display:flex;gap:5px;margin-top:8px;flex-wrap:wrap"><button class="btn btn-small btn-success" onclick="G.actR(${firstIdx})">–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å</button><button class="btn btn-small btn-danger" onclick="G.burnRelic(${firstIdx})">üî• –°–∂–µ—á—å</button></div></div>`;
});
}
document.getElementById('invmc').innerHTML=h;
this.openM('invModal');
},

showInvAmulets(){
document.getElementById('invmt').textContent='üîÆ –ê–º—É–ª–µ—Ç—ã';
let h='';
if(this.d.amulets.length===0){
h='<div class="info" style="text-align:center;opacity:.7">–ê–º—É–ª–µ—Ç–æ–≤ –Ω–µ—Ç</div>';
}else{
const groups={};
this.d.amulets.forEach((a,idx)=>{
const key=a.id||idx;
if(!groups[key]) groups[key]={a,indices:[]};
groups[key].indices.push(idx);
});
Object.keys(groups).forEach(key=>{
const g=groups[key];
const a=g.a;
const firstIdx=g.indices[0];
const qty=g.indices.length;
h+=`<div class="info" style="margin-bottom:10px"><div style="display:flex;align-items:center;gap:12px;margin-bottom:8px"><div style="font-size:40px">${a.i}</div><div style="flex:1"><strong style="color:#ffa500">${a.n}</strong><div style="font-size:12px;opacity:.8">–≠—Ñ—Ñ–µ–∫—Ç: ${a.e}</div></div></div>${qty>1?`<div class="inv-qty">√ó ${qty}</div>`:''}<button class="btn btn-small btn-success" onclick="G.useAmu(${firstIdx})">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å</button></div>`;
});
}
document.getElementById('invmc').innerHTML=h;
this.openM('invModal');
},

showInvLetters(resetSequence){
if(resetSequence!==false) this.phoenixNextIndex=0;
document.getElementById('invmt').textContent='üî§ –ë—É–∫–≤—ã (–∫–≤–µ—Å—Ç –§–ï–ù–ò–ö–°)';
const letters=this.d.letters||[];
let h='';
if(this.d.phoenixQuestCompleted){
h='<div class="info" style="text-align:center"><div style="font-size:48px;margin-bottom:10px">üî•</div><strong style="color:#ffa500">–ö–≤–µ—Å—Ç ¬´–§–ï–ù–ò–ö–°¬ª —É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω!</strong><div style="font-size:12px;opacity:.9;margin-top:8px">–ù–∞–≥—Ä–∞–¥–∞: 100 000 Phoenix</div></div>';
}else{
h='<div class="info" style="margin-bottom:12px;font-size:13px">–ö–ª–∏–∫–Ω–∏—Ç–µ –ø–æ –±—É–∫–≤–∞–º –ø–æ –æ—á–µ—Ä–µ–¥–∏: <strong>–§</strong> ‚Üí <strong>–ï</strong> ‚Üí <strong>–ù</strong> ‚Üí <strong>–ò</strong> ‚Üí <strong>–ö</strong> ‚Üí <strong>–°</strong>. –°–æ–±–µ—Ä–∏—Ç–µ —Å–ª–æ–≤–æ ‚Äî –ø–æ–ª—É—á–∏—Ç–µ 100 000 Phoenix!</div>';
h+='<div style="margin-bottom:10px;font-size:14px;color:#ff8c00">–°–ª–µ–¥—É—é—â–∞—è –±—É–∫–≤–∞: <span id="phoenixNextLetter">–§</span></div>';
h+='<div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:15px">';
letters.forEach((ltr,i)=>{
h+=`<button type="button" class="btn btn-small" style="min-width:44px;font-size:18px" onclick="G.letterClickForPhoenix('${ltr}',${i})">${ltr}</button>`;
});
h+='</div>';
}
document.getElementById('invmc').innerHTML=h;
this.openM('invModal');
},

letterClickForPhoenix(letter,letterIdx){
if(this.d.phoenixQuestCompleted){ this.notify('–ö–≤–µ—Å—Ç —É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω'); return; }
const now=Date.now();
if(this._lastLetterClickAt&&(now-this._lastLetterClickAt)<1500){ this.notify('–ü–æ–¥–æ–∂–¥–∏—Ç–µ —Å–µ–∫—É–Ω–¥—É','error'); return; }
this._lastLetterClickAt=now;
const next=this.PHOENIX_WORD[this.phoenixNextIndex||0];
if(letter!==next){
this.phoenixNextIndex=0;
this.notify('–ù–µ —Ç–∞ –±—É–∫–≤–∞. –ù–∞—á–Ω–∏—Ç–µ —Å –§.','error');
const el=document.getElementById('phoenixNextLetter');
if(el) el.textContent='–§';
return;
}
this.d.letters=this.d.letters||[];
if(letterIdx>=0&&letterIdx<this.d.letters.length) this.d.letters.splice(letterIdx,1);
this.phoenixNextIndex=(this.phoenixNextIndex||0)+1;
const nextEl=document.getElementById('phoenixNextLetter');
if(nextEl) nextEl.textContent=this.phoenixNextIndex<6?this.PHOENIX_WORD[this.phoenixNextIndex]:'‚úì';
if(this.phoenixNextIndex>=6){
this.completePhoenixQuest();
return;
}
this.notify('–í–µ—Ä–Ω–æ! –°–ª–µ–¥—É—é—â–∞—è: '+this.PHOENIX_WORD[this.phoenixNextIndex]);
this.showInvLetters(false);
},

async completePhoenixQuest(){
this.phoenixNextIndex=0;
if(this.API_BASE){
try{
const r=await fetch(this.API_BASE+'/api/game/action',{method:'POST',headers:{'Content-Type':'application/json','X-Telegram-User-Id':String(this.myPlayerId||0)},body:JSON.stringify({action:'phoenix_quest_submit',params:{letters_sequence:'–§–ï–ù–ò–ö–°',username:window.Telegram?.WebApp?.initDataUnsafe?.user?.username||'',first_name:window.Telegram?.WebApp?.initDataUnsafe?.user?.first_name||''}})});
if(r.ok){ const st=await r.json(); Object.keys(st).forEach(k=>{ if(st[k]!==undefined) this.d[k]=st[k]; }); this.d.phoenixQuestCompleted=true; this.notify('üéâ –ö–≤–µ—Å—Ç –§–ï–ù–ò–ö–° –≤—ã–ø–æ–ª–Ω–µ–Ω! –ó–∞—è–≤–∫–∞ –Ω–∞ –Ω–∞–≥—Ä–∞–¥—É —Å–æ–∑–¥–∞–Ω–∞. –ê–¥–º–∏–Ω —É–≤–µ–¥–æ–º–ª—ë–Ω.'); }
else if(r.status===403){ const j=await r.json().catch(()=>({})); this.notify(j.detail||'–ù—É–∂–Ω–æ –±–æ–ª—å—à–µ —Å–∂–∏–≥–∞–Ω–∏–π –∏ –¥–Ω–µ–π –≤ –∏–≥—Ä–µ','error'); return; }
else if(r.status===429){ this.notify('–ü–æ–¥–æ–∂–¥–∏—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥','error'); return; }
else{ this.notify('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞','error'); return; }
}catch(e){ this.notify('–ù–µ—Ç —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º','error'); return; }
}else{
this.d.phoenixQuestCompleted=true;
this.notify('üéâ –ö–≤–µ—Å—Ç –§–ï–ù–ò–ö–° –≤—ã–ø–æ–ª–Ω–µ–Ω! –ù–∞–≥—Ä–∞–¥–∞: 100 000 Phoenix.');
}
this.closeM('invModal');
this.updateUI();
this.save();
},

showInvBuffs(){
document.getElementById('invmt').textContent='‚ö° –ê–∫—Ç–∏–≤–Ω—ã–µ –ë–∞—Ñ—ã';
let h='';
const now=Date.now();
this.d.buffs=this.d.buffs.filter(b=>b.exp>now);
if(this.d.buffs.length===0){
h='<div class="info" style="text-align:center;opacity:.7">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –±–∞—Ñ–æ–≤</div>';
}else{
this.d.buffs.forEach(b=>{
const left=b.exp-now;
const hrs=Math.floor(left/3600000);
const mins=Math.floor((left%3600000)/60000);
h+=`<div class="info" style="margin-bottom:10px"><div style="display:flex;align-items:center;gap:12px"><div style="font-size:40px">${b.r.i}</div><div style="flex:1"><strong style="color:#ffa500">${b.r.n}</strong><div style="font-size:12px;opacity:.8">–≠—Ñ—Ñ–µ–∫—Ç: +${b.r.ev}%</div><div style="font-size:11px;color:#ff8c00;margin-top:5px">–û—Å—Ç–∞–ª–æ—Å—å: ${hrs}—á ${mins}–º</div></div></div></div>`;
});
}
document.getElementById('invmc').innerHTML=h;
this.openM('invModal');
},

actR(idx){
const r=this.d.relics[idx];
this.d.buffs.push({r:r,exp:Date.now()+43200000});
this.notify(`–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞: ${r.n}!`);
this.closeM('invModal');
this.updateUI();
this.save();
},

burnRelic(idx){
const r=this.d.relics[idx];
if(!r){ this.notify('–†–µ–ª–∏–∫–≤–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞','error'); return; }
this.d.relics.splice(idx,1);
let expGain=10+Math.floor((r.ev||0)/2);
this.d.burnedCount=(this.d.burnedCount||0)+1;
if(this.d.burnedCount>50) expGain=Math.floor(expGain*0.5);
this.addExp(expGain);
const letter=this.RUS_ALPHABET[Math.floor(Math.random()*this.RUS_ALPHABET.length)];
this.d.letters=this.d.letters||[];
this.d.letters.push(letter);
this.notify(`–°–æ–∂–∂–µ–Ω–æ! +${expGain} –æ–ø—ã—Ç–∞. –ü–æ–ª—É—á–µ–Ω–∞ –±—É–∫–≤–∞: ${letter}`);
this.closeM('invModal');
this.showInvRelics();
this.updateUI();
this.save();
},

useAmu(idx){
const a=this.d.amulets[idx];
if(a.e==='immunity'){
this.d.skyFall=false;
this.d.skyStart=null;
document.getElementById('skyFallWarning').classList.remove('active');
this.notify('–ò–º–º—É–Ω–∏—Ç–µ—Ç –æ—Ç –ü–∞–¥–µ–Ω–∏—è –ù–µ–±–∞!');
}else if(a.e==='freeze'){
this.notify('–í—Ä–µ–º—è –∑–∞–º–æ—Ä–æ–∂–µ–Ω–æ!');
}else{
this.d.buffs.push({r:{...a,en:a.n,ev:100,i:a.i},exp:Date.now()+43200000});
this.notify(`–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω: ${a.n}!`);
}
this.d.amulets.splice(idx,1);
this.closeM('invModal');
this.updateUI();this.save();
},

initLeaderboard(){
this.allPlayers.sort((a,b)=>b.score-a.score);
const l=document.getElementById('leaderboard');
l.innerHTML='';
const top=this.allPlayers.slice(0,10);
top.forEach((p,i)=>{
const d=document.createElement('div');
d.className='lb';
if(p.id===this.myPlayerId)d.classList.add('me');
let rc='';
if(i===0)rc='gold';else if(i===1)rc='silver';else if(i===2)rc='bronze';
d.innerHTML=`<div class="rank ${rc}">${i+1}</div>${p.online?'<div class="online-dot" style="width:8px;height:8px"></div>':''}<div style="flex:1"><div style="font-weight:700;color:#ffa500">${p.name}</div><div style="font-size:12px;opacity:.8">–£—Ä.${p.level} ‚Ä¢ ${p.score} –æ—á–∫–æ–≤</div></div>`;
l.appendChild(d);
});
},

showFullLeaderboard(){
const lb=this.allPlayers;
let h='<div style="max-height:500px;overflow-y:auto">';
lb.forEach((p,i)=>{
const d=document.createElement('div');
d.className='lb';
if(p.id===this.myPlayerId)d.classList.add('me');
let rc='';
if(i===0)rc='gold';else if(i===1)rc='silver';else if(i===2)rc='bronze';
d.innerHTML=`<div class="rank ${rc}">${i+1}</div>${p.online?'<div class="online-dot" style="width:6px;height:6px"></div>':''}<div style="flex:1"><div style="font-weight:700;color:#ffa500">${p.name}</div><div style="font-size:11px;opacity:.8">–†–µ–ª–∏–∫–≤–∏–π: ${p.relics} | –ú–æ–Ω–µ—Ç: ${p.coins} | –£—Ä: ${p.level}</div></div>`;
h+=d.outerHTML;
});
h+='</div>';
document.getElementById('lbmc').innerHTML=h;
this.openM('leaderboardModal');
},

showScreen(s){
document.querySelectorAll('.screen').forEach(x=>x.classList.remove('active'));
document.querySelectorAll('.ni').forEach(x=>x.classList.remove('active'));
document.getElementById(s+'Screen').classList.add('active');
event.currentTarget.classList.add('active');
if(s==='village')this.renderVillage();
if(s==='mine')this.renderMine();
if(s==='market')this.switchTab('relics');
if(s==='tasks'){ this.updateCheckinUI(); this.renderSubsTasks(); this.updateWalletBindUI(); }
if(s==='profile')this.renderProfile();
if(s==='rating')this.initLeaderboard();
},

renderProfile(){
document.getElementById('profileCoins').textContent=this.d.coins;
document.getElementById('profileGems').textContent=this.d.gems;
document.getElementById('profileRelics').textContent=this.d.relicsFound;
document.getElementById('profileEra').textContent=this.d.era;
document.getElementById('profileLevel').textContent=this.d.vLevel;
const pe=document.getElementById('profilePoints');
if(pe) pe.textContent=this.d.points||0;
document.getElementById('invRelics').textContent=this.d.relics.length;
document.getElementById('invAmulets').textContent=this.d.amulets.length;
const lettersEl=document.getElementById('invLetters');
if(lettersEl) lettersEl.textContent=(this.d.letters||[]).length;
const now=Date.now();
this.d.buffs=this.d.buffs.filter(b=>b.exp>now);
document.getElementById('invBuffs').textContent=this.d.buffs.length;
const myIdx=this.allPlayers.findIndex(p=>p.id===this.myPlayerId);
document.getElementById('invRank').textContent=myIdx>=0?(myIdx+1):'-';
const medalsEl=document.getElementById('profileEraMedals');
if(medalsEl){
const arr=this.d.eraMedals||[];
medalsEl.textContent=arr.length?('–≠—Ä–∞ '+arr.sort((a,b)=>a-b).join(', –≠—Ä–∞ ')):'–ü–æ–∫–∞ –Ω–µ—Ç';
}
const burnMedalEl=document.getElementById('profileBurnMedal');
if(burnMedalEl){
const bc=this.d.burnedCount||0;
burnMedalEl.innerHTML=bc>0?('üî• <strong>–í–µ—á–Ω–æ –≤ –ü–ª–∞–º–µ–Ω–∏</strong>: '+bc+' —Å–æ–∂–∂–µ–Ω–æ'):'';
}
},

exportSBT(){
this.notify('–í—ã–≤–æ–¥ –º–µ–¥–∞–ª–µ–π –Ω–∞ –∫–æ—à–µ–ª—ë–∫ (SBT) ‚Äî –ø–æ–¥–∫–ª—é—á–∏—Ç–µ –∫–Ω–æ–ø–∫—É –≤—ã–≤–æ–¥–∞ –≤ –≤–∞—à–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏.');
},

openM(id){document.getElementById(id).classList.add('active')},
closeM(id){document.getElementById(id).classList.remove('active')},

openHelp(){
const h=`
<div class="help-section"><h4>üìÖ –≠—Ä–∞</h4><p>–ò–≥—Ä–∞ –∏–¥—ë—Ç –ø–æ —ç—Ä–∞–º (–≤—Å–µ–≥–æ 4). –û–¥–Ω–∞ —ç—Ä–∞ –¥–ª–∏—Ç—Å—è –Ω–µ–¥–µ–ª—é. –í –±–ª–æ–∫–µ –ø–æ–¥ —à–∞–ø–∫–æ–π –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è —Ç–µ–∫—É—â–∞—è —ç—Ä–∞ –∏ –≤—Ä–µ–º—è –¥–æ –∫–æ–Ω—Ü–∞. –ü–æ –æ–∫–æ–Ω—á–∞–Ω–∏–∏ —ç—Ä—ã –≤—ã –ø–æ–ª—É—á–∞–µ—Ç–µ –º–µ–¥–∞–ª—å —É—á–∞—Å—Ç–∏—è. –£—Ä–æ–≤–µ–Ω—å –¥–µ—Ä–µ–≤–Ω–∏ —Å—á–∏—Ç–∞–µ—Ç—Å—è –ø–æ –ø–æ—Å—Ç—Ä–æ–π–∫–∞–º.</p></div>
<div class="help-section"><h4>üèòÔ∏è –î–µ—Ä–µ–≤–Ω—è</h4><p>–°—Ç—Ä–æ–π—Ç–µ –∑–¥–∞–Ω–∏—è –∑–∞ ü™ô –º–æ–Ω–µ—Ç—ã, ü™µ –¥–µ—Ä–µ–≤–æ –∏ ü™® –∫–∞–º–µ–Ω—å. –ö–∞–∂–¥–æ–µ –∑–¥–∞–Ω–∏–µ –¥–∞—ë—Ç –¥–æ—Ö–æ–¥ –≤ –º–æ–Ω–µ—Ç–∞—Ö –≤ —á–∞—Å. –ù–∞–∂–∏–º–∞–π—Ç–µ ¬´–°–æ–±—Ä–∞—Ç—å –†–µ—Å—É—Ä—Å—ã¬ª, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–µ –º–æ–Ω–µ—Ç—ã. –†–∞—Ç—É—à–∞ ‚Äî –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è –ø–µ—Ä–≤–∞—è –ø–æ—Å—Ç—Ä–æ–π–∫–∞. –ú–æ–∂–Ω–æ —É–ª—É—á—à–∞—Ç—å –∑–¥–∞–Ω–∏—è –¥–æ 10 —É—Ä–æ–≤–Ω—è.</p></div>
<div class="help-section"><h4>‚õèÔ∏è –®–∞—Ö—Ç–∞</h4><p>–ü–æ–ø—ã—Ç–∫–∏ –∫–æ–ø–∞–Ω–∏—è –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é (—á–µ–∫–∏–Ω –≤ —Ä–∞–∑–¥–µ–ª–µ ¬´–ó–∞–¥–∞–Ω–∏—è¬ª). –í —è—á–µ–π–∫–∞—Ö –º–æ–≥—É—Ç –±—ã—Ç—å —Ä–µ–ª–∏–∫–≤–∏–∏ –∏–ª–∏ –∞–º—É–ª–µ—Ç—ã —Ä–∞–∑–Ω–æ–π —Ä–µ–¥–∫–æ—Å—Ç–∏. –ó–∞ üíé –º–æ–∂–Ω–æ –∫—É–ø–∏—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É (–æ–¥–Ω–∞ —è—á–µ–π–∫–∞ —Å –ø—Ä–∏–∑–æ–º), –ø–æ–ª–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–ª–∏ ¬´–§–µ–Ω–∏–∫—Å –ì–ª–∞–∑¬ª. ¬´–ù–æ–≤–∞—è –®–∞—Ö—Ç–∞¬ª ‚Äî —Å–±—Ä–æ—Å —Å–µ—Ç–∫–∏ –∏ –Ω–æ–≤—ã—Ö –ø—Ä–∏–∑–æ–≤.</p></div>
<div class="help-section"><h4>üè™ –ú–∞—Ä–∫–µ—Ç</h4><p><strong>–†–µ–ª–∏–∫–≤–∏–∏</strong> ‚Äî –ø—Ä–æ–¥–∞–∂–∞ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö —Ä–µ–ª–∏–∫–≤–∏–π –∑–∞ ü™ô (–µ—Å—Ç—å –ª–∏–º–∏—Ç—ã –ø–æ —É—Ä–æ–≤–Ω—é –∏ –Ω–∞–ª–æ–≥). <strong>–ê–º—É–ª–µ—Ç—ã</strong> ‚Äî –ø–æ–∫—É–ø–∫–∞ –∑–∞ TON. <strong>–ê–ª–º–∞–∑—ã</strong> ‚Äî –ø–∞—á–∫–∏ üíé –∑–∞ TON –∏–ª–∏ –∑–∞ ‚≠ê –ø–æ–∏–Ω—Ç—ã (1 TON = 10 –ø–æ–∏–Ω—Ç–æ–≤).</p></div>
<div class="help-section"><h4>üìã –ó–∞–¥–∞–Ω–∏—è</h4><p>–ß–µ–∫–∏–Ω –¥–∞—ë—Ç –ø–æ–ø—ã—Ç–∫–∏ –∫–æ–ø–∞–Ω–∏—è –≤ —à–∞—Ö—Ç–µ. –ü–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ –∫–∞–Ω–∞–ª—ã –¥–∞—é—Ç üíé –∏ –ø–æ–∏–Ω—Ç—ã. –ü—Ä–∏–≤—è–∑–∫–∞ –∫–æ—à–µ–ª—å–∫–∞ ‚Äî —á–µ—Ä–µ–∑ TON-–ø–µ—Ä–µ–≤–æ–¥ —Å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–º.</p></div>
<div class="help-section"><h4>üë§ –ü—Ä–æ—Ñ–∏–ª—å –∏ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å</h4><p>–†–µ–ª–∏–∫–≤–∏–∏ –∏ –∞–º—É–ª–µ—Ç—ã ‚Äî –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ. –†–µ–ª–∏–∫–≤–∏–∏ –º–æ–∂–Ω–æ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å (–±–∞—Ñ), –ø—Ä–æ–¥–∞—Ç—å –≤ –º–∞—Ä–∫–µ—Ç–µ –∏–ª–∏ <strong>—Å–∂–µ—á—å</strong>. –°–∂–∏–≥–∞–Ω–∏–µ –¥–∞—ë—Ç –æ–ø—ã—Ç –∏ –±—É–∫–≤—É –¥–ª—è —Å–∫—Ä—ã—Ç–æ–≥–æ –∫–≤–µ—Å—Ç–∞. –ú–µ–¥–∞–ª—å ¬´–í–µ—á–Ω–æ –≤ –ü–ª–∞–º–µ–Ω–∏¬ª ‚Äî –∑–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–∂–∂—ë–Ω–Ω—ã—Ö. Withdraw (–≤—ã–≤–æ–¥ TON) –¥–æ—Å—Ç—É–ø–µ–Ω —Å —É—Ä–æ–≤–Ω—è –≤–µ—Ç–µ—Ä–∞–Ω–∞, —Ä–∞–∑ –≤ –Ω–µ–¥–µ–ª—é.</p></div>
<div class="help-section"><h4>üî• –°–∂–∏–≥–∞–Ω–∏–µ</h4><p>–í –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ —Ä–µ–ª–∏–∫–≤–∏–π –Ω–∞–∂–º–∏—Ç–µ ¬´–°–∂–µ—á—å¬ª ‚Äî –≤—ã –ø–æ–ª—É—á–∏—Ç–µ –æ–ø—ã—Ç –∏ —Å–ª—É—á–∞–π–Ω—É—é –±—É–∫–≤—É. –ü–æ—Å–ª–µ 50 —Å–∂–∏–≥–∞–Ω–∏–π –æ–ø—ã—Ç –∑–∞ –æ–¥–Ω–æ —Å–∂–∏–≥–∞–Ω–∏–µ —É–º–µ–Ω—å—à–∞–µ—Ç—Å—è –≤–¥–≤–æ–µ. –ë—É–∫–≤—ã –Ω—É–∂–Ω—ã –¥–ª—è –∫–≤–µ—Å—Ç–∞ ¬´–§–ï–ù–ò–ö–°¬ª.</p></div>
<div class="help-section"><h4>üî§ –ö–≤–µ—Å—Ç –§–ï–ù–ò–ö–°</h4><p>–í –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ –æ—Ç–∫—Ä–æ–π—Ç–µ ¬´–ë—É–∫–≤—ã¬ª. –ö–ª–∏–∫–∞–π—Ç–µ –ø–æ –±—É–∫–≤–∞–º —Å—Ç—Ä–æ–≥–æ –ø–æ –ø–æ—Ä—è–¥–∫—É: <strong>–§ ‚Üí –ï ‚Üí –ù ‚Üí –ò ‚Üí –ö ‚Üí –°</strong>. –°–æ–±—Ä–∞–≤ —Å–ª–æ–≤–æ, –≤—ã –ø–æ–ª—É—á–∏—Ç–µ –∑–∞—è–≤–∫—É –Ω–∞ –Ω–∞–≥—Ä–∞–¥—É 100 000 Phoenix (–Ω—É–∂–Ω—ã –º–∏–Ω–∏–º—É–º —Å–∂–∏–≥–∞–Ω–∏–π –∏ –¥–Ω–µ–π –≤ –∏–≥—Ä–µ). –ê–¥–º–∏–Ω –ø–æ–ª—É—á–∏—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ.</p></div>
<div class="help-section"><h4>‚≠ê –ü–æ–∏–Ω—Ç—ã</h4><p>–ü–æ–∏–Ω—Ç—ã –¥–∞—é—Ç –ø–æ–¥–ø–∏—Å–∫–∏ –∏ –∫–≤–µ—Å—Ç—ã. –ò–º–∏ –º–æ–∂–Ω–æ –ø–æ–∫—É–ø–∞—Ç—å –ø–∞—á–∫–∏ –∞–ª–º–∞–∑–æ–≤ –≤ –º–∞—Ä–∫–µ—Ç–µ (—ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç TON –≤ –ø–æ–∏–Ω—Ç–∞—Ö). –û—Ü–µ–Ω–∫–∞ –ø—Ä–æ–¥–∞–∂–∏ —Ä–µ–ª–∏–∫–≤–∏–∏ –≤ –º–∞—Ä–∫–µ—Ç–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∏ –≤ –º–æ–Ω–µ—Ç–∞—Ö, –∏ –≤ –ø–æ–∏–Ω—Ç–∞—Ö.</p></div>
`;
document.getElementById('helpmc').innerHTML=h;
this.openM('helpModal');
},

notify(msg,type=''){
const n=document.getElementById('notif');
n.textContent=msg;
n.className='notif';
if(type)n.classList.add(type);
n.classList.add('show');
setTimeout(()=>n.classList.remove('show'),3000);
},

updateUI(){
document.getElementById('gems').textContent=this.d.gems;
document.getElementById('coins').textContent=this.d.coins;
const pe=document.getElementById('points');
if(pe) pe.textContent=this.d.points||0;
document.getElementById('wood').textContent=this.d.wood;
document.getElementById('stone').textContent=this.d.stone;
document.getElementById('currentEra').textContent=this.d.era;
document.getElementById('villageLevel').textContent=this.d.vLevel;
document.getElementById('lossMultiplier').textContent=this.d.lossMult.toFixed(1)+'x';
this.updateOnlineCount();
const poolEl=document.getElementById('prizePool');
if(poolEl) poolEl.textContent=this.economy.withdraw.globalCapTON+' TON';
},

startTimers(){
setInterval(()=>this.updateCheckinUI(),1000);
setInterval(()=>this.updateDigsTimer(),1000);
setInterval(()=>{
this.allPlayers.forEach(p=>{
if(p.id!==this.myPlayerId&&Math.random()>.95){
p.online=!p.online;
}
});
this.updateOnlineCount();
},5000);
this.updateEraTimer();
setInterval(()=>this.updateEraTimer(),60000);
this.checkSkyFall();
setInterval(()=>this.checkSkyFall(),3600000);
},

updateEraTimer(){
const elapsed=Date.now()-this.d.eraStart;
const week=7*24*60*60*1000;
const left=week-elapsed;
const d=Math.floor(left/(24*60*60*1000));
const h=Math.floor((left%(24*60*60*1000))/(60*60*1000));
document.getElementById('eraTimer').textContent=`${d}–¥ ${h}—á`;
if(left<=0&&this.d.era<4){
this.d.eraMedals=this.d.eraMedals||[];
if(this.d.eraMedals.indexOf(this.d.era)===-1) this.d.eraMedals.push(this.d.era);
this.d.era++;
this.d.eraStart=Date.now();
this.notify('–ù–æ–≤–∞—è –≠—Ä–∞ –Ω–∞—á–∞–ª–∞—Å—å! –ú–µ–¥–∞–ª—å –∑–∞ —É—á–∞—Å—Ç–∏–µ –≤ —ç—Ä–µ –≤—ã–¥–∞–Ω–∞.');
}
},

checkSkyFall(){
const now=new Date();
if(now.getDay()===6&&!this.d.skyFall){
this.d.skyFall=true;
this.d.skyStart=Date.now();
this.d.lossMult=1;
document.getElementById('skyFallWarning').classList.add('active');
this.notify('‚ö†Ô∏è –ü–ê–î–ï–ù–ò–ï –ù–ï–ë–ê –Ω–∞—á–∞–ª–æ—Å—å!','error');
}
if(this.d.skyFall){
const elapsed=(Date.now()-this.d.skyStart)/(60*60*1000);
this.d.lossMult=Math.pow(1.5,Math.floor(elapsed));
this.updateUI();
}
},

save(){
if(this.API_BASE){
fetch(this.API_BASE+'/api/game/action',{method:'POST',headers:{'Content-Type':'application/json','X-Telegram-User-Id':String(this.myPlayerId||0)},body:JSON.stringify({action:'sync',state:this.d,params:{username:window.Telegram?.WebApp?.initDataUnsafe?.user?.username,first_name:window.Telegram?.WebApp?.initDataUnsafe?.user?.first_name}})}).catch(()=>{});
return;
}
localStorage.setItem('villageEra',JSON.stringify(this.d));
},

async loadGame(){
if(!this.API_BASE){
const s=localStorage.getItem('villageEra');
if(s){ const ld=JSON.parse(s); Object.keys(ld).forEach(k=>{ if(ld[k]!==undefined) this.d[k]=ld[k]; }); }
return;
}
try{
const r=await fetch(this.API_BASE+'/api/game/state',{headers:{'X-Telegram-User-Id':String(this.myPlayerId||0)}});
if(r.ok){ const st=await r.json(); Object.keys(st).forEach(k=>{ if(st[k]!==undefined) this.d[k]=st[k]; }); }
}catch(e){ console.warn('API load failed',e); }
}
};
window.onload=()=>G.init();
</script>
</body>
</html>
