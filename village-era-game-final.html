<!DOCTYPE html>
<html lang="ru">
<head>
<!-- build: 2025-02-07 | entry: village-era-game-final.html -->
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–≠—Ä–∞ –ü–ª–µ–º–µ–Ω–∏ - Village Era</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="config.js"></script>
<script>
// –ö–∞—Ç–∞–ª–æ–≥ –ø—Ä–µ–¥–º–µ—Ç–æ–≤ (fallback): –≤—Å–µ–≥–¥–∞ –¥–æ—Å—Ç—É–ø–µ–Ω –∫–∞–∫ window.ITEMS_CATALOG, –µ—Å–ª–∏ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è API/data/items-catalog.json
window.ITEMS_CATALOG=window.ITEMS_CATALOG||[{"key":"fire_01","name":"–ü–ª–∞–º—è –Æ–≥–∞","slot_type":"relic_slot","type":"FIRE","rarity":"FIRE","effect":"+8% –¥–æ—Ö–æ–¥ –î–æ–º–æ–≤"},{"key":"fire_02","name":"–ü–µ–ø–µ–ª –ë–æ–≥–∞—Ç—Å—Ç–≤–∞","slot_type":"relic_slot","type":"FIRE","rarity":"FIRE","effect":"+10% –¥–æ—Ö–æ–¥ –§–µ—Ä–º—ã"},{"key":"fire_03","name":"–ñ–∞—Ä –£—Ä–æ–∂–∞—è","slot_type":"relic_slot","type":"FIRE","rarity":"FIRE","effect":"+8% –¥–æ—Ö–æ–¥ –†—ã–Ω–∫–∞"},{"key":"fire_04","name":"–ú–æ–Ω–µ—Ç–Ω—ã–π –£–≥–æ–ª—å","slot_type":"relic_slot","type":"FIRE","rarity":"FIRE","effect":"+10% wood/stone"},{"key":"fire_05","name":"–ö—Ä–∞—Å–Ω—ã–π –§–∞–∫–µ–ª","slot_type":"relic_slot","type":"FIRE","rarity":"FIRE","effect":"+8% —Ü–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏"},{"key":"fire_06","name":"–ü–ª–∞–º—è –†–µ–º–µ—Å–ª–∞","slot_type":"relic_slot","type":"FIRE","rarity":"FIRE","effect":"‚àí6% —Å—Ç–æ–∏–º–æ—Å—Ç—å –∞–ø–≥—Ä–µ–π–¥–∞"},{"key":"fire_07","name":"–°—É—Ö–æ–π –ñ–∞—Ä","slot_type":"relic_slot","type":"FIRE","rarity":"FIRE","effect":"‚àí6% –≤—Ä–µ–º—è –¥–æ —á–µ–∫–∏–Ω–∞"},{"key":"fire_08","name":"–ñ–∞—Ä –ö–∞–º–Ω—è","slot_type":"relic_slot","type":"FIRE","rarity":"FIRE","effect":"+10% –ª–∏–º–∏—Ç –°–∫–ª–∞–¥–∞/–ö–∞–∑–Ω—ã"},{"key":"yin_01","name":"–¢–µ–Ω—å –ó–∞–ø–∞–¥–∞","slot_type":"relic_slot","type":"YIN","rarity":"YIN","effect":"‚àí8% –ø–æ—Ç–µ—Ä—å –≤ –ü–∞–¥–µ–Ω–∏–µ –Ω–µ–±–∞"},{"key":"yin_02","name":"–¢—É–º–∞–Ω –ó–∞–ø–∞–¥–∞","slot_type":"relic_slot","type":"YIN","rarity":"YIN","effect":"‚àí20% —Å–∏–ª–∞ –≤—Ö–æ–¥—è—â–µ–π –ø–æ—Ä—á–∏"},{"key":"yin_03","name":"–ü–µ—á–∞—Ç—å –°–ø–æ–∫–æ–π—Å—Ç–≤–∏—è","slot_type":"relic_slot","type":"YIN","rarity":"YIN","effect":"1 —Ä–∞–∑/–¥–µ–Ω—å: –∏–≥–Ω–æ—Ä 1 –ø–æ—Ä—á—É"},{"key":"yin_04","name":"–õ—ë–¥ –ë–∞–ª–∞–Ω—Å–∞","slot_type":"relic_slot","type":"YIN","rarity":"YIN","effect":"‚àí2% –ø–æ—Ç–µ—Ä—å –æ—Ç –±–∞–ª–∞–Ω—Å–∞"},{"key":"yin_05","name":"–°—Ç—Ä–∞–∂ –£—Ä–æ–∂–∞—è","slot_type":"relic_slot","type":"YIN","rarity":"YIN","effect":"‚àí10% —É—Ä–æ–Ω –ø–æ—Ä—á–∏ –ø–æ –î–æ–º–∞–º"},{"key":"yin_06","name":"–¢–∏—Ö–∏–π –ö–∞–º–µ–Ω—å","slot_type":"relic_slot","type":"YIN","rarity":"YIN","effect":"‚àí10% —É—Ä–æ–Ω –ø–æ—Ä—á–∏ –ø–æ –§–µ—Ä–º–µ"},{"key":"yin_07","name":"–ü–µ–ª–µ–Ω–∞ –†—ã–Ω–∫–∞","slot_type":"relic_slot","type":"YIN","rarity":"YIN","effect":"‚àí1.5% –Ω–∞–ª–æ–≥ –ø—Ä–æ–¥–∞–∂–∏"},{"key":"yin_08","name":"–ú–æ–ª–∏—Ç–≤–∞ –•—Ä–∞–º–∞","slot_type":"relic_slot","type":"YIN","rarity":"YIN","effect":"‚àí6% —Ä–æ—Å—Ç –ø–æ—Ç–µ—Ä—å"},{"key":"yan_01","name":"–°–æ–ª–Ω—Ü–µ –í–æ—Å—Ç–æ–∫–∞","slot_type":"relic_slot","type":"YAN","rarity":"YAN","effect":"+12% —Å–∏–ª–∞ –ø–æ—Ä—á"},{"key":"yan_02","name":"–õ—É–Ω–∞ –í–æ—Å—Ç–æ–∫–∞","slot_type":"relic_slot","type":"YAN","rarity":"YAN","effect":"+2—á –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–æ—Ä—á–∏"},{"key":"yan_03","name":"–ó–∞—Ç–º–µ–Ω–∏–µ","slot_type":"relic_slot","type":"YAN","rarity":"YAN","effect":"–ü–æ—Ä—á–∞ —Ü–µ–ª–∏: ‚àí6% –¥–æ—Ö–æ–¥"},{"key":"yan_04","name":"–ö–æ–≥–æ—Ç—å –ö—É–∑–Ω–∏—Ü—ã","slot_type":"relic_slot","type":"YAN","rarity":"YAN","effect":"–ü–æ—Ä—á–∞: +3% –ø–æ—Ç–µ—Ä–∏ skyfall"},{"key":"yan_05","name":"–ß–µ—Ä–Ω–∏–ª–∞ –ö–æ–Ω—Ç—Ä–∞–∫—Ç–∞","slot_type":"relic_slot","type":"YAN","rarity":"YAN","effect":"–ü–æ—Ä—á–∞: +1% –Ω–∞–ª–æ–≥"},{"key":"yan_06","name":"–ö—Ä–∏–∫ –í–µ—Ç—Ä–∞","slot_type":"relic_slot","type":"YAN","rarity":"YAN","effect":"‚àí10% resist —Ü–µ–ª–∏"},{"key":"yan_07","name":"–°–≥–ª–∞–∑ –£—Ä–æ–∂–∞—è","slot_type":"relic_slot","type":"YAN","rarity":"YAN","effect":"20% —à–∞–Ω—Å: –±–∞—Ñ —Ü–µ–ª–∏ —Å–ª–∞–±–µ–µ"},{"key":"yan_08","name":"–ö–ª–µ–π–º–æ –ü–æ—Ç–µ—Ä—å","slot_type":"relic_slot","type":"YAN","rarity":"YAN","effect":"+5% –æ—á–∫–∏ –≤ —Ç–æ–ø–µ"},{"key":"tsy_01","name":"–ò–∑—É–º—Ä—É–¥ –í—Ä–µ–º–µ–Ω–∏","slot_type":"relic_slot","type":"TSY","rarity":"TSY","effect":"–∑–∞–º–æ—Ä–æ–∑–∫–∞/–≤—Ä–µ–º—è"},{"key":"tsy_02","name":"–†—É–±–∏–Ω –¢–æ—Ä–≥–∞","slot_type":"relic_slot","type":"TSY","rarity":"TSY","effect":"—Ç–æ—Ä–≥/–ø–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ"},{"key":"tsy_03","name":"–°–∞–ø—Ñ–∏—Ä –°—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏","slot_type":"relic_slot","type":"TSY","rarity":"TSY","effect":"—Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏—è"},{"key":"tsy_04","name":"–Ø–Ω—Ç–∞—Ä—å –õ–µ—Å–∞","slot_type":"relic_slot","type":"TSY","rarity":"TSY","effect":"—Ç–∞–∫—Ç–∏–∫–∞"},{"key":"tsy_05","name":"–û–±—Å–∏–¥–∏–∞–Ω –ö–∞–º–Ω—è","slot_type":"relic_slot","type":"TSY","rarity":"TSY","effect":"—Ç–∞–∫—Ç–∏–∫–∞"},{"key":"tsy_06","name":"–ö–≤–∞—Ä—Ü –û–±–º–µ–Ω–∞","slot_type":"relic_slot","type":"TSY","rarity":"TSY","effect":"–æ–±–º–µ–Ω"},{"key":"tsy_07","name":"–õ–∞–∑—É—Ä—å –°–±—Ä–æ—Å–∞","slot_type":"relic_slot","type":"TSY","rarity":"TSY","effect":"—Å–±—Ä–æ—Å"},{"key":"tsy_08","name":"–¢—É—Ä–º–∞–ª–∏–Ω –†–∏—Å–∫–∞","slot_type":"relic_slot","type":"TSY","rarity":"TSY","effect":"—Ä–∏—Å–∫/–ø—Ä–æ—Ñ–∏—Ç"},{"key":"magic_01","name":"–î—Ä–∞–∫–æ–Ω –°–∏–ª—ã","slot_type":"relic_slot","type":"MAGIC","rarity":"MAGIC","effect":"–∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π"},{"key":"magic_02","name":"–¢–∏—Ç–∞–Ω –ú–æ—â–∏","slot_type":"relic_slot","type":"MAGIC","rarity":"MAGIC","effect":"—É—Å–∏–ª–µ–Ω–∏–µ"},{"key":"magic_03","name":"–ú—É–¥—Ä–æ—Å—Ç—å –í–µ–∫–æ–≤","slot_type":"relic_slot","type":"MAGIC","rarity":"MAGIC","effect":"—É—Å–∏–ª–µ–Ω–∏–µ"},{"key":"magic_04","name":"–í–µ—á–Ω–æ—Å—Ç—å","slot_type":"relic_slot","type":"MAGIC","rarity":"MAGIC","effect":"—É—Å–∏–ª–µ–Ω–∏–µ"},{"key":"magic_05","name":"–ü–µ—á–∞—Ç—å –ú–∞—Å—Ç–µ—Ä–∞","slot_type":"relic_slot","type":"MAGIC","rarity":"MAGIC","effect":"—É—Å–∏–ª–µ–Ω–∏–µ"},{"key":"magic_06","name":"–°–≤–µ—Ç –°–µ–∑–æ–Ω–∞","slot_type":"relic_slot","type":"MAGIC","rarity":"MAGIC","effect":"—É—Å–∏–ª–µ–Ω–∏–µ"},{"key":"epic_01","name":"–§–µ–Ω–∏–∫—Å –í–æ–∑—Ä–æ–∂–¥–µ–Ω–∏—è","slot_type":"relic_slot","type":"EPIC","rarity":"EPIC","effect":"—É–Ω–∏–∫–∞–ª—å–Ω—ã–π (1 –Ω–∞ –∏–≥—Ä–æ–∫–∞)"},{"key":"epic_02","name":"–°–µ—Ä–¥—Ü–µ –ü–µ–ø–ª–∞","slot_type":"relic_slot","type":"EPIC","rarity":"EPIC","effect":"—É–Ω–∏–∫–∞–ª—å–Ω—ã–π"},{"key":"epic_03","name":"–ü–µ—á–∞—Ç—å –°—É–¥—å–±—ã","slot_type":"relic_slot","type":"EPIC","rarity":"EPIC","effect":"—É–Ω–∏–∫–∞–ª—å–Ω—ã–π"},{"key":"epic_04","name":"–ö–ª—è—Ç–≤–∞ –•—Ä–∞–º–∞","slot_type":"relic_slot","type":"EPIC","rarity":"EPIC","effect":"—É–Ω–∏–∫–∞–ª—å–Ω—ã–π"},{"key":"ci_01","name":"–°–¥–≤–∏–≥ –≤—Ä–µ–º–µ–Ω–∏ I","slot_type":"buff","type":"CHECKIN","rarity":"common","effect":"—Å–ª–∞–±—ã–π –±–æ–Ω—É—Å —á–µ–∫–∏–Ω–∞, 6—á"},{"key":"ci_02","name":"–°–¥–≤–∏–≥ –≤—Ä–µ–º–µ–Ω–∏ II","slot_type":"buff","type":"CHECKIN","rarity":"common","effect":"—á–µ–∫–∏–Ω, 6—á"},{"key":"ci_03","name":"–°–¥–≤–∏–≥ –≤—Ä–µ–º–µ–Ω–∏ III","slot_type":"buff","type":"CHECKIN","rarity":"common","effect":"—á–µ–∫–∏–Ω, 6—á"},{"key":"ci_04","name":"–î–æ–ø. –ø–æ–ø—ã—Ç–∫–∞ I","slot_type":"buff","type":"CHECKIN","rarity":"common","effect":"+–ø–æ–ø—ã—Ç–∫–∞ —à–∞—Ö—Ç—ã"},{"key":"ci_05","name":"–î–æ–ø. –ø–æ–ø—ã—Ç–∫–∞ II","slot_type":"buff","type":"CHECKIN","rarity":"rare","effect":"+–ø–æ–ø—ã—Ç–∫–∏, 12—á"},{"key":"ci_06","name":"–í–æ–∑–≤—Ä–∞—Ç –ø–æ–ø—ã—Ç–∫–∏","slot_type":"buff","type":"CHECKIN","rarity":"common","effect":"–≤–æ–∑–≤—Ä–∞—Ç –ø–æ–ø—ã—Ç–∫–∏"},{"key":"ci_07","name":"–ë–µ—Ä–µ–∂–Ω—ã–π –º–∞–π–Ω–∏–Ω–≥","slot_type":"buff","type":"CHECKIN","rarity":"common","effect":"–∑–∞—â–∏—Ç–∞ —à–∞—Ö—Ç—ã"},{"key":"ci_08","name":"–°–∫–∞–Ω–µ—Ä lite","slot_type":"buff","type":"CHECKIN","rarity":"rare","effect":"–ø–æ–¥—Å–∫–∞–∑–∫–∞ —à–∞—Ö—Ç—ã"},{"key":"ci_09","name":"–§–æ–∫—É—Å","slot_type":"buff","type":"CHECKIN","rarity":"rare","effect":"—Ñ–æ–∫—É—Å —à–∞—Ö—Ç—ã"},{"key":"ci_10","name":"–ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–π —á–µ–∫–∏–Ω","slot_type":"buff","type":"CHECKIN","rarity":"magic","effect":"—á–µ–∫–∏–Ω –±–µ–∑ CD, 24—á"},{"key":"df_01","name":"–©–∏—Ç —Ç—É–º–∞–Ω–∞ I","slot_type":"buff","type":"DEFENSE","rarity":"common","effect":"–∑–∞—â–∏—Ç–∞ –æ—Ç –ø–æ—Ä—á–∏, 6—á"},{"key":"df_02","name":"–©–∏—Ç —Ç—É–º–∞–Ω–∞ II","slot_type":"buff","type":"DEFENSE","rarity":"rare","effect":"–∑–∞—â–∏—Ç–∞, 12—á"},{"key":"df_03","name":"–©–∏—Ç —Ç—É–º–∞–Ω–∞ III","slot_type":"buff","type":"DEFENSE","rarity":"magic","effect":"–∑–∞—â–∏—Ç–∞, 24—á"},{"key":"df_04","name":"–ë–∞—Ä—å–µ—Ä I","slot_type":"buff","type":"DEFENSE","rarity":"common","effect":"–±–∞—Ä—å–µ—Ä"},{"key":"df_05","name":"–ë–∞—Ä—å–µ—Ä II","slot_type":"buff","type":"DEFENSE","rarity":"rare","effect":"–±–∞—Ä—å–µ—Ä —Å–∏–ª—å–Ω–µ–µ"},{"key":"df_06","name":"–ö—Ä–µ–ø–æ—Å—Ç—å –≤–µ—Ç—Ä–∞","slot_type":"buff","type":"DEFENSE","rarity":"rare","effect":"–∑–∞—â–∏—Ç–∞"},{"key":"df_07","name":"–°–µ–π—Ñ –±–∞–ª–∞–Ω—Å–∞","slot_type":"buff","type":"DEFENSE","rarity":"rare","effect":"–∑–∞—â–∏—Ç–∞ –±–∞–ª–∞–Ω—Å–∞"},{"key":"df_08","name":"–û—á–∏—â–µ–Ω–∏–µ","slot_type":"buff","type":"DEFENSE","rarity":"magic","effect":"–æ—á–∏—â–µ–Ω–∏–µ"},{"key":"df_09","name":"–°—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏—è","slot_type":"buff","type":"DEFENSE","rarity":"rare","effect":"—Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏—è"},{"key":"df_10","name":"–ú—è–≥–∫–∏–π –º–∏–Ω–∏–º—É–º","slot_type":"buff","type":"DEFENSE","rarity":"common","effect":"—Å–º—è–≥—á–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—å"},{"key":"cs_01","name":"–ü–æ—Ä—á–∞ –¥–æ—Ö–æ–¥–∞","slot_type":"curse","type":"CURSE","rarity":"common","effect":"+–ø–æ—Ç–µ—Ä–∏ / ‚àí–¥–æ—Ö–æ–¥, 6—á"},{"key":"cs_02","name":"–ü–æ—Ä—á–∞ –¥–æ–º–æ–≤","slot_type":"curse","type":"CURSE","rarity":"common","effect":"—É—Ä–æ–Ω –ø–æ –î–æ–º–∞–º"},{"key":"cs_03","name":"–ü–æ—Ä—á–∞ —Ñ–µ—Ä–º—ã","slot_type":"curse","type":"CURSE","rarity":"common","effect":"—É—Ä–æ–Ω –ø–æ –§–µ—Ä–º–µ"},{"key":"cs_04","name":"–ö–ª–µ–π–º–æ Skyfall","slot_type":"curse","type":"CURSE","rarity":"rare","effect":"+–ø–æ—Ç–µ—Ä–∏ –≤ –ü–∞–¥–µ–Ω–∏–µ –Ω–µ–±–∞"},{"key":"cs_05","name":"–ù–∞–ª–æ–≥–æ–≤–∞—è –º–µ—Ç–∫–∞","slot_type":"curse","type":"CURSE","rarity":"common","effect":"+–Ω–∞–ª–æ–≥"},{"key":"cs_06","name":"–°—Ä—ã–≤ —Ü–µ–Ω—ã","slot_type":"curse","type":"CURSE","rarity":"rare","effect":"‚àí—Ü–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏"},{"key":"cs_07","name":"–ó–∞–º–µ–¥–ª–µ–Ω–∏–µ","slot_type":"curse","type":"CURSE","rarity":"common","effect":"–∑–∞–º–µ–¥–ª–µ–Ω–∏–µ"},{"key":"cs_08","name":"–ü–æ–º–µ—Ö–∞ —à–∞—Ö—Ç–µ","slot_type":"curse","type":"CURSE","rarity":"rare","effect":"‚àí–ø–æ–ø—ã—Ç–∫–∏ —à–∞—Ö—Ç—ã"},{"key":"cs_09","name":"–ü—Ä–æ–±–æ–π","slot_type":"curse","type":"CURSE","rarity":"magic","effect":"—Å–∏–ª—å–Ω–∞—è –ø–æ—Ä—á–∞"},{"key":"cs_10","name":"–ú–µ—Ç–∫–∞","slot_type":"curse","type":"CURSE","rarity":"common","effect":"–º–µ—Ç–∫–∞ —Ü–µ–ª–∏"},{"key":"chrono_01","name":"–ü–µ—Å–æ–∫ –ú–∏–Ω—É—Ç","slot_type":"artifact_relic","type":"CHECKIN","rarity":"common","effect":"–∞—Ä—Ç–µ—Ñ–∞–∫—Ç —á–µ–∫–∏–Ω–∞"},{"key":"chrono_02","name":"–ú–∞—è—Ç–Ω–∏–∫ –°–¥–≤–∏–≥–∞","slot_type":"artifact_relic","type":"CHECKIN","rarity":"common","effect":"–∞—Ä—Ç–µ—Ñ–∞–∫—Ç —á–µ–∫–∏–Ω–∞"},{"key":"chrono_03","name":"–ú–∞–ª–∞—è –ü—Ä—É–∂–∏–Ω–∞","slot_type":"artifact_relic","type":"CHECKIN","rarity":"common","effect":"–∞—Ä—Ç–µ—Ñ–∞–∫—Ç —á–µ–∫–∏–Ω–∞"},{"key":"chrono_04","name":"–í—Ä–µ–º–µ–Ω–Ω–æ–π –£–∑–µ–ª","slot_type":"artifact_relic","type":"CHECKIN","rarity":"rare","effect":"–∞—Ä—Ç–µ—Ñ–∞–∫—Ç —á–µ–∫–∏–Ω–∞"},{"key":"chrono_05","name":"–ö–ª—é—á –ß–µ–∫–∏–Ω–∞","slot_type":"artifact_relic","type":"CHECKIN","rarity":"rare","effect":"–∞—Ä—Ç–µ—Ñ–∞–∫—Ç —á–µ–∫–∏–Ω–∞"},{"key":"chrono_06","name":"–†–∞–¥–∞—Ä –£–¥–∞—á–∏","slot_type":"artifact_relic","type":"CHECKIN","rarity":"rare","effect":"–∞—Ä—Ç–µ—Ñ–∞–∫—Ç —à–∞—Ö—Ç—ã"},{"key":"chrono_07","name":"–ì–ª–∞–∑ –®–∞—Ö—Ç—ë—Ä–∞","slot_type":"artifact_relic","type":"CHECKIN","rarity":"rare","effect":"–∞—Ä—Ç–µ—Ñ–∞–∫—Ç —à–∞—Ö—Ç—ã"},{"key":"chrono_08","name":"–ú–æ—Å—Ç –ü–æ–ø—ã—Ç–æ–∫","slot_type":"artifact_relic","type":"CHECKIN","rarity":"magic","effect":"–∞—Ä—Ç–µ—Ñ–∞–∫—Ç –ø–æ–ø—ã—Ç–æ–∫"},{"key":"chrono_09","name":"–ú–µ—Ç–∫–∞ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞","slot_type":"artifact_relic","type":"CHECKIN","rarity":"rare","effect":"–∞—Ä—Ç–µ—Ñ–∞–∫—Ç"},{"key":"chrono_10","name":"–°–µ–∫—É–Ω–¥–∞ –ë–æ–≥–∞","slot_type":"artifact_relic","type":"CHECKIN","rarity":"magic","effect":"–º–≥–Ω–æ–≤–µ–Ω–Ω—ã–π —á–µ–∫–∏–Ω"},{"key":"ward_01","name":"–©–∏—Ç –¢—É–º–∞–Ω–∞","slot_type":"artifact_relic","type":"DEFENSE","rarity":"common","effect":"cleanse –ø–æ—Ä—á–∏"},{"key":"ward_02","name":"–ü–ª–∞—Å—Ç–∏–Ω–∞ –•–æ–ª–æ–¥–∞","slot_type":"artifact_relic","type":"DEFENSE","rarity":"common","effect":"–∑–∞—â–∏—Ç–∞"},{"key":"ward_03","name":"–°—Ñ–µ—Ä–∞ –ë–∞–ª–∞–Ω—Å–∞","slot_type":"artifact_relic","type":"DEFENSE","rarity":"rare","effect":"–∑–∞—â–∏—Ç–∞ –±–∞–ª–∞–Ω—Å–∞"},{"key":"ward_04","name":"–†—É–Ω–∞ –£–∫—Ä—ã—Ç–∏—è","slot_type":"artifact_relic","type":"DEFENSE","rarity":"rare","effect":"—É–∫—Ä—ã—Ç–∏–µ"},{"key":"ward_05","name":"–ö–æ–ª–æ–∫–æ–ª –¢–∏—à–∏–Ω—ã","slot_type":"artifact_relic","type":"DEFENSE","rarity":"rare","effect":"–∑–∞—â–∏—Ç–∞"},{"key":"ward_06","name":"–ó–µ—Ä–∫–∞–ª–æ –û—Ç—Ä–∞–∂–µ–Ω–∏—è","slot_type":"artifact_relic","type":"DEFENSE","rarity":"magic","effect":"–æ—Ç—Ä–∞–∂–µ–Ω–∏–µ –ø–æ—Ä—á–∏"},{"key":"ward_07","name":"–ö–∞–º–µ–Ω—å –°—Ç–æ–π–∫–æ—Å—Ç–∏","slot_type":"artifact_relic","type":"DEFENSE","rarity":"rare","effect":"—Å—Ç–æ–π–∫–æ—Å—Ç—å"},{"key":"ward_08","name":"–ü–µ—á–∞—Ç—å –£–¥–µ—Ä–∂–∞–Ω–∏—è","slot_type":"artifact_relic","type":"DEFENSE","rarity":"rare","effect":"—É–¥–µ—Ä–∂–∞–Ω–∏–µ"},{"key":"ward_09","name":"–ö–∞–ø–ª—è –û—á–∏—â–µ–Ω–∏—è","slot_type":"artifact_relic","type":"DEFENSE","rarity":"magic","effect":"–æ—á–∏—â–µ–Ω–∏–µ –ø–æ—Ä—á–∏"},{"key":"ward_10","name":"–ö—É–ø–æ–ª –•—Ä–∞–º–∞","slot_type":"artifact_relic","type":"DEFENSE","rarity":"magic","effect":"—Å–∏–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞"},{"key":"blight_01","name":"–ú–µ—Ç–∫–∞ –ù–∞–ª–æ–≥–∞","slot_type":"artifact_relic","type":"CURSE","rarity":"common","effect":"–ø–æ—Ä—á–∞ –Ω–∞–ª–æ–≥–∞"},{"key":"blight_02","name":"–ü—Ä–æ–∫–ª—è—Ç–∏–µ –î–æ—Ö–æ–¥–∞","slot_type":"artifact_relic","type":"CURSE","rarity":"rare","effect":"–ø–æ—Ä—á–∞ –¥–æ—Ö–æ–¥–∞"},{"key":"blight_03","name":"–£–¥–∞—Ä –ü–æ –î–æ–º–∞–º","slot_type":"artifact_relic","type":"CURSE","rarity":"rare","effect":"–ø–æ—Ä—á–∞ –¥–æ–º–æ–≤"},{"key":"blight_04","name":"–£–¥–∞—Ä –ü–æ –§–µ—Ä–º–µ","slot_type":"artifact_relic","type":"CURSE","rarity":"rare","effect":"–ø–æ—Ä—á–∞ —Ñ–µ—Ä–º—ã"},{"key":"blight_05","name":"–°—Ä—ã–≤ –°–¥–µ–ª–∫–∏","slot_type":"artifact_relic","type":"CURSE","rarity":"magic","effect":"–ø–æ—Ä—á–∞ –ø—Ä–æ–¥–∞–∂–∏"},{"key":"blight_06","name":"–ú–æ—Ä–æ–∑ –í—Ä–µ–º–µ–Ω–∏","slot_type":"artifact_relic","type":"CURSE","rarity":"rare","effect":"–∑–∞–º–µ–¥–ª–µ–Ω–∏–µ"},{"key":"blight_07","name":"–¢—Ä–µ—â–∏–Ω–∞ –®–∞—Ö—Ç—ã","slot_type":"artifact_relic","type":"CURSE","rarity":"rare","effect":"–ø–æ—Ä—á–∞ —à–∞—Ö—Ç—ã"},{"key":"blight_08","name":"–ö–ª–µ–π–º–æ Skyfall","slot_type":"artifact_relic","type":"CURSE","rarity":"magic","effect":"+–ø–æ—Ç–µ—Ä–∏ skyfall"},{"key":"blight_09","name":"–ò–≥–ª–∞ –ü—Ä–æ–±–æ—è","slot_type":"artifact_relic","type":"CURSE","rarity":"magic","effect":"–ø—Ä–æ–±–æ–π –∑–∞—â–∏—Ç—ã"},{"key":"blight_10","name":"–ß—ë—Ä–Ω—ã–π –ü—Ä–∏–≥–æ–≤–æ—Ä","slot_type":"artifact_relic","type":"CURSE","rarity":"magic","effect":"—Å–∏–ª—å–Ω–∞—è –ø–æ—Ä—á–∞"},{"key":"amu_01","name":"–ò–º–º—É–Ω–∏—Ç–µ—Ç I","slot_type":"amulet","type":"PREMIUM","rarity":"PREMIUM","effect":"–∏–º–º—É–Ω–∏—Ç–µ—Ç –∫ –ø–æ—Ä—á–µ"},{"key":"amu_02","name":"–ò–º–º—É–Ω–∏—Ç–µ—Ç II","slot_type":"amulet","type":"PREMIUM","rarity":"PREMIUM","effect":"–∏–º–º—É–Ω–∏—Ç–µ—Ç —Å–∏–ª—å–Ω–µ–µ"},{"key":"amu_03","name":"–ò–º–º—É–Ω–∏—Ç–µ—Ç III","slot_type":"amulet","type":"PREMIUM","rarity":"PREMIUM","effect":"–ø–æ–ª–Ω—ã–π –∏–º–º—É–Ω–∏—Ç–µ—Ç"},{"key":"amu_04","name":"–ó–∞–º–æ—Ä–æ–∑–∫–∞ –ø–æ—Ä—á–∏","slot_type":"amulet","type":"PREMIUM","rarity":"PREMIUM","effect":"–∑–∞–º–æ—Ä–æ–∑–∫–∞ –ø–æ—Ä—á–∏"},{"key":"amu_05","name":"–û—á–∏—â–µ–Ω–∏–µ","slot_type":"amulet","type":"PREMIUM","rarity":"PREMIUM","effect":"–æ—á–∏—â–µ–Ω–∏–µ"},{"key":"amu_06","name":"–£–¥–∞—á–∞ √ó2","slot_type":"amulet","type":"PREMIUM","rarity":"PREMIUM","effect":"—É–¥–≤–æ–µ–Ω–∏–µ —É–¥–∞—á–∏"},{"key":"amu_07","name":"–î–æ—Ö–æ–¥ √ó3 (–≤—Ä–µ–º.)","slot_type":"amulet","type":"PREMIUM","rarity":"PREMIUM","effect":"—Ç—Ä–æ–π–Ω–æ–π –¥–æ—Ö–æ–¥"},{"key":"amu_08","name":"–ê–Ω—Ç–∏-Skyfall","slot_type":"amulet","type":"PREMIUM","rarity":"PREMIUM","effect":"—Å–Ω–∏–∂–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—å –Ω–µ–±–∞"},{"key":"amu_09","name":"–°–µ–π—Ñ –≤—ã–≤–æ–¥–∞","slot_type":"amulet","type":"PREMIUM","rarity":"PREMIUM","effect":"–∑–∞—â–∏—Ç–∞ –≤—ã–≤–æ–¥–∞"},{"key":"amu_10","name":"–†—ã–Ω–æ–∫ –ü—Ä–µ–º–∏—É–º","slot_type":"amulet","type":"PREMIUM","rarity":"PREMIUM","effect":"–±–æ–Ω—É—Å—ã –º–∞—Ä–∫–µ—Ç–∞"},{"key":"amu_11","name":"–®–∞—Ö—Ç–∞ –ü—Ä–µ–º–∏—É–º","slot_type":"amulet","type":"PREMIUM","rarity":"PREMIUM","effect":"–±–æ–Ω—É—Å—ã —à–∞—Ö—Ç—ã"},{"key":"amu_12","name":"–•—Ä–∞–º–æ–≤—ã–π –û–±–µ—Ç","slot_type":"amulet","type":"PREMIUM","rarity":"PREMIUM","effect":"–æ—Å–æ–±—ã–π –æ–±–µ—Ç"},{"key":"egg_red","name":"–Ø–π—Ü–æ –ö—Ä–∞—Å–Ω–æ–µ","slot_type":"egg","type":"EGG","rarity":"common","effect":"—è–π—Ü–æ (—Ä–µ–¥–∫–æ—Å—Ç—å: common)"},{"key":"egg_blue","name":"–Ø–π—Ü–æ –°–∏–Ω–µ–µ","slot_type":"egg","type":"EGG","rarity":"common","effect":"—è–π—Ü–æ"},{"key":"egg_green","name":"–Ø–π—Ü–æ –ó–µ–ª—ë–Ω–æ–µ","slot_type":"egg","type":"EGG","rarity":"common","effect":"—è–π—Ü–æ"},{"key":"egg_yellow","name":"–Ø–π—Ü–æ –ñ—ë–ª—Ç–æ–µ","slot_type":"egg","type":"EGG","rarity":"common","effect":"—è–π—Ü–æ"},{"key":"egg_purple","name":"–Ø–π—Ü–æ –§–∏–æ–ª–µ—Ç–æ–≤–æ–µ","slot_type":"egg","type":"EGG","rarity":"rare","effect":"—è–π—Ü–æ"},{"key":"egg_white","name":"–Ø–π—Ü–æ –ë–µ–ª–æ–µ","slot_type":"egg","type":"EGG","rarity":"rare","effect":"—è–π—Ü–æ"},{"key":"egg_black","name":"–Ø–π—Ü–æ –ß—ë—Ä–Ω–æ–µ","slot_type":"egg","type":"EGG","rarity":"rare","effect":"—è–π—Ü–æ"}];
</script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Segoe UI',Arial,sans-serif;background:#0a0a0a;background:linear-gradient(135deg,#1a0000 0%,#0a0a0a 50%,#1a0600 100%);min-height:100vh;color:#fff;overflow-x:hidden}
.app{max-width:600px;margin:0 auto;padding-bottom:80px}
.header{background:rgba(0,0,0,.9);padding:10px 15px;display:flex;justify-content:space-between;align-items:center;backdrop-filter:blur(10px);position:sticky;top:0;z-index:100;flex-wrap:wrap;gap:8px;border-bottom:2px solid #ff4500;box-shadow:0 0 20px rgba(255,69,0,.3)}
.res{display:flex;gap:6px;flex-wrap:wrap;font-size:12px}
.r{display:flex;align-items:center;gap:3px;background:linear-gradient(135deg,rgba(255,69,0,.2),rgba(255,140,0,.2));padding:3px 8px;border-radius:12px;font-weight:700;border:1px solid rgba(255,69,0,.4);box-shadow:0 0 10px rgba(255,69,0,.2)}
.online-badge{display:flex;align-items:center;gap:5px;font-size:11px;background:linear-gradient(135deg,rgba(0,255,0,.2),rgba(0,200,0,.2));padding:4px 10px;border-radius:15px;border:1px solid rgba(0,255,0,.4)}
.online-dot{width:8px;height:8px;background:#00ff00;border-radius:50%;animation:blink 2s infinite;box-shadow:0 0 10px #00ff00}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.4}}
.screen{display:none;padding:15px;animation:fadeIn .3s}
.screen.active{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.warn{background:linear-gradient(135deg,#ff0000,#8b0000);padding:15px;border-radius:15px;margin:15px;text-align:center;animation:pulse 1.5s infinite;border:3px solid #ff4500;display:none;box-shadow:0 0 30px rgba(255,0,0,.5)}
.warn.active{display:block}
@keyframes pulse{0%,100%{transform:scale(1);box-shadow:0 0 20px rgba(255,0,0,.5)}50%{transform:scale(1.02);box-shadow:0 0 40px rgba(255,0,0,.8)}}
.era-info{background:rgba(255,69,0,.15);padding:12px;border-radius:12px;margin:15px;border:2px solid #ff4500;box-shadow:0 0 15px rgba(255,69,0,.3)}
.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin:15px 0}
.card{background:linear-gradient(135deg,rgba(20,20,20,.9),rgba(40,20,0,.9));border-radius:12px;padding:10px;text-align:center;cursor:pointer;transition:all .3s;border:2px solid rgba(255,69,0,.3);min-height:130px;box-shadow:0 4px 15px rgba(0,0,0,.5)}
.card:hover{transform:translateY(-3px);box-shadow:0 0 25px rgba(255,69,0,.6);border-color:#ff4500}
.card.dmg{border-color:#ff0000;background:linear-gradient(135deg,rgba(139,0,0,.9),rgba(70,0,0,.9));animation:damage 1s infinite}
@keyframes damage{0%,100%{box-shadow:0 0 15px rgba(255,0,0,.5)}50%{box-shadow:0 0 30px rgba(255,0,0,.8)}}
.ic{font-size:35px;margin-bottom:6px;text-shadow:0 0 10px rgba(255,69,0,.5)}
.nm{font-size:12px;font-weight:700;margin-bottom:4px;color:#ffa500}
.lv{font-size:11px;opacity:.8;margin-bottom:4px}
.inc{font-size:10px;color:#ff8c00;font-weight:700;text-shadow:0 0 5px rgba(255,140,0,.5)}
.loss{font-size:10px;color:#ff0000;font-weight:700;text-shadow:0 0 5px rgba(255,0,0,.5)}
.mine-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:5px;margin:15px 0}
.mb{aspect-ratio:1;background:linear-gradient(135deg,#2a2a2a,#1a1a1a);border-radius:6px;border:2px solid rgba(255,69,0,.3);cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center;font-size:20px;position:relative;box-shadow:0 2px 10px rgba(0,0,0,.5)}
.mb:hover:not(.clr):not(.locked){transform:scale(1.05);box-shadow:0 0 20px rgba(255,69,0,.6);border-color:#ff4500}
.mb.clr{background:linear-gradient(135deg,rgba(255,140,0,.3),rgba(255,69,0,.3));cursor:default;border-color:#ff8c00}
.mb.locked{opacity:.3;cursor:not-allowed}
.mb.epic{background:linear-gradient(135deg,#9b59b6,#8e44ad);animation:shimmer 2s infinite;border:2px solid #9b59b6}
.mb.magic{background:linear-gradient(135deg,#3498db,#2980b9);animation:shimmer 2s infinite;border:2px solid #3498db}
.mb.tsy{background:linear-gradient(135deg,#2ecc71,#27ae60);animation:shimmer 2s infinite;border:2px solid #2ecc71}
.mb.yan{background:linear-gradient(135deg,#f39c12,#e67e22);animation:shimmer 2s infinite;border:2px solid #f39c12}
.mb.yin{background:linear-gradient(135deg,#34495e,#2c3e50);animation:shimmer 2s infinite;border:2px solid #7f8c8d}
.mb.fire{background:linear-gradient(135deg,#ff0000,#ff4500);animation:shimmer 2s infinite;border:2px solid #ff0000}
@keyframes shimmer{0%,100%{box-shadow:0 0 15px currentColor}50%{box-shadow:0 0 30px currentColor}}
.btn{background:linear-gradient(135deg,#ff4500,#ff8c00);border:none;padding:10px 20px;border-radius:20px;color:#fff;font-size:14px;font-weight:700;cursor:pointer;transition:all .3s;margin:4px;box-shadow:0 4px 15px rgba(255,69,0,.4);text-shadow:0 1px 2px rgba(0,0,0,.5)}
.btn:hover{transform:translateY(-2px);box-shadow:0 0 25px rgba(255,69,0,.8)}
.btn:disabled{opacity:.5;cursor:not-allowed}
.btn-success{background:linear-gradient(135deg,#ff8c00,#ffa500)}
.btn-danger{background:linear-gradient(135deg,#8b0000,#ff0000)}
.btn-warning{background:linear-gradient(135deg,#ffa500,#ff4500)}
.btn-small{padding:6px 12px;font-size:12px}
.btn-big{padding:15px 40px;font-size:18px;font-weight:900;box-shadow:0 6px 25px rgba(255,69,0,.6)}
.nav{position:fixed;bottom:0;left:0;right:0;background:rgba(0,0,0,.95);backdrop-filter:blur(10px);display:grid;grid-template-columns:repeat(5,1fr);padding:8px 0;z-index:1000;max-width:600px;margin:0 auto;border-top:2px solid #ff4500;box-shadow:0 -5px 20px rgba(255,69,0,.3)}
.nav-six{grid-template-columns:repeat(6,1fr)}
.ni{text-align:center;padding:6px;cursor:pointer;transition:all .3s;border-radius:8px;margin:0 3px}
.ni.active{background:linear-gradient(135deg,rgba(255,69,0,.4),rgba(255,140,0,.4));box-shadow:0 0 15px rgba(255,69,0,.5)}
.ni:hover{background:rgba(255,69,0,.2)}
.nic{font-size:20px;margin-bottom:3px;text-shadow:0 0 10px rgba(255,140,0,.5)}
.nil{font-size:10px}
.modal{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.95);z-index:2000;align-items:center;justify-content:center;padding:20px;overflow-y:auto}
.modal.active{display:flex}
.mc{background:linear-gradient(135deg,#1a1a1a,#2a1a0a);border-radius:20px;padding:25px;max-width:500px;width:100%;max-height:85vh;overflow-y:auto;position:relative;border:2px solid #ff4500;box-shadow:0 0 40px rgba(255,69,0,.5)}
.mcl{position:absolute;top:15px;right:15px;background:linear-gradient(135deg,rgba(255,69,0,.5),rgba(255,140,0,.5));border:none;width:35px;height:35px;border-radius:50%;color:#fff;font-size:22px;cursor:pointer;transition:all .3s;box-shadow:0 2px 10px rgba(255,69,0,.5)}
.mcl:hover{background:linear-gradient(135deg,#ff4500,#ff8c00);transform:rotate(90deg);box-shadow:0 0 20px rgba(255,69,0,.8)}
.mt{font-size:22px;font-weight:700;margin-bottom:20px;text-align:center;color:#ffa500;text-shadow:0 0 15px rgba(255,140,0,.5)}
.notif{position:fixed;top:70px;left:50%;transform:translateX(-50%);background:linear-gradient(135deg,rgba(255,140,0,.95),rgba(255,69,0,.95));padding:12px 20px;border-radius:10px;font-weight:700;z-index:3000;animation:slideDown .3s;display:none;max-width:90%;text-align:center;border:2px solid #ffa500;box-shadow:0 0 25px rgba(255,140,0,.7)}
.notif.show{display:block}
.notif.error{background:linear-gradient(135deg,rgba(139,0,0,.95),rgba(255,0,0,.95));border-color:#ff0000;box-shadow:0 0 25px rgba(255,0,0,.7)}
@keyframes slideDown{from{opacity:0;transform:translate(-50%,-20px)}to{opacity:1;transform:translate(-50%,0)}}
.info{background:linear-gradient(135deg,rgba(30,30,30,.9),rgba(50,25,0,.9));border-radius:12px;padding:15px;margin:10px 0;border:1px solid rgba(255,69,0,.3);box-shadow:0 4px 15px rgba(0,0,0,.5)}
.ir{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid rgba(255,69,0,.2)}
.ir:last-child{border-bottom:none}
.lb{background:linear-gradient(135deg,rgba(30,30,30,.9),rgba(50,25,0,.9));border-radius:12px;padding:12px;margin:8px 0;display:flex;align-items:center;gap:12px;border:1px solid rgba(255,69,0,.3);box-shadow:0 4px 15px rgba(0,0,0,.5);position:relative}
.lb.me{border:2px solid #ffa500;box-shadow:0 0 20px rgba(255,165,0,.6)}
.rank{font-size:20px;font-weight:700;min-width:35px;text-align:center}
.rank.gold{color:#ffd700;text-shadow:0 0 15px #ffd700}
.rank.silver{color:#c0c0c0;text-shadow:0 0 15px #c0c0c0}
.rank.bronze{color:#cd7f32;text-shadow:0 0 15px #cd7f32}
.checkin-card{background:linear-gradient(135deg,rgba(255,69,0,.2),rgba(255,140,0,.2));border-radius:15px;padding:20px;margin:0 0 15px 0;border:2px solid #ff4500;box-shadow:0 0 25px rgba(255,69,0,.5);text-align:center}
.checkin-btn{padding:15px 40px;font-size:18px;font-weight:900;background:linear-gradient(135deg,#ff4500,#ff8c00);border:3px solid #ffa500;border-radius:25px;box-shadow:0 6px 25px rgba(255,140,0,.7);cursor:pointer;transition:all .3s;color:#fff}
.checkin-btn:hover:not(:disabled){transform:scale(1.05);box-shadow:0 8px 35px rgba(255,140,0,1)}
.checkin-btn:disabled{opacity:.5;cursor:not-allowed}
.digs-left{background:linear-gradient(135deg,rgba(255,69,0,.3),rgba(255,140,0,.3));padding:15px;border-radius:12px;margin:15px 0;text-align:center;border:2px solid #ff4500;box-shadow:0 0 20px rgba(255,69,0,.5)}
.digs-count{font-size:48px;font-weight:900;color:#ffa500;text-shadow:0 0 20px rgba(255,140,0,.8);margin:10px 0}
.rc{background:linear-gradient(135deg,rgba(30,30,30,.9),rgba(50,25,0,.9));border-radius:12px;padding:12px;margin:8px 0;border:2px solid;cursor:pointer;transition:all .3s;box-shadow:0 4px 15px rgba(0,0,0,.5)}
.rc:hover{transform:translateY(-3px);box-shadow:0 0 25px rgba(255,69,0,.6)}
.inv-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin:15px 0}
.inv-item{background:linear-gradient(135deg,rgba(30,30,30,.9),rgba(50,25,0,.9));border-radius:12px;padding:15px;text-align:center;border:2px solid rgba(255,69,0,.3);box-shadow:0 4px 15px rgba(0,0,0,.5);transition:all .3s}
.inv-item:hover{transform:translateY(-3px);box-shadow:0 0 25px rgba(255,69,0,.6)}
.inv-qty{font-size:14px;font-weight:700;color:#ff8c00;margin-top:8px}
.inv-relics-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px;margin:12px 0}
.inv-relic-card{position:relative;background:linear-gradient(180deg,rgba(28,28,28,.98),rgba(40,22,0,.95));border-radius:14px;border:1px solid rgba(255,140,0,.25);overflow:hidden;box-shadow:0 4px 20px rgba(0,0,0,.4);transition:transform .2s,box-shadow .2s}
.inv-relic-card:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(255,69,0,.15)}
.inv-relic-card .inv-relic-head{display:flex;align-items:center;gap:10px;padding:14px 14px 10px;border-bottom:1px solid rgba(255,140,0,.12)}
.inv-relic-card .inv-relic-icon{font-size:36px;line-height:1;flex-shrink:0}
.inv-relic-card .inv-relic-title{font-size:15px;font-weight:700;color:#ffa500;line-height:1.25;flex:1;min-width:0}
.inv-relic-card .inv-relic-badge{font-size:10px;font-weight:700;text-transform:uppercase;padding:3px 8px;border-radius:8px;flex-shrink:0}
.inv-relic-card .inv-relic-body{padding:10px 14px;font-size:12px;color:rgba(255,255,255,.88);line-height:1.4}
.inv-relic-card .inv-relic-price{padding:8px 14px;font-size:12px;color:rgba(255,200,100,.9);display:flex;flex-wrap:wrap;align-items:center;gap:6px 10px;border-top:1px solid rgba(255,140,0,.1)}
.inv-relic-card .inv-relic-actions{display:grid;grid-template-columns:1fr 1fr;gap:8px;padding:12px 14px;background:rgba(0,0,0,.2)}
.inv-relic-card .inv-relic-actions .btn{width:100%;padding:10px 8px;font-size:12px;font-weight:700;border-radius:10px;border:none;cursor:pointer;transition:opacity .2s,transform .15s}
.inv-relic-card .inv-relic-actions .btn:active{transform:scale(0.98)}
.inv-relic-card .inv-relic-actions .btn-sell{background:linear-gradient(135deg,#2d8a2d,#3cb043);color:#fff}
.inv-relic-card .inv-relic-actions .btn-merge{background:linear-gradient(135deg,#5a4a8a,#7b68b8);color:#fff}
.inv-relic-card .inv-relic-qty{position:absolute;top:8px;right:8px;background:rgba(255,69,0,.9);color:#fff;font-size:11px;font-weight:700;padding:2px 8px;border-radius:10px}
.inv-content-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px;margin:12px 0}
.inv-action-card{position:relative;background:linear-gradient(180deg,rgba(28,28,28,.98),rgba(40,22,0,.95));border-radius:14px;border:1px solid rgba(255,140,0,.25);overflow:hidden;box-shadow:0 4px 20px rgba(0,0,0,.4);transition:transform .2s,box-shadow .2s}
.inv-action-card:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(255,69,0,.15)}
.inv-action-card .inv-card-head{display:flex;align-items:center;gap:10px;padding:14px;border-bottom:1px solid rgba(255,140,0,.12)}
.inv-action-card .inv-card-icon{font-size:36px;line-height:1;flex-shrink:0}
.inv-action-card .inv-card-title{font-size:15px;font-weight:700;color:#ffa500;line-height:1.25;flex:1;min-width:0}
.inv-action-card .inv-card-body{padding:10px 14px;font-size:12px;color:rgba(255,255,255,.88);line-height:1.4}
.inv-action-card .inv-card-actions{display:grid;grid-template-columns:1fr 1fr;gap:8px;padding:12px 14px;background:rgba(0,0,0,.2)}
.inv-action-card .inv-card-actions .btn{width:100%;padding:10px 8px;font-size:12px;font-weight:700;border-radius:10px;border:none;cursor:pointer;transition:opacity .2s,transform .15s}
.inv-action-card .inv-card-actions .btn:active{transform:scale(0.98)}
.inv-action-card .inv-card-actions .btn-act{background:linear-gradient(135deg,#2d8a2d,#3cb043);color:#fff}
.inv-action-card .inv-card-actions .btn-burn{background:linear-gradient(135deg,#8b2a2a,#b33);color:#fff}
.inv-action-card .inv-card-qty{position:absolute;top:8px;right:8px;background:rgba(255,69,0,.9);color:#fff;font-size:11px;font-weight:700;padding:2px 8px;border-radius:10px}
#itemCardContent .btn{padding:10px 12px;font-size:13px;font-weight:700;border-radius:10px;border:none;cursor:pointer;transition:opacity .2s,transform .15s}
#itemCardContent .btn:active{transform:scale(0.98)}
#itemCardContent .btn-act{background:linear-gradient(135deg,#2d8a2d,#3cb043);color:#fff}
#itemCardContent .btn-burn{background:linear-gradient(135deg,#8b2a2a,#b33);color:#fff}
#itemCardContent .btn-sell{background:linear-gradient(135deg,#2d8a2d,#3cb043);color:#fff}
#itemCardContent .btn-merge{background:linear-gradient(135deg,#5a4a8a,#7b68b8);color:#fff}
.inv-card-clickable:hover{box-shadow:0 8px 24px rgba(255,69,0,.2)}
.tx-input{width:100%;padding:10px;border-radius:10px;background:rgba(30,30,30,.9);border:2px solid rgba(255,69,0,.5);color:#ffa500;font-size:14px;margin:10px 0;box-shadow:inset 0 2px 10px rgba(0,0,0,.5)}
.tx-input:focus{outline:none;border-color:#ff8c00;box-shadow:inset 0 2px 10px rgba(0,0,0,.5),0 0 15px rgba(255,140,0,.5)}
.help-section{margin:14px 0;padding:12px;background:rgba(30,30,30,.6);border-radius:10px;border-left:4px solid #ff4500}
.help-section h4{color:#ffa500;font-size:14px;margin-bottom:6px}
.help-section p{font-size:13px;line-height:1.45;opacity:.95}
.help-title{font-size:18px;color:#ffa500;margin-bottom:4px}
@media (max-width:400px){.grid{grid-template-columns:repeat(2,1fr)}.mine-grid{grid-template-columns:repeat(5,1fr)}.nil{display:none}}
</style>
</head>
<body>
<div class="app">
<div class="header">
<div class="res">
<div class="online-badge"><div class="online-dot"></div><span id="onlineCount">0</span> –æ–Ω–ª–∞–π–Ω</div>
<div class="r">üíé <span id="gems">0</span></div>
<div class="r">ü™ô <span id="coins">1000</span></div>
<div class="r">‚≠ê <span id="points">0</span></div>
<div class="r">ü™µ <span id="wood">100</span></div>
<div class="r">ü™® <span id="stone">100</span></div>
</div>
<div style="font-size:12px;display:flex;align-items:center;gap:6px;flex-wrap:wrap">
<button type="button" class="btn btn-small" style="padding:4px 8px;font-size:14px" onclick="G.openSettings()" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">‚öôÔ∏è</button>
<div class="online-dot" style="width:6px;height:6px"></div>
<span id="playerName">–ò–≥—Ä–æ–∫</span><span id="testModeBadge" style="display:none;margin-left:6px;font-size:10px;opacity:.8;background:rgba(255,200,0,.3);padding:2px 6px;border-radius:6px">–¢–µ—Å—Ç</span>
<button type="button" class="btn btn-small" style="padding:4px 8px;font-size:14px" onclick="G.openProfileContribution()" title="–í–∫–ª–∞–¥ –∏ —É—Ä–æ–≤–µ–Ω—å –¥–æ–≤–µ—Ä–∏—è">üíù</button>
<button type="button" class="btn btn-small" style="padding:4px 8px;font-size:14px" onclick="G.showScreen('rating')" title="–†–µ–π—Ç–∏–Ω–≥">üìä</button>
<button type="button" class="btn btn-small" style="padding:4px 8px;font-size:14px" onclick="G.showScreen('tasks')" title="–ù–∞–≥—Ä–∞–¥—ã">üéÅ</button>
<button type="button" class="btn btn-small" style="padding:4px 8px;font-size:14px" onclick="G.openAboutProject()" title="–û –ø—Ä–æ–µ–∫—Ç–µ: –∏–Ω—Ñ–æ, –∫–∞—Ç–∞–ª–æ–≥ 121 –ø—Ä–µ–¥–º–µ—Ç, —Å—Å—ã–ª–∫–∏">‚ÑπÔ∏è</button>
<button type="button" class="btn btn-small" style="padding:4px 8px;font-size:14px" onclick="G.openSupport()" title="–ü–æ–¥–¥–µ—Ä–∂–∫–∞">üì©</button>
<button type="button" class="btn btn-small" style="padding:4px 8px;font-size:14px" onclick="G.openNotifications()" title="–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è">üîî</button>
<button type="button" class="btn btn-small" style="padding:4px 8px;font-size:14px" onclick="G.openHelp()" title="–û–±—É—á–µ–Ω–∏–µ">üìñ</button>
</div>
</div>

<div class="warn" id="skyFallWarning">
<h3>‚ö†Ô∏è –ü–ê–î–ï–ù–ò–ï –ù–ï–ë–ê ‚ö†Ô∏è</h3>
<p>–í—Å–µ –ø–æ—Å—Ç—Ä–æ–π–∫–∏ –Ω–µ—Å—É—Ç —É–±—ã—Ç–∫–∏!</p>
<p>–£–±—ã—Ç–æ–∫: <span id="lossMultiplier">1.0x</span></p>
<div id="skyFallArmyBlock" class="info" style="margin-top:12px;display:none">
<div style="font-size:14px;font-weight:700;color:#ffa500;margin-bottom:6px">‚öî –ê—Ä–º–∏—è –∏ –ø—Ä–∏–ø–∞—Å—ã</div>
<div class="ir"><span>–ê—Ä–º–∏—è:</span><span id="skyFallArmy">0</span></div>
<div class="ir"><span>–ü—Ä–∏–ø–∞—Å—ã:</span><span id="skyFallSupplies">0</span></div>
<p style="font-size:12px;opacity:.9;margin:8px 0">–£–≤–µ–ª–∏—á–∏–≤–∞–π—Ç–µ –∞—Ä–º–∏—é –∑–∞ –ø—Ä–∏–ø–∞—Å—ã; –ø—Ä–∏ –Ω–µ—Ö–≤–∞—Ç–∫–µ –ø—Ä–æ–∏–∑–≤–æ–¥—è—Ç –∑–¥–∞–Ω–∏—è. –ê—Ä–º–µ–π—Å–∫–∏–µ –∑–¥–∞–Ω–∏—è: –∫–∞–∂–¥—ã–π —É—Ä–æ–≤–µ–Ω—å √ó2 –ø—Ä–∏—Ä–æ—Å—Ç –≤–æ–π—Å–∫. –ú–æ–∂–Ω–æ –∞—Ç–∞–∫–æ–≤–∞—Ç—å –¥—Ä—É–≥–∏—Ö, –∑–∞–±–∏—Ä–∞—è –ø—Ä–∏–ø–∞—Å—ã, –∏ –Ω–∞–∫–ª–∞–¥—ã–≤–∞—Ç—å –ø–æ—Ä—á—É –Ω–∞ –∑–¥–∞–Ω–∏–µ –∏–ª–∏ –∞—Ä–º–∏—é.</p>
<button type="button" class="btn btn-small" onclick="G.openSkyFallArmy()">–£–≤–µ–ª–∏—á–∏—Ç—å –∞—Ä–º–∏—é</button>
<button type="button" class="btn btn-small btn-danger" onclick="G.openSkyFallAttack()">–ê—Ç–∞–∫–æ–≤–∞—Ç—å (–∑–∞–±—Ä–∞—Ç—å –ø—Ä–∏–ø–∞—Å—ã)</button>
<button type="button" class="btn btn-small" onclick="G.openSkyFallCurse()">–ù–∞–ª–æ–∂–∏—Ç—å –ø–æ—Ä—á—É</button>
</div>
</div>

<div class="era-info">
<div style="display:flex;justify-content:space-between">
<div><strong>–≠—Ä–∞ <span id="currentEra">1</span>/4</strong><div style="font-size:12px;opacity:.8">–î–æ –∫–æ–Ω—Ü–∞: <span id="eraTimer">7–¥ 0—á</span></div></div>
<div style="text-align:right"><div>–ü–ª–µ–º—è: –£—Ä.<span id="villageLevel">1</span></div></div>
</div>
</div>

<div id="villageScreen" class="screen active">
<h2 style="text-align:center;margin-bottom:15px;color:#ffa500;text-shadow:0 0 15px rgba(255,140,0,.5)">üèòÔ∏è –ú–æ—ë –ü–ª–µ–º—è</h2>
<div class="info">
<div class="ir"><span>–î–æ—Ö–æ–¥ –≤ —á–∞—Å:</span><span style="color:#ff8c00" id="totalIncome">+0 ü™ô</span></div>
<div class="ir"><span>–†–∞—Å—Ö–æ–¥—ã –≤ —á–∞—Å:</span><span style="color:#ff0000" id="totalExpenses">-0 ü™ô</span></div>
</div>
<div style="display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin:12px 0">
<button class="btn btn-small" onclick="G.openBuildingsCatalog()">üìã –ü–æ—Å—Ç—Ä–æ–π–∫–∏</button>
<button class="btn btn-small" onclick="G.openUpgradeBuilding()">‚¨ÜÔ∏è –£–ª—É—á—à–∏—Ç—å</button>
<button class="btn btn-small" onclick="G.openRelicsInBuildings()">‚ú® –†–µ–ª–∏–∫–≤–∏–∏ –≤ –∑–¥–∞–Ω–∏—è</button>
<button class="btn btn-small btn-danger" onclick="G.openDemolish()">üóëÔ∏è –°–Ω–µ—Å—Ç–∏</button>
<button class="btn btn-small" onclick="G.openVillageSummary()">üìä –°–≤–æ–¥–∫–∞</button>
</div>
<div class="grid" id="villageGrid"></div>
<div style="text-align:center;margin-top:15px">
<button class="btn btn-success" onclick="G.collectResources()">üì¶ –°–æ–±—Ä–∞—Ç—å –†–µ—Å—É—Ä—Å—ã</button>
</div>
</div>

<div id="mineScreen" class="screen">
<h2 style="text-align:center;margin-bottom:15px;color:#ffa500;text-shadow:0 0 15px rgba(255,140,0,.5)">‚õèÔ∏è –®–∞—Ö—Ç–∞</h2>

<div class="digs-left">
<div style="font-size:18px;font-weight:700;color:#ffa500;margin-bottom:10px">‚õèÔ∏è –ü–æ–ø—ã—Ç–∫–∏ –∫–æ–ø–∞–Ω–∏—è</div>
<div class="digs-count" id="digsLeft">3</div>
<div style="font-size:14px;opacity:.8">–∏–∑ 3 –¥–æ—Å—Ç—É–ø–Ω–æ</div>
<div style="font-size:12px;opacity:.7;margin-top:10px">–í–æ—Å—Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è —á–µ—Ä–µ–∑: <span id="digsTimer">--:--</span></div>
</div>

<div class="info">
<div class="ir"><span>–í—Å–µ–≥–æ –Ω–∞–π–¥–µ–Ω–æ —Ä–µ–ª–∏–∫–≤–∏–π:</span><span id="relicsFound">0</span></div>
</div>
<div class="mine-grid" id="mineGrid"></div>
<div style="text-align:center;margin-top:15px">
<button class="btn" onclick="G.newMine()">üîÑ –ù–æ–≤–∞—è –®–∞—Ö—Ç–∞</button>
</div>
<div class="info" style="margin-top:15px">
<div style="font-size:14px;font-weight:700;color:#ffa500;margin-bottom:10px">üìú –ò—Å—Ç–æ—Ä–∏—è (–ø–æ—Å–ª–µ–¥–Ω–∏–µ –∫–æ–ø–∫–∏)</div>
<div id="mineHistoryList" style="max-height:180px;overflow-y:auto;font-size:12px"></div>
<button class="btn btn-small" onclick="G.refreshMineHistory()" style="margin-top:8px">–û–±–Ω–æ–≤–∏—Ç—å</button>
</div>
</div>

<div id="marketScreen" class="screen">
<h2 style="text-align:center;margin-bottom:15px;color:#ffa500;text-shadow:0 0 15px rgba(255,140,0,.5)">üè™ –ú–∞—Ä–∫–µ—Ç</h2>
<div style="display:flex;justify-content:center;gap:10px;margin-bottom:15px">
<button class="btn" id="tabRelics" onclick="G.switchTab('relics')">‚ú® –†–µ–ª–∏–∫–≤–∏–∏</button>
<button class="btn" id="tabAmulets" onclick="G.switchTab('amulets')">üîÆ –ê–º—É–ª–µ—Ç—ã</button>
<button class="btn" id="tabDiamonds" onclick="G.switchTab('diamonds')">üíé –ê–ª–º–∞–∑—ã</button>
</div>
<div id="marketRelics">
<div class="help-section" style="margin-bottom:12px"><h4>üè¶ –ü–æ–∫—É–ø–∫–∞ –∏–∑ –∫–∞–∑–Ω—ã</h4><p style="font-size:12px;opacity:.85;margin-bottom:8px">–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã –∑–∞ –º–æ–Ω–µ—Ç—ã –∏–ª–∏ –∑–≤—ë–∑–¥—ã.</p><div id="marketShopOffers"><span style="opacity:.8">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</span></div><div class="info" style="margin-top:12px;font-size:11px;opacity:.85;border-left:3px solid #ffa500;padding:8px 10px"><strong>–ö–∞–∫ —É—Å—Ç—Ä–æ–µ–Ω—ã –ø—Ä–∏–∑—ã:</strong> –ü—Ä–∏–∑–æ–≤–æ–π —Ñ–æ–Ω–¥ ‚Äî 10% –æ—Ç –ø—Ä–æ—Ñ–∏—Ç–∞ –∫–∞–∑–Ω—ã. –ù–∞–≥—Ä–∞–¥—ã –≤ –∑–≤—ë–∑–¥–∞—Ö –∏ PHXPW —Ñ–æ—Ä–º–∏—Ä—É—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –∏–∑ –≤–∑–Ω–æ—Å–æ–≤ –∏–≥—Ä–æ–∫–æ–≤: –∫—Ç–æ –ø–ª–∞—Ç–∏–ª –∑–≤—ë–∑–¥–∞–º–∏ –∏–ª–∏ —Ç–æ–∫–µ–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–∞, —Ç–æ—Ç –∏ –ø–æ–ª—É—á–∞–µ—Ç —à–∞–Ω—Å –Ω–∞ —Ç–∞–∫–∏–µ –Ω–∞–≥—Ä–∞–¥—ã –≤ —à–∞—Ö—Ç–µ –∏ –∫–µ–π—Å–∞—Ö. –•–∞–ª—è–≤—ã –Ω–µ—Ç ‚Äî –∫—Ç–æ-—Ç–æ –≤—Å–µ–≥–¥–∞ –ø–ª–∞—Ç–∏—Ç; –∏–Ω–≤–µ—Å—Ç–∏—Ä—É—è, –≤—ã –ø–æ–ª—É—á–∞–µ—Ç–µ —Ä–µ–∞–ª—å–Ω—ã–π —à–∞–Ω—Å.</div></div>
<div class="help-section" style="margin-bottom:12px"><h4>üõí –î–æ—Å—Ç—É–ø–Ω—ã–µ –¥–ª—è –ø–æ–∫—É–ø–∫–∏</h4><p style="font-size:12px;opacity:.85;margin-bottom:8px">–û—Ä–¥–µ—Ä–∞ –æ—Ç –¥—Ä—É–≥–∏—Ö –∏–≥—Ä–æ–∫–æ–≤: –∑–¥–µ—Å—å –ø–æ—è–≤—è—Ç—Å—è —Ä–µ–ª–∏–∫–≤–∏–∏, –∫–æ–≥–¥–∞ –∫—Ç–æ-—Ç–æ –≤—ã—Å—Ç–∞–≤–∏—Ç –∏—Ö –Ω–∞ –ø—Ä–æ–¥–∞–∂—É. –ù–∏–∂–µ ‚Äî –≤–∞—à–∏ —Ä–µ–ª–∏–∫–≤–∏–∏ –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏.</p><div id="marketOrdersAvailable"><span style="opacity:.8">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</span></div></div>
<div class="help-section"><h4>‚ú® –í–∞—à–∏ —Ä–µ–ª–∏–∫–≤–∏–∏</h4><p style="font-size:12px;opacity:.8;margin-bottom:10px">–ü—Ä–æ–¥–∞—Ç—å –∑–∞ –º–æ–Ω–µ—Ç—ã –∏–ª–∏ –æ–±—ä–µ–¥–∏–Ω–∏—Ç—å –≤ —Å–ª–∏—è–Ω–∏–∏.</p><div id="marketRelicsList"></div></div>
</div>
<div id="marketAmulets" style="display:none"><div id="marketAmuletsList"></div></div>
<div id="marketDiamonds" style="display:none"><div id="marketDiamondsList"></div></div>
</div>

<div id="pnlScreen" class="screen">
<h2 style="text-align:center;margin-bottom:15px;color:#ffa500;text-shadow:0 0 15px rgba(255,140,0,.5)">üìä PnL</h2>
<p style="text-align:center;font-size:13px;opacity:.9;margin-bottom:12px">–°—Ç–µ–π–∫–∏–Ω–≥, –ø–æ–∫—É–ø–∫–∞ —Ç–æ–∫–µ–Ω–∞ –∏ NFT –æ—Ç –ø—Ä–æ–µ–∫—Ç–∞</p>

<!-- Developer Profile -->
<div id="pnlDevProfile" class="info" style="margin:0 auto 20px;max-width:500px;border:2px solid rgba(255,165,0,.35);background:linear-gradient(135deg,rgba(255,140,0,.12),rgba(255,100,0,.05));border-radius:14px;padding:16px;display:none">
<div style="display:flex;align-items:center;gap:14px;margin-bottom:12px">
<div style="width:56px;height:56px;border-radius:50%;background:linear-gradient(135deg,#ffa500,#ff6b00);display:flex;align-items:center;justify-content:center;font-size:28px;flex-shrink:0">üî•</div>
<div style="flex:1">
<div style="font-size:16px;font-weight:700;color:#ffa500" id="devProfileNick">Phoenix Paw</div>
<div style="font-size:11px;opacity:.7;margin-top:2px" id="devProfileWallet"></div>
</div>
</div>
<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:10px">
<div style="text-align:center;background:rgba(0,0,0,.2);border-radius:10px;padding:8px 4px">
<div style="font-size:18px;font-weight:700;color:#ffa500" id="devCollCount">-</div>
<div style="font-size:10px;opacity:.7">–ö–æ–ª–ª–µ–∫—Ü–∏–π</div>
</div>
<div style="text-align:center;background:rgba(0,0,0,.2);border-radius:10px;padding:8px 4px">
<div style="font-size:18px;font-weight:700;color:#ffa500" id="devNftCount">-</div>
<div style="font-size:10px;opacity:.7">NFT</div>
</div>
<div style="text-align:center;background:rgba(0,0,0,.2);border-radius:10px;padding:8px 4px">
<div style="font-size:18px;font-weight:700;color:#ffa500" id="devLastSync">-</div>
<div style="font-size:10px;opacity:.7">–û–±–Ω–æ–≤–ª–µ–Ω–æ</div>
</div>
</div>
<div id="devCollectionsList" style="font-size:12px;opacity:.85"></div>
</div>

<!-- User's NFT from dev collections -->
<div id="pnlNftBlock" class="info" style="margin:0 auto 20px;max-width:500px;border:2px solid rgba(255,165,0,.35);background:rgba(255,140,0,.08);border-radius:12px;padding:14px">
<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
<div style="font-size:15px;font-weight:700;color:#ffa500">üñºÔ∏è –í–∞—à–∏ NFT –æ—Ç –ø—Ä–æ–µ–∫—Ç–∞</div>
<div id="pnlNftCount" style="font-size:12px;opacity:.8"></div>
</div>
<div id="pnlNftList" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:12px;min-height:28px">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
</div>

<!-- Wallet state -->
<div id="pnlWalletState" class="info" style="margin:0 auto 20px;max-width:400px">
<div style="font-size:14px;font-weight:700;color:#ffa500;margin-bottom:8px">üíº –°–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ—à–µ–ª—å–∫–æ–≤</div>
<div id="pnlWalletBound" style="font-size:13px;opacity:.9">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
<div id="pnlWalletList" style="font-size:12px;opacity:.85;margin-top:8px"></div>
<div id="pnlStakingStatus" style="font-size:12px;opacity:.9;margin-top:8px"></div>
<div id="pnlStakingContracts" style="font-size:11px;opacity:.8;margin-top:6px"></div>
<div id="pnlNftSummary" style="font-size:12px;opacity:.9;margin-top:10px;padding-top:8px;border-top:1px solid rgba(255,140,0,.2)">üñºÔ∏è NFT –æ—Ç –ø—Ä–æ–µ–∫—Ç–∞: –∑–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
</div>
<div class="inv-grid" style="max-width:400px;margin:0 auto">
<div class="inv-item" style="cursor:pointer" onclick="G.openPnlStaking()">
<div style="font-size:48px;margin-bottom:10px">üîí</div>
<div style="font-weight:700;margin-bottom:5px">–°—Ç–µ–π–∫–∏–Ω–≥</div>
<div style="font-size:12px;opacity:.9">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å PHOEX –∏ –ø–æ–ª—É—á–∞—Ç—å –Ω–∞–≥—Ä–∞–¥—ã</div>
</div>
<div class="inv-item" style="cursor:pointer" onclick="G.openPnlBuy()">
<div style="font-size:48px;margin-bottom:10px">üí±</div>
<div style="font-weight:700;margin-bottom:5px">–ü–æ–∫—É–ø–∫–∞</div>
<div style="font-size:12px;opacity:.9">–ö—É–ø–∏—Ç—å —Ç–æ–∫–µ–Ω PHOEX (Swap)</div>
</div>
</div>
</div>

<!-- NFT Detail Modal -->
<div id="nftDetailModal" style="display:none;position:fixed;inset:0;z-index:9999;background:rgba(0,0,0,.85);overflow-y:auto;padding:20px" onclick="if(event.target===this)this.style.display='none'">
<div style="max-width:400px;margin:40px auto;background:#1a1a2e;border:2px solid rgba(255,165,0,.4);border-radius:16px;padding:20px;position:relative">
<button onclick="document.getElementById('nftDetailModal').style.display='none'" style="position:absolute;top:10px;right:14px;background:none;border:none;color:#fff;font-size:22px;cursor:pointer;opacity:.7">&times;</button>
<div id="nftDetailContent"></div>
</div>
</div>

<div id="profileScreen" class="screen">
<h2 style="text-align:center;margin-bottom:15px;color:#ffa500;text-shadow:0 0 15px rgba(255,140,0,.5)">üë§ –ü—Ä–æ—Ñ–∏–ª—å</h2>
<div class="info">
<div style="text-align:center;margin-bottom:15px">
<div style="font-size:60px;margin-bottom:10px">üî•</div>
<div style="font-size:20px;font-weight:700;color:#ffa500" id="profileName">–ò–≥—Ä–æ–∫</div>
<div style="font-size:14px;opacity:.8">–£—Ä–æ–≤–µ–Ω—å –ø–ª–µ–º–µ–Ω–∏: <span id="profileLevel">1</span></div>
</div>
<div class="ir"><span>–í—Å–µ–≥–æ –º–æ–Ω–µ—Ç:</span><span id="profileCoins">0</span></div>
<div class="ir"><span>–í—Å–µ–≥–æ –∞–ª–º–∞–∑–æ–≤:</span><span id="profileGems">0</span></div>
<div class="ir"><span>–ù–∞–π–¥–µ–Ω–æ —Ä–µ–ª–∏–∫–≤–∏–π:</span><span id="profileRelics">0</span></div>
<div class="ir"><span>–≠—Ä–∞:</span><span id="profileEra">1</span></div>
<div class="ir"><span>–ü–æ–∏–Ω—Ç—ã:</span><span id="profilePoints">0</span></div>
<div class="ir"><span>–ú–µ—Å—Ç–æ –≤ —Ä–µ–π—Ç–∏–Ω–≥–µ:</span><span id="profileRank">-</span></div>
</div>
<div id="profileWalletBlock" style="margin:12px 0">
<div style="font-size:14px;font-weight:700;color:#ffa500;margin-bottom:8px">üíº –ö–æ—à–µ–ª—å–∫–∏</div>
<div id="profileWalletsList" class="info" style="margin-bottom:8px"></div>
<div style="display:flex;flex-wrap:wrap;gap:8px;justify-content:center">
<button class="btn btn-small btn-success" id="profileWalletBindBtn" onclick="G.openWalletBindFromProfile()">–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è</button>
<button class="btn btn-small" id="profileWalletAddBtn" style="display:none" onclick="G.openAddWallet()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∫–æ—à–µ–ª—ë–∫</button>
</div>
</div>
<div style="display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin:12px 0">
<button class="btn btn-warning" onclick="G.openWithdraw()">üì§ –í—ã–≤–æ–¥ PHXPW</button>
<button class="btn btn-small" onclick="G.toggleAds()" id="profileAdsBtn">–†–µ–∫–ª–∞–º–∞ –≤–∫–ª/–≤—ã–∫–ª</button>
<button class="btn btn-small" onclick="G.watchAd()">–°–º–æ—Ç—Ä–µ—Ç—å —Ä–µ–∫–ª–∞–º—É</button>
</div>
<div class="info" style="margin-top:15px">
<div style="font-size:14px;font-weight:700;color:#ffa500;margin-bottom:8px">üèÖ –ú–µ–¥–∞–ª–∏ —ç—Ä (–Ω–∞—à–∏–≤–∫–∏)</div>
<div id="profileEraMedals" style="min-height:24px;opacity:.9"></div>
<div id="profileBurnMedal" style="margin-top:8px;font-size:13px;opacity:.9"></div>
<div id="profilePhoenixBadge"></div>
<div style="margin-top:10px;font-size:12px;opacity:.8">–ó–∞ –∫–∞–∂–¥—É—é —ç—Ä—É —É—á–∞—Å—Ç–Ω–∏–∫–∞–º –≤—ã–¥–∞—ë—Ç—Å—è –º–µ–¥–∞–ª—å. –í—ã–≤–æ–¥ –Ω–∞ –∫–æ—à–µ–ª—ë–∫ (SBT) ‚Äî –∫–Ω–æ–ø–∫–∞ –Ω–∏–∂–µ.</div>
<button class="btn btn-small" style="margin-top:8px" onclick="G.exportSBT()">–í—ã–≤–æ–¥ –º–µ–¥–∞–ª–µ–π –Ω–∞ –∫–æ—à–µ–ª—ë–∫ (SBT)</button>
</div>

<h3 style="margin:20px 0;color:#ffa500">üì¶ –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</h3>
<div class="info" style="margin-bottom:10px">
<div style="font-size:13px;opacity:.95">–†–µ–ª–∏–∫–≤–∏–∏: <span id="invRelics">0</span> ¬∑ –ê–º—É–ª–µ—Ç—ã: <span id="invAmulets">0</span> ¬∑ –ë–∞—Ñ—ã: <span id="invBuffs">0</span> ¬∑ –ü–æ—Ä—á–∏: <span id="invCurses">0</span> ¬∑ –Ø–π—Ü–∞: <span id="invEggs">0</span> ¬∑ –ë—É–∫–≤—ã: <span id="invLetters">0</span></div>
</div>
<button class="btn btn-success" onclick="G.showScreen('inventory')">–û—Ç–∫—Ä—ã—Ç—å –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å</button>
</div>

<div id="inventoryScreen" class="screen">
<h2 style="text-align:center;margin-bottom:15px;color:#ffa500;text-shadow:0 0 15px rgba(255,140,0,.5)">üéí –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</h2>
<div style="display:flex;flex-wrap:wrap;align-items:center;gap:10px;justify-content:center;margin:12px 0">
<label style="font-size:13px;opacity:.9">–ü–æ–∫–∞–∑–∞—Ç—å:</label>
<select id="invFilterSelect" class="btn btn-small" style="min-width:200px;cursor:pointer" onchange="G.applyInvFilter()">
<option value="all">–ë–µ–∑ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ (–ø–æ–ª–æ—Ç–Ω–æ)</option>
<option value="relics">‚ú® –†–µ–ª–∏–∫–≤–∏–∏</option>
<option value="amulets">üîÆ –ê–º—É–ª–µ—Ç—ã</option>
<option value="buffs">‚ö° –ë–∞—Ñ—ã</option>
<option value="curses">üïØ –ü–æ—Ä—á–∏</option>
<option value="eggs">ü•ö –Ø–π—Ü–∞</option>
<option value="letters">üî§ –ë—É–∫–≤—ã</option>
</select>
</div>
<div style="display:flex;flex-wrap:wrap;gap:8px;justify-content:center;align-items:center;margin:10px 0">
<button type="button" class="btn btn-small" onclick="G.invPutInBuilding()" title="–ü–æ—Å—Ç–∞–≤–∏—Ç—å –≤ –∑–¥–∞–Ω–∏–µ">üè†</button>
<button type="button" class="btn btn-small" onclick="G.invSell()" title="–ü—Ä–æ–¥–∞—Ç—å">üè™</button>
<button type="button" class="btn btn-small" onclick="G.invMerge()" title="–°–ª–∏—è–Ω–∏–µ">üîÄ</button>
<button type="button" class="btn btn-small" onclick="G.invPlaceOrder()" title="–†–∞–∑–º–µ—Å—Ç–∏—Ç—å –æ—Ä–¥–µ—Ä">üìã</button>
<button type="button" class="btn btn-small btn-success" onclick="G.showInvLetters()" title="–ö–≤–µ—Å—Ç –§–µ–Ω–∏–∫—Å (–±—É–∫–≤—ã)">üî§</button>
</div>
<p style="font-size:11px;opacity:.6;text-align:center;margin-top:4px">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç –≤ —Å–ø–∏—Å–∫–µ ‚Äî –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –∫–∞—Ä—Ç–æ—á–∫–∞ —Å –¥–µ–π—Å—Ç–≤–∏—è–º–∏</p>
<div id="inventoryTabContent" class="inv-grid" style="margin-top:15px"></div>
</div>

<div id="tasksScreen" class="screen">
<h2 style="text-align:center;margin-bottom:15px;color:#ffa500;text-shadow:0 0 15px rgba(255,140,0,.5)">üìã –ó–∞–¥–∞–Ω–∏—è / –ù–∞–≥—Ä–∞–¥—ã</h2>

<div class="checkin-card">
<div style="font-size:20px;font-weight:700;color:#ffa500;margin-bottom:15px">‚è∞ –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –ß–µ–∫–∏–Ω</div>
<div style="font-size:14px;margin-bottom:10px">–ü–æ–ª—É—á–∞–π –ø–æ–ø—ã—Ç–∫–∏ –∫–æ–ø–∞–Ω–∏—è –∫–∞–∂–¥—ã–µ 10 —á–∞—Å–æ–≤!</div>
<div style="font-size:16px;font-weight:700;margin:15px 0">–ü–æ–ø—ã—Ç–æ–∫: <span id="checkinDigs">3</span>/3</div>
<div style="font-size:14px;margin-bottom:15px" id="checkinTimer">–î–æ—Å—Ç—É–ø–Ω–æ —Å–µ–π—á–∞—Å!</div>
<div style="background:rgba(0,0,0,.3);padding:15px;border-radius:10px;margin:15px 0">
<div style="font-size:14px;font-weight:700;color:#ffa500;margin-bottom:10px">üìä –í–∞—à–∞ –ø–æ–∑–∏—Ü–∏—è</div>
<div style="font-size:24px;font-weight:900;color:#ff8c00;margin:10px 0">–ú–µ—Å—Ç–æ: <span id="myRank">-</span></div>
<div style="font-size:12px;opacity:.8">–∏–∑ <span id="totalPlayers">0</span> –∏–≥—Ä–æ–∫–æ–≤</div>
</div>
<button class="checkin-btn" id="checkinBtn" onclick="G.doCheckin()">‚úÖ –ü–û–õ–£–ß–ò–¢–¨ –ü–û–ü–´–¢–ö–ò</button>
</div>

<div class="checkin-card" style="margin-top:20px">
<div style="font-size:18px;font-weight:700;color:#ffa500;margin-bottom:12px">üì¢ –ü–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ –∫–∞–Ω–∞–ª—ã</div>
<div style="font-size:12px;opacity:.8;margin-bottom:12px">–ü–æ–¥–ø–∏—à–∏—Ç–µ—Å—å –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–ü—Ä–æ–≤–µ—Ä–∏—Ç—å¬ª –¥–ª—è –Ω–∞–≥—Ä–∞–¥—ã</div>
<div id="subsTasksList"></div>
</div>

<div class="checkin-card" style="margin-top:20px">
<div style="font-size:18px;font-weight:700;color:#ffa500;margin-bottom:12px">üîó –ü—Ä–∏–≤—è–∑–∫–∞ –∫–æ—à–µ–ª—å–∫–∞ TON</div>
<div style="font-size:12px;opacity:.8;margin-bottom:10px">–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è: 0.1 TON –∏–ª–∏ 4500 PHXPW —Å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–º –Ω–∞ –∞–¥—Ä–µ—Å –ø—Ä–æ–µ–∫—Ç–∞. –ù–∞–∂–º–∏—Ç–µ ¬´–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è¬ª, –≤—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –∏ ¬´–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∏–≤—è–∑–∫—É¬ª –ø–æ—Å–ª–µ –ø–µ—Ä–µ–≤–æ–¥–∞.</div>
<div id="walletBindStatus" style="margin:10px 0;font-weight:700"></div>
<button class="btn btn-warning" id="walletBindBtn" onclick="G.openAuthModal()">–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è</button>
<div style="margin-top:10px"><button class="btn btn-small" onclick="G.verifyWalletBind()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∏–≤—è–∑–∫—É</button></div>
</div>
</div>

<div id="ratingScreen" class="screen">
<h2 style="text-align:center;margin-bottom:15px;color:#ffa500;text-shadow:0 0 15px rgba(255,140,0,.5)">üèÜ –†–µ–π—Ç–∏–Ω–≥</h2>
<div style="display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin:10px 0">
<button class="btn btn-small btn-success" id="ratingTabEra" onclick="G.switchRatingPeriod('era')">–≠—Ä–∞</button>
<button class="btn btn-small" id="ratingTabWeek" onclick="G.switchRatingPeriod('week')">–ù–µ–¥–µ–ª—è</button>
<button class="btn btn-small" id="ratingTabMonth" onclick="G.switchRatingPeriod('month')">–ú–µ—Å—è—Ü</button>
</div>
<div class="info"><div class="ir"><span>–ü—Ä–∏–∑–æ–≤–æ–π —Ñ–æ–Ω–¥ (10% –æ—Ç –ø—Ä–æ—Ñ–∏—Ç–∞ –∫–∞–∑–Ω—ã, weekly cap):</span><span style="color:#ffa500;font-weight:700" id="prizePool">0 PHXPW</span></div></div>
<div style="text-align:center;margin:15px 0">
<button class="btn btn-success" onclick="G.showFullLeaderboard()">üìã –ü–æ–ª–Ω—ã–π –õ–∏–¥–µ—Ä–±–æ—Ä–¥</button>
</div>
<div id="leaderboard"></div>
</div>

<div class="nav nav-six">
<div class="ni active" data-screen="village" onclick="G.showScreen('village')"><div class="nic">üèòÔ∏è</div><div class="nil">–ü–ª–µ–º—è</div></div>
<div class="ni" data-screen="mine" onclick="G.showScreen('mine')"><div class="nic">‚õèÔ∏è</div><div class="nil">–®–∞—Ö—Ç–∞</div></div>
<div class="ni" data-screen="inventory" onclick="G.showScreen('inventory')"><div class="nic">üéí</div><div class="nil">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</div></div>
<div class="ni" data-screen="market" onclick="G.showScreen('market')"><div class="nic">üè™</div><div class="nil">–ú–∞—Ä–∫–µ—Ç</div></div>
<div class="ni" data-screen="profile" onclick="G.showScreen('profile')"><div class="nic">üë§</div><div class="nil">–ü—Ä–æ—Ñ–∏–ª—å</div></div>
<div class="ni" data-screen="pnl" onclick="G.showScreen('pnl')"><div class="nic">üìä</div><div class="nil">PnL</div></div>
</div>
</div>

<div id="buildingModal" class="modal"><div class="mc"><button class="mcl" onclick="G.closeBuildingModal()">√ó</button><div class="mt" id="bmt">–ü–æ—Å—Ç—Ä–æ–π–∫–∞</div><div id="bmc"></div></div></div>
<div id="mergeModal" class="modal"><div class="mc"><button class="mcl" onclick="G.closeM('mergeModal')">√ó</button><div class="mt">üîÆ –°–ª–∏—è–Ω–∏–µ –†–µ–ª–∏–∫–≤–∏–π</div><div id="mmc"></div></div></div>
<div id="invModal" class="modal"><div class="mc"><button class="mcl" onclick="G.closeM('invModal')">√ó</button><div class="mt" id="invmt">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</div><div id="invmc"></div></div></div>
<div id="itemCardModal" class="modal"><div class="mc" style="max-width:380px"><button class="mcl" onclick="G.closeItemCard()">√ó</button><div class="mt" id="itemCardTitle">–ü—Ä–µ–¥–º–µ—Ç</div><div id="itemCardContent"></div></div></div>
<div id="txModal" class="modal"><div class="mc"><button class="mcl" onclick="G.closeM('txModal')">√ó</button><div class="mt" id="txmt">–ü–æ–∫—É–ø–∫–∞</div><div id="txmc"></div></div></div>
<div id="leaderboardModal" class="modal"><div class="mc"><button class="mcl" onclick="G.closeM('leaderboardModal')">√ó</button><div class="mt">üèÜ –ü–æ–ª–Ω—ã–π –õ–∏–¥–µ—Ä–±–æ—Ä–¥</div><div id="lbmc"></div></div></div>
<div id="rewardModal" class="modal"><div class="mc"><button class="mcl" onclick="G.closeM('rewardModal')">√ó</button><div class="mt" id="rwmt">–ù–∞–≥—Ä–∞–¥–∞!</div><div id="rwmc"></div></div></div>
<div id="helpModal" class="modal"><div class="mc" style="max-width:520px"><button class="mcl" onclick="G.closeM('helpModal')">√ó</button><div class="mt">üìñ –û–±—É—á–µ–Ω–∏–µ</div><div id="helpmc"></div></div></div>
<div id="aboutModal" class="modal"><div class="mc" style="max-width:560px"><button class="mcl" onclick="G.closeM('aboutModal')">√ó</button><div class="mt">‚ÑπÔ∏è –û –ø—Ä–æ–µ–∫—Ç–µ</div><div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:12px" id="aboutTabs"></div><div id="aboutmc" style="max-height:70vh;overflow-y:auto;padding:8px 0"></div></div></div>
<div id="authModal" class="modal"><div class="mc" style="max-width:420px"><button class="mcl" onclick="G.closeM('authModal')">√ó</button><div class="mt">–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</div><div id="authModalBody" style="padding:8px 0"><div style="font-size:13px;opacity:.95;margin-bottom:12px">–ü—Ä–∏–≤—è–∑–∫–∞ –∫–æ—à–µ–ª—å–∫–∞: –æ—Ç–ø—Ä–∞–≤—å—Ç–µ <strong>0.1 TON</strong> –∏–ª–∏ <strong>4500 PHXPW</strong> —Å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–º –Ω–∞ –∞–¥—Ä–µ—Å –ø—Ä–æ–µ–∫—Ç–∞. –ü–æ—Å–ª–µ –ø–µ—Ä–µ–≤–æ–¥–∞ –Ω–∞–∂–º–∏—Ç–µ ¬´–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∏–≤—è–∑–∫—É¬ª.</div><div style="display:flex;flex-direction:column;gap:10px"><button class="btn btn-warning" id="authModalOpenTon" onclick="G.openTonkeeperFromAuthModal('ton')">üì§ 0.1 TON</button><button class="btn btn-success" id="authModalOpenPhxpw" onclick="G.openTonkeeperFromAuthModal('phxpw')">üì§ 4500 PHXPW</button><a href="#" style="font-size:12px;opacity:.85" onclick="G.openTonkeeperFallback(false); return false;">–ù–µ –æ—Ç–∫—Ä—ã–ª–æ—Å—å? 0.1 TON –≤ –±—Ä–∞—É–∑–µ—Ä–µ</a> <a href="#" style="font-size:12px;opacity:.85" onclick="G.openTonkeeperFallback(true); return false;">4500 PHXPW –≤ –±—Ä–∞—É–∑–µ—Ä–µ</a><button class="btn btn-small" onclick="G.verifyWalletBind()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∏–≤—è–∑–∫—É</button></div></div></div></div>

<div id="notif" class="notif"></div>

<script>
const G={
d:{
gems:0,coins:1000,wood:100,stone:100,era:1,eraStart:Date.now(),vLevel:1,skyFall:false,skyStart:null,lossMult:1,buildings:[],mineBlocks:[],relicsFound:0,relics:[],amulets:[],buffs:[],digsLeft:3,lastCheckin:null,nextCheckinAt:null,
exp:0,level:0,createdAt:Date.now(),actions:0,weekId:null,weeklyScore:0,withdrawsThisWeek:0,lock:{active:false,amount:0,until:0},kyc:{verified:false},sellDay:null,sellsToday:0,
walletBound:false,walletVerifyCode:null,subscribedChannels:{phxpw:false,ludoman:false,kriptobratv:false},points:0,eraMedals:[],mineHintIndices:[],mineScanActive:false,phoenixEyeActive:false,
burnedCount:0,letters:[],phoenixQuestCompleted:false,mineHistory:[],army:0,supplies:0
},
PHOENIX_WORD:'–§–ï–ù–ò–ö–°',
RUS_ALPHABET:'–ê–ë–í–ì–î–ï–Å–ñ–ó–ò–ô–ö–õ–ú–ù–û–ü–†–°–¢–£–§–•–¶–ß–®–©–™–´–¨–≠–Æ–Ø',
tonWallet:'UQD6RieTjAKQckERVNlCtSlGOgdfsmCAgLI2abAVz_tl3nuz',
nftDevWallet:'UQCFBaCdPYEnNVrk9BcplNWGzxXxd2JSOTKDFm4pU0PmxySD',
walletBindAmountTON:0.1,
PHXPW_PRICE_TON:0.00002412,
tonPriceUsd:1.47,
PHOEX_JETTON_MASTER:'EQABtSLSzrAOISWPfIjBl2VmeStkM1eHaPrUxRTj8mY-9h43',
subsChannels:[
{id:'phoenix_channel',name:'Phoenix PHOEX ‚Äî –∫–∞–Ω–∞–ª',url:'https://t.me/PHXPW',reward:{gems:5,points:50}},
{id:'phoenix_chat',name:'Phoenix ‚Äî —á–∞—Ç',url:'https://t.me/phxpwchat',reward:{gems:5,points:50}},
{id:'phoenix_reward',name:'Phoenix Reward',url:'https://t.me/+PPW1fH5sefM4NTEy',reward:{gems:8,points:80}},
{id:'phoenix_lucky',name:'Phoenix Lucky',url:'https://t.me/+OwQ7nEHLIkA2ZDJi',reward:{gems:5,points:50}},
{id:'whales',name:'–ß–∞—Ç –∫–∏—Ç–æ–≤ Phoenix (5000 PHOEX)',url:'https://t.me/+1930JmDV1DVjMDM8',reward:{gems:10,points:100}},
{id:'premium_club',name:'–ü—Ä–µ–º–∏—É–º –∫–ª—É–± Phoenix (30$/–º–µ—Å)',url:'https://t.me/+X3yGXxrQ7Fs3NzY0',reward:{gems:15,points:150}}
],
gemsCosts:{digs5:10,checkinNow:15,hint:5,fullScan:15,phoenixEye:25,exp100:20},
POINTS_PER_TON:10,
COIN_TO_TON:320,
basePriceByRarity:{fire:80,yin:150,yan:280,tsy:600,magic:1500,epic:5000},
pointsPerCoin:10,
myPlayerId:null,
API_BASE:(typeof window.GAME_API_BASE!=='undefined'?window.GAME_API_BASE:''),
allPlayers:[],
_wsOnline:null,
_wsReconnectDelay:1000,

raritySystem:{
epic:{name:'–≠–ø–∏—á–µ—Å–∫–∏–π',color:'#9b59b6',chance:0.001,dropWeight:1,items:[]},
magic:{name:'–ú–∞–≥–∏—á–µ—Å–∫–∏–π',color:'#3498db',chance:0.01,dropWeight:10,items:[]},
tsy:{name:'–¶—ã',color:'#2ecc71',chance:0.08,dropWeight:8,items:[]},
yan:{name:'–Ø–Ω—å',color:'#f39c12',chance:0.15,dropWeight:15,items:[]},
yin:{name:'–ò–Ω—å',color:'#7f8c8d',chance:0.26,dropWeight:26,items:[]},
fire:{name:'–ê–ª—ã–π –û–≥–æ–Ω—å',color:'#ff4500',chance:0.50,dropWeight:50,items:[]}
},

buildingTypes:{
townhall:{n:'–†–∞—Ç—É—à–∞',i:'üèõÔ∏è',inc:4,c:{wood:50,stone:50,coins:100},d:'–¶–µ–Ω—Ç—Ä —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–µ—Ä–µ–≤–Ω–µ–π. –û—Ç–∫—Ä—ã–≤–∞–µ—Ç –Ω–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Å –∫–∞–∂–¥—ã–º —É—Ä–æ–≤–Ω–µ–º.',b:'–î–æ—Ö–æ–¥ –º–æ–Ω–µ—Ç, —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Ñ—É–Ω–∫—Ü–∏–π'},
houses:{n:'–î–æ–º–∞',i:'üè†',inc:8,c:{wood:20,stone:10,coins:50},d:'–ñ–∏–ª—ã–µ –¥–æ–º–∞ –¥–ª—è –∂–∏—Ç–µ–ª–µ–π. –ß–µ–º –±–æ–ª—å—à–µ –∂–∏—Ç–µ–ª–µ–π ‚Äî —Ç–µ–º –≤—ã—à–µ –¥–æ—Ö–æ–¥.',b:'–í—ã—Å–æ–∫–∏–π –ø–∞—Å—Å–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥ –º–æ–Ω–µ—Ç'},
farm:{n:'–§–µ—Ä–º–∞',i:'üåæ',inc:10,c:{wood:30,stone:15,coins:75},d:'–õ—É—á—à–∏–π –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–æ—Ö–æ–¥–∞. –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç –µ–¥—É –∏ –ø—Ä–∏–Ω–æ—Å–∏—Ç —Å—Ç–∞–±–∏–ª—å–Ω—ã–π –∑–∞—Ä–∞–±–æ—Ç–æ–∫.',b:'–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –ø–∞—Å—Å–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥'},
market:{n:'–†—ã–Ω–æ–∫',i:'üè™',inc:6,c:{wood:40,stone:30,coins:200},d:'–¢–æ—Ä–≥–æ–≤–∞—è –ø–ª–æ—â–∞–¥—å. –ü–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ–∫—É–ø–∞—Ç—å –∏ –ø—Ä–æ–¥–∞–≤–∞—Ç—å –ø—Ä–µ–¥–º–µ—Ç—ã –º–µ–∂–¥—É –∏–≥—Ä–æ–∫–∞–º–∏.',b:'–î–æ—Ö–æ–¥ + —Ç–æ—Ä–≥–æ–≤–ª—è –ø—Ä–µ–¥–º–µ—Ç–∞–º–∏'},
warehouse:{n:'–°–∫–ª–∞–¥',i:'üì¶',inc:0,c:{wood:25,stone:25,coins:80},d:'–£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –∑–∞–ø–∞—Å —Ä–µ—Å—É—Ä—Å–æ–≤. –ó–∞—â–∏—â–∞–µ—Ç —á–∞—Å—Ç—å —Ä–µ—Å—É—Ä—Å–æ–≤ –æ—Ç –æ–≥—Ä–∞–±–ª–µ–Ω–∏—è.',b:'–ó–∞—â–∏—Ç–∞ —Ä–µ—Å—É—Ä—Å–æ–≤ –æ—Ç –∫—Ä–∞–∂–∏'},
lumbermill:{n:'–õ–µ—Å–æ–ø–∏–ª–∫–∞',i:'ü™µ',inc:6,c:{wood:25,stone:20,coins:100},d:'–ü–µ—Ä–µ—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –¥—Ä–µ–≤–µ—Å–∏–Ω—É. –ü—Ä–∏–Ω–æ—Å–∏—Ç —Å—Ç–∞–±–∏–ª—å–Ω—ã–π –¥–æ—Ö–æ–¥ –∏ –±–æ–Ω—É—Å –∫ –¥–æ–±—ã—á–µ –¥–µ—Ä–µ–≤–∞.',b:'–î–æ—Ö–æ–¥ + –±–æ–Ω—É—Å –∫ –¥–æ–±—ã—á–µ –¥–µ—Ä–µ–≤–∞'},
quarry:{n:'–ö–∞–º–µ–Ω–æ–ª–æ–º–Ω—è',i:'ü™®',inc:4,c:{wood:20,stone:25,coins:100},d:'–î–æ–±—ã–≤–∞–µ—Ç –∫–∞–º–µ–Ω—å –∏–∑ –Ω–µ–¥—Ä. –ü—Ä–∏–Ω–æ—Å–∏—Ç –¥–æ—Ö–æ–¥ –∏ –±–æ–Ω—É—Å –∫ –¥–æ–±—ã—á–µ –∫–∞–º–Ω—è.',b:'–î–æ—Ö–æ–¥ + –±–æ–Ω—É—Å –∫ –¥–æ–±—ã—á–µ –∫–∞–º–Ω—è'},
mine_office:{n:'–®–∞—Ö—Ç–Ω—ã–π –æ—Ñ–∏—Å',i:'‚õèÔ∏è',inc:1,c:{wood:30,stone:30,coins:120},d:'–£–ø—Ä–∞–≤–ª—è–µ—Ç —à–∞—Ö—Ç–∞–º–∏. –£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –Ω–∞–≥—Ä–∞–¥—ã –∑–∞ –∫–æ–ø–∞–Ω–∏–µ –∏ —à–∞–Ω—Å —Ä–µ–¥–∫–∏—Ö –Ω–∞—Ö–æ–¥–æ–∫.',b:'–ë–æ–Ω—É—Å –∫ —à–∞—Ö—Ç–µ, —à–∞–Ω—Å —Ä–µ–¥–∫–∏—Ö –Ω–∞—Ö–æ–¥–æ–∫'},
forge:{n:'–ö—É–∑–Ω–∏—Ü–∞',i:'‚öíÔ∏è',inc:2,c:{wood:40,stone:40,coins:150},d:'–°–æ–∑–¥–∞—ë—Ç –∏ —É–ª—É—á—à–∞–µ—Ç –æ—Ä—É–∂–∏–µ, –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã. –û—Ç–∫—Ä—ã–≤–∞–µ—Ç –∫—Ä–∞—Ñ—Ç —Ä–µ–ª–∏–∫–≤–∏–π.',b:'–ö—Ä–∞—Ñ—Ç, —É–ª—É—á—à–µ–Ω–∏–µ —Ä–µ–ª–∏–∫–≤–∏–π'},
temple:{n:'–•—Ä–∞–º',i:'‚õ™',inc:1,c:{wood:50,stone:50,coins:300},d:'–î—É—Ö–æ–≤–Ω—ã–π —Ü–µ–Ω—Ç—Ä. –î–∞—ë—Ç –±–æ–Ω—É—Å –∫ –æ–ø—ã—Ç—É –∏ —É—Å–∏–ª–∏–≤–∞–µ—Ç –≤—Å–µ –º–∞–≥–∏—á–µ—Å–∫–∏–µ —ç—Ñ—Ñ–µ–∫—Ç—ã.',b:'–ë–æ–Ω—É—Å –∫ –æ–ø—ã—Ç—É, —É—Å–∏–ª–µ–Ω–∏–µ –º–∞–≥–∏–∏'},
guard_post:{n:'–°—Ç—Ä–∞–∂-–ø–æ—Å—Ç',i:'üõ°Ô∏è',inc:0,c:{wood:35,stone:35,coins:100},d:'–û—Ö—Ä–∞–Ω—è–µ—Ç –¥–µ—Ä–µ–≤–Ω—é. –°–Ω–∏–∂–∞–µ—Ç –ø–æ—Ç–µ—Ä–∏ –ø—Ä–∏ –æ–≥—Ä–∞–±–ª–µ–Ω–∏–∏ –∏ –æ—Ç–ø—É–≥–∏–≤–∞–µ—Ç –≤–æ—Ä–æ–≤.',b:'–ó–∞—â–∏—Ç–∞ –æ—Ç –æ–≥—Ä–∞–±–ª–µ–Ω–∏–π'},
watchtower:{n:'–ë–∞—à–Ω—è –Ω–∞–±–ª—é–¥–µ–Ω–∏—è',i:'üóº',inc:0,c:{wood:40,stone:30,coins:120},d:'–û–±–∑–æ—Ä–Ω–∞—è –±–∞—à–Ω—è. –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞–µ—Ç –æ –Ω–∞–ø–∞–¥–µ–Ω–∏—è—Ö –∏ –¥–∞—ë—Ç –±–æ–Ω—É—Å –∫ —Ä–∞–∑–≤–µ–¥–∫–µ.',b:'–†–∞–Ω–Ω–µ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ, —Ä–∞–∑–≤–µ–¥–∫–∞'},
infirmary:{n:'–õ–∞–∑–∞—Ä–µ—Ç',i:'üè•',inc:0,c:{wood:30,stone:40,coins:110},d:'–õ–µ—á–∏—Ç —Ä–∞–Ω–µ–Ω—ã—Ö. –£—Å–∫–æ—Ä—è–µ—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ –∞—Ç–∞–∫ –∏ —Å–Ω–∏–∂–∞–µ—Ç –ø–æ—Ç–µ—Ä–∏.',b:'–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ –∞—Ç–∞–∫'},
academy:{n:'–ê–∫–∞–¥–µ–º–∏—è',i:'üìö',inc:2,c:{wood:35,stone:35,coins:140},d:'–¶–µ–Ω—Ç—Ä –æ–±—É—á–µ–Ω–∏—è. –£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –ø–æ–ª—É—á–∞–µ–º—ã–π –æ–ø—ã—Ç –∏ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è.',b:'–ë–æ–Ω—É—Å –∫ –æ–ø—ã—Ç—É, –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è'},
workshop:{n:'–ú–∞—Å—Ç–µ—Ä—Å–∫–∞—è',i:'üî®',inc:1,c:{wood:35,stone:35,coins:150},d:'–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∏ —É–ª—É—á—à–∞–µ—Ç –∑–¥–∞–Ω–∏—è. –°–Ω–∏–∂–∞–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç—å —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞.',b:'–°–∫–∏–¥–∫–∞ –Ω–∞ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ'},
alchemy:{n:'–ê–ª—Ö–∏–º–∏—á–µ—Å–∫–∞—è',i:'‚öóÔ∏è',inc:1,c:{wood:40,stone:30,coins:130},d:'–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è –∑–µ–ª–∏–π. –°–æ–∑–¥–∞—ë—Ç –±–∞—Ñ—ã –∏ —É—Å–∏–ª–µ–Ω–∏—è –¥–ª—è —ç–∫—Å–ø–µ–¥–∏—Ü–∏–π.',b:'–°–æ–∑–¥–∞–Ω–∏–µ –∑–µ–ª–∏–π –∏ –±–∞—Ñ–æ–≤'},
post_office:{n:'–ü–æ—á—Ç–∞',i:'üìÆ',inc:0,c:{wood:25,stone:25,coins:90},d:'–ü–æ—á—Ç–æ–≤–∞—è —Å–ª—É–∂–±–∞. –û—Ç–∫—Ä—ã–≤–∞–µ—Ç –æ–±–º–µ–Ω –ø–∏—Å—å–º–∞–º–∏ –∏ –ø–æ–¥–∞—Ä–∫–∞–º–∏ –º–µ–∂–¥—É –∏–≥—Ä–æ–∫–∞–º–∏.',b:'–û–±–º–µ–Ω –ø–æ–¥–∞—Ä–∫–∞–º–∏'},
portal:{n:'–ü–æ—Ä—Ç–∞–ª',i:'üåÄ',inc:0,c:{wood:50,stone:50,coins:200},d:'–ú–∞–≥–∏—á–µ—Å–∫–∏–π –ø–æ—Ä—Ç–∞–ª. –û—Ç–∫—Ä—ã–≤–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –æ—Å–æ–±—ã–º –º–∏—Ä–∞–º –∏ —ç–≤–µ–Ω—Ç–∞–º.',b:'–î–æ—Å—Ç—É–ø –∫ —Å–ø–µ—Ü—Å–æ–±—ã—Ç–∏—è–º'},
treasury:{n:'–ö–∞–∑–Ω–∞',i:'üè¶',inc:1,c:{wood:35,stone:35,coins:120},d:'–•—Ä–∞–Ω–∏–ª–∏—â–µ –±–æ–≥–∞—Ç—Å—Ç–≤. –ù–∞—á–∏—Å–ª—è–µ—Ç –ø—Ä–æ—Ü–µ–Ω—Ç –Ω–∞ –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–µ –º–æ–Ω–µ—Ç—ã.',b:'–ü—Ä–æ—Ü–µ–Ω—Ç –Ω–∞ –º–æ–Ω–µ—Ç—ã'},
firebrigade:{n:'–ü–æ–∂–∞—Ä–Ω–∞—è',i:'üöí',inc:0,c:{wood:40,stone:30,coins:110},d:'–ó–∞—â–∏—â–∞–µ—Ç –æ—Ç –ø–æ–∂–∞—Ä–æ–≤ –∏ —Å—Ç–∏—Ö–∏–π–Ω—ã—Ö –±–µ–¥—Å—Ç–≤–∏–π. –°–Ω–∏–∂–∞–µ—Ç —É—Ä–æ–Ω –æ—Ç –∫–∞—Ç–∞—Å—Ç—Ä–æ—Ñ.',b:'–ó–∞—â–∏—Ç–∞ –æ—Ç —Å—Ç–∏—Ö–∏–π–Ω—ã—Ö –±–µ–¥—Å—Ç–≤–∏–π'},
well:{n:'–ö–æ–ª–æ–¥–µ—Ü',i:'ü™£',inc:0,c:{wood:20,stone:30,coins:80},d:'–ò—Å—Ç–æ—á–Ω–∏–∫ –≤–æ–¥—ã. –£—Å–∫–æ—Ä—è–µ—Ç —Ä–æ—Å—Ç –∑–¥–∞–Ω–∏–π –∏ —Å–Ω–∏–∂–∞–µ—Ç –≤—Ä–µ–º—è –ø–µ—Ä–µ–∑–∞—Ä—è–¥–æ–∫.',b:'–£—Å–∫–æ—Ä–µ–Ω–∏–µ –∫—É–ª–¥–∞—É–Ω–æ–≤'},
trade_guild:{n:'–¢–æ—Ä–≥–æ–≤–∞—è –≥–∏–ª—å–¥–∏—è',i:'ü§ù',inc:2,c:{wood:40,stone:30,coins:160},d:'–û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ —Ç–æ—Ä–≥–æ–≤—Ü–µ–≤. –°–Ω–∏–∂–∞–µ—Ç –∫–æ–º–∏—Å—Å–∏—é –ø—Ä–∏ —Ç–æ—Ä–≥–æ–≤–ª–µ –∏ —É–ª—É—á—à–∞–µ—Ç —Ü–µ–Ω—ã.',b:'–°–Ω–∏–∂–µ–Ω–∏–µ –∫–æ–º–∏—Å—Å–∏–∏, –ª—É—á—à–∏–µ —Ü–µ–Ω—ã'},
auction_house:{n:'–ê—É–∫—Ü–∏–æ–Ω–Ω—ã–π –¥–æ–º',i:'üî®',inc:2,c:{wood:45,stone:35,coins:180},d:'–ê—É–∫—Ü–∏–æ–Ω —Ä–µ–¥–∫–∏—Ö –ø—Ä–µ–¥–º–µ—Ç–æ–≤. –û—Ç–∫—Ä—ã–≤–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∫ —ç–∫—Å–∫–ª—é–∑–∏–≤–Ω—ã–º –ª–æ—Ç–∞–º.',b:'–î–æ—Å—Ç—É–ø –∫ —Ä–µ–¥–∫–∏–º –ª–æ—Ç–∞–º'},
caravan:{n:'–ö–∞—Ä–∞–≤–∞–Ω-—Å–∞—Ä–∞–π',i:'üê™',inc:1,c:{wood:35,stone:25,coins:130},d:'–¢–æ—Ä–≥–æ–≤—ã–π –∫–∞—Ä–∞–≤–∞–Ω. –ü—Ä–∏–Ω–æ—Å–∏—Ç —Å–ª—É—á–∞–π–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã –∏ –±–æ–Ω—É—Å—ã –∏–∑ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–π.',b:'–°–ª—É—á–∞–π–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã –∏ –±–æ–Ω—É—Å—ã'},
arena:{n:'–ê—Ä–µ–Ω–∞',i:'‚öîÔ∏è',inc:2,c:{wood:50,stone:40,coins:200},d:'–ë–æ–µ–≤–∞—è –∞—Ä–µ–Ω–∞. –û—Ç–∫—Ä—ã–≤–∞–µ—Ç PvP-—Å—Ä–∞–∂–µ–Ω–∏—è –∏ —Ç—É—Ä–Ω–∏—Ä—ã —Å –Ω–∞–≥—Ä–∞–¥–∞–º–∏.',b:'PvP-–±–æ–∏, —Ç—É—Ä–Ω–∏—Ä—ã'},
contracts_board:{n:'–î–æ—Å–∫–∞ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤',i:'üìã',inc:1,c:{wood:30,stone:30,coins:120},d:'–î–æ—Å–∫–∞ –∑–∞–∫–∞–∑–æ–≤. –û—Ç–∫—Ä—ã–≤–∞–µ—Ç –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è —Å –Ω–∞–≥—Ä–∞–¥–∞–º–∏.',b:'–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è'},
egg_shrine:{n:'–°–≤—è—Ç–∏–ª–∏—â–µ —è–∏—Ü',i:'ü•ö',inc:0,c:{wood:35,stone:35,coins:100},d:'–ú–∏—Å—Ç–∏—á–µ—Å–∫–æ–µ —Å–≤—è—Ç–∏–ª–∏—â–µ. –£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —à–∞–Ω—Å –Ω–∞–π—Ç–∏ —è–π—Ü–∞ –§–µ–Ω–∏–∫—Å–∞.',b:'–®–∞–Ω—Å —è–∏—Ü –§–µ–Ω–∏–∫—Å–∞'},
incubator:{n:'–ò–Ω–∫—É–±–∞—Ç–æ—Ä',i:'üê£',inc:0,c:{wood:30,stone:30,coins:110},d:'–í—ã—Å–∏–∂–∏–≤–∞–µ—Ç –ø–∏—Ç–æ–º—Ü–µ–≤ –∏–∑ —è–∏—Ü. –û—Ç–∫—Ä—ã–≤–∞–µ—Ç —Å–∏—Å—Ç–µ–º—É –ø–µ—Ç–æ–≤-–ø–æ–º–æ—â–Ω–∏–∫–æ–≤.',b:'–†–∞–∑–≤–µ–¥–µ–Ω–∏–µ –ø–∏—Ç–æ–º—Ü–µ–≤'},
ad_totem:{n:'–†–µ–∫–ª–∞–º–Ω—ã–π —Ç–æ—Ç–µ–º',i:'üì¢',inc:0,c:{wood:25,stone:25,coins:90},d:'–†–µ–∫–ª–∞–º–Ω—ã–π —Å—Ç–æ–ª–±. –î–∞—ë—Ç –±–æ–Ω—É—Å–Ω—ã–µ –º–æ–Ω–µ—Ç—ã –∑–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä —Ä–µ–∫–ª–∞–º—ã.',b:'–ë–æ–Ω—É—Å –∑–∞ —Ä–µ–∫–ª–∞–º—É'},
era_monument:{n:'–ü–∞–º—è—Ç–Ω–∏–∫ —ç—Ä—ã',i:'üóΩ',inc:1,c:{wood:40,stone:40,coins:170},d:'–ú–æ–Ω—É–º–µ–Ω—Ç —Ç–µ–∫—É—â–µ–π —ç—Ä—ã. –î–∞—ë—Ç –±–æ–Ω—É—Å –∫ –æ—á–∫–∞–º —ç—Ä—ã –∏ –º–µ–¥–∞–ª—è–º.',b:'–ë–æ–Ω—É—Å –∫ –æ—á–∫–∞–º —ç—Ä—ã'},
silence_chapel:{n:'–ß–∞—Å–æ–≤–Ω—è —Ç–∏—à–∏–Ω—ã',i:'‚õ™',inc:0,c:{wood:35,stone:35,coins:100},d:'–¢–∏—Ö–æ–µ –º–µ—Å—Ç–æ –º–µ–¥–∏—Ç–∞—Ü–∏–∏. –°–Ω–∏–∂–∞–µ—Ç –≤—Ä–µ–º—è –∫—É–ª–¥–∞—É–Ω–æ–≤ –∏ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —ç–Ω–µ—Ä–≥–∏—é.',b:'–°–Ω–∏–∂–µ–Ω–∏–µ –∫—É–ª–¥–∞—É–Ω–æ–≤'},
blacklist_office:{n:'–ö–∞–Ω—Ü–µ–ª—è—Ä–∏—è –∑–∞–ø—Ä–µ—Ç–æ–≤',i:'üìú',inc:0,c:{wood:30,stone:30,coins:110},d:'–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø—Ä–µ—Ç–∞–º–∏. –ü–æ–∑–≤–æ–ª—è–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –Ω–µ–∂–µ–ª–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π.',b:'–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∏–≥—Ä–æ–∫–æ–≤'}
},

selectedMerge:[],

economy:{
levels:{
0:{name:'–ù–æ–≤–∏—á–æ–∫',canWithdraw:false,sell:{tax:0.15,perDay:2,maxValue:5000}},
1:{name:'–£—á–µ–Ω–∏–∫',canWithdraw:false,sell:{tax:0.12,perDay:4,maxValue:5000}},
2:{name:'–û–ø—ã—Ç–Ω—ã–π',canWithdraw:false,sell:{tax:0.10,perDay:7,maxValue:5000}},
3:{name:'–í–µ—Ç–µ—Ä–∞–Ω',canWithdraw:true,sell:{tax:0.08,perDay:10,maxValue:5000}}
},
withdraw:{perUserCapTON:5,globalCapTON:50,minAmountTON:0.5,kycUsdThreshold:100,firstLockTON:10,firstLockDays:14},
scoring:{relicWeight:120,villageWeight:80,actionWeight:1,expWeight:2},
prize:{playerPaymentsShare:0.60,marketShare:0.40,projectCapShareOfNet:0.10}
},

getWeekId(ts=Date.now()){
const d=new Date(ts);
const target=new Date(d.valueOf());
const day=(d.getDay()+6)%7;
target.setDate(target.getDate()-day+3);
const firstThu=new Date(target.getFullYear(),0,4);
const firstDay=(firstThu.getDay()+6)%7;
firstThu.setDate(firstThu.getDate()-firstDay+3);
const week=Math.round((target-firstThu)/604800000)+1;
return `${target.getFullYear()}-${String(week).padStart(2,'0')}`;
},

ensureWeek(){
const w=this.getWeekId();
if(this.d.weekId!==w){
this.d.weekId=w;
this.d.withdrawsThisWeek=0;
}
},

addExp(x){
this.ensureWeek();
this.d.exp=(this.d.exp||0)+x;
const e=this.d.exp;
this.d.level=(e>=2500)?3:(e>=1200)?2:(e>=400)?1:0;
},

calcWeeklyScore(){
const s=this.economy.scoring;
const relics=this.d.relicsFound||0;
const village=this.d.vLevel||1;
const actions=this.d.actions||0;
const exp=this.d.exp||0;
return Math.floor(relics*s.relicWeight+village*s.villageWeight+actions*s.actionWeight+exp*s.expWeight);
},

canWithdrawTON(amountTON){
this.ensureWeek();
const lvl=this.d.level||0;
const rules=this.economy.withdraw;
const checks={levelOk:lvl>=3,amountMin:amountTON>=rules.minAmountTON,perUserCap:amountTON<=rules.perUserCapTON,weeklyCount:(this.d.withdrawsThisWeek||0)<1,lockOk:!this.d.lock?.active||Date.now()>=this.d.lock.until};
const ok=Object.values(checks).every(Boolean);
return {ok,checks};
},

startFirstLockIfNeeded(){
const rules=this.economy.withdraw;
if(!this.d.lock||!this.d.lock.active){
this.d.lock={active:true,amount:rules.firstLockTON,until:Date.now()+rules.firstLockDays*24*60*60*1000};
}
},

renderSubsTasks(){
const el=document.getElementById('subsTasksList');
if(!el)return;
let h='';
this.subsChannels.forEach(ch=>{
const done=!!this.d.subscribedChannels[ch.id];
h+=`<div class="info" style="margin-bottom:8px"><div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px"><div><a href="${ch.url}" target="_blank" rel="noopener" style="color:#ffa500;font-weight:700">${ch.name}</a><div style="font-size:11px;opacity:.8">–ù–∞–≥—Ä–∞–¥–∞: ${ch.reward.gems} üíé, ${ch.reward.points} –ø–æ–∏–Ω—Ç–æ–≤</div></div><button class="btn btn-small ${done?'btn-success':''}" ${done?'disabled':''} onclick="G.openChannelAndVerify('${ch.id}')">${done?'‚úì –í—ã–ø–æ–ª–Ω–µ–Ω–æ':'–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è'}</button><button class="btn btn-small" onclick="G.verifySubscription('${ch.id}')" style="margin-left:4px">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button></div></div>`;
});
el.innerHTML=h||'<div style="opacity:.7">–ù–µ—Ç –∑–∞–¥–∞–Ω–∏–π</div>';
},

openChannelAndVerify(chId){
const ch=this.subsChannels.find(c=>c.id===chId);
if(!ch)return;
if(window.Telegram&&window.Telegram.WebApp&&window.Telegram.WebApp.openTelegramLink){
window.Telegram.WebApp.openTelegramLink(ch.url);
}else{
window.open(ch.url,'_blank');
}
this.notify('–ü–æ–¥–ø–∏—à–∏—Ç–µ—Å—å –Ω–∞ –∫–∞–Ω–∞–ª, –∑–∞—Ç–µ–º –Ω–∞–∂–º–∏—Ç–µ ¬´–ü—Ä–æ–≤–µ—Ä–∏—Ç—å¬ª');
},

verifySubscription(chId){
const ch=this.subsChannels.find(c=>c.id===chId);
if(!ch)return;
if(this.d.subscribedChannels[ch.id]){ this.notify('–£–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ'); return; }
this.notify('–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏... (–Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ)');
setTimeout(()=>{
this.d.subscribedChannels[ch.id]=true;
this.d.gems=(this.d.gems||0)+ch.reward.gems;
this.d.points=(this.d.points||0)+ch.reward.points;
this.notify(`–ü–æ–¥–ø–∏—Å–∫–∞ –∑–∞—Å—á–∏—Ç–∞–Ω–∞! +${ch.reward.gems} üíé, +${ch.reward.points} –ø–æ–∏–Ω—Ç–æ–≤`);
this.renderSubsTasks();
this.updateUI();
this.save();
},1500);
},

getWalletBindUrl(){
const code='VE_'+(this.myPlayerId||this.d.playerId||Date.now());
this.d.walletVerifyCode=code;
const amountNano=Math.floor(this.walletBindAmountTON*1e9);
return `ton://transfer/${this.tonWallet}?amount=${amountNano}&text=${encodeURIComponent(code)}`;
},

openAuthModal(){
this.notify('–û—Ç–∫—Ä—ã–≤–∞—é –æ–∫–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏‚Ä¶');
this.openM('authModal');
if(this.API_BASE) this._fetchWalletBindData();
},

async _fetchWalletBindData(){
try{
const r=await fetch(this.API_BASE+'/api/game/wallet',{method:'POST',headers:{'Content-Type':'application/json','X-Telegram-User-Id':String(this.myPlayerId||0)},body:JSON.stringify({})});
const data=r.ok?await r.json():{};
const pw=(data.project_wallet||'').trim();
const comment=data.verify_comment||data.verify_code||'';
const jetton=data.jetton_master||this.PHOEX_JETTON_MASTER||'';
const phxpwAmt=data.phxpw_amount!=null?data.phxpw_amount:4500;
if(pw&&comment) this._authWalletData={project_wallet:pw,verify_comment:comment,jetton_master:jetton,phxpw_amount:phxpwAmt};
}catch(e){}
},

async openTonkeeperFromAuthModal(method){
method=method||'ton';
const amountNano=100000000;
const phxpwRaw=4500000000000;
let url, httpsUrl; let addr, comment;
if(this.API_BASE){
if(!this._authWalletData) await this._fetchWalletBindData();
const d=this._authWalletData;
if(!d||!d.verify_comment){ this.notify('–ü–æ–¥–æ–∂–¥–∏—Ç–µ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞','error'); return; }
addr=(d.project_wallet||'').trim();
comment=d.verify_comment;
if(!addr){ this.notify('–ù–∞ —Å–µ—Ä–≤–µ—Ä–µ –Ω–µ –∑–∞–¥–∞–Ω –∞–¥—Ä–µ—Å –∫–æ—à–µ–ª—å–∫–∞ (PROJECT_WALLET_ADDRESS). –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å—Å—ã–ª–∫—É ¬´–û—Ç–∫—Ä—ã—Ç—å –≤ –±—Ä–∞—É–∑–µ—Ä–µ¬ª.','error'); addr=this.tonWallet; }
if(method==='phxpw'){
const jetton=(d.jetton_master||this.PHOEX_JETTON_MASTER||'').trim();
const amt=d.phxpw_amount!=null?Math.floor(Number(d.phxpw_amount)*1e9):phxpwRaw;
url=jetton?`ton://transfer/${addr}?jetton=${encodeURIComponent(jetton)}&amount=${amt}&text=${encodeURIComponent(comment)}`:`ton://transfer/${addr}?amount=${amountNano}&text=${encodeURIComponent(comment)}`;
httpsUrl=jetton?`https://app.tonkeeper.com/jetton/${encodeURIComponent(jetton)}/transfer?address=${encodeURIComponent(addr)}&amount=${amt}&comment=${encodeURIComponent(comment)}`:`https://app.tonkeeper.com/transfer/${addr}?amount=${amountNano}&text=${encodeURIComponent(comment)}`;
}else{
url=`ton://transfer/${addr}?amount=${amountNano}&text=${encodeURIComponent(comment)}`;
httpsUrl=`https://app.tonkeeper.com/transfer/${addr}?amount=${amountNano}&text=${encodeURIComponent(comment)}`;
}
}else{
url=this.getWalletBindUrl();
addr=this.tonWallet;
comment='VE_'+(this.myPlayerId||this.d.playerId||Date.now());
httpsUrl='https://app.tonkeeper.com/transfer/'+addr+'?amount='+amountNano+'&text='+encodeURIComponent(comment);
}
try{
if(window.Telegram&&window.Telegram.WebApp&&window.Telegram.WebApp.openLink){
window.Telegram.WebApp.openLink(method==='phxpw'?httpsUrl:url);
}else{
window.open(method==='phxpw'?httpsUrl:url,'_blank');
}
}catch(e){ window.open(httpsUrl,'_blank'); }
this.notify(method==='phxpw'?'–û—Ç–∫—Ä–æ–π—Ç–µ –∫–æ—à–µ–ª—ë–∫: 4500 PHXPW –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –ø–æ–¥—Å—Ç–∞–≤–ª–µ–Ω—ã. –ü–æ—Å–ª–µ –ø–µ—Ä–µ–≤–æ–¥–∞ –Ω–∞–∂–º–∏—Ç–µ ¬´–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∏–≤—è–∑–∫—É¬ª.':'–û—Ç–∫—Ä–æ–π—Ç–µ –∫–æ—à–µ–ª—ë–∫: 0.1 TON –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –ø–æ–¥—Å—Ç–∞–≤–ª–µ–Ω—ã. –ü–æ—Å–ª–µ –ø–µ—Ä–µ–≤–æ–¥–∞ –Ω–∞–∂–º–∏—Ç–µ ¬´–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∏–≤—è–∑–∫—É¬ª.');
},

openTonkeeperFallback(usePhxpw){
const amountNano=100000000;
const phxpwRaw=4500000000000;
let addr, comment, url;
if(this.API_BASE&&this._authWalletData){
addr=this._authWalletData.project_wallet;
comment=this._authWalletData.verify_comment;
if(usePhxpw){
const jetton=(this._authWalletData.jetton_master||this.PHOEX_JETTON_MASTER||'').trim();
const amt=this._authWalletData.phxpw_amount!=null?Math.floor(Number(this._authWalletData.phxpw_amount)*1e9):phxpwRaw;
url=jetton?`https://app.tonkeeper.com/jetton/${encodeURIComponent(jetton)}/transfer?address=${encodeURIComponent(addr)}&amount=${amt}&comment=${encodeURIComponent(comment)}`:`https://app.tonkeeper.com/transfer/${addr}?amount=${amountNano}&text=${encodeURIComponent(comment)}`;
}else{
url=`https://app.tonkeeper.com/transfer/${addr}?amount=${amountNano}&text=${encodeURIComponent(comment)}`;
}
}else{ addr=this.tonWallet; comment='VE_'+(this.myPlayerId||this.d.playerId||Date.now()); url=`https://app.tonkeeper.com/transfer/${addr}?amount=${amountNano}&text=${encodeURIComponent(comment)}`; }
window.open(url,'_blank');
this.notify(usePhxpw?'–û—Ç–∫—Ä—ã—Ç–æ: –ø–µ—Ä–µ–≤–æ–¥ 4500 PHXPW. –ï—Å–ª–∏ Tonkeeper —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.':'–û—Ç–∫—Ä—ã—Ç–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ. –ï—Å–ª–∏ Tonkeeper —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.');
},

openWalletBind(){
this.openAuthModal();
const btn=document.getElementById('authModalOpenTon');
if(btn) btn.click();
},

copyWalletBindLink(){
const amountNano=100000000;
let url;
if(this._authWalletData){
url=`ton://transfer/${this._authWalletData.project_wallet}?amount=${amountNano}&text=${encodeURIComponent(this._authWalletData.verify_comment)}`;
}else{ url=this.getWalletBindUrl(); }
if(navigator.clipboard&&navigator.clipboard.writeText){
navigator.clipboard.writeText(url).then(()=>this.notify('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞')).catch(()=>this.notify(url));
}else{
const inp=document.createElement('input');inp.value=url;document.body.appendChild(inp);inp.select();document.execCommand('copy');document.body.removeChild(inp);
this.notify('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞');
}
},

updateWalletBindUI(){
const st=document.getElementById('walletBindStatus');
const btn=document.getElementById('walletBindBtn');
if(st) st.textContent=this.d.walletBound?'‚úÖ –ö–æ—à–µ–ª—ë–∫ –ø—Ä–∏–≤—è–∑–∞–Ω':'–ö–æ—à–µ–ª—ë–∫ –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω';
if(btn) btn.style.display=this.d.walletBound?'none':'block';
},

async verifyWalletBind(){
if(!this.API_BASE){ this.notify('–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏–≤—è–∑–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –∫ —Å–µ—Ä–≤–µ—Ä—É.','error'); return; }
this.notify('–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏‚Ä¶');
try{
const r=await fetch(this.API_BASE+'/api/game/wallet/verify',{method:'POST',headers:{'Content-Type':'application/json','X-Telegram-User-Id':String(this.myPlayerId||0)}});
const data=r.ok?await r.json():{};
if(data.ok){
this.d.walletBound=true;
this.updateWalletBindUI();
this.save();
this.closeM('authModal');
this.notify('–ö–æ—à–µ–ª—ë–∫ –ø—Ä–∏–≤—è–∑–∞–Ω!');
}else{
const reason=data.reason||'tx_not_found';
this.notify(reason==='tx_not_found'?'–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ü–æ–¥–æ–∂–¥–∏—Ç–µ 1‚Äì2 –º–∏–Ω—É—Ç—ã –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∏–≤—è–∑–∫—É¬ª —Å–Ω–æ–≤–∞.':'–û—à–∏–±–∫–∞: '+reason,'error');
}
}catch(e){
this.notify('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.','error');
}
},

init(){
if(this.API_BASE) this._fetchRates();
const done=()=>{
this.initTG();
this.initRaritySystem();
if(this.d.buildings.length===0)this.d.buildings.push({t:'townhall',lv:1,last:Date.now()});
this.newMine();
this.initPlayers();
this.updateUI();
this.startTimers();
};
if(this.API_BASE){
this.loadGame().then(done).catch(()=>done());
}else{
this.loadGame();
done();
}
},
async _fetchRates(){
try{
const r=await fetch(this.API_BASE+'/api/game/rates');
if(r.ok){
const d=await r.json();
const num=parseFloat(d.phxpw_price_ton);
if(num!=null&&!isNaN(num)&&num>0) this.PHXPW_PRICE_TON=num;
const tonUsd=parseFloat(d.ton_price_usd);
if(tonUsd!=null&&!isNaN(tonUsd)&&tonUsd>0) this.tonPriceUsd=tonUsd;
}
}catch(e){}
},
_phxpwFromTon(ton){
const rate=this.PHXPW_PRICE_TON||0.00002412;
if(!rate) return 0;
const raw=Number(ton)/rate;
return raw>=1e6?Math.round(raw/1e5)*1e5:raw>=1e3?Math.round(raw/100)*100:Math.round(raw);
},
_phxpwToUsd(phxpw){
const rate=this.PHXPW_PRICE_TON||0.00002412;
const tonUsd=this.tonPriceUsd||1.47;
return (phxpw*rate*tonUsd)||0;
},
_starsToUsd(pts){
return this._phxpwToUsd((pts||0)*2);
},

initTG(){
const urlParams=new URLSearchParams(window.location.search);
const testTg=urlParams.get('tg');
if(testTg!==null&&testTg!==''){
const id=parseInt(testTg,10)||Math.floor(Math.random()*1000000);
this.myPlayerId=id;
document.getElementById('playerName').textContent='–¢–µ—Å—Ç '+id;
document.getElementById('profileName').textContent='–¢–µ—Å—Ç '+id;
const badge=document.getElementById('testModeBadge');
if(badge){ badge.style.display='inline'; badge.textContent='–¢–µ—Å—Ç ID: '+id; }
return;
}
if(window.Telegram?.WebApp){
const tg=window.Telegram.WebApp;
tg.ready();tg.expand();
const u=tg.initDataUnsafe?.user;
if(u){
const n=u.first_name||'–ò–≥—Ä–æ–∫';
this.myPlayerId=u.id||Math.floor(Math.random()*1000000);
document.getElementById('playerName').textContent=n;
document.getElementById('profileName').textContent=n;
}else{
this.myPlayerId=Math.floor(Math.random()*1000000);
}
}else{
this.myPlayerId=Math.floor(Math.random()*1000000);
}
},

initRaritySystem(){
this.raritySystem.epic.items=[
{id:'ruling_amulet',n:'–ê–º—É–ª–µ—Ç –ü—Ä–∞–≤–ª–µ–Ω–∏—è',i:'üëë',type:'amulet',e:'immunity',pts:250},
{id:'immortal_amulet',n:'–ë–µ—Å—Å–º–µ—Ä—Ç–∏–µ',i:'üí´',type:'amulet',e:'no_loss',pts:300},
{id:'phoenix_relic',n:'–§–µ–Ω–∏–∫—Å –í–æ–∑—Ä–æ–∂–¥–µ–Ω–∏—è',i:'üî¥',type:'relic',ev:500}
];

this.raritySystem.magic.items=[
{id:'freeze_amulet',n:'–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –í—Ä–µ–º–µ–Ω–∏',i:'‚è∏Ô∏è',type:'amulet',e:'freeze',pts:200},
{id:'prosperity_amulet',n:'–ü—Ä–æ—Ü–≤–µ—Ç–∞–Ω–∏–µ',i:'üí∞',type:'amulet',e:'income_x3',pts:150},
{id:'fortune_amulet',n:'–£–¥–∞—á–∞',i:'üçÄ',type:'amulet',e:'relic_x2',pts:100},
{id:'dragon_relic',n:'–î—Ä–∞–∫–æ–Ω –°–∏–ª—ã',i:'üü£',type:'relic',ev:300},
{id:'titan_relic',n:'–¢–∏—Ç–∞–Ω –ú–æ—â–∏',i:'üü£',type:'relic',ev:280},
{id:'wisdom_relic',n:'–ú—É–¥—Ä–æ—Å—Ç—å –í–µ–∫–æ–≤',i:'üü£',type:'relic',ev:250},
{id:'eternal_relic',n:'–í–µ—á–Ω–æ—Å—Ç—å',i:'üü£',type:'relic',ev:270}
];

const tsyNames=['–ò–∑—É–º—Ä—É–¥','–°–∞–ø—Ñ–∏—Ä','–†—É–±–∏–Ω','–¢–æ–ø–∞–∑','–ê–º–µ—Ç–∏—Å—Ç','–û–ø–∞–ª','–ñ–µ–º—á—É–≥','–Ø–Ω—Ç–∞—Ä—å','–ö–æ—Ä–∞–ª–ª','–û–±—Å–∏–¥–∏–∞–Ω','–ö–≤–∞—Ä—Ü','–õ—É–Ω–Ω—ã–π –ö–∞–º–µ–Ω—å','–ê–≥–∞—Ç','–û–Ω–∏–∫—Å','–¢—É—Ä–º–∞–ª–∏–Ω','–ù–µ—Ñ—Ä–∏—Ç','–Ø—à–º–∞','–ú–∞–ª–∞—Ö–∏—Ç','–ì—Ä–∞–Ω–∞—Ç','–¶–∏—Ç—Ä–∏–Ω','–ë–µ—Ä–∏–ª–ª','–ê–ª–µ–∫—Å–∞–Ω–¥—Ä–∏—Ç','–ü–µ—Ä–∏–¥–æ—Ç','–ê–∫–≤–∞–º–∞—Ä–∏–Ω','–¢–∞–Ω–∑–∞–Ω–∏—Ç','–®–ø–∏–Ω–µ–ª—å','–¶–∏—Ä–∫–æ–Ω','–¢–æ–ø–∞–∑','–†–æ–¥–æ–ª–∏—Ç','–¢—É—Ä–º–∞–ª–∏–Ω'];
tsyNames.forEach((n,i)=>{
this.raritySystem.tsy.items.push({id:`tsy${i}`,n:`–ö–∞–º–µ–Ω—å ${n}`,i:'üü¢',type:'relic',ev:100+Math.floor(Math.random()*100)});
});

const yanNames=['–°–æ–ª–Ω—Ü–µ','–õ—É–Ω–∞','–ó–≤–µ–∑–¥–∞','–ö–æ–º–µ—Ç–∞','–ó–∞—Ä—è','–ó–∞–∫–∞—Ç','–†–∞—Å—Å–≤–µ—Ç','–ü–æ–ª–¥–µ–Ω—å','–ü–æ–ª–Ω–æ—á—å','–°—É–º–µ—Ä–∫–∏'];
yanNames.forEach((n,i)=>{
this.raritySystem.yan.items.push({id:`yan${i}`,n:`${n} –í–æ—Å—Ç–æ–∫–∞`,i:'üü°',type:'relic',ev:50+Math.floor(Math.random()*70)});
});

const yinNames=['–¢–µ–Ω—å','–¢—É–º–∞–Ω','–î—ã–º','–ú–≥–ª–∞','–ü–µ–ø–µ–ª','–ü—Ä–∞—Ö','–°–∞–∂–∞','–£–≥–æ–ª—å','–ü—ã–ª—å','–ü–µ—Å–æ–∫','–í–µ—Ç–µ—Ä','–î–æ–∂–¥—å','–°–Ω–µ–≥','–õ–µ–¥','–ì—Ä–∞–¥'];
yinNames.forEach((n,i)=>{
this.raritySystem.yin.items.push({id:`yin${i}`,n:`${n} –ó–∞–ø–∞–¥–∞`,i:'‚ö´',type:'relic',ev:30+Math.floor(Math.random()*50)});
});

const fireNames=['–ü–ª–∞–º—è','–ò—Å–∫—Ä–∞','–ñ–∞—Ä','–ó–Ω–æ–π','–¢–µ–ø–ª–æ','–û–≥–æ–Ω—å','–í—Å–ø—ã—à–∫–∞','–í–∑—Ä—ã–≤','–§–∞–∫–µ–ª','–ö–æ—Å—Ç–µ—Ä','–ü–æ–∂–∞—Ä','–ì–æ—Ä–µ–Ω–∏–µ','–ñ–∞—Ä–∞','–£–≥–ª–∏','–õ–∞–≤–∞','–ú–∞–≥–º–∞','–í—É–ª–∫–∞–Ω','–ü–µ—á—å','–ì–æ—Ä–Ω','–ö—É–∑–Ω—è','–ñ–∞—Ä–æ–≤–Ω—è','–û—á–∞–≥'];
fireNames.forEach((n,i)=>{
this.raritySystem.fire.items.push({id:`fire${i}`,n:`${n} –Æ–≥–∞`,i:'üî•',type:'relic',ev:20+Math.floor(Math.random()*40)});
});
},

initPlayers(){
// Real data only ‚Äî no fake players. allPlayers used only as local fallback.
this.allPlayers=[];
this.ensureWeek();
this.allPlayers.push({
id:this.myPlayerId,
name:document.getElementById('playerName').textContent,
score:this.calcWeeklyScore(),
relics:this.d.relicsFound||0,
coins:this.d.coins,
level:this.d.vLevel,
online:true
});
// Fetch real stats from server
if(this.API_BASE){
fetch(this.API_BASE+'/api/game/stats').then(r=>r.ok?r.json():null).then(d=>{
if(d){
const oc=document.getElementById('onlineCount');if(oc)oc.textContent=d.online||0;
const tp=document.getElementById('totalPlayers');if(tp)tp.textContent=d.total_players||0;
}
}).catch(()=>{});
}
},

updateOnlineCount(){
// Online count is updated via WebSocket ‚Äî no-op here for compat
},

connectOnlineWS(){
if(!this.API_BASE)return;
const proto=this.API_BASE.startsWith('https')?'wss':'ws';
const host=this.API_BASE.replace(/^https?:\/\//,'');
const url=proto+'://'+host+'/ws/online';
try{
const ws=new WebSocket(url);
this._wsOnline=ws;
ws.onmessage=(e)=>{
try{
const d=JSON.parse(e.data);
if(d.online!==undefined){
const oc=document.getElementById('onlineCount');
if(oc)oc.textContent=d.online;
}
}catch(_){}
};
ws.onclose=()=>{
this._wsOnline=null;
setTimeout(()=>this.connectOnlineWS(),this._wsReconnectDelay);
this._wsReconnectDelay=Math.min(this._wsReconnectDelay*1.5,30000);
};
ws.onopen=()=>{this._wsReconnectDelay=1000;};
ws.onerror=()=>{};
}catch(_){}
},

renderVillage(){
const g=document.getElementById('villageGrid');
g.innerHTML='';
let ti=0,te=0;
this.d.buildings.forEach((b,idx)=>{
const t=this.buildingTypes[b.t];
const c=document.createElement('div');
c.className='card';
if(this.d.skyFall)c.classList.add('dmg');
const inc=t.inc*b.lv;
let di='';
if(this.d.skyFall){
const l=Math.floor(inc*this.d.lossMult);
te+=l;
di=`<div class="loss">-${l}/—á</div>`;
}else if(inc>0){
ti+=inc;
di=`<div class="inc">+${inc}/—á</div>`;
}
c.innerHTML=`<div class="ic">${t.i}</div><div class="nm">${t.n}</div><div class="lv">–£—Ä. ${b.lv}/10</div>${di}`;
c.onclick=()=>this.showBuild(idx);
g.appendChild(c);
});
for(let i=this.d.buildings.length;i<9;i++){
const c=document.createElement('div');
c.className='card';
c.style.opacity='0.5';
c.innerHTML='<div class="ic">‚ûï</div><div class="nm">–ù–æ–≤–∞—è</div>';
c.onclick=()=>this.showNew();
g.appendChild(c);
}
document.getElementById('totalIncome').textContent=`+${ti} ü™ô`;
document.getElementById('totalExpenses').textContent=`-${te} ü™ô`;
},

showBuild(idx){
const b=this.d.buildings[idx];
const t=this.buildingTypes[b.t];
const uc=this.getUpgCost(b);
const can=b.lv<10&&this.d.wood>=uc.wood&&this.d.stone>=uc.stone&&this.d.coins>=uc.coins;
let h=`<div class="info"><div class="ir"><span>–£—Ä–æ–≤–µ–Ω—å:</span><span>${b.lv}/10</span></div><div class="ir"><span>–î–æ—Ö–æ–¥:</span><span style="color:#ff8c00">+${t.inc*b.lv}/—á</span></div>`;
if(b.lv<10){
h+=`<div class="ir"><span>–°–ª–µ–¥. —É—Ä.:</span><span style="color:#ffa500">+${t.inc*(b.lv+1)}/—á</span></div><div style="margin-top:15px"><strong>–°—Ç–æ–∏–º–æ—Å—Ç—å:</strong><div style="margin-top:8px">ü™µ ${uc.wood} | ü™® ${uc.stone} | ü™ô ${uc.coins}</div></div>`;
}
h+=`</div>`;
if(b.lv<10){
h+=`<div style="text-align:center;margin-top:15px"><button class="btn btn-success" ${!can?'disabled':''} onclick="G.upgBuild(${idx})">‚¨ÜÔ∏è –î–æ —É—Ä–æ–≤–Ω—è ${b.lv+1}</button></div>`;
}
if(b.t!=='townhall'){
h+=`<div style="text-align:center;margin-top:10px"><button class="btn btn-danger btn-small" onclick="G.demoBuild(${idx})">üóëÔ∏è –°–Ω–µ—Å—Ç–∏</button></div>`;
}
document.getElementById('bmt').textContent=t.n;
document.getElementById('bmc').innerHTML=h;
this._buildingModalView='building';
this.openM('buildingModal');
},

getUpgCost(b){
const t=this.buildingTypes[b.t];
const m=Math.pow(1.5,b.lv);
return{wood:Math.floor(t.c.wood*m),stone:Math.floor(t.c.stone*m),coins:Math.floor(t.c.coins*m)};
},

async upgBuild(idx){
const b=this.d.buildings[idx];
if(!b) return;
const c=this.getUpgCost(b);
if(this.API_BASE){
try{
const r=await fetch(this.API_BASE+'/api/game/field/upgrade',{method:'POST',headers:{'Content-Type':'application/json','X-Telegram-User-Id':String(this.myPlayerId||0)},body:JSON.stringify({building_key:b.t,cost:c.coins||50})});
const data=await r.json().catch(()=>({}));
if(!r.ok){ this.notify(data.detail||'–û—à–∏–±–∫–∞ —É–ª—É—á—à–µ–Ω–∏—è','error'); return; }
this.d.actions++;this.addExp(15);
this.d.wood-=c.wood;this.d.stone-=c.stone;this.d.coins-=c.coins;
b.lv++;
this.notify(`${this.buildingTypes[b.t].n} —É–ª—É—á—à–µ–Ω–∞ –¥–æ ${b.lv}!`);
this.closeM('buildingModal');this.renderVillage();this.updateUI();this.save();
}catch(e){ this.notify(e.message||'–û—à–∏–±–∫–∞','error'); }
return;
}
if(this.d.wood>=c.wood&&this.d.stone>=c.stone&&this.d.coins>=c.coins){
this.d.actions++;this.addExp(15);
this.d.wood-=c.wood;this.d.stone-=c.stone;this.d.coins-=c.coins;b.lv++;
this.notify(`${this.buildingTypes[b.t].n} —É–ª—É—á—à–µ–Ω–∞ –¥–æ ${b.lv}!`);
this.closeM('buildingModal');this.renderVillage();this.updateUI();this.save();
}else this.notify('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ!','error');
},

demoBuild(idx){
if(confirm('–°–Ω–µ—Å—Ç–∏?')){
const b=this.d.buildings[idx];
const c=this.getUpgCost(b);
this.d.wood+=Math.floor(c.wood*.5);this.d.stone+=Math.floor(c.stone*.5);this.d.coins+=Math.floor(c.coins*.3);
this.d.buildings.splice(idx,1);
this.notify('–°–Ω–µ—Å–µ–Ω–æ. –†–µ—Å—É—Ä—Å—ã –≤–æ–∑–≤—Ä–∞—â–µ–Ω—ã.');
this.closeM('buildingModal');this.renderVillage();this.updateUI();this.save();
}
},

_buildingListScroll:0,
_buildingModalView:'list',

showNew(restoreScroll){
let h='<div id="buildingListScroller" style="max-height:400px;overflow-y:auto">';
Object.entries(this.buildingTypes).forEach(([k,t])=>{
if(k==='townhall')return;
const can=this.d.wood>=t.c.wood&&this.d.stone>=t.c.stone&&this.d.coins>=t.c.coins;
h+=`<div class="info" style="margin-bottom:10px;cursor:pointer" onclick="G.showBuildingInfo('${k}')"><div style="display:flex;align-items:center;gap:15px;margin-bottom:10px"><div style="font-size:40px">${t.i}</div><div style="flex:1"><strong>${t.n}</strong><div style="font-size:12px;opacity:.8">${t.inc>0?'+'+t.inc+'/—á':'‚Äî'} ${t.b?'¬∑ '+t.b:''}</div></div><div style="font-size:18px;opacity:.5">‚ÑπÔ∏è</div></div><div style="font-size:12px;margin-bottom:8px">ü™µ ${t.c.wood} | ü™® ${t.c.stone} | ü™ô ${t.c.coins}</div><button class="btn btn-success btn-small" ${!can?'disabled':''} onclick="event.stopPropagation();G.buildNew('${k}')">–ü–æ—Å—Ç—Ä–æ–∏—Ç—å</button></div>`;
});
h+='</div>';
document.getElementById('bmt').textContent='–ù–æ–≤–∞—è –ø–æ—Å—Ç—Ä–æ–π–∫–∞';
document.getElementById('bmc').innerHTML=h;
this._buildingModalView='list';
this.openM('buildingModal');
if(restoreScroll){
const sc=document.getElementById('buildingListScroller');
if(sc) requestAnimationFrame(()=>{ sc.scrollTop=this._buildingListScroll; });
}
},

showBuildingInfo(k){
const scroller=document.getElementById('buildingListScroller');
if(scroller) this._buildingListScroll=scroller.scrollTop;
const t=this.buildingTypes[k];
if(!t)return;
this._buildingModalView='info';
const can=this.d.wood>=t.c.wood&&this.d.stone>=t.c.stone&&this.d.coins>=t.c.coins;
let h=`<div style="text-align:center;margin-bottom:15px"><div style="font-size:64px">${t.i}</div></div>`;
h+=`<div class="info" style="margin-bottom:12px"><div style="margin-bottom:8px;font-size:13px;line-height:1.5">${t.d||''}</div>`;
if(t.b) h+=`<div style="margin-bottom:8px"><span style="color:#ffa500;font-weight:600">–ë–æ–Ω—É—Å:</span> ${t.b}</div>`;
h+=`<div class="ir"><span>–ë–∞–∑–æ–≤—ã–π –¥–æ—Ö–æ–¥:</span><span style="color:#ff8c00">${t.inc>0?'+'+t.inc+' ü™ô/—á':'–ù–µ—Ç –¥–æ—Ö–æ–¥–∞'}</span></div>`;
h+=`</div>`;
h+=`<div class="info" style="margin-bottom:12px"><div style="font-weight:600;margin-bottom:8px">–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª –ø–æ —É—Ä–æ–≤–Ω—è–º</div><div style="font-size:12px;max-height:160px;overflow-y:auto">`;
for(let lv=1;lv<=10;lv++){
const m=Math.pow(1.5,lv-1);
const upgW=Math.floor(t.c.wood*m);
const upgS=Math.floor(t.c.stone*m);
const upgC=Math.floor(t.c.coins*m);
const inc=t.inc*lv;
h+=`<div style="display:flex;justify-content:space-between;padding:4px 0;${lv%2===0?'background:rgba(255,255,255,0.03)':''}"><span style="font-weight:600;min-width:55px">–£—Ä. ${lv}</span><span style="color:#ff8c00;min-width:60px">${inc>0?'+'+inc+' ü™ô/—á':'‚Äî'}</span><span style="opacity:.7">ü™µ${upgW} ü™®${upgS} ü™ô${upgC}</span></div>`;
}
h+=`</div></div>`;
h+=`<div class="info" style="margin-bottom:12px"><div style="font-weight:600;margin-bottom:8px">–°—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ—Å—Ç—Ä–æ–π–∫–∏</div><div style="display:flex;justify-content:space-around;text-align:center"><div>ü™µ<br><strong>${t.c.wood}</strong></div><div>ü™®<br><strong>${t.c.stone}</strong></div><div>ü™ô<br><strong>${t.c.coins}</strong></div></div></div>`;
h+=`<div style="display:flex;gap:10px;justify-content:center;margin-top:15px"><button class="btn btn-small" onclick="G.showNew(true)">‚Üê –ù–∞–∑–∞–¥</button><button class="btn btn-success" ${!can?'disabled':''} onclick="G.buildNew('${k}')">–ü–æ—Å—Ç—Ä–æ–∏—Ç—å ${t.n}</button></div>`;
document.getElementById('bmt').textContent=t.n;
document.getElementById('bmc').innerHTML=h;
},

closeBuildingModal(){
if(this._buildingModalView==='info'){
this.showNew(true);
return;
}
this._buildingModalView='list';
this._buildingListScroll=0;
this.closeM('buildingModal');
},

async buildNew(t){
const bt=this.buildingTypes[t];
if(!bt) return;
const c=bt.c;
if(this.API_BASE){
const slot=this.getFirstEmptySlot();
if(!slot){ this.notify('–í—Å–µ 9 —Å–ª–æ—Ç–æ–≤ –∑–∞–Ω—è—Ç—ã','error'); return; }
try{
const r=await fetch(this.API_BASE+'/api/game/field/place',{method:'POST',headers:{'Content-Type':'application/json','X-Telegram-User-Id':String(this.myPlayerId||0)},body:JSON.stringify({slot_index:slot,building_key:t,cost:c.coins||100})});
const data=await r.json().catch(()=>({}));
if(!r.ok){ this.notify(data.detail||'–û—à–∏–±–∫–∞ –ø–æ—Å—Ç—Ä–æ–π–∫–∏','error'); return; }
this.d.actions++;this.addExp(20);
this.d.wood-=c.wood;this.d.stone-=c.stone;this.d.coins-=c.coins;
this.d.buildings.push({t:t,lv:1,last:Date.now(),_slotIndex:slot});
this.notify(`${bt.n} –ø–æ—Å—Ç—Ä–æ–µ–Ω–∞!`);
this.closeM('buildingModal');this.renderVillage();this.updateUI();this.save();
}catch(e){ this.notify(e.message||'–û—à–∏–±–∫–∞','error'); }
return;
}
if(this.d.wood>=c.wood&&this.d.stone>=c.stone&&this.d.coins>=c.coins){
this.d.actions++;this.addExp(20);
this.d.wood-=c.wood;this.d.stone-=c.stone;this.d.coins-=c.coins;
this.d.buildings.push({t:t,lv:1,last:Date.now()});
this.notify(`${bt.n} –ø–æ—Å—Ç—Ä–æ–µ–Ω–∞!`);
this.closeM('buildingModal');this.renderVillage();this.updateUI();this.save();
}else this.notify('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ!','error');
},

collectResources(){
this.d.actions++;this.addExp(5);
const now=Date.now();
let col={coins:0};
this.d.buildings.forEach(b=>{
const t=this.buildingTypes[b.t];
const h=(now-b.last)/(1000*60*60);
const inc=t.inc*b.lv*h;
if(this.d.skyFall){
const l=Math.floor(inc*this.d.lossMult);
this.d.coins=Math.max(0,this.d.coins-l);
}else{
col.coins+=Math.floor(inc);
}
b.last=now;
});
if(!this.d.skyFall){
this.d.coins+=col.coins;
this.notify(`–°–æ–±—Ä–∞–Ω–æ: ü™ô${col.coins}`);
}else this.notify('–í–æ –≤—Ä–µ–º—è –ü–∞–¥–µ–Ω–∏—è –Ω–µ–ª—å–∑—è —Å–æ–±–∏—Ä–∞—Ç—å!','error');
this.updateUI();this.save();
},

newMine(){
this.d.mineHintIndices=[];
this.d.mineScanActive=false;
this.d.phoenixEyeActive=false;
this.d.mineBlocks=[];
const sz=36;
const rand=Math.random();
const prizeCount=rand<0.10?2:rand<0.30?3:rand<0.60?4:rand<0.85?5:6;
const prizeIndices=[];
while(prizeIndices.length<prizeCount){
const idx=Math.floor(Math.random()*sz);
if(!prizeIndices.includes(idx))prizeIndices.push(idx);
}
for(let i=0;i<sz;i++){
if(prizeIndices.includes(i)){
const rarity=this.rollRarityForMine();
this.d.mineBlocks.push({cl:false,rarity:rarity,reward:this.getReward(rarity),hasPrize:true});
}else{
this.d.mineBlocks.push({cl:false,rarity:'empty',reward:{type:'empty'},hasPrize:false});
}
}
this.renderMine();
},

rollRarity(){
const rand=Math.random();
let cumulative=0;
for(const[key,data]of Object.entries(this.raritySystem)){
cumulative+=data.chance;
if(rand<=cumulative)return key;
}
return 'fire';
},

rollRarityForMine(){
const total=Object.values(this.raritySystem).reduce((s,data)=>s+(data.dropWeight||10),0);
let r=Math.random()*total;
for(const[key,data]of Object.entries(this.raritySystem)){
const w=data.dropWeight||10;
if(r<w)return key;
r-=w;
}
return 'fire';
},

getReward(rarity){
if(rarity==='empty')return{type:'empty'};
const items=this.raritySystem[rarity].items;
if(items.length===0)return{type:'coins',amount:Math.floor(Math.random()*50)+10};
const item=items[Math.floor(Math.random()*items.length)];
return{...item,rarity:rarity};
},

renderMine(){
const g=document.getElementById('mineGrid');
if(!g)return;
g.innerHTML='';
const hintIdx=this.d.mineHintIndices||[];
const scan=!!this.d.mineScanActive;
const eye=!!this.d.phoenixEyeActive;
this.d.mineBlocks.forEach((b,idx)=>{
const c=document.createElement('div');
c.className='mb';
if(b.cl){
c.classList.add('clr');
if(b.hasPrize){
c.classList.add(b.rarity);
if(b.reward.type==='relic'||b.reward.type==='amulet'){
c.textContent='‚ú®';
}else{
c.textContent='üí∞';
}
}else{
c.textContent='‚ùå';
c.style.opacity='0.5';
}
}else{
if(this.d.digsLeft<=0){
c.classList.add('locked');
c.textContent='üîí';
}else{
c.onclick=()=>this.dig(idx);
if(hintIdx.indexOf(idx)>=0){
c.textContent='?';
c.style.fontSize='22px';
c.style.color='#ffa500';
c.style.fontWeight='bold';
c.classList.add(b.rarity);
}else if(eye&&b.hasPrize){
if(b.reward.type==='relic'||b.reward.type==='amulet') c.textContent='‚ú®';
else c.textContent='üí∞';
c.classList.add(b.rarity);
c.style.opacity='0.95';
}else if(scan&&b.hasPrize){
c.textContent='‚Ä¢';
c.style.fontSize='24px';
c.style.color='#ffd700';
}else{
c.textContent='‚õ∞Ô∏è';
}
}
}
g.appendChild(c);
});
document.getElementById('digsLeft').textContent=this.d.digsLeft;
const rf=document.getElementById('relicsFound');
if(rf) rf.textContent=this.d.relicsFound;
},

buyDigsForGems(){
const cost=this.gemsCosts.digs5;
if((this.d.gems||0)<cost){ this.notify('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫—Ä–∏—Å—Ç–∞–ª–ª–æ–≤','error'); return; }
this.d.gems-=cost;
this.d.digsLeft=(this.d.digsLeft||0)+3;
this.notify('+3 –ø–æ–ø—ã—Ç–æ–∫ –∫–æ–ø–∞–Ω–∏—è!');
this.updateUI(); this.renderMine(); this.save();
},

reduceCheckinForGems(){
const cost=this.gemsCosts.checkinNow;
if((this.d.gems||0)<cost){ this.notify('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫—Ä–∏—Å—Ç–∞–ª–ª–æ–≤','error'); return; }
this.d.gems-=cost;
this.d.lastCheckin=null;
this.notify('–ß–µ–∫–∏–Ω –¥–æ—Å—Ç—É–ø–µ–Ω! –ù–∞–∂–º–∏—Ç–µ ¬´–ü–û–õ–£–ß–ò–¢–¨ –ü–û–ü–´–¢–ö–ò¬ª');
this.updateCheckinUI(); this.updateUI(); this.save();
},

buyMineHint(){
const cost=this.gemsCosts.hint;
if((this.d.gems||0)<cost){ this.notify('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫—Ä–∏—Å—Ç–∞–ª–ª–æ–≤','error'); return; }
const hintIdx=this.d.mineHintIndices||[];
const prizeIdx=[];
this.d.mineBlocks.forEach((b,i)=>{ if(!b.cl&&b.hasPrize&&hintIdx.indexOf(i)<0) prizeIdx.push(i); });
if(prizeIdx.length===0){ this.notify('–í—Å–µ –ø—Ä–∏–∑–æ–≤—ã–µ —è—á–µ–π–∫–∏ —É–∂–µ –æ—Ç–º–µ—á–µ–Ω—ã –ø–æ–¥—Å–∫–∞–∑–∫–∞–º–∏ –∏–ª–∏ –ø—Ä–∏–∑–æ–≤ –Ω–µ—Ç.','error'); return; }
this.d.gems-=cost;
this.d.mineHintIndices=this.d.mineHintIndices||[];
this.d.mineHintIndices.push(prizeIdx[Math.floor(Math.random()*prizeIdx.length)]);
this.notify('–ü–æ–¥—Å–∫–∞–∑–∫–∞: –æ–¥–Ω–∞ —è—á–µ–π–∫–∞ —Å –ø—Ä–∏–∑–æ–º –æ—Ç–º–µ—á–µ–Ω–∞ ¬´?¬ª');
this.updateUI(); this.renderMine(); this.save();
},

buyFullScan(){
const cost=this.gemsCosts.fullScan;
if((this.d.gems||0)<cost){ this.notify('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫—Ä–∏—Å—Ç–∞–ª–ª–æ–≤','error'); return; }
this.d.gems-=cost;
this.d.mineScanActive=true;
this.notify('–ü–æ–ª–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ: —è—á–µ–π–∫–∏ —Å –ø—Ä–∏–∑–∞–º–∏ –æ—Ç–º–µ—á–µ–Ω—ã —Ç–æ—á–∫–æ–π');
this.updateUI(); this.renderMine(); this.save();
},

buyPhoenixEye(){
const cost=this.gemsCosts.phoenixEye;
if((this.d.gems||0)<cost){ this.notify('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫—Ä–∏—Å—Ç–∞–ª–ª–æ–≤','error'); return; }
this.d.gems-=cost;
this.d.phoenixEyeActive=true;
this.notify('–§–µ–Ω–∏–∫—Å –ì–ª–∞–∑: –≤–∏–¥–Ω—ã —Ç–∏–ø—ã –ø—Ä–∏–∑–æ–≤. –ù–µ –ø–æ–Ω—Ä–∞–≤–∏–ª–æ—Å—å ‚Äî –æ–±–Ω–æ–≤–∏—Ç–µ —à–∞—Ö—Ç—É.');
this.updateUI(); this.renderMine(); this.save();
},

buyExpForGems(){
const cost=this.gemsCosts.exp100||20;
if((this.d.gems||0)<cost){ this.notify('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫—Ä–∏—Å—Ç–∞–ª–ª–æ–≤','error'); return; }
this.d.gems-=cost;
this.addExp(100);
this.notify('+100 –æ–ø—ã—Ç–∞!');
this.updateUI(); this.save();
},

dig(idx){
const b=this.d.mineBlocks[idx];
if(b.cl)return;
if(this.d.digsLeft<=0){
this.notify('–ù–µ—Ç –ø–æ–ø—ã—Ç–æ–∫! –ü–æ–ª—É—á–∏—Ç–µ –∏—Ö –≤ –∑–∞–¥–∞–Ω–∏—è—Ö —á–µ—Ä–µ–∑ —á–µ–∫–∏–Ω.','error');
return;
}
this.d.digsLeft--;
this.d.actions++;this.addExp(10);
b.cl=true;
if(!this.d.mineHistory)this.d.mineHistory=[];
if(!b.hasPrize){
this.d.mineHistory.push({t:'–ö–æ–ø–∫–∞',r:'–ü—É—Å—Ç–æ'});
this.notify('–ü—É—Å—Ç–æ... üòî');
this.renderMine();
this.updateUI();
this.save();
return;
}
const rw=b.reward;
if(rw.type==='amulet'){
this.d.mineHistory.push({t:'–ö–æ–ø–∫–∞',r:rw.n||'–ê–º—É–ª–µ—Ç'});
this.d.amulets.push({...rw,obt:Date.now()});
this.showReward(rw,b.rarity);
}else if(rw.type==='relic'){
this.d.mineHistory.push({t:'–ö–æ–ø–∫–∞',r:rw.n||'–†–µ–ª–∏–∫–≤–∏—è'});
this.d.relics.push({...rw,id:`ri${Date.now()}_${Math.random()}`});
this.d.relicsFound++;
this.showReward(rw,b.rarity);
}else if(rw.type==='coins'){
this.d.mineHistory.push({t:'–ö–æ–ø–∫–∞',r:'ü™ô '+ (rw.amount||50)});
this.d.coins+=rw.amount||50;
this.notify(`üí∞ +${rw.amount||50} ü™ô`);
}
this.renderMine();
this.updateUI();this.save();
},

getEffectDescription(rw){
const catalog=window.ITEMS_CATALOG||[];
const byName=catalog.find(x=>x.name===rw.n);
if(byName&&byName.effect) return byName.effect;
if(rw.ev!=null) return `–ë–æ–Ω—É—Å +${rw.ev}% –∫ –¥–æ—Ö–æ–¥—É, –∑–∞—â–∏—Ç–µ –∏–ª–∏ –ø—Ä–æ–¥–∞–∂–µ ‚Äî —Å–º–æ—Ç—Ä–∏ —Å–ª–æ—Ç –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ.`;
return '–ë–æ–Ω—É—Å –∫ –∑–¥–∞–Ω–∏—è–º –∏–ª–∏ —à–∞—Ö—Ç–µ ‚Äî —Å–º–æ—Ç—Ä–∏ –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ.';
},
showReward(rw,rarity){
const rd=this.raritySystem[rarity];
document.getElementById('rwmt').textContent='üéâ –ù–∞–≥—Ä–∞–¥–∞!';
let h=`<div style="text-align:center"><div style="font-size:80px;margin-bottom:15px">${rw.i}</div><h2 style="color:${rd.color}">${rw.n}</h2><div style="background:${rd.color};color:#fff;padding:5px 15px;border-radius:20px;display:inline-block;margin:15px 0;font-weight:700">${rd.name}</div></div>`;
if(rw.type==='amulet'){
const effLabel={immunity:'–ò–º–º—É–Ω–∏—Ç–µ—Ç –∫ –ü–∞–¥–µ–Ω–∏—é –Ω–µ–±–∞',no_loss:'–ó–¥–∞–Ω–∏—è –Ω–µ —Ç–µ—Ä—è—é—Ç –º–æ–Ω–µ—Ç—ã',freeze:'–ó–∞–º–æ—Ä–æ–∑–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ –∑–¥–∞–Ω–∏–π',income_x3:'–¢—Ä–æ–π–Ω–æ–π –¥–æ—Ö–æ–¥ 12—á',relic_x2:'–£–¥–≤–æ–µ–Ω–∏–µ —à–∞–Ω—Å–∞ —Ä–µ–ª–∏–∫–≤–∏–π'}[rw.e]||rw.e;
h+=`<div class="info"><p style="text-align:center">–ê–º—É–ª–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å!</p><p style="text-align:center;font-size:12px;opacity:.9;margin-top:6px">–ß—Ç–æ –¥–∞—ë—Ç: <strong>${effLabel}</strong></p></div>`;
}else if(rw.type==='relic'){
const effText=this.getEffectDescription(rw);
h+=`<div class="info"><p style="text-align:center">–†–µ–ª–∏–∫–≤–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å!</p><p style="text-align:center;font-size:12px;opacity:.9;margin-top:6px">–ß—Ç–æ –¥–∞—ë—Ç: <strong>${effText}</strong></p></div>`;
}
h+=`<div style="text-align:center;margin-top:20px"><button class="btn btn-success btn-big" onclick="G.closeM('rewardModal')">–û—Ç–ª–∏—á–Ω–æ!</button></div>`;
document.getElementById('rwmc').innerHTML=h;
this.openM('rewardModal');
},

async doCheckin(){
if(this.API_BASE){
try{
const r=await fetch(this.API_BASE+'/api/game/checkin',{method:'POST',headers:{'X-Telegram-User-Id':String(this.myPlayerId||0)}});
const data=await r.json().catch(()=>({}));
this.d.digsLeft=data.attempts_balance!==undefined?data.attempts_balance:this.d.digsLeft;
if(data.next_checkin_at) this.d.nextCheckinAt=new Date(data.next_checkin_at.replace('Z','')).getTime();
if(data.ok){
this.notify('‚úÖ –ü–æ–ª—É—á–µ–Ω–æ '+data.granted_attempts+' –ø–æ–ø—ã—Ç–æ–∫ –∫–æ–ø–∞–Ω–∏—è!');
this.renderMine();
}else{
this.notify(data.message==='cooldown'?'–ü–æ–¥–æ–∂–¥–∏—Ç–µ –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —á–µ–∫–∏–Ω–∞ (—Å–º. —Ç–∞–π–º–µ—Ä)':'–ß–µ–∫–∏–Ω –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω','error');
}
this.updateCheckinUI(); this.save(); return;
}catch(e){ this.notify('–û—à–∏–±–∫–∞ —á–µ–∫–∏–Ω–∞','error'); return; }
}
const now=Date.now();
if(this.d.nextCheckinAt!=null&&now<this.d.nextCheckinAt){ this.notify('–ü–æ–¥–æ–∂–¥–∏—Ç–µ –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —á–µ–∫–∏–Ω–∞','error'); return; }
if(this.d.lastCheckin){
const elapsed=now-this.d.lastCheckin;
const tenHours=10*60*60*1000;
if(elapsed<tenHours){ const left=tenHours-elapsed; const h=Math.floor(left/(60*60*1000)); const m=Math.floor((left%(60*60*1000))/(60*1000)); this.notify(`–ü–æ–¥–æ–∂–¥–∏—Ç–µ ${h}—á ${m}–º –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —á–µ–∫–∏–Ω–∞`,'error'); return; }
}
this.d.actions++;this.addExp(10);
this.d.digsLeft=3;
this.d.lastCheckin=now;
this.notify('‚úÖ –ü–æ–ª—É—á–µ–Ω–æ 3 –ø–æ–ø—ã—Ç–æ–∫ –∫–æ–ø–∞–Ω–∏—è!');
this.updateCheckinUI();
this.renderMine();
this.save();
},

updateCheckinUI(){
const btn=document.getElementById('checkinBtn');
const timer=document.getElementById('checkinTimer');
document.getElementById('checkinDigs').textContent=this.d.digsLeft;
const now=Date.now();
let canCheckin=false;
let leftMs=0;
if(this.d.nextCheckinAt!=null&&this.d.nextCheckinAt!==undefined){
canCheckin=now>=this.d.nextCheckinAt;
if(!canCheckin) leftMs=Math.max(0,this.d.nextCheckinAt-now);
}else if(this.d.lastCheckin){
const tenHours=10*60*60*1000;
const elapsed=now-this.d.lastCheckin;
canCheckin=elapsed>=tenHours;
if(!canCheckin) leftMs=Math.max(0,tenHours-elapsed);
}else{
canCheckin=true;
}
if(canCheckin){
if(btn) btn.disabled=false;
if(timer) timer.textContent='–î–æ—Å—Ç—É–ø–Ω–æ —Å–µ–π—á–∞—Å!';
}else{
if(btn) btn.disabled=true;
if(timer&&leftMs>0){
const h=Math.floor(leftMs/(60*60*1000));
const m=Math.floor((leftMs%(60*60*1000))/(60*1000));
const s=Math.floor((leftMs%(60*1000))/1000);
timer.textContent=`–°–ª–µ–¥—É—é—â–∏–π —á–µ—Ä–µ–∑: ${h}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
}
}
const listForRank=this.API_BASE?this.leaderboardList:this.allPlayers;
const myIdx=listForRank&&listForRank.length?listForRank.findIndex(p=>p.id===this.myPlayerId):-1;
const myRankEl=document.getElementById('myRank');
const totalEl=document.getElementById('totalPlayers');
if(myRankEl) myRankEl.textContent=myIdx>=0?(myIdx+1):'-';
if(totalEl) totalEl.textContent=listForRank&&listForRank.length?listForRank.length:'0';
},

updateDigsTimer(){
const el=document.getElementById('digsTimer');
if(!el)return;
const now=Date.now();
let leftMs=0;
if(this.d.nextCheckinAt!=null&&this.d.nextCheckinAt!==undefined){
if(now>=this.d.nextCheckinAt){ el.textContent='–ì–æ—Ç–æ–≤–æ!'; return; }
leftMs=this.d.nextCheckinAt-now;
}else if(this.d.lastCheckin){
const tenHours=10*60*60*1000;
const elapsed=now-this.d.lastCheckin;
if(elapsed>=tenHours){ el.textContent='–ì–æ—Ç–æ–≤–æ!'; return; }
leftMs=tenHours-elapsed;
}else{ el.textContent='–ì–æ—Ç–æ–≤–æ!'; return; }
const h=Math.floor(leftMs/(60*60*1000));
const m=Math.floor((leftMs%(60*60*1000))/(60*1000));
const s=Math.floor((leftMs%(60*1000))/1000);
el.textContent=`${h}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
},

switchTab(t){
['Relics','Amulets','Diamonds'].forEach(x=>{
const el=document.getElementById('market'+x);
if(el)el.style.display='none';
const tab=document.getElementById('tab'+x);
if(tab)tab.className='btn btn-small';
});
const showEl=document.getElementById('market'+t.charAt(0).toUpperCase()+t.slice(1));
if(showEl)showEl.style.display='block';
const showTab=document.getElementById('tab'+t.charAt(0).toUpperCase()+t.slice(1));
if(showTab)showTab.className='btn btn-small btn-success';
if(t==='relics')this.renderMarketRelics();
if(t==='amulets'){ this.renderMarketAmulets(); this._fetchRates().then(()=>this.renderMarketAmulets()); }
if(t==='diamonds'){ this.renderMarketDiamonds(); this._fetchRates().then(()=>this.renderMarketDiamonds()); }
},

switchMarketTab(t){
if(!document.getElementById('tabMarketSell')){ if(t==='sell')this.switchTab('relics'); return; }
['marketSellBlock','marketP2PBlock','marketOrdersBlock','marketOffersBlock'].forEach(id=>{
const e=document.getElementById(id);
if(e)e.style.display='none';
});
['marketRelics','marketAmulets','marketDiamonds'].forEach(id=>{
const e=document.getElementById(id);
if(e)e.style.display='none';
});
['tabMarketSell','tabMarketP2P','tabMarketOrders','tabMarketOffers'].forEach(id=>{
const el=document.getElementById(id);
if(el)el.className='btn btn-small';
});
if(t==='sell'){
const mr=document.getElementById('marketRelics');
const ma=document.getElementById('marketAmulets');
const md=document.getElementById('marketDiamonds');
if(mr)mr.style.display='block';
if(ma)ma.style.display='none';
if(md)md.style.display='none';
const tab=document.getElementById('tabMarketSell');
if(tab)tab.className='btn btn-small btn-success';
this.switchTab('relics');
}else if(t==='p2p'){
const e=document.getElementById('marketP2PBlock');
if(e)e.style.display='block';
document.getElementById('tabMarketP2P').className='btn btn-small btn-success';
}else if(t==='orders'){
const e=document.getElementById('marketOrdersBlock');
if(e)e.style.display='block';
document.getElementById('tabMarketOrders').className='btn btn-small btn-success';
this.renderMarketOrders();
}else if(t==='offers'){
const e=document.getElementById('marketOffersBlock');
if(e)e.style.display='block';
document.getElementById('tabMarketOffers').className='btn btn-small btn-success';
this.renderMarketOffers();
}
},

invFilter:'all',
applyInvFilter(){
const sel=document.getElementById('invFilterSelect');
this.invFilter=(sel&&sel.value)||'all';
this.renderInventoryContent(this.invFilter);
},
renderInventoryContent(filter){
const content=document.getElementById('inventoryTabContent');
if(!content)return;
const show=(f)=>!filter||filter==='all'||filter===f;
content.innerHTML='';
const frag=document.createDocumentFragment();
const now=Date.now();
this.d.buffs=this.d.buffs.filter(b=>b.exp>now);
const relics=this.d.relics||[];
const amulets=this.d.amulets||[];
const buffs=this.d.buffs||[];
const curses=this.d.curses||[];
const eggs=this.d.eggs||[];
const letters=this.d.letters||[];
function addRelics(){
if(!show('relics'))return;
if(relics.length===0&&filter==='relics'){ const d=document.createElement('div'); d.className='info'; d.style.textAlign='center'; d.style.opacity='.7'; d.textContent='–†–µ–ª–∏–∫–≤–∏–π –Ω–µ—Ç'; content.appendChild(d); return; }
if(filter==='all'){ const t=document.createElement('div'); t.className='help-section'; t.style.marginTop='16px'; t.innerHTML='<h4 style="margin-bottom:8px">‚ú® –†–µ–ª–∏–∫–≤–∏–∏</h4>'; content.appendChild(t); }
const groups={};
relics.forEach((r,idx)=>{ const key=`${r.n}|${r.ev}|${r.rarity||'fire'}`; if(!groups[key])groups[key]={r,indices:[]}; groups[key].indices.push(idx); });
let h='<div class="inv-content-grid">';
Object.keys(groups).forEach(key=>{
const g=groups[key], r=g.r, firstIdx=g.indices[0], qty=g.indices.length;
const effDesc=G.getEffectDescription(r);
const rarityName=(G.raritySystem[r.rarity||'fire']||{}).name||r.rarity||'';
const rarityColor=G.raritySystem[r.rarity||'fire']?.color||'#ff6600';
h+=`<div class="inv-action-card inv-card-clickable" style="border-color:${rarityColor}40;cursor:pointer" onclick="G.showItemCard('relic',${firstIdx})" role="button" tabindex="0">`;
if(qty>1) h+=`<span class="inv-card-qty">√ó${qty}</span>`;
h+=`<div class="inv-card-head"><span class="inv-card-icon">${r.i||'‚ú®'}</span><span class="inv-card-title">${r.n}</span><span style="font-size:10px;font-weight:700;text-transform:uppercase;padding:3px 6px;border-radius:6px;background:${rarityColor}33;color:${rarityColor}">${rarityName}</span></div>`;
h+=`<div class="inv-card-body">${effDesc}</div>`;
h+=`<div style="padding:10px 14px;font-size:11px;color:rgba(255,255,255,.5);text-align:center">–ù–∞–∂–º–∏—Ç–µ ‚Äî –∫–∞—Ä—Ç–æ—á–∫–∞ —Å –¥–µ–π—Å—Ç–≤–∏—è–º–∏</div>`;
h+='</div>';
});
h+='</div>';
content.insertAdjacentHTML('beforeend',h);
}
function addAmulets(){
if(!show('amulets'))return;
if(amulets.length===0&&filter==='amulets'){ const d=document.createElement('div'); d.className='info'; d.style.textAlign='center'; d.style.opacity='.7'; d.textContent='–ê–º—É–ª–µ—Ç–æ–≤ –Ω–µ—Ç'; content.appendChild(d); return; }
if(filter==='all'){ const t=document.createElement('div'); t.className='help-section'; t.style.marginTop='16px'; t.innerHTML='<h4 style="margin-bottom:8px">üîÆ –ê–º—É–ª–µ—Ç—ã</h4>'; content.appendChild(t); }
const effLabels={immunity:'–ò–º–º—É–Ω–∏—Ç–µ—Ç –∫ –ü–∞–¥–µ–Ω–∏—é –Ω–µ–±–∞',no_loss:'–ó–¥–∞–Ω–∏—è –Ω–µ —Ç–µ—Ä—è—é—Ç –º–æ–Ω–µ—Ç—ã',freeze:'–ó–∞–º–æ—Ä–æ–∑–∫–∞ –≤—Ä–µ–º–µ–Ω–∏',income_x3:'–¢—Ä–æ–π–Ω–æ–π –¥–æ—Ö–æ–¥ 12—á',relic_x2:'–£–¥–≤–æ–µ–Ω–∏–µ —à–∞–Ω—Å–∞ —Ä–µ–ª–∏–∫–≤–∏–π'};
const groups={};
amulets.forEach((a,idx)=>{ const key=a.id||idx; if(!groups[key])groups[key]={a,indices:[]}; groups[key].indices.push(idx); });
let h='<div class="inv-content-grid">';
Object.keys(groups).forEach(key=>{
const g=groups[key], a=g.a, firstIdx=g.indices[0], qty=g.indices.length;
const effText=effLabels[a.e]||a.e||'';
h+=`<div class="inv-action-card inv-card-clickable" style="cursor:pointer" onclick="G.showItemCard('amulet',${firstIdx})" role="button" tabindex="0">`;
if(qty>1) h+=`<span class="inv-card-qty">√ó${qty}</span>`;
h+=`<div class="inv-card-head"><span class="inv-card-icon">${a.i||'üîÆ'}</span><span class="inv-card-title">${a.n}</span></div>`;
h+=`<div class="inv-card-body">${effText}</div>`;
h+=`<div style="padding:10px 14px;font-size:11px;color:rgba(255,255,255,.5);text-align:center">–ù–∞–∂–º–∏—Ç–µ ‚Äî –∫–∞—Ä—Ç–æ—á–∫–∞ —Å –¥–µ–π—Å—Ç–≤–∏—è–º–∏</div>`;
h+='</div>';
});
h+='</div>';
content.insertAdjacentHTML('beforeend',h);
}
function addBuffs(){
if(!show('buffs'))return;
if(buffs.length===0&&filter==='buffs'){ const d=document.createElement('div'); d.className='info'; d.style.textAlign='center'; d.style.opacity='.7'; d.textContent='–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –±–∞—Ñ–æ–≤'; content.appendChild(d); return; }
if(filter==='all'){ const t=document.createElement('div'); t.className='help-section'; t.style.marginTop='16px'; t.innerHTML='<h4 style="margin-bottom:8px">‚ö° –ë–∞—Ñ—ã</h4>'; content.appendChild(t); }
let h='<div class="inv-content-grid">';
buffs.forEach(b=>{
const left=b.exp-now; const hrs=Math.floor(left/3600000); const mins=Math.floor((left%3600000)/60000);
h+=`<div class="inv-action-card"><div class="inv-card-head"><span class="inv-card-icon">${b.r.i||'‚ú®'}</span><span class="inv-card-title">${b.r.n}</span></div><div class="inv-card-body">–≠—Ñ—Ñ–µ–∫—Ç: +${b.r.ev}%<br><span style="color:#ff8c00;font-size:11px">–û—Å—Ç–∞–ª–æ—Å—å: ${hrs}—á ${mins}–º</span></div></div>`;
});
h+='</div>';
content.insertAdjacentHTML('beforeend',h);
}
function addCurses(){
if(!show('curses'))return;
if(filter!=='curses'&&curses.length===0)return;
if(curses.length===0){ const d=document.createElement('div'); d.className='info'; d.style.textAlign='center'; d.style.opacity='.7'; d.textContent='–ü–æ—Ä—á–∏ ‚Äî —Å–∫–æ—Ä–æ.'; content.appendChild(d); return; }
const d=document.createElement('div'); d.className='info'; d.style.opacity='.8'; d.textContent='–ü–æ—Ä—á–∏: '+curses.length; content.appendChild(d);
}
function addEggs(){
if(!show('eggs'))return;
if(filter!=='eggs'&&eggs.length===0)return;
if(eggs.length===0){ const d=document.createElement('div'); d.className='info'; d.style.textAlign='center'; d.style.opacity='.7'; d.textContent='–Ø–π—Ü–∞ ‚Äî —Å–∫–æ—Ä–æ.'; content.appendChild(d); return; }
const d=document.createElement('div'); d.className='info'; d.style.opacity='.8'; d.textContent='–Ø–π—Ü–∞: '+eggs.length; content.appendChild(d);
}
function addLetters(){
if(!show('letters'))return;
const d=document.createElement('div'); d.className='info'; d.style.marginBottom='10px';
if(filter==='letters'&&letters.length===0){ d.style.textAlign='center'; d.style.opacity='.7'; d.textContent='–ë—É–∫–≤ –Ω–µ—Ç (–ø–æ–ª—É—á–∞—é—Ç—Å—è –ø—Ä–∏ —Å–∂–∏–≥–∞–Ω–∏–∏ —Ä–µ–ª–∏–∫–≤–∏–π)'; content.appendChild(d); return; }
d.innerHTML='<div style="margin-bottom:8px"><strong style="color:#ffa500">üî§ –ë—É–∫–≤—ã</strong> <span style="opacity:.9">('+letters.length+')</span></div><div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:8px">'+(letters.map(l=>'<span class="btn btn-small" style="min-width:44px;font-size:18px">'+l+'</span>').join('')||'<span style="opacity:.7">‚Äî</span>')+'</div><button type="button" class="btn btn-small btn-success" onclick="G.showInvLetters()">–û—Ç–∫—Ä—ã—Ç—å –∫–≤–µ—Å—Ç –§–µ–Ω–∏–∫—Å</button>';
content.appendChild(d);
}
addRelics(); addAmulets(); addBuffs(); addCurses(); addEggs(); addLetters();
if(content.children.length===0){ const d=document.createElement('div'); d.className='info'; d.style.textAlign='center'; d.style.opacity='.7'; d.textContent='–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –ø—É—Å—Ç'; content.appendChild(d); }
},
switchInvTab(t){
const sel=document.getElementById('invFilterSelect');
if(sel){ sel.value=t||'all'; this.invFilter=sel.value; }
this.renderInventoryContent(this.invFilter||t||'all');
},

refreshMineHistory(){
const list=document.getElementById('mineHistoryList');
if(!list)return;
const hist=this.d.mineHistory||[];
if(hist.length===0){ list.innerHTML='<div style="opacity:.7">–ü–æ–∫–∞ –Ω–µ—Ç –∫–æ–ø–æ–∫</div>'; return; }
list.innerHTML=hist.slice(-20).reverse().map(h=>`<div class="ir">${h.t||'–ö–æ–ø–∫–∞'}: ${h.r||'‚Äî'}</div>`).join('');
},

openBuildingsCatalog(){ this.showScreen('village'); this.showNew(); },
openUpgradeBuilding(){ this.showScreen('village'); this.notify('–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∑–¥–∞–Ω–∏–µ –Ω–∞ –∫–∞—Ä—Ç–µ, –∑–∞—Ç–µ–º ¬´–î–æ —É—Ä–æ–≤–Ω—è N¬ª.'); },
openRelicsInBuildings(){ this.showScreen('village'); this.notify('–û—Ç–∫—Ä–æ–π—Ç–µ –∑–¥–∞–Ω–∏–µ –Ω–∞ –∫–∞—Ä—Ç–µ ‚Äî –≤ –∫–∞—Ä—Ç–æ—á–∫–µ –∑–¥–∞–Ω–∏—è –±—É–¥—É—Ç —Å–ª–æ—Ç—ã –¥–ª—è —Ä–µ–ª–∏–∫–≤–∏–π (–≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ).'); },
openDemolish(){ this.showScreen('village'); this.notify('–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∑–¥–∞–Ω–∏–µ –Ω–∞ –∫–∞—Ä—Ç–µ, –≤ –∫–∞—Ä—Ç–æ—á–∫–µ –Ω–∞–∂–º–∏—Ç–µ ¬´–°–Ω–µ—Å—Ç–∏¬ª.'); },
openVillageSummary(){
this.showScreen('village');
let ti=0; this.d.buildings.forEach(b=>{ const t=this.buildingTypes[b.t]; if(t) ti+=t.inc*b.lv; });
this.notify('–î–æ—Ö–æ–¥ –≤ —á–∞—Å: '+ti+' ü™ô. –í—Å–µ–≥–æ –ø–æ—Å—Ç—Ä–æ–µ–∫: '+this.d.buildings.length+'/9.');
},

marketBuy(){ this.notify('–ö—É–ø–∏—Ç—å ‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ –ª–æ—Ç –≤ —Å–ø–∏—Å–∫–µ (—Å–∫–æ—Ä–æ).'); },
marketCreateOrder(){ this.notify('–°–æ–∑–¥–∞—Ç—å –æ—Ä–¥–µ—Ä ‚Äî —Å–∫–æ—Ä–æ.'); },
marketCreateExchange(){ this.notify('–°–æ–∑–¥–∞—Ç—å –æ–±–º–µ–Ω P2P ‚Äî —Å–∫–æ—Ä–æ.'); },
marketAcceptExchange(){ this.notify('–ü—Ä–∏–Ω—è—Ç—å –æ–±–º–µ–Ω ‚Äî —Å–∫–æ—Ä–æ.'); },
marketCancel(){ this.notify('–û—Ç–º–µ–Ω–∏—Ç—å –æ—Ä–¥–µ—Ä/–æ—Ñ—Ñ–µ—Ä ‚Äî —Å–∫–æ—Ä–æ.'); },
renderMarketOrders(){ const el=document.getElementById('marketOrdersList'); if(el)el.innerHTML='<p class="info">–ú–æ–∏ –æ—Ä–¥–µ—Ä–∞ ‚Äî —Å–∫–æ—Ä–æ.</p>'; },
renderMarketOffers(){ const el=document.getElementById('marketOffersList'); if(el)el.innerHTML='<p class="info">–ú–æ–∏ –æ—Ñ—Ñ–µ—Ä—ã ‚Äî —Å–∫–æ—Ä–æ.</p>'; },

openWalletBindFromProfile(){ this.openAuthModal(); },
toggleAds(){ this.notify('–†–µ–∫–ª–∞–º–∞ –≤–∫–ª/–≤—ã–∫–ª ‚Äî —Å–∫–æ—Ä–æ.'); },
watchAd(){ this.notify('–°–º–æ—Ç—Ä–µ—Ç—å —Ä–µ–∫–ª–∞–º—É ‚Äî —Å–∫–æ—Ä–æ.'); },
openProfileContribution(){ this.notify('–í–∫–ª–∞–¥ –≤ –ø—Ä–æ—Ñ–∏–ª—å (—Ä–µ–π—Ç–∏–Ω–≥ ¬´–°–∞–º—ã–µ —Å–µ—Ä–¥–µ—á–Ω—ã–µ¬ª) ‚Äî —Å–∫–æ—Ä–æ.'); },
openSettings(){ this.notify('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Äî —Å–∫–æ—Ä–æ.'); },
openSkyFallArmy(){ this.notify('–£–≤–µ–ª–∏—á–∏—Ç—å –∞—Ä–º–∏—é –∑–∞ –ø—Ä–∏–ø–∞—Å—ã (–∑–¥–∞–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥—è—Ç –ø—Ä–∏ –Ω–µ—Ö–≤–∞—Ç–∫–µ). –ê—Ä–º–µ–π—Å–∫–∏–µ –∑–¥–∞–Ω–∏—è: –∫–∞–∂–¥—ã–π —É—Ä–æ–≤–µ–Ω—å √ó2 –ø—Ä–∏—Ä–æ—Å—Ç. ‚Äî –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ.'); },
openSkyFallAttack(){ this.notify('–ê—Ç–∞–∫–æ–≤–∞—Ç—å –∏–≥—Ä–æ–∫–∞ –∏ –∑–∞–±—Ä–∞—Ç—å –ø—Ä–∏–ø–∞—Å—ã –¥–ª—è –≤—ã–∂–∏–≤–∞–Ω–∏—è. ‚Äî –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ.'); },
openSkyFallCurse(){ this.notify('–ù–∞–ª–æ–∂–∏—Ç—å –ø–æ—Ä—á—É –Ω–∞ –∑–¥–∞–Ω–∏–µ –∏–ª–∏ –∞—Ä–º–∏—é –ª—é–±–æ–≥–æ –∏–≥—Ä–æ–∫–∞. ‚Äî –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ.'); },

openRules(){ this.openHelp(); },
openSupport(){ this.notify('–ü–æ–¥–¥–µ—Ä–∂–∫–∞: @phoenix_support –∏–ª–∏ —Å—Å—ã–ª–∫–∞ –∏–∑ ¬´–û –ø—Ä–æ–µ–∫—Ç–µ¬ª.'); },
openNotifications(){ this.notify('–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è ‚Äî —Å–∫–æ—Ä–æ.'); },

invUse(){ this.notify('–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç –≤ —Å–ø–∏—Å–∫–µ ‚Äî –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –∫–∞—Ä—Ç–æ—á–∫–∞ —Å –¥–µ–π—Å—Ç–≤–∏—è–º–∏.'); },
invPutInBuilding(){ this.notify('–ü–æ—Å—Ç–∞–≤–∏—Ç—å –≤ –∑–¥–∞–Ω–∏–µ ‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ –∑–¥–∞–Ω–∏–µ –Ω–∞ –∫–∞—Ä—Ç–µ (—Å–∫–æ—Ä–æ).'); },
invMerge(){ this.showMerge(); },
invSell(){ this.showScreen('market'); this.switchTab('relics'); },
invPlaceOrder(){ this.notify('–†–∞–∑–º–µ—Å—Ç–∏—Ç—å –æ—Ä–¥–µ—Ä ‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç –∏ –ø–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –ú–∞—Ä–∫–µ—Ç (—Å–∫–æ—Ä–æ).'); this.showScreen('market'); },

showItemCard(type,index){
const titleEl=document.getElementById('itemCardTitle');
const contentEl=document.getElementById('itemCardContent');
if(!titleEl||!contentEl)return;
let h='', title='';
if(type==='relic'){
const r=this.d.relics[index];
if(!r){ this.notify('–ü—Ä–µ–¥–º–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω','error'); return; }
const p=this.basePriceByRarity[r.rarity]||80;
const pPts=Math.ceil(p/10);
const phxEq=pPts*2;
const effDesc=this.getEffectDescription(r);
const rarityName=(this.raritySystem[r.rarity||'fire']||{}).name||r.rarity||'';
const rarityColor=this.raritySystem[r.rarity||'fire']?.color||'#ff6600';
title=r.n;
h+=`<div style="text-align:center;margin-bottom:14px"><div style="font-size:56px">${r.i||'‚ú®'}</div><div style="font-size:11px;font-weight:700;text-transform:uppercase;padding:4px 10px;border-radius:8px;display:inline-block;margin-top:8px;background:${rarityColor}33;color:${rarityColor}">${rarityName}</div></div>`;
h+=`<div class="info" style="margin-bottom:12px"><div style="font-size:13px;line-height:1.45">${effDesc}</div></div>`;
h+=`<div style="font-size:11px;color:rgba(255,255,255,.35);text-align:center;margin-bottom:14px">~${p} ü™ô ¬∑ ${pPts} ‚≠ê ¬∑ ${phxEq} PHXPW ‚Äî –Ω–æ–º–∏–Ω–∞–ª –Ω–∞ —Ä—ã–Ω–∫–µ</div>`;
h+=`<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">`;
h+=`<button type="button" class="btn btn-act" onclick="G.closeItemCard();G.actR(${index})">–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å</button>`;
h+=`<button type="button" class="btn btn-burn" onclick="G.closeItemCard();G.burnRelic(${index})">üî• –°–∂–µ—á—å</button>`;
h+=`<button type="button" class="btn btn-sell" onclick="G.closeItemCard();G.sellR(${index})">üè™ –ü—Ä–æ–¥–∞—Ç—å</button>`;
h+=`<button type="button" class="btn btn-merge" onclick="G.closeItemCard();G.showMerge()">üîÄ –°–ª–∏—è–Ω–∏–µ</button>`;
h+=`</div>`;
}else if(type==='amulet'){
const a=this.d.amulets[index];
if(!a){ this.notify('–ü—Ä–µ–¥–º–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω','error'); return; }
const effLabels={immunity:'–ò–º–º—É–Ω–∏—Ç–µ—Ç –∫ –ü–∞–¥–µ–Ω–∏—é –Ω–µ–±–∞',no_loss:'–ó–¥–∞–Ω–∏—è –Ω–µ —Ç–µ—Ä—è—é—Ç –º–æ–Ω–µ—Ç—ã',freeze:'–ó–∞–º–æ—Ä–æ–∑–∫–∞ –≤—Ä–µ–º–µ–Ω–∏',income_x3:'–¢—Ä–æ–π–Ω–æ–π –¥–æ—Ö–æ–¥ 12—á',relic_x2:'–£–¥–≤–æ–µ–Ω–∏–µ —à–∞–Ω—Å–∞ —Ä–µ–ª–∏–∫–≤–∏–π'};
const effText=effLabels[a.e]||a.e||'';
title=a.n;
h+=`<div style="text-align:center;margin-bottom:14px"><div style="font-size:56px">${a.i||'üîÆ'}</div></div>`;
h+=`<div class="info" style="margin-bottom:12px"><div style="font-size:13px;line-height:1.45">${effText}</div></div>`;
h+=`<div style="font-size:11px;color:rgba(255,255,255,.35);text-align:center;margin-bottom:14px">–ê–º—É–ª–µ—Ç ‚Äî –Ω–æ–º–∏–Ω–∞–ª —É—Ç–æ—á–Ω—è–π—Ç–µ –≤ –º–∞—Ä–∫–µ—Ç–µ</div>`;
h+=`<div style="display:grid;gap:8px">`;
h+=`<button type="button" class="btn btn-act" onclick="G.closeItemCard();G.useAmu(${index})">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å</button>`;
h+=`</div>`;
}else{
return;
}
this._itemCardData={type,index};
titleEl.textContent=title;
contentEl.innerHTML=h;
this.openM('itemCardModal');
},
closeItemCard(){
this._itemCardData=null;
this.closeM('itemCardModal');
if(document.getElementById('inventoryScreen')&&document.getElementById('inventoryScreen').classList.contains('active')) this.renderInventoryContent(this.invFilter||'all');
},

renderMarketRelics(){
const shopEl=document.getElementById('marketShopOffers');
if(shopEl) this.loadShopOffers(shopEl);
const l=document.getElementById('marketRelicsList');
const avail=document.getElementById('marketOrdersAvailable');
if(avail){
if(window.MarketModule) MarketModule.renderAvailableOrders(avail,this);
else avail.innerHTML='<div class="info" style="text-align:center;opacity:.7">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –æ—Ä–¥–µ—Ä–æ–≤‚Ä¶</div>';
}
l.innerHTML='';
if(this.d.relics.length===0){
l.innerHTML='<div class="info" style="text-align:center;opacity:.7;padding:24px">–£ –≤–∞—Å –Ω–µ—Ç —Ä–µ–ª–∏–∫–≤–∏–π –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏</div>';
return;
}
const groups={};
this.d.relics.forEach((r,idx)=>{
const key=`${r.n}|${r.ev}|${r.rarity||'fire'}`;
if(!groups[key]) groups[key]={r,indices:[]};
groups[key].indices.push(idx);
});
let html='<div class="inv-relics-grid">';
Object.keys(groups).forEach(key=>{
const g=groups[key];
const r=g.r;
const firstIdx=g.indices[0];
const qty=g.indices.length;
const p=this.basePriceByRarity[r.rarity]||80;
const pPts=Math.ceil(p/10);
const phxEq=pPts*2;
const effDesc=this.getEffectDescription(r);
const rarityName=(this.raritySystem[r.rarity||'fire']||{}).name||r.rarity||'';
const rarityColor=this.raritySystem[r.rarity||'fire']?.color||'#ff6600';
html+=`<div class="inv-relic-card" style="border-color:${rarityColor}40">`;
if(qty>1) html+=`<span class="inv-relic-qty">√ó${qty}</span>`;
html+=`<div class="inv-relic-head"><span class="inv-relic-icon">${r.i||'‚ú®'}</span><span class="inv-relic-title">${r.n}</span><span class="inv-relic-badge" style="background:${rarityColor}33;color:${rarityColor}">${rarityName}</span></div>`;
html+=`<div class="inv-relic-body">${effDesc}</div>`;
html+=`<div class="inv-relic-price"><span>${p} ü™ô</span><span>${pPts} ‚≠ê</span><span>${phxEq} PHXPW</span></div>`;
html+=`<div class="inv-relic-actions"><button type="button" class="btn btn-sell" onclick="G.sellR(${firstIdx})">–ü—Ä–æ–¥–∞—Ç—å ${p}ü™ô</button><button type="button" class="btn btn-merge" onclick="G.showMerge()">–°–ª–∏—è–Ω–∏–µ</button></div>`;
html+='</div>';
});
html+='</div>';
l.innerHTML=html;
},
_shopIcons:{furnace:'üî•',amulet:'üîÆ',artifact_relic:'‚öîÔ∏è',buff:'‚ú®',special:'üìú',relic_slot:'üß©',curse:'üíÄ',egg:'ü•ö'},
_rarityColors:{common:'#aaa',fire:'#ff6600',magic:'#a855f7',rare:'#3b82f6',epic:'#facc15',legendary:'#ef4444',PREMIUM:'#e879f9',EPIC:'#facc15',FIRE:'#ff6600',MAGIC:'#a855f7',TSY:'#14b8a6',YAN:'#f97316',YIN:'#60a5fa'},

async loadShopOffers(container){
if(!container) return;
try{
const r=await fetch(this.API_BASE+'/api/game/shop/offers',{headers:{'X-Telegram-User-Id':String(this.myPlayerId||0)}});
if(!r.ok){ container.innerHTML='<div class="info" style="opacity:.7">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–∞–≥–∞–∑–∏–Ω</div>'; return; }
const offers=await r.json();
if(!offers.length){ container.innerHTML='<div class="info" style="opacity:.7">–ù–µ—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π</div>'; return; }
const coinOffers=offers.filter(o=>o.pay_currency==='COINS');
const starOffers=offers.filter(o=>o.pay_currency==='STARS');
let h='';
if(starOffers.length){
h+='<div style="font-size:12px;font-weight:700;color:#facc15;margin-bottom:8px">–ó–∞ –∑–≤—ë–∑–¥—ã ‚≠ê</div>';
h+=this._renderShopGrid(starOffers);
}
if(coinOffers.length){
h+='<div style="font-size:12px;font-weight:700;color:#ffa500;margin:12px 0 8px">–ó–∞ –º–æ–Ω–µ—Ç—ã ü™ô</div>';
h+=this._renderShopGrid(coinOffers);
}
container.innerHTML=h;
}catch(e){ container.innerHTML='<div class="info" style="opacity:.7">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>'; }
},
_renderShopGrid(offers){
let h='<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:8px">';
offers.forEach(o=>{
const cur=o.pay_currency==='STARS'?'‚≠ê':'ü™ô';
const icon=this._shopIcons[o.item_key?.split('_')[0]]||this._shopIcons[o.rarity]||'üéÅ';
const rc=this._rarityColors[o.rarity]||'#aaa';
const eff=o.effects?.effect||'';
h+=`<div style="background:rgba(255,255,255,0.04);border:1px solid ${rc}33;border-radius:10px;padding:10px;display:flex;flex-direction:column;gap:4px">`;
h+=`<div style="display:flex;align-items:center;gap:8px"><span style="font-size:24px">${icon}</span><span style="font-size:13px;font-weight:700;color:${rc}">${o.item_name||o.item_key}</span></div>`;
if(eff) h+=`<div style="font-size:11px;opacity:.8;line-height:1.3">${eff}</div>`;
const phxEq=o.pay_currency==='STARS'?o.pay_amount*2:Math.ceil(o.pay_amount/5);
h+=`<div style="margin-top:auto;padding-top:6px"><div style="display:flex;align-items:baseline;gap:6px;margin-bottom:4px"><span style="font-size:13px;font-weight:700">${o.pay_amount} ${cur}</span><span style="font-size:10px;opacity:.6">–∏–ª–∏ ${phxEq.toLocaleString('ru-RU')} PHXPW</span></div><button class="btn btn-small btn-success" style="padding:3px 10px;font-size:11px;width:100%" onclick="G.purchaseShopOffer(${o.id},1)">–ö—É–ø–∏—Ç—å</button></div>`;
h+=`</div>`;
});
h+='</div>';
return h;
},
async purchaseShopOffer(offerId,quantity){
try{
const r=await fetch(this.API_BASE+'/api/game/shop/purchase',{method:'POST',headers:{'Content-Type':'application/json','X-Telegram-User-Id':String(this.myPlayerId||0)},body:JSON.stringify({offer_id:offerId,quantity:quantity||1})});
const data=await r.json().catch(()=>({}));
if(!r.ok){ this.notify(data.detail||'–û—à–∏–±–∫–∞ –ø–æ–∫—É–ø–∫–∏'); return; }
this.notify('–ü–æ–∫—É–ø–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞'); this.load(); this.renderMarketRelics();
}catch(e){ this.notify('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'); }
},
async fillMarketOrder(orderId){
if(window.MarketModule) return MarketModule.fillMarketOrder(orderId,this);
this.notify('–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ');
},

renderMarketAmulets(){
const l=document.getElementById('marketAmuletsList');
l.innerHTML='';
const effectNames={immunity:'–ò–º–º—É–Ω–∏—Ç–µ—Ç –æ—Ç –ü–∞–¥–µ–Ω–∏—è –ù–µ–±–∞',no_loss:'–ó–¥–∞–Ω–∏—è –Ω–µ —Ç–µ—Ä—è—é—Ç –º–æ–Ω–µ—Ç—ã',freeze:'–ó–∞–º–æ—Ä–æ–∑–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ –∑–¥–∞–Ω–∏–π',income_x3:'–¢—Ä–æ–π–Ω–æ–π –¥–æ—Ö–æ–¥ 12—á',relic_x2:'–£–¥–≤–æ–µ–Ω–∏–µ —à–∞–Ω—Å–∞ —Ä–µ–ª–∏–∫–≤–∏–π'};
const amulets=[];
Object.values(this.raritySystem).forEach(r=>{
r.items.forEach(item=>{
if(item.type==='amulet')amulets.push(item);
});
});
if(!amulets.length){ l.innerHTML='<div class="info" style="opacity:.7;text-align:center">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∞–º—É–ª–µ—Ç–æ–≤</div>'; return; }
let h='<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:10px">';
amulets.forEach(a=>{
const effLabel=effectNames[a.e]||a.e;
const pts=a.pts||0;
const phxpw=pts*2;
const usd=this._starsToUsd(pts);
h+=`<div style="background:rgba(255,255,255,0.04);border:1px solid rgba(255,140,0,0.25);border-radius:10px;padding:12px;display:flex;flex-direction:column;gap:6px">`;
h+=`<div style="text-align:center;font-size:36px">${a.i}</div>`;
h+=`<div style="font-size:13px;font-weight:700;color:#ffa500;text-align:center">${a.n}</div>`;
h+=`<div style="font-size:11px;opacity:.8;text-align:center;line-height:1.3">${effLabel}</div>`;
h+=`<div style="margin-top:auto;padding-top:8px;text-align:center">`;
h+=`<div style="font-size:13px;font-weight:700;margin-bottom:2px">${pts.toLocaleString('ru-RU')} ‚≠ê –∏–ª–∏ ${phxpw.toLocaleString('ru-RU')} PHXPW</div>`;
h+=`<div style="font-size:10px;opacity:.65;margin-bottom:6px">‚âà $${usd.toFixed(2)}</div>`;
h+=`<button class="btn btn-success btn-small" style="width:100%;font-size:11px" onclick="G.buyAmulet('${a.id}')">–ö—É–ø–∏—Ç—å</button></div></div>`;
});
h+='</div>';
l.innerHTML=h;
},

renderMarketDiamonds(){
const l=document.getElementById('marketDiamondsList');
l.innerHTML='';
const packs=[
{gems:100,pts:50,bonus:0},
{gems:500,pts:200,bonus:50},
{gems:1000,pts:400,bonus:150},
{gems:5000,pts:2000,bonus:1000}
];
let h='<div style="font-size:14px;font-weight:700;color:#ffa500;margin-bottom:12px">üíé –ö—É–ø–∏—Ç—å –∞–ª–º–∞–∑—ã</div>';
h+='<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px;margin-bottom:20px">';
packs.forEach((pk,idx)=>{
const total=pk.gems+(pk.bonus||0);
const phxpw=pk.pts*2;
const usd=this._starsToUsd(pk.pts);
h+=`<div style="background:rgba(255,255,255,0.04);border:1px solid rgba(250,204,21,0.25);border-radius:10px;padding:14px;text-align:center;display:flex;flex-direction:column;gap:6px">`;
h+=`<div style="font-size:32px">üíé</div>`;
h+=`<div style="font-size:18px;font-weight:700;color:#facc15">${pk.gems}${pk.bonus?' <span style="font-size:12px;color:#ff8c00">+'+pk.bonus+'</span>':''}</div>`;
h+=`<div style="font-size:11px;opacity:.8">–ò—Ç–æ–≥–æ: ${total} –∞–ª–º–∞–∑–æ–≤</div>`;
h+=`<div style="margin-top:auto;padding-top:8px">`;
h+=`<div style="font-size:14px;font-weight:700;margin-bottom:2px">${pk.pts.toLocaleString('ru-RU')} ‚≠ê –∏–ª–∏ ${phxpw.toLocaleString('ru-RU')} PHXPW</div>`;
h+=`<div style="font-size:10px;opacity:.65;margin-bottom:6px">‚âà $${usd.toFixed(2)}</div>`;
h+=`<div style="display:flex;gap:4px"><button class="btn btn-success btn-small" style="flex:1;font-size:11px;padding:5px 4px" onclick="G.buyDiamondsForPoints(${idx})">‚≠ê –ö—É–ø–∏—Ç—å</button>`;
h+=`<button class="btn btn-warning btn-small" style="flex:1;font-size:11px;padding:5px 4px" onclick="G.buyDiamonds(${idx})">PHXPW</button></div>`;
h+=`</div></div>`;
});
h+='</div>';
h+='<div class="info" style="margin-top:0"><div style="font-size:14px;font-weight:700;color:#ffa500;margin-bottom:10px">üíé –¢—Ä–∞—Ç–∏—Ç—å –∞–ª–º–∞–∑—ã</div>';
h+='<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:8px">';
const spends=[
{label:'+3 –ø–æ–ø—ã—Ç–æ–∫',cost:10,fn:'buyDigsForGems'},
{label:'–ß–µ–∫–∏–Ω —Å–µ–π—á–∞—Å',cost:15,fn:'reduceCheckinForGems'},
{label:'–ü–æ–¥—Å–∫–∞–∑–∫–∞ —è—á–µ–π–∫–∏',cost:5,fn:'buyMineHint'},
{label:'–ü–æ–ª–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ',cost:15,fn:'buyFullScan'},
{label:'–§–µ–Ω–∏–∫—Å –ì–ª–∞–∑',cost:25,fn:'buyPhoenixEye'},
{label:'+100 –æ–ø—ã—Ç–∞',cost:20,fn:'buyExpForGems'}
];
spends.forEach(s=>{
h+=`<button class="btn btn-small" style="display:flex;flex-direction:column;align-items:center;padding:10px 8px;font-size:11px;line-height:1.3" onclick="G.${s.fn}()"><span>${s.label}</span><span style="font-weight:700;color:#facc15">${s.cost} üíé</span></button>`;
});
h+='</div></div>';
l.innerHTML=h;
},

buyDiamondsForPoints(idx){
const packs=[{gems:100,pts:50,bonus:0},{gems:500,pts:200,bonus:50},{gems:1000,pts:400,bonus:150},{gems:5000,pts:2000,bonus:1000}];
const pk=packs[idx];
const ptsNeed=pk.pts;
if((this.d.points||0)<ptsNeed){ this.notify('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø–æ–∏–Ω—Ç–æ–≤','error'); return; }
this.d.points-=ptsNeed;
this.d.gems+=pk.gems+(pk.bonus||0);
this.notify(`–ö—É–ø–ª–µ–Ω–æ ${pk.gems}+${pk.bonus||0} üíé –∑–∞ ${ptsNeed.toLocaleString('ru-RU')} –ø–æ–∏–Ω—Ç–æ–≤!`);
this.updateUI(); this.save();
},

buyAmulet(id){
const amulets=[];
Object.values(this.raritySystem).forEach(r=>{
r.items.forEach(item=>{
if(item.type==='amulet')amulets.push(item);
});
});
const a=amulets.find(x=>x.id===id);
this.showTxModal({type:'amulet',item:a,amount_pts:a.pts});
},

buyDiamonds(idx){
const packs=[
{gems:100,pts:50,bonus:0},
{gems:500,pts:200,bonus:50},
{gems:1000,pts:400,bonus:150},
{gems:5000,pts:2000,bonus:1000}
];
const pk=packs[idx];
this.showTxModal({type:'diamonds',item:pk,amount_pts:pk.pts});
},

showTxModal(data){
document.getElementById('txmt').textContent=data.type==='amulet'?'–ö—É–ø–∏—Ç—å –ê–º—É–ª–µ—Ç':'–ö—É–ø–∏—Ç—å –ê–ª–º–∞–∑—ã';
const txid=`${Date.now()}_${Math.random().toString(36).substr(2,9)}`;
this._pendingTx={txid,data};
const amountPts=data.amount_pts||0;
const amountPHXPW=amountPts>0?amountPts*2:0;
const usdStars=this._starsToUsd(amountPts);
const usdPhxpw=this._phxpwToUsd(amountPHXPW);
let h=`<div class="info"><div style="text-align:center;margin-bottom:15px">`;
if(data.type==='amulet'){
h+=`<div style="font-size:60px;margin-bottom:10px">${data.item.i}</div><div style="font-size:20px;font-weight:700;color:#ffa500;margin-bottom:10px">${data.item.n}</div>`;
}else{
h+=`<div style="font-size:60px;margin-bottom:10px">üíé</div><div style="font-size:20px;font-weight:700;color:#ffa500;margin-bottom:10px">${data.item.gems}${data.item.bonus?' +'+data.item.bonus:''} –ê–ª–º–∞–∑–æ–≤</div>`;
}
h+=`</div><div class="ir"><span>–°—Ç–æ–∏–º–æ—Å—Ç—å:</span><span style="color:#ffa500;font-weight:700">${amountPts.toLocaleString('ru-RU')} ‚≠ê</span><span style="font-size:11px;opacity:.8"> ‚âà $${usdStars.toFixed(2)}</span></div>`;
h+=`<div class="ir"><span>–ò–ª–∏:</span><span style="color:#ffa500;font-weight:700">${amountPHXPW.toLocaleString('ru-RU')} PHXPW</span><span style="font-size:11px;opacity:.8"> ‚âà $${usdPhxpw.toFixed(2)}</span></div></div>`;
h+=`<div style="margin:15px 0"><div style="font-size:14px;font-weight:700;color:#ffa500;margin-bottom:8px">–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã:</div>`;
h+=`<div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px">`;
h+=`<button class="btn btn-success btn-big" style="flex:1" onclick="G.buyForPoints()">‚≠ê –û–ø–ª–∞—Ç–∞ ${amountPts.toLocaleString('ru-RU')} –ø–æ–∏–Ω—Ç–æ–≤</button>`;
if(amountPHXPW>0){
h+=`<button class="btn btn-warning" style="flex:1" onclick="G.openTxTransfer('phxpw')">üì§ –ü–µ—Ä–µ–≤–æ–¥ ${amountPHXPW.toLocaleString('ru-RU')} PHXPW</button>`;
}
h+=`</div>`;
if(amountPHXPW>0){
h+=`<div style="font-size:12px;opacity:.8">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –ø–µ—Ä–µ–≤–æ–¥—É (—É–∂–µ –≤ —Å—Å—ã–ª–∫–µ): <strong>${txid}</strong></div>`;
h+=`<div style="margin:10px 0"><div style="font-size:12px;font-weight:700;margin-bottom:6px">–ê–¥—Ä–µ—Å –ø—Ä–æ–µ–∫—Ç–∞:</div><input type="text" class="tx-input" value="${this.tonWallet}" readonly onclick="this.select()" style="font-size:11px"></div>`;
h+=`<div style="text-align:center;margin-top:10px"><button class="btn btn-warning" onclick="G.checkTxFromPending()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é PHXPW</button></div>`;
}
h+=`</div>`;
document.getElementById('txmc').innerHTML=h;
this.openM('txModal');
},

buyForPoints(){
if(!this._pendingTx){ this.notify('–ù–µ—Ç –æ–∂–∏–¥–∞—é—â–µ–π –ø–æ–∫—É–ø–∫–∏','error'); return; }
const data=this._pendingTx.data;
const amountPts=data.amount_pts||0;
if(amountPts<=0){ this.notify('–û—à–∏–±–∫–∞: —Ü–µ–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞','error'); return; }
if((this.d.points||0)<amountPts){ this.notify('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø–æ–∏–Ω—Ç–æ–≤! –ù—É–∂–Ω–æ '+amountPts.toLocaleString('ru-RU')+' ‚≠ê','error'); return; }
this.d.points-=amountPts;
if(data.type==='amulet'&&data.item){
if(!this.d.amulets)this.d.amulets=[];
this.d.amulets.push({id:data.item.id,n:data.item.n,i:data.item.i,e:data.item.e,active:false,bought:Date.now()});
this.notify('–ê–º—É–ª–µ—Ç ¬´'+data.item.n+'¬ª –∫—É–ø–ª–µ–Ω –∑–∞ '+amountPts.toLocaleString('ru-RU')+' ‚≠ê!');
}else if(data.type==='diamonds'&&data.item){
const total=data.item.gems+(data.item.bonus||0);
this.d.gems=(this.d.gems||0)+total;
this.notify('–ö—É–ø–ª–µ–Ω–æ '+total+' üíé –∑–∞ '+amountPts.toLocaleString('ru-RU')+' ‚≠ê!');
}
this.closeM('txModal');
this.updateUI(); this.save();
},

openTxTransfer(currency){
if(!this._pendingTx)return;
const txid=this._pendingTx.txid;
const data=this._pendingTx.data;
const amountPts=data.amount_pts||0;
const amountPHXPW=amountPts>0?amountPts*2:0;
const jettonAmountRaw=Math.ceil(amountPHXPW*1e9);
const jettonUrl=`https://app.tonkeeper.com/jetton/${this.PHOEX_JETTON_MASTER}/transfer?address=${encodeURIComponent(this.tonWallet)}&amount=${jettonAmountRaw}&comment=${encodeURIComponent(txid)}`;
try{ if(window.Telegram?.WebApp?.openLink) window.Telegram.WebApp.openLink(jettonUrl); else window.open(jettonUrl,'_blank'); }catch(e){ window.open(jettonUrl,'_blank'); }
this.notify('–û—Ç–∫—Ä–æ–π—Ç–µ –∫–æ—à–µ–ª—ë–∫: –æ—Ç–ø—Ä–∞–≤—å—Ç–µ '+amountPHXPW.toLocaleString('ru-RU')+' PHXPW —Å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–º '+txid);
},

checkTxFromPending(){
if(!this._pendingTx){ this.notify('–ù–µ—Ç –æ–∂–∏–¥–∞—é—â–µ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏','error'); return; }
this.checkTx(this._pendingTx.txid,this._pendingTx.data);
},

checkTx(txid,data){
this.notify('–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏... (–≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ). –†–µ–∞–ª—å–Ω—ã–µ –≤—ã–ø–ª–∞—Ç—ã –Ω–µ –ø—Ä–æ–∏–∑–≤–æ–¥—è—Ç—Å—è.','error');
},

sellR(idx){
const lvl=this.d.level||0;
const sell=this.economy.levels[lvl].sell;
const today=new Date().toDateString();
if(this.d.sellDay!==today){ this.d.sellDay=today; this.d.sellsToday=0; }
this.d.sellsToday=this.d.sellsToday||0;
const r=this.d.relics[idx];
const raw=this.basePriceByRarity[r.rarity]||80;
if(this.d.sellsToday>=sell.perDay){
this.notify('–õ–∏–º–∏—Ç –ø—Ä–æ–¥–∞–∂ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è –∏—Å—á–µ—Ä–ø–∞–Ω.','error');return;
}
if(raw>sell.maxValue){
this.notify('–≠—Ç–∞ –ø—Ä–æ–¥–∞–∂–∞ –ø—Ä–µ–≤—ã—à–∞–µ—Ç –ª–∏–º–∏—Ç –ø–æ —É—Ä–æ–≤–Ω—é.','error');return;
}
const tax=Math.floor(raw*sell.tax);
const net=Math.max(0,raw-tax);
const ptsEq=Math.ceil(raw/10);
const phxEq=ptsEq*2;
if(confirm(`–ü—Ä–æ–¥–∞—Ç—å ${r.n} –∑–∞ ${raw} ü™ô (${ptsEq} ‚≠ê / ${phxEq} PHXPW)? –ù–∞–ª–æ–≥: ${tax} ü™ô, –ø–æ–ª—É—á–∏—Ç–µ: ${net} ü™ô`)){
this.d.coins+=net;
this.d.relics.splice(idx,1);
this.d.sellsToday++;
this.addExp(20);
this.notify(`–ü—Ä–æ–¥–∞–Ω–æ: +${net} ü™ô (–Ω–∞–ª–æ–≥ ${tax})`);
this.switchTab('relics');
this.updateUI();this.save();
}
},

openWithdraw(){
const lvl=this.d.level||0;
if(lvl<3){ this.notify('–í—ã–≤–æ–¥ –¥–æ—Å—Ç—É–ø–µ–Ω —Å —É—Ä–æ–≤–Ω—è L3.','error'); return; }
const maxPHXPW=this.economy.withdraw.perUserCapTON*41650;
const h=`<div class="info">
<div class="ir"><span>–í–∞—à —É—Ä–æ–≤–µ–Ω—å:</span><span>${this.economy.levels[lvl].name} (L${lvl})</span></div>
<div class="ir"><span>–õ–∏–º–∏—Ç/–Ω–µ–¥–µ–ª—é:</span><span>${maxPHXPW.toLocaleString('ru-RU')} PHXPW</span></div>
<div class="ir"><span>–í—ã–≤–æ–¥–æ–≤ –Ω–∞ –Ω–µ–¥–µ–ª–µ:</span><span>${this.d.withdrawsThisWeek||0}/1</span></div>
</div>
<div style="margin:15px 0">
<div style="font-size:14px;font-weight:700;color:#ffa500;margin-bottom:10px">–°—É–º–º–∞ (PHXPW):</div>
<input id="wdAmt" class="tx-input" type="number" min="1000" step="1000" value="1000">
<div style="font-size:12px;opacity:.9;margin-top:6px">–ö–æ–º–∏—Å—Å–∏—è –≤—ã–≤–æ–¥–∞ 5%. –ö –ø–æ–ª—É—á–µ–Ω–∏—é: <span id="wdNetTon">950</span> PHXPW</div>
<button class="btn btn-warning btn-big" onclick="G.requestWithdraw()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å</button>
<div style="font-size:12px;opacity:.7;margin-top:10px">–í—ã–¥–∞—á–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç weekly batch. –í –¥–µ–º–æ ‚Äî –±–µ–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö –≤—ã–ø–ª–∞—Ç.</div>
</div>`;
document.getElementById('txmt').textContent='Withdraw (demo)';
document.getElementById('txmc').innerHTML=h;
const wdInput=document.getElementById('wdAmt');
const updateWdNet=()=>{ const el=document.getElementById('wdNetTon'); if(el){ const a=parseFloat(wdInput.value||'0')||0; el.textContent=Math.floor(a*0.95).toLocaleString('ru-RU'); } };
if(wdInput){ wdInput.oninput=updateWdNet; updateWdNet(); }
this.openM('txModal');
},

requestWithdraw(){
const amt=parseFloat(document.getElementById('wdAmt').value||'0');
const netTon=(amt*0.95).toFixed(2);
const res=this.canWithdrawTON(amt);
if(!res.ok){
this.notify('–í—ã–≤–æ–¥ –æ—Ç–∫–ª–æ–Ω—ë–Ω: –ø—Ä–æ–≤–µ—Ä—å —É—Å–ª–æ–≤–∏—è.','error');
return;
}
if(!confirm(`–ó–∞–ø—Ä–æ—Å–∏—Ç—å –≤—ã–≤–æ–¥ ${amt} PHXPW? –ö–æ–º–∏—Å—Å–∏—è 5%, –∫ –ø–æ–ª—É—á–µ–Ω–∏—é: ${netTon} PHXPW`)){
return;
}
if(!(this.d.lock&&this.d.lock.active)){
this.startFirstLockIfNeeded();
this.notify('–ó–∞–ø—Ä–æ—Å –ø—Ä–∏–Ω—è—Ç. –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω lock 416 500 PHXPW –Ω–∞ 14 –¥–Ω–µ–π (demo).','error');
}else{
this.notify('–ó–∞–ø—Ä–æ—Å –ø—Ä–∏–Ω—è—Ç –≤ weekly batch (demo).');
}
this.d.withdrawsThisWeek=(this.d.withdrawsThisWeek||0)+1;
this.addExp(50);
this.closeM('txModal');
this.save();
},

showMerge(){
if(this.d.relics.length<2){this.notify('–ù—É–∂–Ω–æ 2+ —Ä–µ–ª–∏–∫–≤–∏–∏!','error');return}
let h='<div class="info"><p style="text-align:center;margin-bottom:15px">–í—ã–±–µ—Ä–∏—Ç–µ 2-3 —Ä–µ–ª–∏–∫–≤–∏–∏. –†–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã—à–µ —Ä–µ–¥–∫–æ—Å—Ç–∏!</p></div><div id="mergeSel"></div><div style="text-align:center;margin-top:15px"><button class="btn btn-warning btn-big" onclick="G.doMerge()">üîÆ –û–±—ä–µ–¥–∏–Ω–∏—Ç—å</button></div>';
document.getElementById('mmc').innerHTML=h;
const sel=document.getElementById('mergeSel');
this.d.relics.forEach((r,idx)=>{
const c=document.createElement('div');
c.className='rc';
c.style.borderColor=this.raritySystem[r.rarity||'fire'].color;
c.style.cursor='pointer';
c.onclick=()=>this.togMerge(idx);
c.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><div><span style="font-size:20px;margin-right:8px">${r.i}</span><span style="color:#ffa500;font-weight:700">${r.n}</span></div></div><div style="font-size:12px">–≠—Ñ—Ñ–µ–∫—Ç: +${r.ev}%</div><div id="mc${idx}" style="text-align:center;margin-top:8px;display:none"><span style="color:#ff8c00;font-size:20px">‚úì –í—ã–±—Ä–∞–Ω–æ</span></div>`;
sel.appendChild(c);
});
this.openM('mergeModal');
},

togMerge(idx){
const ce=document.getElementById(`mc${idx}`);
if(this.selectedMerge.includes(idx)){
this.selectedMerge=this.selectedMerge.filter(i=>i!==idx);
ce.style.display='none';
}else{
if(this.selectedMerge.length<3){
this.selectedMerge.push(idx);
ce.style.display='block';
}else this.notify('–ú–∞–∫—Å 3!','error');
}
},

doMerge(){
this.d.actions++;this.addExp(25);
if(this.selectedMerge.length<2){this.notify('–í—ã–±–µ—Ä–∏—Ç–µ 2+!','error');return}
const sr=this.selectedMerge.map(i=>this.d.relics[i]);
const avgEv=sr.reduce((s,r)=>s+(r.ev||50),0)/sr.length;
const newEv=Math.floor(avgEv*1.5);
const nr={
id:`ri${Date.now()}_${Math.random()}`,
n:'–°–ª–∏—Ç–∞—è –†–µ–ª–∏–∫–≤–∏—è –°–∏–ª—ã',
i:'üîÆ',
ev:newEv,
type:'relic',
rarity:'magic'
};
this.selectedMerge.sort((a,b)=>b-a).forEach(i=>this.d.relics.splice(i,1));
this.d.relics.push(nr);
this.selectedMerge=[];
this.notify(`üéâ –°–æ–∑–¥–∞–Ω–∞ —Ä–µ–ª–∏–∫–≤–∏—è —Å —ç—Ñ—Ñ–µ–∫—Ç–æ–º +${newEv}%!`);
this.closeM('mergeModal');
this.updateUI();this.save();
},

showInvRelics(){
document.getElementById('invmt').textContent='‚ú® –†–µ–ª–∏–∫–≤–∏–∏';
let h='';
if(this.d.relics.length===0){
h='<div class="info" style="text-align:center;opacity:.7">–†–µ–ª–∏–∫–≤–∏–π –Ω–µ—Ç</div>';
}else{
const groups={};
this.d.relics.forEach((r,idx)=>{
const key=`${r.n}|${r.ev}|${r.rarity||'fire'}`;
if(!groups[key]) groups[key]={r,indices:[]};
groups[key].indices.push(idx);
});
Object.keys(groups).forEach(key=>{
const g=groups[key];
const r=g.r;
const firstIdx=g.indices[0];
const qty=g.indices.length;
h+=`<div class="rc" style="margin-bottom:10px;border-color:${this.raritySystem[r.rarity||'fire'].color}"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><div><span style="font-size:20px;margin-right:8px">${r.i}</span><span style="color:#ffa500;font-weight:700">${r.n}</span></div></div><div style="font-size:12px">–≠—Ñ—Ñ–µ–∫—Ç: +${r.ev}%</div>${qty>1?`<div class="inv-qty">√ó ${qty}</div>`:''}<div style="display:flex;gap:5px;margin-top:8px;flex-wrap:wrap"><button class="btn btn-small btn-success" onclick="G.actR(${firstIdx})">–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å</button><button class="btn btn-small btn-danger" onclick="G.burnRelic(${firstIdx})">üî• –°–∂–µ—á—å</button></div></div>`;
});
}
document.getElementById('invmc').innerHTML=h;
this.openM('invModal');
},

showInvAmulets(){
document.getElementById('invmt').textContent='üîÆ –ê–º—É–ª–µ—Ç—ã';
let h='';
if(this.d.amulets.length===0){
h='<div class="info" style="text-align:center;opacity:.7">–ê–º—É–ª–µ—Ç–æ–≤ –Ω–µ—Ç</div>';
}else{
const groups={};
this.d.amulets.forEach((a,idx)=>{
const key=a.id||idx;
if(!groups[key]) groups[key]={a,indices:[]};
groups[key].indices.push(idx);
});
Object.keys(groups).forEach(key=>{
const g=groups[key];
const a=g.a;
const firstIdx=g.indices[0];
const qty=g.indices.length;
h+=`<div class="info" style="margin-bottom:10px"><div style="display:flex;align-items:center;gap:12px;margin-bottom:8px"><div style="font-size:40px">${a.i}</div><div style="flex:1"><strong style="color:#ffa500">${a.n}</strong><div style="font-size:12px;opacity:.8">–≠—Ñ—Ñ–µ–∫—Ç: ${a.e}</div></div></div>${qty>1?`<div class="inv-qty">√ó ${qty}</div>`:''}<button class="btn btn-small btn-success" onclick="G.useAmu(${firstIdx})">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å</button></div>`;
});
}
document.getElementById('invmc').innerHTML=h;
this.openM('invModal');
},

phoenixSelectedIds:[],
phoenixSelectedWord:'',
phoenixLetterItems:[],
phoenixWordHint:{},

async showInvLetters(resetSequence){
if(resetSequence!==false){ this.phoenixSelectedIds=[]; this.phoenixSelectedWord=''; }
document.getElementById('invmt').textContent='üî§ –ë—É–∫–≤—ã (–∫–≤–µ—Å—Ç –§–ï–ù–ò–ö–°)';
const hasBadge=!!this.d.phoenixQuestCompleted;
let h='';
if(hasBadge){
h='<div class="info" style="text-align:center"><div style="font-size:48px;margin-bottom:10px">üìñ</div><strong style="color:#ffa500">–ë–µ–π–¥–∂ ¬´–ë—É–∫–≤–∞—Ä—å¬ª</strong><div style="font-size:12px;opacity:.9;margin-top:8px">–í—ã –≤ —Ç–æ–ø-5 –ø–æ –∑–∞–≥–∞–¥–∞–Ω–Ω–æ–º—É —Å–ª–æ–≤—É. –£—á–∞—Å—Ç–≤—É–µ—Ç–µ –≤ –µ–∂–µ–º–µ—Å—è—á–Ω–æ–º –ø—Ä–∏–∑–µ.</div></div>';
}else{
h='<div class="info" style="margin-bottom:10px;font-size:12px">–°–æ–±–µ—Ä–∏—Ç–µ —Å–ª–æ–≤–æ –∏–∑ —Å–≤–æ–∏—Ö –±—É–∫–≤ (–ø–æ–ª—É—á–∞—é—Ç—Å—è –ø—Ä–∏ —Å–∂–∏–≥–∞–Ω–∏–∏ —Ä–µ–ª–∏–∫–≤–∏–π). –ü—Ä–∏ –≤–µ—Ä–Ω–æ–º —Å–ª–æ–≤–µ ‚Äî –º–µ—Å—Ç–æ –≤ —Ç–æ–ø-5 –∏ –±–µ–π–¥–∂ ¬´–ë—É–∫–≤–∞—Ä—å¬ª. –ù–∞ –∫–∞–∂–¥–æ–µ —Å–ª–æ–≤–æ —Ç–æ–ª—å–∫–æ 5 –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π; –∑–∞—Ç–µ–º –Ω–æ–≤–æ–µ —Å–ª–æ–≤–æ. –ë–µ–π–¥–∂ –¥–∞—ë—Ç –ø—Ä–∞–≤–æ –Ω–∞ –µ–∂–µ–º–µ—Å—è—á–Ω—ã–π –ø—Ä–∏–∑.</div>';
if(this.API_BASE){
try{
const [wordR,lettersR]=await Promise.all([
fetch(this.API_BASE+'/api/game/phoenix/word').then(r=>r.ok?r.json():{}),
fetch(this.API_BASE+'/api/game/phoenix/letters',{headers:{'X-Telegram-User-Id':String(this.myPlayerId||0)}}).then(r=>r.ok?r.json():{letters:[]})
]);
this.phoenixWordHint=wordR;
this.phoenixLetterItems=lettersR.letters||[];
}catch(e){ this.phoenixLetterItems=[]; this.phoenixWordHint={}; }
h+='<div class="info" style="margin-bottom:8px">–ü–æ–¥—Å–∫–∞–∑–∫–∞: <span id="phoenixHint">'+ (this.phoenixWordHint.current_word_hint||'?') +'</span> ¬∑ —Å–¥–∞—á: '+ (this.phoenixWordHint.submissions_count||0) +'/5</div>';
h+='<div style="margin-bottom:8px">–°–ª–æ–≤–æ: <span id="phoenixBuiltWord" style="font-size:18px;color:#ffa500"></span> <button type="button" class="btn btn-small" onclick="G.phoenixClearWord()">–°–±—Ä–æ—Å–∏—Ç—å</button></div>';
h+='<div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:12px">';
(this.phoenixLetterItems||[]).forEach(l=>{
h+=`<button type="button" class="btn btn-small" style="min-width:44px;font-size:18px" data-id="${l.id}" data-sym="${(l.symbol||'?').replace(/"/g,'&quot;')}" onclick="G.phoenixAddLetter(${l.id},'${(l.symbol||'?').replace(/'/g,"\\'")}')">${l.symbol||'?'}</button>`;
});
h+='</div>';
h+='<button type="button" class="btn btn-success" onclick="G.phoenixSubmitWord()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–ª–æ–≤–æ</button>';
}else{
h+='<div class="info" style="opacity:.8">–ë—É–∫–≤—ã –∏–∑ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è (–ø—Ä–∏ —Å–∂–∏–≥–∞–Ω–∏–∏). –î–ª—è –∫–≤–µ—Å—Ç–∞ –Ω—É–∂–Ω–∞ —Å–≤—è–∑—å —Å —Å–µ—Ä–≤–µ—Ä–æ–º.</div>';
const letters=this.d.letters||[];
h+='<div style="display:flex;flex-wrap:wrap;gap:8px">';
letters.forEach((ltr,i)=>{ h+=`<span class="btn btn-small" style="min-width:44px;font-size:18px">${ltr}</span>`; });
h+='</div>';
}
}
document.getElementById('invmc').innerHTML=h;
const pw=document.getElementById('phoenixBuiltWord');
if(pw)pw.textContent=this.phoenixSelectedWord;
this.openM('invModal');
},

phoenixAddLetter(itemId,symbol){
this.phoenixSelectedIds=this.phoenixSelectedIds||[];
this.phoenixSelectedWord=this.phoenixSelectedWord||'';
this.phoenixSelectedIds.push(itemId);
this.phoenixSelectedWord+=symbol;
const el=document.getElementById('phoenixBuiltWord');
if(el) el.textContent=this.phoenixSelectedWord;
},

phoenixClearWord(){
this.phoenixSelectedIds=[]; this.phoenixSelectedWord='';
const el=document.getElementById('phoenixBuiltWord');
if(el) el.textContent='';
},

async phoenixSubmitWord(){
if(!this.phoenixSelectedWord||!(this.phoenixSelectedIds||[]).length){
this.notify('–°–æ–±–µ—Ä–∏—Ç–µ —Å–ª–æ–≤–æ –∏–∑ –±—É–∫–≤ (–∫–ª–∏–∫–∞–π—Ç–µ –ø–æ –±—É–∫–≤–∞–º)','error');
return;
}
if(!this.API_BASE){ this.notify('–ù—É–∂–Ω–∞ —Å–≤—è–∑—å —Å —Å–µ—Ä–≤–µ—Ä–æ–º','error'); return; }
try{
const r=await fetch(this.API_BASE+'/api/game/phoenix/submit',{
method:'POST',
headers:{'Content-Type':'application/json','X-Telegram-User-Id':String(this.myPlayerId||0)},
body:JSON.stringify({word:this.phoenixSelectedWord,letter_item_ids:this.phoenixSelectedIds})
});
const j=await r.json().catch(()=>({}));
if(r.ok&&j.success){
this.notify(j.message||'–°–ª–æ–≤–æ –ø—Ä–∏–Ω—è—Ç–æ');
if(j.badge_granted) this.d.phoenixQuestCompleted=true;
this.phoenixSelectedIds=[]; this.phoenixSelectedWord='';
this.closeM('invModal');
this.updateUI(); this.save();
this.showInvLetters(true);
}else{
this.notify(j.message||'–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏','error');
}
}catch(e){
this.notify('–ù–µ—Ç —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º','error');
}
},

showInvBuffs(){
document.getElementById('invmt').textContent='‚ö° –ê–∫—Ç–∏–≤–Ω—ã–µ –ë–∞—Ñ—ã';
let h='';
const now=Date.now();
this.d.buffs=this.d.buffs.filter(b=>b.exp>now);
if(this.d.buffs.length===0){
h='<div class="info" style="text-align:center;opacity:.7">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –±–∞—Ñ–æ–≤</div>';
}else{
this.d.buffs.forEach(b=>{
const left=b.exp-now;
const hrs=Math.floor(left/3600000);
const mins=Math.floor((left%3600000)/60000);
h+=`<div class="info" style="margin-bottom:10px"><div style="display:flex;align-items:center;gap:12px"><div style="font-size:40px">${b.r.i}</div><div style="flex:1"><strong style="color:#ffa500">${b.r.n}</strong><div style="font-size:12px;opacity:.8">–≠—Ñ—Ñ–µ–∫—Ç: +${b.r.ev}%</div><div style="font-size:11px;color:#ff8c00;margin-top:5px">–û—Å—Ç–∞–ª–æ—Å—å: ${hrs}—á ${mins}–º</div></div></div></div>`;
});
}
document.getElementById('invmc').innerHTML=h;
this.openM('invModal');
},

actR(idx){
const r=this.d.relics[idx];
this.d.buffs.push({r:r,exp:Date.now()+43200000});
this.notify(`–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞: ${r.n}!`);
this.closeM('invModal');
this.updateUI();
this.save();
},

burnRelic(idx){
const r=this.d.relics[idx];
if(!r){ this.notify('–†–µ–ª–∏–∫–≤–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞','error'); return; }
this.d.relics.splice(idx,1);
let expGain=10+Math.floor((r.ev||0)/2);
this.d.burnedCount=(this.d.burnedCount||0)+1;
if(this.d.burnedCount>50) expGain=Math.floor(expGain*0.5);
this.addExp(expGain);
if(!this.API_BASE){
const letter=this.RUS_ALPHABET[Math.floor(Math.random()*this.RUS_ALPHABET.length)];
this.d.letters=this.d.letters||[];
this.d.letters.push(letter);
this.notify(`–°–æ–∂–∂–µ–Ω–æ! +${expGain} –æ–ø—ã—Ç–∞. –ü–æ–ª—É—á–µ–Ω–∞ –±—É–∫–≤–∞: ${letter}`);
}else{
this.notify(`–°–æ–∂–∂–µ–Ω–æ! +${expGain} –æ–ø—ã—Ç–∞. –ë—É–∫–≤–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å (–∫–≤–µ—Å—Ç –§–ï–ù–ò–ö–°).`);
}
this.closeM('invModal');
if(document.getElementById('inventoryScreen').classList.contains('active')) this.renderInventoryContent(this.invFilter||'all');
else this.showInvRelics();
this.updateUI();
this.save();
},

useAmu(idx){
const a=this.d.amulets[idx];
if(a.e==='immunity'){
this.d.skyFall=false;
this.d.skyStart=null;
document.getElementById('skyFallWarning').classList.remove('active');
this.notify('–ò–º–º—É–Ω–∏—Ç–µ—Ç –æ—Ç –ü–∞–¥–µ–Ω–∏—è –ù–µ–±–∞!');
}else if(a.e==='freeze'){
this.notify('–í—Ä–µ–º—è –∑–∞–º–æ—Ä–æ–∂–µ–Ω–æ!');
}else{
this.d.buffs.push({r:{...a,en:a.n,ev:100,i:a.i},exp:Date.now()+43200000});
this.notify(`–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω: ${a.n}!`);
}
this.d.amulets.splice(idx,1);
this.closeM('invModal');
this.updateUI();this.save();
if(document.getElementById('inventoryScreen').classList.contains('active')) this.renderInventoryContent(this.invFilter||'all');
},

ratingPeriod:'era',
leaderboardList:[],

switchRatingPeriod(p){
this.ratingPeriod=p||'era';
['ratingTabEra','ratingTabWeek','ratingTabMonth'].forEach(id=>{
const el=document.getElementById(id);
if(el)el.className='btn btn-small'+(el.getAttribute('onclick').includes("'"+p+"'")?' btn-success':'');
});
this.initLeaderboard();
},

async initLeaderboard(){
const l=document.getElementById('leaderboard');
if(!l)return;
if(this.API_BASE){
try{
const periodMap={era:'era',week:'weekly',month:'monthly'};
const period=periodMap[this.ratingPeriod]||'era';
let periodKey='';
if(this.ratingPeriod==='era') periodKey=String(this.d.era||1);
else if(this.ratingPeriod==='week'){
const d=new Date(); const one=new Date(d.getFullYear(),0,1); const weekNum=Math.ceil((((d-one)/86400000)+one.getDay()+1)/7); periodKey=d.getFullYear()+'-W'+String(weekNum).padStart(2,'0');
}else if(this.ratingPeriod==='month'){
const d=new Date(); periodKey=d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0');
}
const url=this.API_BASE+'/api/game/leaderboards?period='+encodeURIComponent(period)+(periodKey?'&period_key='+encodeURIComponent(periodKey):'');
const r=await fetch(url,{headers:{'X-Telegram-User-Id':String(this.myPlayerId||0)}});
const data=r.ok?await r.json():[];
this.leaderboardList=Array.isArray(data)?data:[];
}catch(e){ this.leaderboardList=[]; }
}else{
this.leaderboardList=[];
this.allPlayers.sort((a,b)=>b.score-a.score);
this.leaderboardList=this.allPlayers.map(p=>({id:p.id,name:p.name,points:p.score,level:p.level}));
}
l.innerHTML='';
const top=this.leaderboardList.slice(0,10);
top.forEach((p,i)=>{
const d=document.createElement('div');
d.className='lb';
if(p.id===this.myPlayerId)d.classList.add('me');
let rc='';
if(i===0)rc='gold';else if(i===1)rc='silver';else if(i===2)rc='bronze';
const attackBtn=p.id!==this.myPlayerId?` <button type="button" class="btn btn-small btn-danger" onclick="G.attackPlayer(${p.id})" title="–£–∫—Ä–∞—Å—Ç—å 1 –∫–ª–µ—Ç–∫—É —à–∞—Ö—Ç—ã —Å –ø—Ä–∏–∑–æ–º">‚öî –ù–∞–ø–∞—Å—Ç—å</button>`:'';
const pts=p.points!==undefined?p.points:p.score;
const name=p.name||('–ò–≥—Ä–æ–∫ '+p.id);
const sub=p.level!=null?('–£—Ä.'+p.level+' ‚Ä¢ '):'';
d.innerHTML=`<div class="rank ${rc}">${i+1}</div><div style="flex:1"><div style="font-weight:700;color:#ffa500">${name}</div><div style="font-size:12px;opacity:.8">${sub}${pts} –æ—á–∫–æ–≤</div></div>${attackBtn}`;
l.appendChild(d);
});
const myIdx=this.leaderboardList.findIndex(p=>p.id===this.myPlayerId);
const totalEl=document.getElementById('totalPlayers');
const myRankEl=document.getElementById('myRank');
if(myRankEl) myRankEl.textContent=myIdx>=0?(myIdx+1):'-';
if(totalEl) totalEl.textContent=this.leaderboardList.length;
},
async attackPlayer(targetPlayerId,buildingSlots){
if(targetPlayerId===this.myPlayerId){ this.notify('–ù–µ–ª—å–∑—è –Ω–∞–ø–∞—Å—Ç—å –Ω–∞ —Å–µ–±—è','error'); return; }
if(!this.API_BASE){ this.notify('–ê—Ç–∞–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Å —Å–µ—Ä–≤–µ—Ä–æ–º.'); return; }
try{
const r=await fetch(this.API_BASE+'/api/game/attack/'+targetPlayerId,{method:'POST',headers:{'Content-Type':'application/json','X-Telegram-User-Id':String(this.myPlayerId||0)},body:JSON.stringify({building_slot_indexes:buildingSlots||[]})});
const data=await r.json().catch(()=>({}));
if(!r.ok){ this.notify(data.detail||data.message||'–û—à–∏–±–∫–∞ –∞—Ç–∞–∫–∏','error'); return; }
if(data.total_stolen>0) this.notify('–£–∫—Ä–∞–¥–µ–Ω–æ –º–æ–Ω–µ—Ç: '+data.total_stolen);
else this.notify('–í–∏–∑–∏—Ç –∑–∞—Å—á–∏—Ç–∞–Ω. –û–≥—Ä–∞–±–ª–µ–Ω–∏–µ –¥–æ 2 –ø–æ—Å—Ç—Ä–æ–µ–∫ (–≤—ã–±–µ—Ä–∏—Ç–µ —Å–ª–æ—Ç—ã –≤ –≥–æ—Å—Ç—è—Ö).');
if(data.refresh) this.initLeaderboard();
}catch(e){ this.notify('–û—à–∏–±–∫–∞ –∞—Ç–∞–∫–∏','error'); }
},

showFullLeaderboard(){
const lb=this.leaderboardList&&this.leaderboardList.length?this.leaderboardList:this.allPlayers;
let h='<div style="max-height:500px;overflow-y:auto">';
lb.forEach((p,i)=>{
const name=p.name||('–ò–≥—Ä–æ–∫ '+p.id);
const pts=p.points!==undefined?p.points:p.score;
const sub=p.level!=null?('–£—Ä.'+p.level+' ‚Ä¢ '):'';
const attackBtn=p.id!==this.myPlayerId?` <button type="button" class="btn btn-small btn-danger" onclick="G.attackPlayer(${p.id})">‚öî –ù–∞–ø–∞—Å—Ç—å</button>`:'';
let rc=''; if(i===0)rc='gold';else if(i===1)rc='silver';else if(i===2)rc='bronze';
h+=`<div class="lb ${p.id===this.myPlayerId?'me':''}"><div class="rank ${rc}">${i+1}</div><div style="flex:1"><div style="font-weight:700;color:#ffa500">${name}</div><div style="font-size:11px;opacity:.8">${sub}${pts} –æ—á–∫–æ–≤</div></div>${attackBtn}</div>`;
});
h+='</div>';
document.getElementById('lbmc').innerHTML=h;
this.openM('leaderboardModal');
},

showScreen(s){
document.querySelectorAll('.screen').forEach(x=>x.classList.remove('active'));
document.querySelectorAll('.ni').forEach(x=>x.classList.remove('active'));
const screenEl=document.getElementById(s+'Screen');
if(screenEl) screenEl.classList.add('active');
const ni=document.querySelector('.ni[data-screen="'+s+'"]');
if(ni) ni.classList.add('active');
if(s==='village')this.renderVillage();
if(s==='mine'){
this.syncCheckinState();
if(!this.d.mineBlocks||this.d.mineBlocks.length!==36)this.newMine();
this.renderMine();
this.refreshMineHistory();
}
if(s==='market')this.switchTab('relics');
if(s==='inventory'){ const sel=document.getElementById('invFilterSelect'); if(sel)sel.value='all'; this.invFilter='all'; this.renderInventoryContent('all'); }
if(s==='tasks'){ this.syncCheckinState(); this.initLeaderboard().then(()=>this.updateCheckinUI()); this.updateCheckinUI(); this.renderSubsTasks(); this.updateWalletBindUI(); }
if(s==='profile')this.renderProfile();
if(s==='pnl')this.refreshPnlWalletState().catch(e=>console.error('PnL refresh error',e));
if(s==='rating'){ this.switchRatingPeriod(this.ratingPeriod); }
},
async refreshPnlWalletState(){
const boundEl=document.getElementById('pnlWalletBound');
const listEl=document.getElementById('pnlWalletList');
const stakingEl=document.getElementById('pnlStakingStatus');
const contractsEl=document.getElementById('pnlStakingContracts');
if(!boundEl)return;
if(this.API_BASE){
try{
const r=await fetch(this.API_BASE+'/api/game/pnl/wallet-state',{headers:{'X-Telegram-User-Id':String(this.myPlayerId||0)}});
const data=r.ok?await r.json():{};
const wallets=data.wallets||[];
boundEl.textContent=data.wallet_bound?('‚úÖ –ö–æ—à–µ–ª—å–∫–æ–≤ –ø—Ä–∏–≤—è–∑–∞–Ω–æ: '+wallets.length):'–ö–æ—à–µ–ª—ë–∫ –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω';
if(listEl){
if(wallets.length===0){
listEl.innerHTML='';
}else{
let html='';
wallets.forEach((w,i)=>{
const full=w.wallet_address_friendly||'';
const masked=w.wallet_address_masked||full;
const isPool=full&&full===this.tonWallet;
const isDev=full&&this.nftDevWallet&&full===this.nftDevWallet;
let tag='';
if(isPool) tag=' <span style="font-size:10px;background:#ffa500;color:#000;padding:1px 6px;border-radius:8px;font-weight:700">–ü—É–ª –ø—Ä–æ–µ–∫—Ç–∞</span>';
else if(isDev) tag=' <span style="font-size:10px;background:#7b68b8;color:#fff;padding:1px 6px;border-radius:8px;font-weight:700">–ö–æ—à–µ–ª—ë–∫ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞</span>';
html+='<div style="margin-bottom:6px;word-break:break-all">'+(masked||'‚Äî')+tag+'</div>';
});
listEl.innerHTML=html;
}
}
if(stakingEl)stakingEl.textContent=data.has_active_staking?('üîí –ê–∫—Ç–∏–≤–Ω—ã—Ö —Å—Ç–µ–π–∫–∏–Ω–≥–æ–≤: '+data.active_staking_count):'–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å—Ç–µ–π–∫–∏–Ω–≥–æ–≤';
if(contractsEl){
const list=data.staking_contracts||[];
contractsEl.textContent=list.length?('–ö–æ–Ω—Ç—Ä–∞–∫—Ç—ã —Å—Ç–µ–π–∫–∏–Ω–≥–∞: '+list.map(c=>c.label||c.contract_address?.slice(0,8)+'‚Ä¶').join(', ')):'';
}
}catch(e){
boundEl.textContent='–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å';
if(listEl)listEl.innerHTML=''; if(stakingEl)stakingEl.textContent=''; if(contractsEl)contractsEl.textContent='';
}
}else{
boundEl.textContent=this.d.walletBound?'‚úÖ –ö–æ—à–µ–ª—ë–∫ –ø—Ä–∏–≤—è–∑–∞–Ω':'–ö–æ—à–µ–ª—ë–∫ –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω';
if(listEl)listEl.textContent=this.d.walletVerifyCode?'(–ª–æ–∫–∞–ª—å–Ω–æ)':'';
if(stakingEl)stakingEl.textContent='–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å—Ç–µ–π–∫–∏–Ω–≥–æ–≤';
if(contractsEl)contractsEl.textContent='';
}
await this.refreshPnlNft();
await this.loadDevProfile();
},
async loadDevProfile(){
const el=document.getElementById('pnlDevProfile');
if(!el||!this.API_BASE)return;
try{
const r=await fetch(this.API_BASE+'/api/game/nft/dev-profile',{headers:{'X-Telegram-User-Id':String(this.myPlayerId||0)}});
if(!r.ok)return;
const d=await r.json();
el.style.display='block';
const nick=document.getElementById('devProfileNick');
const wallet=document.getElementById('devProfileWallet');
const collC=document.getElementById('devCollCount');
const nftC=document.getElementById('devNftCount');
const sync=document.getElementById('devLastSync');
const collList=document.getElementById('devCollectionsList');
if(nick)nick.textContent=d.nickname||'Phoenix Paw';
if(wallet){const w=d.dev_wallet||'';wallet.textContent=w.length>20?w.slice(0,10)+'...'+w.slice(-6):w;}
if(collC)collC.textContent=d.collections_count||0;
if(nftC)nftC.textContent=d.nfts_total||0;
if(sync){
if(d.last_synced_at){const dt=new Date(d.last_synced_at);sync.textContent=dt.toLocaleTimeString('ru',{hour:'2-digit',minute:'2-digit'});}
else sync.textContent='-';
}
if(collList&&Array.isArray(d.collections)&&d.collections.length>0){
let h='<div style="margin-top:8px;font-weight:600;font-size:12px;color:#ffa500;margin-bottom:6px">–ö–æ–ª–ª–µ–∫—Ü–∏–∏:</div>';
d.collections.forEach(c=>{
const n=(c.name||'–ö–æ–ª–ª–µ–∫—Ü–∏—è').replace(/</g,'&lt;');
const cnt=c.items_count||'?';
const img=c.image?`<img src="${c.image.replace(/"/g,'&quot;')}" style="width:24px;height:24px;border-radius:6px;object-fit:cover;margin-right:8px" onerror="this.style.display='none'">`:
'<span style="font-size:16px;margin-right:8px">üé®</span>';
h+=`<div style="display:flex;align-items:center;padding:4px 0;border-bottom:1px solid rgba(255,140,0,.1)">${img}<span style="flex:1">${n}</span><span style="opacity:.6;font-size:11px">${cnt} —à—Ç.</span></div>`;
});
collList.innerHTML=h;
}
}catch(e){console.error('loadDevProfile',e);}
},
_escHtml(s){return String(s||'').replace(/</g,'&lt;').replace(/>/g,'&gt;');},
_nftCardHtml(nft,clickable){
const imgUrl=String(nft.image||'').trim();
const name=this._escHtml(nft.name||'NFT');
const coll=this._escHtml(nft.collection_name||'');
const click=clickable?'cursor:pointer':'';
let h=`<div style="background:rgba(255,255,255,0.05);border-radius:12px;overflow:hidden;border:1px solid rgba(255,140,0,.2);display:flex;flex-direction:column;align-items:center;text-align:center;padding:8px;transition:transform .15s;${click}" ${clickable?'onmouseenter="this.style.transform=\'scale(1.03)\'" onmouseleave="this.style.transform=\'scale(1)\'"':''}>`;
if(imgUrl) h+=`<div style="width:100%;aspect-ratio:1;background:#1a1a1a;border-radius:8px;overflow:hidden;margin-bottom:8px"><img src="${imgUrl.replace(/"/g,'&quot;')}" alt="" style="width:100%;height:100%;object-fit:cover" onerror="this.parentElement.innerHTML='<span style=font-size:24px>üñºÔ∏è</span>'"></div>`;
else h+=`<div style="width:100%;aspect-ratio:1;background:rgba(255,140,0,.15);border-radius:8px;margin-bottom:8px;display:flex;align-items:center;justify-content:center;font-size:32px">üñºÔ∏è</div>`;
h+=`<div style="font-size:12px;font-weight:700;color:#ffa500;margin-bottom:2px;word-break:break-word">${name}</div>`;
if(coll) h+=`<div style="font-size:10px;opacity:.7;margin-bottom:4px">${coll}</div>`;
h+='</div>';
return h;
},
showNftDetail(nft){
const modal=document.getElementById('nftDetailModal');
const content=document.getElementById('nftDetailContent');
if(!modal||!content)return;
const imgUrl=String(nft.image||'').trim();
const name=this._escHtml(nft.name||'NFT');
const coll=this._escHtml(nft.collection_name||'');
const desc=this._escHtml(nft.description||'');
const addr=String(nft.nft_address||nft.address||'').trim();
const collAddr=String(nft.collection_address||'').trim();
const attrs=Array.isArray(nft.attributes)?nft.attributes:[];
let h='';
if(imgUrl) h+=`<div style="width:100%;aspect-ratio:1;background:#1a1a1a;border-radius:12px;overflow:hidden;margin-bottom:14px"><img src="${imgUrl.replace(/"/g,'&quot;')}" alt="" style="width:100%;height:100%;object-fit:cover" onerror="this.parentElement.innerHTML='<div style=display:flex;align-items:center;justify-content:center;height:100%;font-size:48px>üñºÔ∏è</div>'"></div>`;
h+=`<div style="font-size:18px;font-weight:700;color:#ffa500;margin-bottom:4px">${name}</div>`;
if(coll) h+=`<div style="font-size:13px;opacity:.7;margin-bottom:8px">${coll}</div>`;
if(desc) h+=`<div style="font-size:12px;opacity:.85;margin-bottom:12px;line-height:1.5">${desc}</div>`;
if(attrs.length>0){
h+='<div style="margin-bottom:12px">';
attrs.forEach(a=>{
const t=this._escHtml(a.trait_type||a.key||'');
const v=this._escHtml(a.value||'');
if(t||v) h+=`<div style="display:inline-block;background:rgba(255,140,0,.15);border:1px solid rgba(255,140,0,.25);border-radius:8px;padding:4px 10px;margin:3px 4px 3px 0;font-size:11px"><span style="opacity:.7">${t}:</span> <span style="color:#ffa500;font-weight:600">${v}</span></div>`;
});
h+='</div>';
}
const tvBase='https://tonviewer.com/';
const gmBase='https://getgems.io/nft/';
h+='<div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">';
if(addr) h+=`<a href="${tvBase}${encodeURIComponent(addr)}" target="_blank" rel="noopener" style="font-size:12px;color:#ff8c00;text-decoration:none;padding:6px 12px;border:1px solid rgba(255,140,0,.3);border-radius:8px">TonViewer</a>`;
if(addr) h+=`<a href="${gmBase}${encodeURIComponent(addr)}" target="_blank" rel="noopener" style="font-size:12px;color:#ff8c00;text-decoration:none;padding:6px 12px;border:1px solid rgba(255,140,0,.3);border-radius:8px">Getgems</a>`;
h+='</div>';
content.innerHTML=h;
modal.style.display='block';
},
async refreshPnlNft(){
const block=document.getElementById('pnlNftBlock');
const list=document.getElementById('pnlNftList');
const summary=document.getElementById('pnlNftSummary');
const countEl=document.getElementById('pnlNftCount');
function setSummary(t){ if(summary) summary.textContent=t; }
if(!block||!list)return;
list.innerHTML='<span style="opacity:.7">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</span>';
setSummary('üñºÔ∏è NFT –æ—Ç –ø—Ä–æ–µ–∫—Ç–∞: –∑–∞–≥—Ä—É–∑–∫–∞‚Ä¶');
if(countEl)countEl.textContent='';
if(!this.API_BASE){
list.innerHTML='<div style="font-size:12px;opacity:.7;grid-column:1/-1">–ü—Ä–∏–≤—è–∂–∏—Ç–µ –∫–æ—à–µ–ª—ë–∫ –≤ –ü—Ä–æ—Ñ–∏–ª–µ ‚Äî –¥–∞–Ω–Ω—ã–µ –æ NFT –ø–æ–¥–≥—Ä—É–∂–∞—é—Ç—Å—è —Å —Å–µ—Ä–≤–µ—Ä–∞.</div>';
setSummary('üñºÔ∏è NFT –æ—Ç –ø—Ä–æ–µ–∫—Ç–∞: –Ω—É–∂–µ–Ω —Å–µ—Ä–≤–µ—Ä.');
return;
}
try{
const r=await fetch(this.API_BASE+'/api/game/nft/user-nfts',{headers:{'X-Telegram-User-Id':String(this.myPlayerId||0)}});
let data={};
try{ data=r.ok?await r.json():{}; }catch(_){}
const items=Array.isArray(data.items)?data.items:[];
if(!r.ok){
list.innerHTML='<div style="font-size:12px;opacity:.7;grid-column:1/-1">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å NFT ('+r.status+')</div>';
setSummary('üñºÔ∏è NFT –æ—Ç –ø—Ä–æ–µ–∫—Ç–∞: –æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏.');
return;
}
if(items.length===0){
list.innerHTML='<div style="font-size:12px;opacity:.7;grid-column:1/-1">–ù–µ—Ç NFT –æ—Ç –ø—Ä–æ–µ–∫—Ç–∞ –Ω–∞ –≤–∞—à–∏—Ö –∫–æ—à–µ–ª—å–∫–∞—Ö. –í—Å–µ NFT –ø—Ä–æ–µ–∫—Ç–∞ –º–æ–∂–Ω–æ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤ –ø—Ä–æ—Ñ–∏–ª–µ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞ –≤—ã—à–µ.</div>';
setSummary('üñºÔ∏è NFT –æ—Ç –ø—Ä–æ–µ–∫—Ç–∞: 0');
if(countEl)countEl.textContent='0 —à—Ç.';
return;
}
setSummary('üñºÔ∏è NFT –æ—Ç –ø—Ä–æ–µ–∫—Ç–∞: '+items.length+' —à—Ç.');
if(countEl)countEl.textContent=items.length+' —à—Ç.';
list.innerHTML='';
const self=this;
items.forEach((nft,i)=>{
const wrapper=document.createElement('div');
wrapper.innerHTML=self._nftCardHtml(nft,true);
const card=wrapper.firstElementChild;
card.addEventListener('click',()=>self.showNftDetail(nft));
list.appendChild(card);
});
}catch(e){
list.innerHTML='<div style="font-size:12px;opacity:.7;grid-column:1/-1">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ NFT. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–µ—Ç—å.</div>';
setSummary('üñºÔ∏è NFT –æ—Ç –ø—Ä–æ–µ–∫—Ç–∞: –æ—à–∏–±–∫–∞ —Å–µ—Ç–∏.');
}
},

renderProfile(){
document.getElementById('profileCoins').textContent=this.d.coins;
document.getElementById('profileGems').textContent=this.d.gems;
document.getElementById('profileRelics').textContent=this.d.relicsFound;
document.getElementById('profileEra').textContent=this.d.era;
document.getElementById('profileLevel').textContent=this.d.vLevel;
const pe=document.getElementById('profilePoints');
if(pe) pe.textContent=this.d.points||0;
document.getElementById('invRelics').textContent=this.d.relics.length;
document.getElementById('invAmulets').textContent=this.d.amulets.length;
const lettersEl=document.getElementById('invLetters');
if(lettersEl) lettersEl.textContent=(this.d.letters||[]).length;
const now=Date.now();
this.d.buffs=this.d.buffs.filter(b=>b.exp>now);
document.getElementById('invBuffs').textContent=this.d.buffs.length;
const cursesEl=document.getElementById('invCurses');
if(cursesEl) cursesEl.textContent=(this.d.curses||[]).length;
const eggsEl=document.getElementById('invEggs');
if(eggsEl) eggsEl.textContent=(this.d.eggs||[]).length;
const rankEl=document.getElementById('profileRank');
if(rankEl){ const myIdx=this.allPlayers.findIndex(p=>p.id===this.myPlayerId); rankEl.textContent=myIdx>=0?(myIdx+1):'-'; }
const medalsEl=document.getElementById('profileEraMedals');
if(medalsEl){
const arr=this.d.eraMedals||[];
medalsEl.textContent=arr.length?('–≠—Ä–∞ '+arr.sort((a,b)=>a-b).join(', –≠—Ä–∞ ')):'–ü–æ–∫–∞ –Ω–µ—Ç';
}
const burnMedalEl=document.getElementById('profileBurnMedal');
if(burnMedalEl){
const bc=this.d.burnedCount||0;
burnMedalEl.innerHTML=bc>0?('üî• <strong>–í–µ—á–Ω–æ –≤ –ü–ª–∞–º–µ–Ω–∏</strong>: '+bc+' —Å–æ–∂–∂–µ–Ω–æ'):'';
}
const badgeEl=document.getElementById('profilePhoenixBadge');
if(badgeEl){
badgeEl.innerHTML=this.d.phoenixQuestCompleted?'<div class="info" style="margin-top:8px">üìñ <strong>–ë–µ–π–¥–∂ ¬´–ë—É–∫–≤–∞—Ä—å¬ª</strong> ‚Äî —É—á–∞—Å—Ç–∏–µ –≤ –µ–∂–µ–º–µ—Å—è—á–Ω–æ–º –ø—Ä–∏–∑–µ</div>':'';
}
this.refreshProfileWallets();
},
async refreshProfileWallets(){
const listEl=document.getElementById('profileWalletsList');
const bindBtn=document.getElementById('profileWalletBindBtn');
const addBtn=document.getElementById('profileWalletAddBtn');
if(!listEl)return;
if(this.API_BASE){
try{
const r=await fetch(this.API_BASE+'/api/game/wallets',{headers:{'X-Telegram-User-Id':String(this.myPlayerId||0)}});
const data=r.ok?await r.json():{wallets:[],max_wallets:10};
const wallets=data.wallets||[];
const max=data.max_wallets||10;
if(bindBtn) bindBtn.style.display=wallets.length===0?'inline-block':'none';
if(bindBtn) bindBtn.textContent='–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è';
if(addBtn){ addBtn.style.display=wallets.length>0&&wallets.length<max?'inline-block':'none'; addBtn.textContent='‚ûï –î–æ–±–∞–≤–∏—Ç—å –∫–æ—à–µ–ª—ë–∫'; }
listEl.innerHTML=wallets.length===0?'–ù–µ—Ç –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã—Ö –∫–æ—à–µ–ª—å–∫–æ–≤. –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≤—Å–µ–º –∫–æ—à–µ–ª—å–∫–∞–º –ø–æ—Å–ª–µ –ø—Ä–∏–≤—è–∑–∫–∏.':wallets.map(w=>{ const status=w.verified_at?' ‚úì':(w.wallet_address_masked&&w.wallet_address_masked!=='–æ–∂–∏–¥–∞–µ—Ç –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏'?' (–æ–∂–∏–¥–∞–µ—Ç)':''); const fullAddr=w.wallet_address_friendly||w.wallet_address||''; const isProject=fullAddr&&fullAddr===G.tonWallet; const tag=isProject?'<span style="font-size:10px;background:#ffa500;color:#000;padding:1px 6px;border-radius:8px;margin-left:6px;font-weight:700">–ü—É–ª –ø—Ä–æ–µ–∫—Ç–∞</span>':''; const copyBtn=fullAddr?' <button type="button" class="btn btn-small" style="padding:2px 6px;font-size:11px" onclick="navigator.clipboard&&navigator.clipboard.writeText(\''+fullAddr.replace(/'/g,"\\'")+'\').then(()=>G.notify(\'–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ\')).catch(()=>{})" title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∞–¥—Ä–µ—Å">üìã</button>':''; return '<div class="ir" style="align-items:center;flex-wrap:wrap"><span style="font-size:12px;word-break:break-all">'+(w.wallet_address_masked||'–æ–∂–∏–¥–∞–µ—Ç –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏')+status+'</span>'+tag+copyBtn+'<button type="button" class="btn btn-small btn-danger" onclick="G.unbindWallet('+w.id+')">–û—Ç–≤—è–∑–∞—Ç—å</button></div>'; }).join('');
}catch(e){ listEl.innerHTML='–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫'; if(bindBtn)bindBtn.style.display='inline-block'; if(addBtn)addBtn.style.display='none'; }
}else{
const hasWallet=!!this.d.walletBound;
if(bindBtn) bindBtn.style.display=hasWallet?'none':'inline-block';
if(addBtn) addBtn.style.display=hasWallet?'inline-block':'none';
listEl.innerHTML=hasWallet?'–ö–æ—à–µ–ª—ë–∫ –ø—Ä–∏–≤—è–∑–∞–Ω (–ª–æ–∫–∞–ª—å–Ω–æ). –î–ª—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∫–æ—à–µ–ª—å–∫–æ–≤ –Ω—É–∂–µ–Ω —Å–µ—Ä–≤–µ—Ä.':'–ü—Ä–∏–≤—è–∑–∫–∞ –≤ —Ä–∞–∑–¥–µ–ª–µ –ó–∞–¥–∞–Ω–∏—è.';
}
},
async unbindWallet(id){
if(!this.API_BASE){ this.notify('–û—Ç–≤—è–∑–∫–∞ —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–µ—Ä','error'); return; }
try{
await fetch(this.API_BASE+'/api/game/wallet/'+id,{method:'DELETE',headers:{'X-Telegram-User-Id':String(this.myPlayerId||0)}});
this.notify('–ö–æ—à–µ–ª—ë–∫ –æ—Ç–≤—è–∑–∞–Ω');
this.renderProfile();
}catch(e){ this.notify('–û—à–∏–±–∫–∞ –æ—Ç–≤—è–∑–∫–∏','error'); }
},
async openAddWallet(){
if(!this.API_BASE){ this.openAuthModal(); return; }
try{
const r=await fetch(this.API_BASE+'/api/game/wallet',{method:'POST',headers:{'Content-Type':'application/json','X-Telegram-User-Id':String(this.myPlayerId||0)},body:JSON.stringify({})});
const data=await r.json();
if(!data.verify_comment&&!data.verify_code){ this.notify(data.detail||'–õ–∏–º–∏—Ç –∫–æ—à–µ–ª—å–∫–æ–≤','error'); return; }
const comment=data.verify_comment||data.verify_code;
const pw=(data.project_wallet||'').trim();
if(pw&&comment) this._authWalletData={project_wallet:pw,verify_comment:comment};
this.d._addWalletCode=comment;
this.d._addWalletBindingId=data.binding_id;
this.openAuthModal();
this.updateWalletBindUI();
this.notify('–û—Ç–ø—Ä–∞–≤—å—Ç–µ 0.1 TON —Å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–º —Å –Ω—É–∂–Ω–æ–≥–æ –∫–æ—à–µ–ª—å–∫–∞. –ù–∞–∂–º–∏—Ç–µ ¬´–û—Ç–∫—Ä—ã—Ç—å Tonkeeper¬ª.');
}catch(e){ this.notify(e.message||'–û—à–∏–±–∫–∞','error'); }
},
openProfileContribution(){
const h='<div class="info"><div style="font-size:14px;font-weight:700;color:#ffa500;margin-bottom:8px">üíù –í–∫–ª–∞–¥ –≤ –ø—Ä–æ—Ñ–∏–ª—å</div><p style="font-size:13px;opacity:.9">–£—Ä–æ–≤–µ–Ω—å –¥–æ–≤–µ—Ä–∏—è –∏ –≤–∫–ª–∞–¥ —É—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –¥–ª—è —Ä–µ–π—Ç–∏–Ω–≥–∞ ¬´–°–∞–º—ã–µ —Å–µ—Ä–¥–µ—á–Ω—ã–µ¬ª –∏ –±–æ–Ω—É—Å–æ–≤.</p><div class="ir"><span>–£—Ä–æ–≤–µ–Ω—å –¥–æ–≤–µ—Ä–∏—è:</span><span id="contributionTrust">‚Äî</span></div><div class="ir"><span>–í–∫–ª–∞–¥ (–ø–µ—Ä–∏–æ–¥):</span><span id="contributionValue">‚Äî</span></div><p style="font-size:12px;opacity:.8;margin-top:10px">–î–∞–Ω–Ω—ã–µ –ø–æ–¥–≥—Ä—É–∂–∞—é—Ç—Å—è —Å —Å–µ—Ä–≤–µ—Ä–∞.</p></div>';
const wrap=document.createElement('div');
wrap.innerHTML=h;
const modal=document.getElementById('contributionModal');
if(!modal){
const m=document.createElement('div');
m.id='contributionModal';
m.className='modal';
m.innerHTML='<div class="mc"><button class="mcl" onclick="G.closeM(\'contributionModal\')">√ó</button><div class="mt">üíù –í–∫–ª–∞–¥ –∏ —É—Ä–æ–≤–µ–Ω—å –¥–æ–≤–µ—Ä–∏—è</div><div id="contributionMc"></div></div>';
document.body.appendChild(m);
}
document.getElementById('contributionMc').innerHTML=h;
if(this.API_BASE){
fetch(this.API_BASE+'/api/game/withdraw/eligibility',{headers:{'X-Telegram-User-Id':String(this.myPlayerId||0)}}).then(r=>r.json()).then(el=>{
const tr=document.getElementById('contributionTrust');
const v=document.getElementById('contributionValue');
if(tr) tr.textContent=el.compliance_ok?'–í—ã—Å–æ–∫–∏–π':'–û–±—ã—á–Ω—ã–π';
if(v) v.textContent=(el.completed_action_value_ton||0)+' / '+(el.required_action_value_ton||0)+' PHXPW';
}).catch(()=>{});
}
this.openM('contributionModal');
},

exportSBT(){
this.notify('–í—ã–≤–æ–¥ –º–µ–¥–∞–ª–µ–π –Ω–∞ –∫–æ—à–µ–ª—ë–∫ (SBT) ‚Äî –ø–æ–¥–∫–ª—é—á–∏—Ç–µ –∫–Ω–æ–ø–∫—É –≤—ã–≤–æ–¥–∞ –≤ –≤–∞—à–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏.');
},

openM(id){document.getElementById(id).classList.add('active')},
closeM(id){document.getElementById(id).classList.remove('active')},

openHelp(){ var el=document.getElementById('helpmc'); if(el) el.innerHTML='<div class="help-section"><h4>üìñ –û–±—É—á–µ–Ω–∏–µ</h4><p>–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</p></div>'; this.openM('helpModal'); },

PNL_STAKING_URL:'https://jvault.xyz/staking/v2/stake/FIRST-YEAR-COMPL',
PNL_SWAP_URL:'https://app.ston.fi/swap?ft=TON&tt=EQABtSLSzrAOISWPfIjBl2VmeStkM1eHaPrUxRTj8mY-9h43&chartVisible=true&chartInterval=1w',

openPnlStaking(){
const url=this.PNL_STAKING_URL||'https://jvault.xyz/staking/v2/stake/FIRST-YEAR-COMPL';
if(window.Telegram?.WebApp?.openLink){ window.Telegram.WebApp.openLink(url); }else{ window.open(url,'_blank'); }
},
openPnlBuy(){
const url=this.PNL_SWAP_URL||'https://app.ston.fi/swap?ft=TON&tt=EQABtSLSzrAOISWPfIjBl2VmeStkM1eHaPrUxRTj8mY-9h43';
if(window.Telegram?.WebApp?.openLink){ window.Telegram.WebApp.openLink(url); }else{ window.open(url,'_blank'); }
},

async openAboutProject(){
const links=[{name:'–°–∞–π—Ç –ø—Ä–æ–µ–∫—Ç–∞',url:'https://phoenixpaw.com',icon:'üåê'},{name:'–ö—É–ø–∏—Ç—å PHOEX (Swap)',url:'https://app.ston.fi/swap?ft=TON&tt=EQABtSLSzrAOISWPfIjBl2VmeStkM1eHaPrUxRTj8mY-9h43&chartVisible=true&chartInterval=1w',icon:'üí±'},{name:'–ü—É–ª—ã (DexScreener)',url:'https://dexscreener.com/ton/eqadltefzxg_xtelfakfgd-hpvkrejqv_fdc7z2rooddrndm',icon:'üìä'},{name:'–°—Ç–µ–π–∫–∏–Ω–≥ (jVault)',url:'https://jvault.xyz/staking/v2/stake/FIRST-YEAR-COMPL',icon:'üîí'},{name:'NFT –∫–æ–ª–ª–µ–∫—Ü–∏—è',url:'https://getgems.io/phoenixpaw',icon:'üñºÔ∏è'}];
const aboutHtml='<div class="help-section"><h4>üî• –ü—Ä–æ–µ–∫—Ç Phoenix</h4><p><strong>Phoenix</strong> ‚Äî —ç–∫–æ—Å–∏—Å—Ç–µ–º–∞ –≤ —Å–µ—Ç–∏ TON: —Ç–æ–∫–µ–Ω PHOEX, —Å—Ç–µ–π–∫–∏–Ω–≥, –ø—É–ª—ã –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏, –±–æ—Ç –∏ –∏–≥—Ä–∞ Village Era. –î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è: 17 –¥–µ–∫–∞–±—Ä—è 2024.</p><p>Village Era ‚Äî –∏–≥—Ä–∞ –≤ –º–∏—Ä–µ Phoenix: –≤—ã —Å—Ç—Ä–æ–∏—Ç–µ –ø–ª–µ–º—è –∏–∑ 32 —Ç–∏–ø–æ–≤ –∑–¥–∞–Ω–∏–π (9 —Å–ª–æ—Ç–æ–≤), –∫–æ–ø–∞–µ—Ç–µ —à–∞—Ö—Ç—É –∑–∞ —Ä–µ–ª–∏–∫–≤–∏—è–º–∏ –∏ –∞–º—É–ª–µ—Ç–∞–º–∏, —Ç–æ—Ä–≥—É–µ—Ç–µ –≤ –º–∞—Ä–∫–µ—Ç–µ, —É—á–∞—Å—Ç–≤—É–µ—Ç–µ –≤ —ç—Ä–∞—Ö –∏ –∫–≤–µ—Å—Ç–µ ¬´–§–ï–ù–ò–ö–°¬ª. –ß–µ–∫–∏–Ω –∏ –ø–æ–¥–ø–∏—Å–∫–∏ –¥–∞—é—Ç –ø–æ–ø—ã—Ç–∫–∏ –∫–æ–ø–∞–Ω–∏—è –∏ –Ω–∞–≥—Ä–∞–¥—ã.</p></div><div class="help-section"><h4>ü™ô –¢–æ–∫–µ–Ω PHOEX</h4><p>–°–∏–º–≤–æ–ª: <strong>PHOEX</strong> (—Ä–∞–Ω–µ–µ PHXPW). –ö–æ–Ω—Ç—Ä–∞–∫—Ç –≤ TON: EQABtSLSzrAOISWPfIjBl2VmeStkM1eHaPrUxRTj8mY-9h43. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Å–≤–∞–ø–æ–≤, —Å—Ç–µ–π–∫–∏–Ω–≥–∞, –Ω–∞–≥—Ä–∞–¥ –∏ –º–∞—Ä–∫–µ—Ç–∞ –≤ –∏–≥—Ä–µ.</p></div><div class="help-section"><h4>üìä –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤</h4><p>‚Ä¢ üî• –°–æ–∂–∂–µ–Ω–æ: ~9.2% ¬∑ üîí –ö —Å–∂–∏–≥–∞–Ω–∏—é: 1% ¬∑ üè¶ –ü—Ä–æ–µ–∫—Ç: ~34% ¬∑ üíé –í —Å—Ç–µ–π–∫–∏–Ω–≥–µ: ~35% ¬∑ üíß –í –ø—É–ª–∞—Ö –∏ –Ω–∞ —Ä—ã–Ω–∫–µ: ~9.7%.</p></div><div class="help-section"><h4>üè¶ –°—Ç–µ–π–∫–∏–Ω–≥ –∏ –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç—å</h4><p>–ü—É–ª—ã 90/120/220/365 –¥–Ω–µ–π, APR –¥–æ 330%. JVault ‚Äî –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –ø—É–ª (LP —Å–æ–∂–∂–µ–Ω—ã). StonFi –∏ DeDust ‚Äî –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç—å, –Ω–∏–∑–∫–æ–µ –ø—Ä–æ—Å–∫–∞–ª—å–∑—ã–≤–∞–Ω–∏–µ.</p></div><div class="help-section"><h4>üë• –•–æ–ª–¥–µ—Ä—ã</h4><p>–î–µ—Ä–∂–∞—Ç–µ–ª–∏ PHOEX —É—á–∞—Å—Ç–≤—É—é—Ç –≤ —Å—Ç–µ–π–∫–∏–Ω–≥–µ, —Ä–µ—Ñ–µ—Ä–∞–ª–∞—Ö –∏ –Ω–∞–≥—Ä–∞–¥–∞—Ö. –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –∫–æ—à–µ–ª—å–∫–∞ –≤ –∏–≥—Ä–µ: 0.1 TON —Å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–º –Ω–∞ –∞–¥—Ä–µ—Å –ø—Ä–æ–µ–∫—Ç–∞ (–∫–Ω–æ–ø–∫–∞ ¬´–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è¬ª).</p></div><div class="help-section"><h4>üìö –ö–∞—Ç–∞–ª–æ–≥ –ø—Ä–µ–¥–º–µ—Ç–æ–≤</h4><p>–í–∫–ª–∞–¥–∫–∏ –≤—ã—à–µ: <strong>–†–µ–ª–∏–∫–≤–∏–∏, –ê–º—É–ª–µ—Ç—ã, –ë–∞—Ñ—ã, –ü–æ—Ä—á–∏, –ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã, –Ø–π—Ü–∞</strong> ‚Äî –≤—Å–µ –ø—Ä–µ–¥–º–µ—Ç—ã –∏–≥—Ä—ã (~121). –ü–æ–¥—Ä–æ–±–Ω–µ–µ –æ —ç—Ñ—Ñ–µ–∫—Ç–∞—Ö –∏ –∫–æ–º–±–∏–Ω–∞—Ü–∏—è—Ö ‚Äî –≤ <strong>–û–±—É—á–µ–Ω–∏–∏</strong> (üìñ).</p></div><div class="help-section"><h4>üîó –°—Å—ã–ª–∫–∏</h4><div style="display:flex;flex-direction:column;gap:8px">'+links.map(l=>`<a href="${l.url}" target="_blank" rel="noopener" style="color:#ffa500;font-weight:600">${l.icon} ${l.name}</a>`).join('')+'</div></div>';
let catalog=[];
try{ if(this.API_BASE){ const r=await fetch(this.API_BASE+'/api/game/items-catalog',{headers:{'X-Telegram-User-Id':String(this.myPlayerId||0)}}); if(r.ok) catalog=await r.json(); } if(catalog.length===0){ const r2=await fetch('data/items-catalog.json'); if(r2.ok) catalog=await r2.json(); } if(catalog.length===0&&window.ITEMS_CATALOG) catalog=window.ITEMS_CATALOG; }catch(e){ if(window.ITEMS_CATALOG) catalog=window.ITEMS_CATALOG; }
const slotToTab={relic_slot:'relics',amulet:'amulets',buff:'buffs',curse:'curses',artifact_relic:'artifacts',egg:'eggs'};
const tabLabels={about:'–û –ø—Ä–æ–µ–∫—Ç–µ',relics:'–†–µ–ª–∏–∫–≤–∏–∏',amulets:'–ê–º—É–ª–µ—Ç—ã',buffs:'–ë–∞—Ñ—ã',curses:'–ü–æ—Ä—á–∏',artifacts:'–ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã',eggs:'–Ø–π—Ü–∞'};
this._aboutCatalog=catalog; this._aboutAboutHtml=aboutHtml; this._aboutSlotToTab=slotToTab; this._aboutTabLabels=tabLabels;
const tabsEl=document.getElementById('aboutTabs');
if(tabsEl) tabsEl.innerHTML=['about','relics','amulets','buffs','curses','artifacts','eggs'].map(t=>'<button type="button" class="btn btn-small '+(t==='about'?'btn-success':'')+'" onclick="G.switchAboutTab(\''+t+'\')">'+tabLabels[t]+'</button>').join('');
this.switchAboutTab('about');
this.openM('aboutModal');
},
switchAboutTab(tabId){
const contentEl=document.getElementById('aboutmc');
if(!contentEl) return;
document.querySelectorAll('#aboutTabs .btn').forEach(b=>{
b.classList.remove('btn-success');
if((b.getAttribute('onclick')||'').indexOf("'"+tabId+"'")>=0) b.classList.add('btn-success');
});
if(tabId==='about'){ contentEl.innerHTML=this._aboutAboutHtml||''; return; }
const catalog=this._aboutCatalog||[];
const slotForTab={}; Object.keys(this._aboutSlotToTab||{}).forEach(k=>{ slotForTab[this._aboutSlotToTab[k]]=k; });
const slotType=slotForTab[tabId];
const items=catalog.filter(i=>(i.slot_type||i.item_type)===slotType);
const labels=this._aboutTabLabels||{relics:'–†–µ–ª–∏–∫–≤–∏–∏',amulets:'–ê–º—É–ª–µ—Ç—ã',buffs:'–ë–∞—Ñ—ã',curses:'–ü–æ—Ä—á–∏',artifacts:'–ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã',eggs:'–Ø–π—Ü–∞'};
const tabContent=window.ABOUT_TABS_CONTENT&&window.ABOUT_TABS_CONTENT[tabId];
let html='<div class="help-section"><h4>'+(labels[tabId]||tabId)+'</h4>';
if(tabContent){ if(tabContent.intro) html+=tabContent.intro; if(tabContent.usage) html+='<div style="margin-top:12px">'+tabContent.usage+'</div>'; if(tabContent.whenActivate) html+='<div style="margin-top:12px">'+tabContent.whenActivate+'</div>'; }
html+='<h5 style="margin-top:16px;margin-bottom:8px">–°–ø–∏—Å–æ–∫ –ø—Ä–µ–¥–º–µ—Ç–æ–≤</h5>';
if(items.length===0){ html+='<p style="opacity:.8">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –≤ –∫–∞—Ç–∞–ª–æ–≥–µ</p></div>'; contentEl.innerHTML=html; return; }
html+='<table style="width:100%;font-size:12px;border-collapse:collapse"><tr style="border-bottom:1px solid rgba(255,69,0,.4)"><th style="text-align:left;padding:6px">ID</th><th style="text-align:left;padding:6px">–ù–∞–∑–≤–∞–Ω–∏–µ</th><th style="text-align:left;padding:6px">–¢–∏–ø/—Ä–µ–¥–∫–æ—Å—Ç—å</th><th style="text-align:left;padding:6px">–≠—Ñ—Ñ–µ–∫—Ç</th></tr>';
items.forEach(i=>{ const typeRarity=(i.subtype||i.type||i.rarity||'').toString(); const effect=(i.effect||(i.effects&&typeof i.effects==='object'?JSON.stringify(i.effects):'')||'‚Äî').toString(); html+='<tr style="border-bottom:1px solid rgba(255,69,0,.2)"><td style="padding:6px;opacity:.9">'+(i.key||i.id||'').toString()+'</td><td style="padding:6px;color:#ffa500">'+(i.name||'‚Äî').toString()+'</td><td style="padding:6px">'+typeRarity+'</td><td style="padding:6px;opacity:.95">'+effect+'</td></tr>'; });
html+='</table></div>';
contentEl.innerHTML=html;
},

notify(msg,type=''){
const n=document.getElementById('notif');
n.textContent=msg;
n.className='notif';
if(type)n.classList.add(type);
n.classList.add('show');
setTimeout(()=>n.classList.remove('show'),3000);
},

updateUI(){
document.getElementById('gems').textContent=this.d.gems;
document.getElementById('coins').textContent=this.d.coins;
const pe=document.getElementById('points');
if(pe) pe.textContent=this.d.points||0;
document.getElementById('wood').textContent=this.d.wood;
document.getElementById('stone').textContent=this.d.stone;
document.getElementById('currentEra').textContent=this.d.era;
document.getElementById('villageLevel').textContent=this.d.vLevel;
document.getElementById('lossMultiplier').textContent=this.d.lossMult.toFixed(1)+'x';
this.updateOnlineCount();
const poolEl=document.getElementById('prizePool');
if(poolEl) poolEl.textContent=(this.economy.withdraw.globalCapTON*41650).toLocaleString('ru-RU')+' PHXPW';
},

startTimers(){
setInterval(()=>this.updateCheckinUI(),1000);
setInterval(()=>this.updateDigsTimer(),1000);
// WebSocket handles online count ‚Äî connect once
this.connectOnlineWS();
this.updateEraTimer();
setInterval(()=>this.updateEraTimer(),60000);
this.checkSkyFall();
setInterval(()=>this.checkSkyFall(),3600000);
},

updateEraTimer(){
const elapsed=Date.now()-this.d.eraStart;
const week=7*24*60*60*1000;
const left=week-elapsed;
const d=Math.floor(left/(24*60*60*1000));
const h=Math.floor((left%(24*60*60*1000))/(60*60*1000));
document.getElementById('eraTimer').textContent=`${d}–¥ ${h}—á`;
if(left<=0&&this.d.era<4){
this.d.eraMedals=this.d.eraMedals||[];
if(this.d.eraMedals.indexOf(this.d.era)===-1) this.d.eraMedals.push(this.d.era);
this.d.era++;
this.d.eraStart=Date.now();
this.notify('–ù–æ–≤–∞—è –≠—Ä–∞ –Ω–∞—á–∞–ª–∞—Å—å! –ú–µ–¥–∞–ª—å –∑–∞ —É—á–∞—Å—Ç–∏–µ –≤ —ç—Ä–µ –≤—ã–¥–∞–Ω–∞.');
}
},

checkSkyFall(){
const now=new Date();
if(now.getDay()===6&&!this.d.skyFall){
this.d.skyFall=true;
this.d.skyStart=Date.now();
this.d.lossMult=1;
document.getElementById('skyFallWarning').classList.add('active');
this.notify('‚ö†Ô∏è –ü–ê–î–ï–ù–ò–ï –ù–ï–ë–ê –Ω–∞—á–∞–ª–æ—Å—å!','error');
}
if(this.d.skyFall){
const elapsed=(Date.now()-this.d.skyStart)/(60*60*1000);
this.d.lossMult=Math.pow(1.5,Math.floor(elapsed));
this.updateUI();
}
},

save(){
if(this.API_BASE){
fetch(this.API_BASE+'/api/game/action',{method:'POST',headers:{'Content-Type':'application/json','X-Telegram-User-Id':String(this.myPlayerId||0)},body:JSON.stringify({action:'sync',state:this.d,params:{username:window.Telegram?.WebApp?.initDataUnsafe?.user?.username,first_name:window.Telegram?.WebApp?.initDataUnsafe?.user?.first_name}})}).then(r=>{
if(!r.ok){ console.error('[save] sync failed, status='+r.status); r.text().then(t=>console.error('[save] body:',t)).catch(()=>{}); if(!this._syncWarnShown){this._syncWarnShown=true;this.notify('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä ('+r.status+')','error');}}
}).catch(e=>{console.error('[save] network error',e);if(!this._syncWarnShown){this._syncWarnShown=true;this.notify('–ù–µ—Ç —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º','error');}});
return;
}
localStorage.setItem('villageEra',JSON.stringify(this.d));
},

async loadGame(){
if(!this.API_BASE){
const s=localStorage.getItem('villageEra');
if(s){ const ld=JSON.parse(s); Object.keys(ld).forEach(k=>{ if(ld[k]!==undefined) this.d[k]=ld[k]; }); }
return;
}
try{
const r=await fetch(this.API_BASE+'/api/game/state',{headers:{'X-Telegram-User-Id':String(this.myPlayerId||0)}});
if(r.ok){ const st=await r.json(); Object.keys(st).forEach(k=>{ if(st[k]!==undefined&&k!=='buildings') this.d[k]=st[k]; }); }
const fieldR=await fetch(this.API_BASE+'/api/game/field',{headers:{'X-Telegram-User-Id':String(this.myPlayerId||0)}});
if(fieldR.ok){
const field=await fieldR.json();
const bySlot=[];
for(let s=1;s<=9;s++){
const row=field.find(x=>x.slot_index===s);
if(row) bySlot.push({t:row.building_key,lv:row.level||1,last:Date.now(),_slotIndex:s});
}
this.d.buildings=bySlot;
this._fieldFromApi=true;
}
const defR=await fetch(this.API_BASE+'/api/game/buildings/def',{headers:{'X-Telegram-User-Id':String(this.myPlayerId||0)}});
if(defR.ok){
const defs=await defR.json();
defs.forEach(b=>{
const cfg=b.config||{};
const incArr=cfg.incomePerHour||[];
const inc=incArr[0]||0;
if(!this.buildingTypes[b.key]) this.buildingTypes[b.key]={n:b.name||b.key,i:'üèóÔ∏è',inc,c:{wood:30,stone:30,coins:100}};
else{ this.buildingTypes[b.key].n=b.name||this.buildingTypes[b.key].n; if(incArr.length) this.buildingTypes[b.key].inc=inc; }
});
}
if(this.API_BASE){ this.syncCheckinState(); this.initLeaderboard().then(()=>this.updateCheckinUI()); }
}catch(e){ console.warn('API load failed',e); if(typeof this.notify==='function') this.notify('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å —Å–µ—Ä–≤–µ—Ä–∞','error'); }
},
async syncCheckinState(){
if(!this.API_BASE)return;
try{
const r=await fetch(this.API_BASE+'/api/game/checkin-state',{headers:{'X-Telegram-User-Id':String(this.myPlayerId||0)}});
const data=r.ok?await r.json():{};
this.d.digsLeft=data.attempts!==undefined?data.attempts:this.d.digsLeft;
if(data.next_checkin_at) this.d.nextCheckinAt=new Date(data.next_checkin_at.replace('Z','')).getTime();
else this.d.nextCheckinAt=null;
this.updateCheckinUI(); this.updateDigsTimer();
}catch(_){}
},

getBuildingSlotIndex(idx){
if(this._fieldFromApi&&this.d.buildings[idx]&&this.d.buildings[idx]._slotIndex) return this.d.buildings[idx]._slotIndex;
return (idx+1);
},
getFirstEmptySlot(){
if(!this._fieldFromApi) return this.d.buildings.length<9 ? (this.d.buildings.length+1) : null;
const used=new Set((this.d.buildings||[]).map(b=>b._slotIndex).filter(Boolean));
for(let s=1;s<=9;s++) if(!used.has(s)) return s;
return null;
},

runButtonChecks(){
const missing=[]; let ok=0; const seen=new Set();
document.querySelectorAll('[onclick*="G."]').forEach(el=>{
const m=(el.getAttribute('onclick')||'').match(/G\.(\w+)/g);
if(m) m.forEach(x=>{ const name=x.replace('G.',''); if(seen.has(name)) return; seen.add(name); if(typeof this[name]!=='function') missing.push(name); else ok++; });
});
if(missing.length) console.warn('–ö–Ω–æ–ø–∫–∏ –±–µ–∑ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞:', missing);
else console.log('–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–Ω–æ–ø–æ–∫: –≤—Å–µ '+ok+' –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –Ω–∞ –º–µ—Å—Ç–µ.');
return {ok,missing};
}
};
window.onload=()=>{ G.init(); setTimeout(()=>{ if(window.G&&G.runButtonChecks) G.runButtonChecks(); },1500); };
</script>
<script src="frontend/config/features.js"></script>
<script src="frontend/js/market.js"></script>
<script src="frontend/data/about-tabs-content.js"></script>
<script src="frontend/js/about.js"></script>
<script src="frontend/data/help-content.js"></script>
<script src="frontend/js/help.js"></script>
</body>
</html>
