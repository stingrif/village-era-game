<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å ‚Äî Village Era</title>
<style>
*{box-sizing:border-box}
body{font-family:system-ui,-apple-system,sans-serif;margin:0;padding:0;background:#111827;color:#e5e7eb;min-height:100vh}
.wrap{max-width:820px;margin:0 auto;padding:16px}
h1{color:#f59e0b;font-size:1.5rem;margin:0 0 4px}
h2{color:#f59e0b;font-size:1.1rem;margin:20px 0 10px}
h3{color:#d97706;font-size:.95rem;margin:14px 0 8px}
a{color:#60a5fa}
.subtitle{font-size:13px;opacity:.7;margin-bottom:16px}

/* Nav */
.nav{display:flex;gap:4px;flex-wrap:wrap;margin-bottom:16px;background:rgba(0,0,0,.3);padding:8px;border-radius:10px}
.nav button{padding:7px 12px;border-radius:8px;border:1px solid rgba(245,158,11,.25);background:transparent;color:#d1d5db;font-size:13px;cursor:pointer;white-space:nowrap}
.nav button:hover{background:rgba(245,158,11,.15)}
.nav button.active{background:linear-gradient(135deg,#d97706,#f59e0b);color:#111827;font-weight:700;border-color:transparent}

/* Cards */
.card{background:rgba(255,255,255,.04);border:1px solid rgba(245,158,11,.2);border-radius:12px;padding:16px;margin-bottom:16px}
.section{display:none}
.section.active{display:block}

/* Forms */
input[type="text"],input[type="password"],input[type="number"],textarea,select{width:100%;padding:9px 12px;border:1px solid rgba(245,158,11,.35);border-radius:8px;background:rgba(0,0,0,.35);color:#fff;font-size:14px;margin-bottom:8px}
input::placeholder,textarea::placeholder{color:rgba(255,255,255,.35)}
textarea{min-height:60px;resize:vertical}
label{display:block;font-size:12px;color:#9ca3af;margin-bottom:3px}

/* Buttons */
button,btn{cursor:pointer;font-size:14px}
.btn{padding:8px 16px;border-radius:8px;border:none;font-weight:600}
.btn-primary{background:linear-gradient(135deg,#d97706,#f59e0b);color:#111827}
.btn-danger{background:linear-gradient(135deg,#b91c1c,#dc2626);color:#fff}
.btn-success{background:linear-gradient(135deg,#047857,#10b981);color:#fff}
.btn-sm{padding:5px 10px;font-size:12px}
.btn:hover{opacity:.9}
.btn:disabled{opacity:.5;cursor:not-allowed}

/* List items */
.list-item{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:10px 12px;background:rgba(0,0,0,.2);border-radius:8px;margin-bottom:6px;font-size:13px}
.list-item .label{color:#f59e0b;font-weight:600;margin-right:6px}
.list-item .meta{opacity:.7;font-size:11px;word-break:break-all}
.list-item .actions{display:flex;gap:4px;flex-shrink:0}

/* Stats grid */
.stats{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:10px;margin-bottom:16px}
.stat{background:rgba(245,158,11,.08);border:1px solid rgba(245,158,11,.2);border-radius:10px;padding:12px;text-align:center;cursor:pointer;transition:all .2s;position:relative}
.stat:hover{background:rgba(245,158,11,.18);border-color:rgba(245,158,11,.5);transform:translateY(-2px);box-shadow:0 4px 15px rgba(245,158,11,.15)}
.stat:active{transform:translateY(0)}
.stat .val{font-size:1.5rem;font-weight:700;color:#f59e0b}
.stat .lbl{font-size:11px;color:#9ca3af;margin-top:2px}
.stat .expand-icon{position:absolute;top:6px;right:8px;font-size:10px;opacity:.4}
.stat.open .expand-icon{transform:rotate(180deg)}

/* Detail drawer */
.detail-drawer{display:none;grid-column:1/-1;background:rgba(0,0,0,.3);border:1px solid rgba(245,158,11,.25);border-radius:10px;padding:14px 16px;animation:drawerIn .2s ease-out}
.detail-drawer.open{display:block}
@keyframes drawerIn{from{opacity:0;max-height:0}to{opacity:1;max-height:500px}}
.detail-drawer h4{margin:0 0 10px;font-size:13px;color:#f59e0b}
.detail-drawer .detail-row{display:flex;justify-content:space-between;padding:5px 0;border-bottom:1px solid rgba(255,255,255,.05);font-size:12px}
.detail-drawer .detail-row:last-child{border-bottom:none}
.detail-drawer .detail-val{color:#f59e0b;font-weight:600}
.detail-drawer .player-row{display:flex;align-items:center;gap:8px;padding:6px 8px;background:rgba(255,255,255,.03);border-radius:6px;margin-bottom:4px;font-size:12px}
.detail-drawer .player-row .rank-num{font-weight:700;color:#f59e0b;min-width:22px}
.detail-drawer .player-row .name{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.detail-drawer .player-row .pts{color:#f59e0b;font-weight:600}

/* Messages */
.msg{font-size:13px;margin-top:8px;min-height:18px}
.msg.err{color:#ef4444}
.msg.ok{color:#10b981}

/* Toggle */
.toggle{display:inline-flex;align-items:center;gap:6px;cursor:pointer;font-size:12px}
.toggle input{width:16px;height:16px;accent-color:#f59e0b}

/* Top list */
.top-list{list-style:none;padding:0;margin:0}
.top-list li{padding:6px 0;border-bottom:1px solid rgba(255,255,255,.06);font-size:13px;display:flex;justify-content:space-between}
.top-list li:last-child{border-bottom:none}

/* Login screens */
.login-card{max-width:400px;margin:60px auto}
.hidden{display:none!important}
.logout{float:right;font-size:12px;padding:4px 10px}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:end;margin-bottom:8px}
.row>*{flex:1;min-width:120px}
.inline-form{display:flex;gap:8px;flex-wrap:wrap;align-items:end}
.inline-form>*:not(button){flex:1;min-width:100px}

/* Game Config */
#gcContent .card h3:hover{color:#f59e0b}
#gcContent textarea{font-family:'Courier New',monospace;font-size:11px}
</style>
</head>
<body>
<div class="wrap">
<h1>Village Era ‚Äî Admin</h1>
<p class="subtitle">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–æ–º</p>

<!-- ===== Auth screens ===== -->
<div id="setupBlock" class="login-card card hidden">
<h2>–ü–µ—Ä–≤—ã–π –≤—Ö–æ–¥</h2>
<label>–õ–æ–≥–∏–Ω</label><input type="text" id="setupLogin" placeholder="admin">
<label>–ü–∞—Ä–æ–ª—å</label><input type="password" id="setupPassword" placeholder="–º–∏–Ω. 6 —Å–∏–º–≤–æ–ª–æ–≤">
<button class="btn btn-primary" id="btnSetup">–°–æ–∑–¥–∞—Ç—å</button>
<div id="setupMsg" class="msg"></div>
</div>

<div id="loginBlock" class="login-card card hidden">
<h2>–í—Ö–æ–¥</h2>
<label>–õ–æ–≥–∏–Ω</label><input type="text" id="loginLogin" placeholder="–õ–æ–≥–∏–Ω">
<label>–ü–∞—Ä–æ–ª—å</label><input type="password" id="loginPassword" placeholder="–ü–∞—Ä–æ–ª—å">
<button class="btn btn-primary" id="btnLogin">–í–æ–π—Ç–∏</button>
<div id="loginMsg" class="msg"></div>
</div>

<!-- ===== Main panel ===== -->
<div id="panelBlock" class="hidden">
<p style="margin:0 0 12px;font-size:13px">
  <span id="panelLogin" style="color:#f59e0b;font-weight:600"></span>
  <button class="btn btn-sm btn-danger logout" id="btnLogout">–í—ã–π—Ç–∏</button>
</p>

<div class="nav" id="mainNav">
  <button data-s="dashboard" class="active">Dashboard</button>
  <button data-s="gameconfig">–ò–≥—Ä–∞</button>
  <button data-s="tasks">–ó–∞–¥–∞–Ω–∏—è</button>
  <button data-s="payouts">üí∞ –ü–µ—Ä–µ–≤–æ–¥—ã –∏ —à—Ç—Ä–∞—Ñ—ã</button>
  <button data-s="channels">–ö–∞–Ω–∞–ª—ã</button>
  <button data-s="texts">–¢–µ–∫—Å—Ç—ã</button>
  <button data-s="tokens">–¢–æ–∫–µ–Ω—ã</button>
  <button data-s="contracts">–°—Ç–µ–π–∫–∏–Ω–≥</button>
  <button data-s="nft">NFT</button>
  <button data-s="activity">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</button>
  <button data-s="settings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
</div>

<!-- ‚îÄ‚îÄ Dashboard ‚îÄ‚îÄ -->
<div id="sec-dashboard" class="section active">
<div class="stats" id="dashStats"></div>
<div id="dashDetailArea"></div>
</div>

<!-- ‚îÄ‚îÄ Game Config ‚îÄ‚îÄ -->
<div id="sec-gameconfig" class="section">
<div id="gcMsg" class="msg"></div>
<div id="gcContent"><p style="opacity:.6">–ó–∞–≥—Ä—É–∑–∫–∞...</p></div>
</div>

<!-- ‚îÄ‚îÄ Tasks ‚îÄ‚îÄ -->
<div id="sec-tasks" class="section">
<div class="card">
<h3>–î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ</h3>
<div class="row">
  <div><label>–¢–∏–ø –∑–∞–¥–∞–Ω–∏—è</label><select id="taskType" onchange="onTaskTypeChange()"><option value="custom">–°–≤–æ—ë —É—Å–ª–æ–≤–∏–µ</option></select></div>
  <div><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input type="text" id="taskTitle" placeholder="–ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ TG –∫–∞–Ω–∞–ª"></div>
</div>
<div class="row">
  <div><label>–û–ø–∏—Å–∞–Ω–∏–µ</label><input type="text" id="taskDesc" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è –¥–ª—è –∏–≥—Ä–æ–∫–∞"></div>
</div>
<div id="taskExtraFields"></div>
<div class="row">
  <div><label>–¢–∏–ø –Ω–∞–≥—Ä–∞–¥—ã</label><select id="taskRewardType"><option value="COINS">COINS</option></select></div>
  <div><label>–°—É–º–º–∞ –Ω–∞–≥—Ä–∞–¥—ã</label><input type="number" id="taskRewardVal" placeholder="100" value="100"></div>
</div>
<div style="background:rgba(245,158,11,.06);border-radius:8px;padding:10px;margin-bottom:10px;font-size:12px;opacity:.7" id="taskHint">
  –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –∑–∞–¥–∞–Ω–∏—è ‚Äî –∫–ª—é—á —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
</div>
<button class="btn btn-primary btn-sm" id="btnAddTask">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ</button>
<div id="taskMsg" class="msg"></div>
</div>
<div id="tasksList"></div>
</div>

<!-- ‚îÄ‚îÄ Channels ‚îÄ‚îÄ -->
<div id="sec-channels" class="section">
<div class="card">
<h3>–î–æ–±–∞–≤–∏—Ç—å –∫–∞–Ω–∞–ª / —á–∞—Ç</h3>
<div class="row">
  <div><label>Chat ID</label><input type="text" id="chChatId" placeholder="-1001234567890"></div>
  <div><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input type="text" id="chTitle" placeholder="Phoenix Paw"></div>
  <div><label>–¢–∏–ø</label>
    <select id="chType"><option value="channel">–ö–∞–Ω–∞–ª</option><option value="group">–ì—Ä—É–ø–ø–∞</option><option value="supergroup">–°—É–ø–µ—Ä–≥—Ä—É–ø–ø–∞</option></select>
  </div>
</div>
<div style="display:flex;gap:8px;margin-bottom:10px">
  <button class="btn btn-primary btn-sm" id="btnAddChannel">–î–æ–±–∞–≤–∏—Ç—å</button>
  <button class="btn btn-success btn-sm" id="btnDetectChats">–ê–≤—Ç–æ–æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –∫–∞–Ω–∞–ª–æ–≤ –±–æ—Ç–∞</button>
</div>
<div id="chMsg" class="msg"></div>
<div id="botChatsPreview" style="display:none;margin-bottom:12px"></div>
</div>
<div id="channelsList"></div>
</div>

<!-- ‚îÄ‚îÄ Page Texts ‚îÄ‚îÄ -->
<div id="sec-texts" class="section">
<div class="card">
<h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤</h3>
<p style="font-size:12px;opacity:.7">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é.</p>
<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px">
  <select id="txtPageId" style="max-width:220px"><option value="">‚Äî –∑–∞–≥—Ä—É–∑–∫–∞ ‚Äî</option></select>
  <button class="btn btn-primary btn-sm" id="btnLoadTexts">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
  <button class="btn btn-sm btn-success" id="btnNewPage" title="–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É">+ –ù–æ–≤–∞—è</button>
</div>
<div id="textsEditor"></div>
<div id="txtMsg" class="msg"></div>
</div>
</div>

<!-- ‚îÄ‚îÄ Partner Tokens ‚îÄ‚îÄ -->
<div id="sec-tokens" class="section">
<div class="card">
<h3>–î–æ–±–∞–≤–∏—Ç—å –ø–∞—Ä—Ç–Ω—ë—Ä—Å–∫–∏–π —Ç–æ–∫–µ–Ω</h3>
<div class="row">
  <div><label>–ê–¥—Ä–µ—Å —Ç–æ–∫–µ–Ω–∞</label><input type="text" id="ptAddr" placeholder="EQ..."></div>
  <div><label>–°–∏–º–≤–æ–ª</label><input type="text" id="ptSymbol" placeholder="PHXPW"></div>
</div>
<div class="row">
  <div><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input type="text" id="ptName" placeholder="Phoenix Paw Token"></div>
  <div><label>–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ</label><input type="text" id="ptUsage" placeholder="payment" value="payment"></div>
</div>
<button class="btn btn-primary btn-sm" id="btnAddToken">–î–æ–±–∞–≤–∏—Ç—å</button>
<div id="ptMsg" class="msg"></div>
</div>
<div id="tokensList"></div>
</div>

<!-- ‚îÄ‚îÄ Staking Contracts ‚îÄ‚îÄ -->
<div id="sec-contracts" class="section">
<div class="card">
<h3>–°—Ç–µ–π–∫–∏–Ω–≥-–∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã</h3>
<div class="inline-form" style="margin-bottom:12px">
  <input type="text" id="scAddr" placeholder="–ê–¥—Ä–µ—Å –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞ (TON)">
  <input type="text" id="scLabel" placeholder="–ü–æ–¥–ø–∏—Å—å" style="max-width:160px">
  <button class="btn btn-primary btn-sm" id="btnAddContract">–î–æ–±–∞–≤–∏—Ç—å</button>
</div>
<div id="scMsg" class="msg"></div>
</div>
<div id="contractsList"></div>
</div>

<!-- ‚îÄ‚îÄ NFT ‚îÄ‚îÄ -->
<div id="sec-nft" class="section">
<div class="card">
<h3>NFT-–∫–æ–ª–ª–µ–∫—Ü–∏–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞</h3>
<button class="btn btn-success btn-sm" id="btnNftSync" style="margin-bottom:12px">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å NFT</button>
<div id="nftSyncMsg" class="msg"></div>
<div id="nftCollList"></div>
</div>
<div class="card">
<h3>NFT –ø—Ä–µ–¥–º–µ—Ç—ã</h3>
<div id="nftItemsList" style="max-height:400px;overflow-y:auto"></div>
</div>
<div class="card">
<h3>–•–æ–ª–¥–µ—Ä—ã NFT</h3>
<div style="display:flex;gap:8px;margin-bottom:12px">
  <button class="btn btn-success btn-sm" id="btnHolderSync">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ö–æ–ª–¥–µ—Ä–æ–≤</button>
  <button class="btn btn-primary btn-sm" id="btnLoadHolders">–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
</div>
<div id="holderSyncMsg" class="msg"></div>
<div id="holdersList" style="max-height:500px;overflow-y:auto"></div>
</div>
</div>

<!-- ‚îÄ‚îÄ –ü–µ—Ä–µ–≤–æ–¥—ã –∏ —à—Ç—Ä–∞—Ñ—ã ‚îÄ‚îÄ -->
<div id="sec-payouts" class="section">
<div class="card">
<h3>–ù–∞–≥—Ä–∞–¥–∞ (–ø–µ—Ä–µ–≤–æ–¥ –ø–æ iCryptoCheck)</h3>
<p style="font-size:12px;opacity:.7">–ö–æ–≥–æ –Ω–∞–≥—Ä–∞–¥–∏—Ç—å: –≤—ã–±–µ—Ä–∏—Ç–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞ –∏–∑ —Å–ø–∏—Å–∫–∞ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ Telegram ID. –°—É–º–º–∞ –∏ –≤–∞–ª—é—Ç–∞ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –ø–æ–ª—É—á–∞—Ç–µ–ª—é —á–µ—Ä–µ–∑ iCryptoCheck.</p>
<div class="row" style="margin-bottom:10px">
  <div style="min-width:220px">
    <label>–£—á–∞—Å—Ç–Ω–∏–∫ (–∫—Ç–æ –ø–æ–ª—É—á–∏—Ç)</label>
    <select id="payoutRewardUser" style="margin-bottom:4px"><option value="">‚Äî –≤–≤–æ–¥ ID –≤—Ä—É—á–Ω—É—é ‚Äî</option></select>
    <input type="text" id="payoutRewardTgId" placeholder="Telegram ID (–µ—Å–ª–∏ –Ω–µ—Ç –≤ —Å–ø–∏—Å–∫–µ)" style="margin-top:0">
  </div>
</div>
<div class="row">
  <div style="min-width:120px"><label>–°—É–º–º–∞</label><input type="number" id="payoutRewardAmount" placeholder="1000" min="0.01" step="0.01"></div>
  <div style="min-width:120px"><label>–í–∞–ª—é—Ç–∞</label><select id="payoutRewardCurrency"><option value="PHXPW">PHXPW</option><option value="TON">TON</option></select></div>
</div>
<div class="row">
  <div style="flex:1"><label>–ü—Ä–∏—á–∏–Ω–∞ –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –ø–æ–ª—É—á–∞—Ç–µ–ª—é)</label><input type="text" id="payoutRewardDescription" placeholder="–Ω–∞–≥—Ä–∞–¥—ã –∑–∞ –∑–∞–¥–∞–Ω–∏—è, –±–æ–Ω—É—Å –∑–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å"></div>
</div>
<p id="payoutTransferLimits" style="font-size:11px;opacity:.5;margin-top:4px"></p>
<p style="font-size:11px;opacity:.4;margin-top:4px">–ü–µ—Ä–µ–≤–æ–¥—ã —Å —Ö–æ–ª–æ–¥–Ω–æ–≥–æ –∫–æ—à–µ–ª—å–∫–∞ –±—É–¥—É—Ç –¥–æ—Å—Ç—É–ø–Ω—ã –ø–æ–∑–∂–µ.</p>
<button class="btn btn-success btn-sm" id="btnPayoutTransfer">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–µ—Ä–µ–≤–æ–¥</button>
<div id="payoutTransferMsg" class="msg"></div>
</div>
<div class="card">
<h3>–®—Ç—Ä–∞—Ñ –Ω–∞ –≤—ã–≤–æ–¥</h3>
<p style="font-size:12px;opacity:.7">–®—Ç—Ä–∞—Ñ –±—É–¥–µ—Ç —É–¥–µ—Ä–∂–∞–Ω –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –≤—ã–≤–æ–¥–µ —Å—Ä–µ–¥—Å—Ç–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º. –£–∫–∞–∂–∏—Ç–µ –∫–æ–º—É, —Å—É–º–º—É –∏ –≤–∞–ª—é—Ç—É.</p>
<div class="row" style="margin-bottom:10px">
  <div style="min-width:220px">
    <label>–£—á–∞—Å—Ç–Ω–∏–∫ (–∫–æ–º—É –Ω–∞–ª–æ–∂–∏—Ç—å —à—Ç—Ä–∞—Ñ)</label>
    <select id="payoutPenaltyUser" style="margin-bottom:4px"><option value="">‚Äî –≤–≤–æ–¥ ID –≤—Ä—É—á–Ω—É—é ‚Äî</option></select>
    <input type="text" id="payoutPenaltyTgId" placeholder="Telegram ID (–µ—Å–ª–∏ –Ω–µ—Ç –≤ —Å–ø–∏—Å–∫–µ)" style="margin-top:0">
  </div>
</div>
<div class="row">
  <div style="min-width:120px"><label>–°—É–º–º–∞</label><input type="number" id="payoutPenaltyAmount" placeholder="100" min="0.01" step="0.01"></div>
  <div style="min-width:120px"><label>–í–∞–ª—é—Ç–∞</label><select id="payoutPenaltyCurrency"><option value="PHXPW">PHXPW</option><option value="TON">TON</option></select></div>
</div>
<div class="row">
  <div style="flex:1"><label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–ø—Ä–∏—á–∏–Ω–∞ —à—Ç—Ä–∞—Ñ–∞)</label><input type="text" id="payoutPenaltyComment" placeholder="–ø—Ä–∏—á–∏–Ω–∞ —à—Ç—Ä–∞—Ñ–∞"></div>
</div>
<div class="row" style="align-items:center;margin-top:8px">
  <label class="toggle"><input type="checkbox" id="payoutPenaltyNotify" checked> –û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –æ —à—Ç—Ä–∞—Ñ–µ</label>
</div>
<p id="payoutPenaltyLimits" style="font-size:11px;opacity:.5;margin-top:4px"></p>
<button class="btn btn-danger btn-sm" id="btnPayoutPenalty">–ù–∞–ª–æ–∂–∏—Ç—å —à—Ç—Ä–∞—Ñ</button>
<div id="payoutPenaltyMsg" class="msg"></div>
</div>
</div>

<!-- ‚îÄ‚îÄ Activity ‚îÄ‚îÄ -->
<div id="sec-activity" class="section">
<div class="card">
<h3>–õ–æ–≥ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</h3>
<div class="inline-form" style="margin-bottom:12px">
  <input type="text" id="actTgId" placeholder="Telegram ID (–æ–ø—Ü.)" style="max-width:180px">
  <button class="btn btn-primary btn-sm" id="btnLoadActivity">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
</div>
<div id="actLog" style="max-height:400px;overflow-y:auto;font-size:12px"></div>
</div>
<div class="card">
<h3>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
<div id="actStats" style="font-size:13px"></div>
</div>
</div>

<!-- ‚îÄ‚îÄ Settings ‚îÄ‚îÄ -->
<div id="sec-settings" class="section">
<div class="card">
<h3>–ü–µ—Ä–µ–≤–æ–¥—ã –∏ —à—Ç—Ä–∞—Ñ—ã</h3>
<p style="font-size:12px;opacity:.7">–ù–∞–≥—Ä–∞–¥—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º (–ø–µ—Ä–µ–≤–æ–¥ –ø–æ iCryptoCheck) –∏ –Ω–∞–ª–æ–∂–µ–Ω–∏–µ —à—Ç—Ä–∞—Ñ–æ–≤ –Ω–∞ –≤—ã–≤–æ–¥.</p>
<button class="btn btn-primary btn-sm" onclick="goToSection('payouts')">–û—Ç–∫—Ä—ã—Ç—å —Ä–∞–∑–¥–µ–ª ¬´–ü–µ—Ä–µ–≤–æ–¥—ã –∏ —à—Ç—Ä–∞—Ñ—ã¬ª</button>
</div>
<div class="card">
<h3>–°–º–µ–Ω–∞ –ª–æ–≥–∏–Ω–∞ / –ø–∞—Ä–æ–ª—è</h3>
<label>–ù–æ–≤—ã–π –ª–æ–≥–∏–Ω</label><input type="text" id="setLogin" placeholder="–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º">
<label>–¢–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å</label><input type="password" id="setCurPwd" placeholder="–û–±—è–∑–∞—Ç–µ–ª–µ–Ω –ø—Ä–∏ —Å–º–µ–Ω–µ –ø–∞—Ä–æ–ª—è">
<label>–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</label><input type="password" id="setNewPwd" placeholder="–ú–∏–Ω. 6 —Å–∏–º–≤–æ–ª–æ–≤">
<button class="btn btn-primary btn-sm" id="btnSaveSettings">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
<div id="setMsg" class="msg"></div>
</div>
</div>

</div><!-- panelBlock -->
</div><!-- wrap -->

<script src="config.js"></script>
<script>
const API = (window.GAME_API_BASE || window.API_BASE || '').replace(/\/$/,'');
const ADM = API + '/api/admin';
const PANEL = API + '/api/admin-panel';
const TK = 'admin_panel_token';
const TG_KEY = 'admin_tg_id';

function token(){ return localStorage.getItem(TK); }
function setTk(t){ t?localStorage.setItem(TK,t):localStorage.removeItem(TK); }
function tgId(){ return localStorage.getItem(TG_KEY)||'496560064'; }

function $(id){ return document.getElementById(id); }
function show(id){ $(id).classList.remove('hidden'); }
function hide(id){ $(id).classList.add('hidden'); }
function msg(id,t,err){ const e=$(id); e.textContent=t||''; e.className='msg'+(err?' err':' ok'); }

async function api(url, opt={}){
  const h={'Content-Type':'application/json',...(opt.headers||{})};
  const tk=token(); if(tk) h['Authorization']='Bearer '+tk;
  h['X-Telegram-User-Id']=tgId();
  const r=await fetch(url,{...opt,headers:h});
  if(!r.ok){ const d=await r.json().catch(()=>({})); throw new Error(d.detail||r.statusText); }
  const ct=r.headers.get('content-type');
  return ct&&ct.includes('json')?r.json():null;
}

// ‚Äî‚Äî‚Äî Navigation ‚Äî‚Äî‚Äî
function goToSection(s){
  const b=document.querySelector('.nav button[data-s="'+s+'"]');
  if(b){ b.click(); return; }
  document.querySelectorAll('.nav button').forEach(x=>x.classList.remove('active'));
  document.querySelectorAll('.section').forEach(x=>x.classList.remove('active'));
  const sec=$('sec-'+s); if(sec)sec.classList.add('active');
  const btn=document.querySelector('.nav button[data-s="'+s+'"]'); if(btn)btn.classList.add('active');
  if(s==='payouts') loadPayouts();
  if(s==='dashboard') loadDashboard();
}
$('mainNav').addEventListener('click',e=>{
  const b=e.target.closest('button[data-s]'); if(!b)return;
  document.querySelectorAll('.nav button').forEach(x=>x.classList.remove('active'));
  b.classList.add('active');
  document.querySelectorAll('.section').forEach(x=>x.classList.remove('active'));
  const sec=$('sec-'+b.dataset.s); if(sec)sec.classList.add('active');
  // auto-load
  const s=b.dataset.s;
  if(s==='dashboard') loadDashboard();
  if(s==='gameconfig') loadGameConfig();
  if(s==='tasks') loadTasks();
  if(s==='channels') loadChannels();
  if(s==='texts') loadPageList();
  if(s==='tokens') loadTokens();
  if(s==='contracts') loadContracts();
  if(s==='nft'){ loadNft(); loadHolders(); }
  if(s==='payouts') loadPayouts();
  if(s==='activity'){ loadActivityStats(); }
});

// ‚Äî‚Äî‚Äî Auth ‚Äî‚Äî‚Äî
async function init(){
  const tk=token();
  if(tk){
    try{ const me=await api(PANEL+'/me'); $('panelLogin').textContent=me.login; show('panelBlock'); hide('setupBlock'); hide('loginBlock'); loadDashboard(); return; }
    catch(_){ setTk(null); }
  }
  try{
    const s=await api(PANEL+'/setup/status');
    if(s.admin_exists){ show('loginBlock'); hide('setupBlock'); }
    else{ show('setupBlock'); hide('loginBlock'); }
    hide('panelBlock');
  }catch(e){ document.body.insertAdjacentHTML('beforeend','<p style="color:#ef4444;padding:20px">API –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ API_BASE.</p>'); }
}

$('btnSetup').onclick=async()=>{
  msg('setupMsg');
  try{
    const d=await api(PANEL+'/setup',{method:'POST',body:JSON.stringify({login:$('setupLogin').value.trim(),password:$('setupPassword').value})});
    setTk(d.token); $('panelLogin').textContent=d.login; show('panelBlock'); hide('setupBlock'); loadDashboard();
  }catch(e){ msg('setupMsg',e.message,1); }
};
$('btnLogin').onclick=async()=>{
  msg('loginMsg');
  try{
    const d=await api(PANEL+'/login',{method:'POST',body:JSON.stringify({login:$('loginLogin').value.trim(),password:$('loginPassword').value})});
    setTk(d.token); $('panelLogin').textContent=d.login; show('panelBlock'); hide('loginBlock'); loadDashboard();
  }catch(e){ msg('loginMsg',e.message,1); }
};
$('btnLogout').onclick=()=>{ setTk(null); init(); hide('panelBlock'); };

// ‚Äî‚Äî‚Äî Settings ‚Äî‚Äî‚Äî
$('btnSaveSettings').onclick=async()=>{
  msg('setMsg');
  try{
    await api(PANEL+'/settings',{method:'PUT',body:JSON.stringify({new_login:$('setLogin').value.trim()||undefined,current_password:$('setCurPwd').value,new_password:$('setNewPwd').value||undefined})});
    msg('setMsg','–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
    $('setLogin').value=''; $('setCurPwd').value=''; $('setNewPwd').value='';
  }catch(e){ msg('setMsg',e.message,1); }
};

// ‚Äî‚Äî‚Äî Dashboard ‚Äî‚Äî‚Äî
let _dashData=null;
let _openStat=null;

async function loadDashboard(){
  try{
    const d=await api(ADM+'/dashboard');
    _dashData=d;
    const p=d.players||d; const nft=d.nft||{}; const eco=d.economy||{};
    const cards=[
      {id:'players', icon:'üë•', val:p.total||d.total_players||0, lbl:'–ò–≥—Ä–æ–∫–æ–≤'},
      {id:'online',  icon:'üü¢', val:Math.max(p.online_ws||0,p.online_recent||0)||d.online||0, lbl:'–û–Ω–ª–∞–π–Ω'},
      {id:'new',     icon:'üìà', val:p.new_today||d.new_today||0, lbl:'–ù–æ–≤—ã—Ö —Å–µ–≥–æ–¥–Ω—è'},
      {id:'week',    icon:'üìÖ', val:p.new_week||d.new_week||0, lbl:'–ó–∞ –Ω–µ–¥–µ–ª—é'},
      {id:'checkins',icon:'‚úÖ', val:d.checkins_today||0, lbl:'–ß–µ–∫–∏–Ω–æ–≤ —Å–µ–≥–æ–¥–Ω—è'},
      {id:'nftcol',  icon:'üé®', val:nft.collections||d.nft_collections||0, lbl:'NFT –∫–æ–ª–ª–µ–∫—Ü–∏–π'},
      {id:'nfts',    icon:'üñº', val:nft.total_nfts||d.nft_total||0, lbl:'NFT –≤—Å–µ–≥–æ'},
      {id:'payouts', icon:'üí∞', val:eco.pending_payouts||d.pending_payouts||0, lbl:'–û–∂–∏–¥. –≤—ã–ø–ª–∞—Ç'},
    ];
    $('dashStats').innerHTML=cards.map(c=>
      `<div class="stat${_openStat===c.id?' open':''}" data-stat="${c.id}" onclick="toggleStat('${c.id}')">
        <span class="expand-icon">‚ñº</span>
        <div style="font-size:18px;margin-bottom:2px">${c.icon}</div>
        <div class="val">${c.val}</div>
        <div class="lbl">${c.lbl}</div>
      </div>`
    ).join('');
    renderDetail();
  }catch(e){ $('dashStats').innerHTML='<p class="msg err">'+esc(e.message)+'</p>'; }
}

function toggleStat(id){
  _openStat=(_openStat===id)?null:id;
  document.querySelectorAll('.stat').forEach(el=>{
    el.classList.toggle('open',el.dataset.stat===_openStat);
  });
  renderDetail();
}

async function renderDetail(){
  const area=$('dashDetailArea');
  if(!_openStat||!_dashData){ area.innerHTML=''; return; }
  const d=_dashData;
  const p=d.players||d; const nft=d.nft||{}; const eco=d.economy||{};
  area.innerHTML='<div class="detail-drawer open"><p style="opacity:.6">–ó–∞–≥—Ä—É–∑–∫–∞...</p></div>';
  let h='<div class="detail-drawer open">';

  switch(_openStat){
    case 'players': {
      const det=await api(ADM+'/dashboard/players?filter=all&limit=20').catch(()=>null);
      h+=`<h4>üë• –í—Å–µ –∏–≥—Ä–æ–∫–∏</h4>`;
      h+=drow('–í—Å–µ–≥–æ', p.total||0);h+=drow('–û–Ω–ª–∞–π–Ω WS', p.online_ws||0);h+=drow('–ê–∫—Ç–∏–≤–Ω—ã—Ö 5–º', p.online_recent||0);
      h+=`<div style="display:flex;gap:6px;margin:10px 0;flex-wrap:wrap">
        <button class="btn btn-sm btn-primary" onclick="loadPlayerFilter('all')">–í—Å–µ</button>
        <button class="btn btn-sm btn-success" onclick="loadPlayerFilter('online')">–û–Ω–ª–∞–π–Ω</button>
        <button class="btn btn-sm btn-primary" onclick="loadPlayerFilter('today')">–°–µ–≥–æ–¥–Ω—è</button>
        <button class="btn btn-sm btn-primary" onclick="loadPlayerFilter('week')">–ù–µ–¥–µ–ª—è</button>
      </div>`;
      h+=`<div id="playerDetailList">${renderPlayerList(det)}</div>`;
      break;
    }
    case 'online': {
      const det=await api(ADM+'/dashboard/players?filter=online&limit=20').catch(()=>null);
      h+=`<h4>üü¢ –°–µ–π—á–∞—Å –æ–Ω–ª–∞–π–Ω</h4>`;
      h+=drow('WebSocket', p.online_ws||0);h+=drow('–ê–∫—Ç–∏–≤–Ω—ã—Ö 5–º (DB)', p.online_recent||0);
      h+=`<div id="playerDetailList" style="margin-top:10px">${renderPlayerList(det)}</div>`;
      h+=`<p style="font-size:11px;opacity:.4;margin-top:8px">WS ‚Äî —Ä–µ–∞–ª—å–Ω—ã–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è. DB ‚Äî updated_at –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 –º–∏–Ω.</p>`;
      break;
    }
    case 'new': {
      const det=await api(ADM+'/dashboard/players?filter=today&limit=20').catch(()=>null);
      h+=`<h4>üìà –ù–æ–≤—ã–µ —Å–µ–≥–æ–¥–Ω—è</h4>`;
      h+=drow('–ù–æ–≤—ã—Ö –∑–∞ 24—á', p.new_today||0);
      const pct=((p.new_today||0)/(p.total||1)*100).toFixed(1);
      h+=drow('% –æ—Ç –≤—Å–µ—Ö', pct+'%');
      h+=`<div id="playerDetailList" style="margin-top:10px">${renderPlayerList(det)}</div>`;
      break;
    }
    case 'week': {
      const det=await api(ADM+'/dashboard/players?filter=week&limit=20').catch(()=>null);
      h+=`<h4>üìÖ –ù–æ–≤—ã–µ –∑–∞ –Ω–µ–¥–µ–ª—é</h4>`;
      h+=drow('–ó–∞ 7 –¥–Ω–µ–π', p.new_week||0);
      h+=drow('–°—Ä–µ–¥–Ω–µ–µ/–¥–µ–Ω—å', ((p.new_week||0)/7).toFixed(1));
      h+=`<div id="playerDetailList" style="margin-top:10px">${renderPlayerList(det)}</div>`;
      break;
    }
    case 'checkins': {
      const det=await api(ADM+'/dashboard/checkins').catch(()=>null);
      h+=`<h4>‚úÖ –ß–µ–∫–∏–Ω—ã —Å–µ–≥–æ–¥–Ω—è</h4>`;
      if(det){
        h+=drow('–ß–µ–∫–∏–Ω–æ–≤ –∑–∞ 24—á', (det.today||[]).length);
        h+=drow('–ú–∞–∫—Å. —Å—Ç—Ä–∏–∫ (–≤—Å–µ)', det.max_streak);
        h+=drow('–°—Ä–µ–¥–Ω–∏–π —Å—Ç—Ä–∏–∫', det.avg_streak);
        h+=`<div style="margin-top:10px">`;
        (det.today||[]).forEach(c=>{
          const t=c.last_checkin?new Date(c.last_checkin).toLocaleTimeString('ru',{hour:'2-digit',minute:'2-digit'}):'';
          h+=`<div class="player-row">
            <span class="name">${esc(c.name)}</span>
            <span style="font-size:11px;opacity:.6">—Å—Ç—Ä–∏–∫: ${c.streak}</span>
            <span style="font-size:11px;opacity:.6">–ø–æ–ø—ã—Ç–æ–∫: ${c.attempts}</span>
            <span style="font-size:10px;opacity:.4">${t}</span>
          </div>`;
        });
        if(!(det.today||[]).length) h+=`<p style="opacity:.5;font-size:12px">–°–µ–≥–æ–¥–Ω—è –Ω–∏–∫—Ç–æ –Ω–µ —á–µ–∫–∏–Ω–∏–ª—Å—è</p>`;
        h+=`</div>`;
      }
      break;
    }
    case 'nftcol':
    case 'nfts': {
      const det=await api(ADM+'/dashboard/nft-details').catch(()=>null);
      h+=`<h4>${_openStat==='nftcol'?'üé® –ö–æ–ª–ª–µ–∫—Ü–∏–∏':'üñº NFT'} ‚Äî –¥–µ—Ç–∞–ª—å–Ω–æ</h4>`;
      const syncT=nft.last_synced_at||d.nft_last_sync;
      h+=drow('–ü–æ—Å–ª–µ–¥–Ω–∏–π —Å–∏–Ω–∫', syncT?new Date(syncT).toLocaleString():'‚Äî');
      if(det){
        h+=`<div style="margin-top:10px">`;
        (det.collections||[]).forEach(c=>{
          h+=`<div style="display:flex;align-items:center;gap:10px;padding:8px;background:rgba(255,255,255,.03);border-radius:8px;margin-bottom:6px">
            ${c.image?`<img src="${esc(c.image)}" style="width:32px;height:32px;border-radius:6px;object-fit:cover">`:'<span style="font-size:20px">üé®</span>'}
            <div style="flex:1;min-width:0">
              <div style="font-size:12px;font-weight:600;color:#f59e0b;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(c.name)}</div>
              <div style="font-size:11px;opacity:.6">${c.nft_count} NFT | ${c.unique_owners} –≤–ª–∞–¥–µ–ª—å—Ü–µ–≤</div>
            </div>
          </div>`;
        });
        if((det.recent_nfts||[]).length){
          h+=`<h4 style="margin-top:14px">–ü–æ—Å–ª–µ–¥–Ω–∏–µ NFT</h4>`;
          det.recent_nfts.forEach(n=>{
            const owner=n.owner?(n.owner.length>20?n.owner.slice(0,8)+'...'+n.owner.slice(-6):n.owner):'‚Äî';
            h+=`<div class="player-row">
              ${n.image?`<img src="${esc(n.image)}" style="width:24px;height:24px;border-radius:4px;object-fit:cover">`:''}
              <span class="name" style="font-size:11px">${esc(n.name)}</span>
              <span style="font-size:10px;opacity:.5">${esc(n.collection)}</span>
              <span style="font-size:10px;opacity:.4;font-family:monospace">${owner}</span>
            </div>`;
          });
        }
        h+=`</div>`;
      }
      h+=`<div style="margin-top:10px"><button class="btn btn-sm btn-primary" onclick="document.querySelector('[data-s=nft]').click()">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ NFT</button></div>`;
      break;
    }
    case 'payouts': {
      const det=await api(ADM+'/dashboard/economy').catch(()=>null);
      h+=`<h4>üí∞ –≠–∫–æ–Ω–æ–º–∏–∫–∞ ‚Äî –¥–µ—Ç–∞–ª—å–Ω–æ</h4>`;
      if(det){
        if((det.flows||[]).length){
          h+=`<div style="margin-bottom:12px"><strong style="font-size:12px;color:#d97706">–ü–æ—Ç–æ–∫–∏ –ø–æ –≤–∞–ª—é—Ç–∞–º</strong></div>`;
          det.flows.forEach(f=>{
            h+=`<div class="detail-row">
              <span><span style="color:#f59e0b;font-weight:600">${esc(f.currency)}</span> <span style="opacity:.6">/ ${esc(f.reason)}</span></span>
              <span><span style="color:#10b981">+${f.total_in}</span> <span style="color:#ef4444">-${f.total_out}</span> <span style="opacity:.5">(${f.tx_count} tx)</span></span>
            </div>`;
          });
        }
        if((det.pending_payouts||[]).length){
          h+=`<h4 style="margin-top:12px">–û–∂–∏–¥–∞—é—â–∏–µ –≤—ã–ø–ª–∞—Ç—ã</h4>`;
          det.pending_payouts.forEach(pp=>{
            h+=`<div class="player-row">
              <span class="name">${esc(pp.name)}</span>
              <span class="pts">${pp.amount} ${esc(pp.currency)}</span>
              <span style="font-size:10px;opacity:.4">${pp.created_at?new Date(pp.created_at).toLocaleDateString():''}</span>
            </div>`;
          });
        } else { h+=drow('–û–∂–∏–¥–∞—é—â–∏—Ö –≤—ã–ø–ª–∞—Ç','0'); }
        h+=`<div style="margin-top:12px"><button class="btn btn-sm btn-primary" onclick="goToSection('payouts')">–ü–µ—Ä–µ–π—Ç–∏ –≤ —Ä–∞–∑–¥–µ–ª ¬´–ü–µ—Ä–µ–≤–æ–¥—ã –∏ —à—Ç—Ä–∞—Ñ—ã¬ª</button></div>`;
        if((det.recent_transactions||[]).length){
          h+=`<h4 style="margin-top:12px">–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</h4>`;
          det.recent_transactions.forEach(tx=>{
            const cls=tx.amount>=0?'color:#10b981':'color:#ef4444';
            h+=`<div class="detail-row">
              <span>${esc(tx.user)} <span style="opacity:.5;font-size:10px">${esc(tx.reason)}</span></span>
              <span style="${cls};font-weight:600">${tx.amount>0?'+':''}${tx.amount} ${esc(tx.currency)}</span>
            </div>`;
          });
        }
      }
      break;
    }
  }
  h+='</div>';
  area.innerHTML=h;
}

window.loadPlayerFilter=async(filter)=>{
  const el=$('playerDetailList'); if(!el)return;
  el.innerHTML='<p style="opacity:.5;font-size:12px">–ó–∞–≥—Ä—É–∑–∫–∞...</p>';
  const det=await api(ADM+'/dashboard/players?filter='+filter+'&limit=30').catch(()=>null);
  el.innerHTML=renderPlayerList(det);
};

function renderPlayerList(det){
  if(!det||!det.players||!det.players.length) return '<p style="opacity:.5;font-size:12px">–ù–µ—Ç –∏–≥—Ä–æ–∫–æ–≤</p>';
  let h=`<p style="font-size:11px;opacity:.5;margin-bottom:6px">–ü–æ–∫–∞–∑–∞–Ω–æ ${det.players.length} –∏–∑ ${det.total}</p>`;
  det.players.forEach(pl=>{
    const lastAct=pl.last_active?timeAgo(new Date(pl.last_active)):'‚Äî';
    const created=pl.created_at?new Date(pl.created_at).toLocaleDateString('ru'):'‚Äî';
    const checkin=pl.checkin?`—Å—Ç—Ä–∏–∫:${pl.checkin.streak} –ø–æ–ø—ã—Ç–æ–∫:${pl.checkin.attempts}`:'‚Äî';
    h+=`<div class="player-row" style="flex-wrap:wrap">
      <span class="rank-num" style="font-size:11px;min-width:auto">üÜî</span>
      <span class="name" title="TG: ${pl.telegram_id}">${esc(pl.name)}</span>
      <span style="font-size:10px;opacity:.5" title="Telegram ID">${pl.telegram_id}</span>
      <span class="pts">${pl.points} pts</span>
    </div>
    <div style="display:flex;gap:12px;font-size:10px;opacity:.55;padding:0 8px 6px 30px;margin-top:-2px">
      <span title="–ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å">‚è± ${lastAct}</span>
      <span title="–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏">üìÖ ${created}</span>
      <span title="–ß–µ–∫–∏–Ω">${checkin!=='‚Äî'?'‚úÖ '+checkin:'‚Äî'}</span>
      ${pl.username?'<span>@'+esc(pl.username)+'</span>':''}
    </div>`;
  });
  return h;
}

function timeAgo(date){
  const s=Math.floor((Date.now()-date.getTime())/1000);
  if(s<60) return s+'—Å –Ω–∞–∑–∞–¥';
  if(s<3600) return Math.floor(s/60)+'–º –Ω–∞–∑–∞–¥';
  if(s<86400) return Math.floor(s/3600)+'—á –Ω–∞–∑–∞–¥';
  return Math.floor(s/86400)+'–¥ –Ω–∞–∑–∞–¥';
}

function drow(label,val){ return `<div class="detail-row"><span>${esc(label)}</span><span class="detail-val">${esc(String(val))}</span></div>`; }
function renderTop5(top){
  if(!top.length) return '<p style="opacity:.6;font-size:12px">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>';
  const medals=['ü•á','ü•à','ü•â','4.','5.'];
  return top.map((p,i)=>`<div class="player-row"><span class="rank-num">${medals[i]||i+1+'.'}</span><span class="name">${esc(p.name)}</span><span class="pts">${p.points} pts</span></div>`).join('');
}

function esc(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

// ‚Äî‚Äî‚Äî Tasks ‚Äî‚Äî‚Äî
const TASK_TYPE_LABELS = {
  'subscribe_channel': '–ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∫–∞–Ω–∞–ª/—á–∞—Ç',
  'subscribe_tg': '–ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ Telegram',
  'visit_url': '–ü–æ—Å–µ—Ç–∏—Ç—å —Å—Å—ã–ª–∫—É',
  'connect_wallet': '–ü—Ä–∏–≤—è–∑–∞—Ç—å –∫–æ—à–µ–ª—ë–∫',
  'buy_nft': '–ö—É–ø–∏—Ç—å NFT',
  'checkin_streak': '–°—Ç—Ä–∏–∫ —á–µ–∫–∏–Ω–æ–≤',
  'mine_count': '–ö–æ–ø–∞—Ç—å N —Ä–∞–∑',
  'invite_friend': '–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–≥–∞',
  'custom': '–°–≤–æ—ë —É—Å–ª–æ–≤–∏–µ',
};
const REWARD_TYPE_LABELS = {
  'COINS':'–ú–æ–Ω–µ—Ç—ã','GEMS':'–ì–µ–º—ã','STARS':'–ó–≤—ë–∑–¥—ã','PHXPW':'PHXPW','PHOEX':'PHOEX',
  'WOOD':'–î–µ—Ä–µ–≤–æ','STONE':'–ö–∞–º–µ–Ω—å','ATTEMPTS':'–ü–æ–ø—ã—Ç–∫–∏','POINTS':'–û—á–∫–∏','EGG':'–Ø–π—Ü–æ','RELIC':'–†–µ–ª–∏–∫–≤–∏—è',
};

// Show/hide extra fields based on task type
window.onTaskTypeChange = () => {
  const type = $('taskType').value;
  let h = '';
  const hint = $('taskHint');
  if (type === 'subscribe_channel' || type === 'subscribe_tg') {
    h += `<div class="row"><div><label>–ö–∞–Ω–∞–ª / —á–∞—Ç</label><select id="taskChannel"><option value="">‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option></select></div></div>`;
    if(hint) hint.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞–Ω–∞–ª. –ë–æ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∞–¥–º–∏–Ω–æ–º –≤ —ç—Ç–æ–º –∫–∞–Ω–∞–ª–µ.';
  } else if (type === 'visit_url') {
    h += `<div class="row"><div><label>URL —Å—Å—ã–ª–∫–∏</label><input type="text" id="taskUrl" placeholder="https://..."></div></div>`;
    if(hint) hint.textContent = '–í–≤–µ–¥–∏—Ç–µ URL, –∫–æ—Ç–æ—Ä—ã–π –∏–≥—Ä–æ–∫ –¥–æ–ª–∂–µ–Ω –ø–æ—Å–µ—Ç–∏—Ç—å.';
  } else if (type === 'checkin_streak') {
    h += `<div class="row"><div><label>–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Å—Ç—Ä–∏–∫</label><input type="number" id="taskMinStreak" value="3" min="1"></div></div>`;
    if(hint) hint.textContent = '–ò–≥—Ä–æ–∫ –ø–æ–ª—É—á–∏—Ç –Ω–∞–≥—Ä–∞–¥—É –∑–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ —Å—Ç—Ä–∏–∫–∞ —á–µ–∫–∏–Ω–æ–≤.';
  } else if (type === 'mine_count') {
    h += `<div class="row"><div><label>–°–∫–æ–ª—å–∫–æ —Ä–∞–∑ –∫–æ–ø–∞—Ç—å</label><input type="number" id="taskMineCount" value="10" min="1"></div></div>`;
    if(hint) hint.textContent = '–ò–≥—Ä–æ–∫ –ø–æ–ª—É—á–∏—Ç –Ω–∞–≥—Ä–∞–¥—É –∑–∞ N –∫–æ–ø–∞–Ω–∏–π –≤ —à–∞—Ö—Ç–µ.';
  } else if (type === 'invite_friend') {
    h += `<div class="row"><div><label>–ö–æ–ª-–≤–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π</label><input type="number" id="taskInviteCount" value="1" min="1"></div></div>`;
    if(hint) hint.textContent = '–ò–≥—Ä–æ–∫ –ø–æ–ª—É—á–∏—Ç –Ω–∞–≥—Ä–∞–¥—É –∑–∞ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –¥—Ä—É–∑–µ–π.';
  } else if (type === 'connect_wallet') {
    if(hint) hint.textContent = '–ò–≥—Ä–æ–∫ –ø–æ–ª—É—á–∏—Ç –Ω–∞–≥—Ä–∞–¥—É –∑–∞ –ø—Ä–∏–≤—è–∑–∫—É –∫–æ—à–µ–ª—å–∫–∞.';
  } else if (type === 'buy_nft') {
    if(hint) hint.textContent = '–ò–≥—Ä–æ–∫ –ø–æ–ª—É—á–∏—Ç –Ω–∞–≥—Ä–∞–¥—É –∑–∞ –ø–æ–∫—É–ø–∫—É NFT –∏–∑ –∫–æ–ª–ª–µ–∫—Ü–∏–π –ø—Ä–æ–µ–∫—Ç–∞.';
  } else {
    if(hint) hint.textContent = '–¢–∏–ø ¬´—Å–≤–æ—ë —É—Å–ª–æ–≤–∏–µ¬ª ‚Äî –∑–∞–¥–∞–π—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –≤—Ä—É—á–Ω—É—é.';
  }
  $('taskExtraFields').innerHTML = h;
  // Populate channel dropdown if needed
  if (type === 'subscribe_channel' || type === 'subscribe_tg') {
    populateTaskChannelDropdown();
  }
  // Auto-fill title if empty
  const title = $('taskTitle');
  if (!title.value.trim()) {
    const lbl = TASK_TYPE_LABELS[type] || type;
    title.value = lbl;
  }
};

async function populateTaskChannelDropdown() {
  const sel = $('taskChannel');
  if (!sel) return;
  const meta = await loadMeta();
  if (!meta) return;
  let opts = '<option value="">‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ –∫–∞–Ω–∞–ª ‚Äî</option>';
  // From existing channels
  (meta.channels || []).forEach(ch => {
    opts += `<option value="${ch.chat_id}">${esc(ch.title || '#' + ch.chat_id)} (${ch.channel_type})</option>`;
  });
  sel.innerHTML = opts;
  // Also try bot-detected chats
  try {
    const d = await api(ADM + '/bot-chats');
    const existing = new Set((meta.channels||[]).map(c=>String(c.chat_id)));
    (d.chats||[]).forEach(ch => {
      if (!existing.has(String(ch.chat_id))) {
        sel.innerHTML += `<option value="${ch.chat_id}" style="color:#10b981">+ ${esc(ch.title||ch.chat_id)} (–∞–≤—Ç–æ)</option>`;
      }
    });
  } catch(_) {}
}

async function loadTasks(){
  try{
    const list=await api(ADM+'/tasks');
    $('tasksList').innerHTML=list.map(t=>{
      const typeLbl = TASK_TYPE_LABELS[t.task_key] || t.task_key;
      const rewardLbl = REWARD_TYPE_LABELS[t.reward_type] || t.reward_type || '?';
      return `<div class="list-item" style="flex-wrap:wrap">
        <div style="flex:1;min-width:200px">
          <div><span class="label">${esc(typeLbl)}</span> ${esc(t.title)}</div>
          <div class="meta">${esc(t.description||'')} | –ù–∞–≥—Ä–∞–¥–∞: ${rewardLbl} x${t.reward_value||0} | ${t.is_active?'<span style="color:#10b981">–ê–∫—Ç–∏–≤–Ω–æ</span>':'<span style="color:#ef4444">–ù–µ–∞–∫—Ç–∏–≤–Ω–æ</span>'}</div>
          <div class="meta" style="opacity:.35">–ö–ª—é—á: ${esc(t.task_key)}</div>
        </div>
        <div class="actions">
          <button class="btn btn-sm ${t.is_active?'btn-danger':'btn-success'}" onclick="toggleTask(${t.id},${!t.is_active})">${t.is_active?'–í—ã–∫–ª':'–í–∫–ª'}</button>
          <button class="btn btn-sm btn-danger" onclick="delTask(${t.id})">X</button>
        </div>
      </div>`;
    }).join('')||'<p style="opacity:.6;font-size:13px">–ù–µ—Ç –∑–∞–¥–∞–Ω–∏–π</p>';
  }catch(e){ msg('taskMsg',e.message,1); }
}

window.toggleTask=async(id,active)=>{ try{ await api(ADM+'/tasks/'+id,{method:'PUT',body:JSON.stringify({is_active:active})}); loadTasks(); }catch(e){ alert(e.message); }};
window.delTask=async(id)=>{ if(!confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ?'))return; try{ await api(ADM+'/tasks/'+id,{method:'DELETE'}); loadTasks(); }catch(e){ alert(e.message); }};

// ‚Äî‚Äî‚Äî Channels ‚Äî‚Äî‚Äî
async function loadChannels(){
  try{
    const list=await api(ADM+'/channels');
    $('channelsList').innerHTML=list.map(c=>`
      <div class="list-item">
        <div style="flex:1">
          <span class="label">${esc(c.title||'#'+c.chat_id)}</span>
          <span class="meta">ID: ${c.chat_id} | ${c.channel_type} | ${c.is_active?'–ê–∫—Ç–∏–≤–µ–Ω':'–ù–µ–∞–∫—Ç–∏–≤–µ–Ω'}</span>
        </div>
        <div class="actions">
          <button class="btn btn-sm btn-danger" onclick="delChannel(${c.id})">X</button>
        </div>
      </div>`).join('')||'<p style="opacity:.6;font-size:13px">–ù–µ—Ç –∫–∞–Ω–∞–ª–æ–≤</p>';
  }catch(e){ msg('chMsg',e.message,1); }
}
$('btnAddChannel').onclick=async()=>{
  msg('chMsg');
  try{
    await api(ADM+'/channels',{method:'POST',body:JSON.stringify({chat_id:parseInt($('chChatId').value),title:$('chTitle').value.trim(),channel_type:$('chType').value})});
    msg('chMsg','–î–æ–±–∞–≤–ª–µ–Ω–æ'); $('chChatId').value=''; $('chTitle').value=''; loadChannels();
  }catch(e){ msg('chMsg',e.message,1); }
};
window.delChannel=async(id)=>{ if(!confirm('–£–¥–∞–ª–∏—Ç—å –∫–∞–Ω–∞–ª?'))return; try{ await api(ADM+'/channels/'+id,{method:'DELETE'}); loadChannels(); }catch(e){ alert(e.message); }};

// ‚Äî‚Äî‚Äî Page Texts ‚Äî‚Äî‚Äî
async function loadPageList(){
  try{
    const all=await api(ADM+'/page-texts');
    const pages=Object.keys(all||{}).sort();
    const sel=$('txtPageId');
    let opts='<option value="">‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É ‚Äî</option>';
    pages.forEach(p=>{ opts+=`<option value="${esc(p)}">${esc(p)}</option>`; });
    sel.innerHTML=opts;
  }catch(_){}
}
$('btnLoadTexts').onclick=async()=>{
  const pid=$('txtPageId').value.trim(); if(!pid){msg('txtMsg','–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É',1);return;}
  msg('txtMsg');
  try{
    const data=await api(ADM+'/page-texts/'+encodeURIComponent(pid));
    renderTextsEditor(pid,data);
  }catch(e){ msg('txtMsg',e.message,1); }
};
$('btnNewPage').onclick=()=>{
  const name=prompt('–í–≤–µ–¥–∏—Ç–µ ID –Ω–æ–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–ª–∞—Ç–∏–Ω–∏—Ü–µ–π, –Ω–∞–ø—Ä. home, tasks, about):');
  if(!name||!name.trim())return;
  const pid=name.trim().toLowerCase().replace(/[^a-z0-9_-]/g,'_');
  renderTextsEditor(pid,{});
  // Add to select
  const sel=$('txtPageId');
  const opt=document.createElement('option');
  opt.value=pid; opt.textContent=pid; opt.selected=true;
  sel.appendChild(opt);
  msg('txtMsg','–ù–æ–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ ¬´'+pid+'¬ª. –î–æ–±–∞–≤—å—Ç–µ –∫–ª—é—á–∏ –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ.');
};
function renderTextsEditor(pid,data){
  const keys=Object.keys(data||{});
  let h='<h3>–°—Ç—Ä–∞–Ω–∏—Ü–∞: '+esc(pid)+'</h3>';
  if(!keys.length) h+='<p style="font-size:12px;opacity:.7">–ù–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤. –î–æ–±–∞–≤—å—Ç–µ –Ω–∏–∂–µ.</p>';
  keys.forEach(k=>{
    h+=`<label>${esc(k)}</label><textarea data-key="${esc(k)}">${esc(data[k])}</textarea>`;
  });
  h+=`<div class="inline-form" style="margin-top:8px">
    <input type="text" id="newTxtKey" placeholder="–ù–æ–≤—ã–π –∫–ª—é—á" style="max-width:180px">
    <input type="text" id="newTxtVal" placeholder="–ó–Ω–∞—á–µ–Ω–∏–µ">
    <button class="btn btn-sm btn-success" onclick="addTextKey()">+</button>
  </div>`;
  h+=`<button class="btn btn-primary btn-sm" style="margin-top:12px" onclick="saveTexts('${esc(pid)}')">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>`;
  $('textsEditor').innerHTML=h;
}
window.addTextKey=()=>{
  const k=$('newTxtKey').value.trim(); const v=$('newTxtVal').value;
  if(!k)return;
  const ta=document.createElement('div');
  ta.innerHTML=`<label>${esc(k)}</label><textarea data-key="${esc(k)}">${esc(v)}</textarea>`;
  $('textsEditor').insertBefore(ta.firstElementChild,$('textsEditor').querySelector('.inline-form'));
  $('textsEditor').insertBefore(ta.firstElementChild,$('textsEditor').querySelector('.inline-form'));
  $('newTxtKey').value=''; $('newTxtVal').value='';
};
window.saveTexts=async(pid)=>{
  msg('txtMsg');
  const texts={};
  $('textsEditor').querySelectorAll('textarea[data-key]').forEach(ta=>{ texts[ta.dataset.key]=ta.value; });
  try{
    await api(ADM+'/page-texts/'+encodeURIComponent(pid),{method:'PUT',body:JSON.stringify(texts)});
    msg('txtMsg','–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
  }catch(e){ msg('txtMsg',e.message,1); }
};

// ‚Äî‚Äî‚Äî Partner Tokens ‚Äî‚Äî‚Äî
async function loadTokens(){
  try{
    const list=await api(ADM+'/partner-tokens');
    $('tokensList').innerHTML=list.map(t=>`
      <div class="list-item">
        <div style="flex:1">
          <span class="label">${esc(t.symbol)}</span> ${esc(t.name||'')}
          <div class="meta">${esc(t.token_address)} | ${t.usage} | ${t.is_active?'–ê–∫—Ç–∏–≤–µ–Ω':'–ù–µ–∞–∫—Ç–∏–≤–µ–Ω'}</div>
        </div>
        <div class="actions">
          <button class="btn btn-sm btn-danger" onclick="delToken(${t.id})">X</button>
        </div>
      </div>`).join('')||'<p style="opacity:.6;font-size:13px">–ù–µ—Ç —Ç–æ–∫–µ–Ω–æ–≤</p>';
  }catch(e){ msg('ptMsg',e.message,1); }
}
$('btnAddToken').onclick=async()=>{
  msg('ptMsg');
  try{
    await api(ADM+'/partner-tokens',{method:'POST',body:JSON.stringify({token_address:$('ptAddr').value.trim(),symbol:$('ptSymbol').value.trim(),name:$('ptName').value.trim(),usage:$('ptUsage').value.trim()})});
    msg('ptMsg','–î–æ–±–∞–≤–ª–µ–Ω–æ'); $('ptAddr').value=''; $('ptSymbol').value=''; $('ptName').value=''; loadTokens();
  }catch(e){ msg('ptMsg',e.message,1); }
};
window.delToken=async(id)=>{ if(!confirm('–£–¥–∞–ª–∏—Ç—å —Ç–æ–∫–µ–Ω?'))return; try{ await api(ADM+'/partner-tokens/'+id,{method:'DELETE'}); loadTokens(); }catch(e){ alert(e.message); }};

// ‚Äî‚Äî‚Äî Staking Contracts ‚Äî‚Äî‚Äî
async function loadContracts(){
  try{
    const list=await api(PANEL+'/staking-contracts');
    $('contractsList').innerHTML=list.map(c=>`
      <div class="list-item">
        <div style="flex:1">
          <span class="label">${esc(c.label||'‚Äî')}</span>
          <span class="meta">${esc(c.contract_address)}</span>
        </div>
        <div class="actions">
          <button class="btn btn-sm btn-danger" onclick="delContract(${c.id})">X</button>
        </div>
      </div>`).join('')||'<p style="opacity:.6;font-size:13px">–ù–µ—Ç –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤</p>';
  }catch(e){ msg('scMsg',e.message,1); }
}
$('btnAddContract').onclick=async()=>{
  msg('scMsg');
  try{
    await api(PANEL+'/staking-contracts',{method:'POST',body:JSON.stringify({contract_address:$('scAddr').value.trim(),label:$('scLabel').value.trim()||undefined})});
    msg('scMsg','–î–æ–±–∞–≤–ª–µ–Ω–æ'); $('scAddr').value=''; $('scLabel').value=''; loadContracts();
  }catch(e){ msg('scMsg',e.message,1); }
};
window.delContract=async(id)=>{ if(!confirm('–£–¥–∞–ª–∏—Ç—å –∫–æ–Ω—Ç—Ä–∞–∫—Ç?'))return; try{ await api(PANEL+'/staking-contracts/'+id,{method:'DELETE'}); loadContracts(); }catch(e){ alert(e.message); }};

// ‚Äî‚Äî‚Äî NFT ‚Äî‚Äî‚Äî
async function loadNft(){
  try{
    const colls=await api(ADM+'/nft/collections');
    $('nftCollList').innerHTML=(Array.isArray(colls)?colls:[]).map(c=>`
      <div class="list-item" style="cursor:pointer" onclick="loadNftItems('${esc(c.collection_address)}')">
        <div style="display:flex;align-items:center;gap:10px;flex:1">
          ${c.image?'<img src="'+esc(c.image)+'" style="width:36px;height:36px;border-radius:6px;object-fit:cover">':''}
          <div>
            <span class="label">${esc(c.name)}</span>
            <div class="meta">${c.items_count} NFT | ${esc(c.collection_address).substring(0,16)}...</div>
          </div>
        </div>
      </div>`).join('')||'<p style="opacity:.6;font-size:13px">–ù–µ—Ç –∫–æ–ª–ª–µ–∫—Ü–∏–π</p>';
    // load all items
    const items=await api(ADM+'/nft/items?limit=200');
    renderNftItems(items);
  }catch(e){ msg('nftSyncMsg',e.message,1); }
}
function renderNftItems(items){
  $('nftItemsList').innerHTML=(items||[]).map(n=>`
    <div class="list-item">
      <div style="display:flex;align-items:center;gap:8px;flex:1">
        ${n.image?'<img src="'+esc(n.image)+'" style="width:28px;height:28px;border-radius:4px;object-fit:cover">':''}
        <div>
          <span style="font-size:12px;font-weight:600">${esc(n.name)}</span>
          <div class="meta">${esc(n.collection_name||'')} | owner: ${esc((n.owner_address||'').substring(0,16))}...</div>
        </div>
      </div>
    </div>`).join('')||'<p style="opacity:.6;font-size:13px">–ù–µ—Ç NFT</p>';
}
window.loadNftItems=async(addr)=>{
  try{
    const items=await api(ADM+'/nft/items?collection_address='+encodeURIComponent(addr)+'&limit=200');
    renderNftItems(items);
  }catch(e){ alert(e.message); }
};
$('btnNftSync').onclick=async()=>{
  msg('nftSyncMsg','–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...');
  $('btnNftSync').disabled=true;
  try{
    const r=await api(ADM+'/nft/sync',{method:'POST'});
    msg('nftSyncMsg','–ì–æ—Ç–æ–≤–æ: '+(r.stats?.collections_synced||0)+' –∫–æ–ª–ª–µ–∫—Ü–∏–π, '+(r.stats?.nfts_synced||0)+' NFT');
    loadNft();
  }catch(e){ msg('nftSyncMsg',e.message,1); }
  $('btnNftSync').disabled=false;
};

// ‚Äî‚Äî‚Äî NFT Holders ‚Äî‚Äî‚Äî
async function loadHolders(){
  try{
    const d=await api(ADM+'/nft-holders');
    const holders=d.holders||[];
    if(!holders.length){
      $('holdersList').innerHTML='<p style="opacity:.6;font-size:13px">–ù–µ—Ç —Ö–æ–ª–¥–µ—Ä–æ–≤. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é.</p>';
      return;
    }
    let h=`<p style="font-size:11px;opacity:.5;margin-bottom:8px">–í—Å–µ–≥–æ —Ö–æ–ª–¥–µ—Ä–æ–≤: ${holders.length}</p>`;
    h+=`<table style="width:100%;font-size:12px;border-collapse:collapse">
      <tr style="text-align:left;opacity:.6;border-bottom:1px solid rgba(245,158,11,.2)">
        <th style="padding:6px 4px">–ê–¥—Ä–µ—Å</th>
        <th style="padding:6px 4px">NFT</th>
        <th style="padding:6px 4px">PHXPW</th>
        <th style="padding:6px 4px">–ü–æ–ª—É—á–µ–Ω–æ</th>
        <th style="padding:6px 4px">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ</th>
        <th style="padding:6px 4px">TG</th>
      </tr>`;
    holders.forEach(hl=>{
      const addr=hl.owner_address||'';
      const short=addr.length>16?addr.slice(0,6)+'...'+addr.slice(-4):addr;
      const colls=(hl.collections||[]).map(c=>c.name||'?').join(', ');
      const tgCell=hl.tg_link
        ?`<a href="${esc(hl.tg_link)}" target="_blank" style="color:#60a5fa">${esc(hl.linked_username||'TG:'+hl.linked_telegram_id)}</a>`
        :'<span style="opacity:.4">‚Äî</span>';
      h+=`<tr style="border-bottom:1px solid rgba(255,255,255,.04)">
        <td style="padding:6px 4px;font-family:monospace;font-size:11px" title="${esc(addr)}">${esc(short)}</td>
        <td style="padding:6px 4px;color:#f59e0b;font-weight:600">${hl.nft_count}</td>
        <td style="padding:6px 4px">${(hl.phxpw_balance||0).toLocaleString('ru',{maximumFractionDigits:2})}</td>
        <td style="padding:6px 4px;color:#10b981">+${(hl.total_received||0).toLocaleString('ru',{maximumFractionDigits:2})}</td>
        <td style="padding:6px 4px;color:#ef4444">-${(hl.total_sent||0).toLocaleString('ru',{maximumFractionDigits:2})}</td>
        <td style="padding:6px 4px">${tgCell}</td>
      </tr>
      <tr><td colspan="6" style="padding:2px 4px 8px;font-size:10px;opacity:.4">${esc(colls)}</td></tr>`;
    });
    h+='</table>';
    $('holdersList').innerHTML=h;
  }catch(e){ msg('holderSyncMsg',e.message,1); }
}

$('btnHolderSync').onclick=async()=>{
  msg('holderSyncMsg','–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ö–æ–ª–¥–µ—Ä–æ–≤...');
  $('btnHolderSync').disabled=true;
  try{
    const r=await api(ADM+'/nft-holders/sync',{method:'POST'});
    msg('holderSyncMsg','–ì–æ—Ç–æ–≤–æ: '+(r.holders_synced||0)+' —Ö–æ–ª–¥–µ—Ä–æ–≤ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ');
    loadHolders();
  }catch(e){ msg('holderSyncMsg',e.message,1); }
  $('btnHolderSync').disabled=false;
};

$('btnLoadHolders').onclick=()=>loadHolders();

// ‚Äî‚Äî‚Äî –ü–µ—Ä–µ–≤–æ–¥—ã –∏ —à—Ç—Ä–∞—Ñ—ã ‚Äî‚Äî‚Äî
let _payoutParticipants = [];
async function loadPayouts(){
  msg('payoutTransferMsg'); msg('payoutPenaltyMsg');
  try{
    const [part, cur] = await Promise.all([api(ADM+'/participants'), api(ADM+'/transfer/currencies')]);
    _payoutParticipants = part.participants||[];
    let opts='<option value="">‚Äî –≤–≤–æ–¥ ID –≤—Ä—É—á–Ω—É—é ‚Äî</option>';
    _payoutParticipants.forEach(p=>{
      const label = (p.username ? '@'+p.username : '')+' (id '+p.telegram_id+')';
      opts+=`<option value="${p.telegram_id}" data-user-id="${p.user_id}">${esc(label)}</option>`;
    });
    $('payoutRewardUser').innerHTML=opts;
    $('payoutPenaltyUser').innerHTML=opts;
    if(cur.currencies&&cur.currencies.length){
      const rCur=$('payoutRewardCurrency');
      if(rCur.options.length<=2){ rCur.innerHTML=cur.currencies.map(c=>`<option value="${c.value}">${c.label}</option>`).join(''); }
      const pCur=$('payoutPenaltyCurrency');
      if(pCur.options.length<=2){ pCur.innerHTML=cur.currencies.map(c=>`<option value="${c.value}">${c.label}</option>`).join(''); }
    }
    $('payoutTransferLimits').textContent=cur.limits_note||'';
    if(cur.penalty_note) $('payoutPenaltyLimits').textContent='–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è: '+cur.penalty_note;
  }catch(e){ msg('payoutTransferMsg',e.message,1); }
}

$('payoutRewardUser').onchange=function(){
  const v=this.value;
  $('payoutRewardTgId').value=v||'';
};
$('payoutPenaltyUser').onchange=function(){
  const v=this.value;
  $('payoutPenaltyTgId').value=v||'';
};

$('btnPayoutTransfer').onclick=async()=>{
  const tgId=$('payoutRewardTgId').value.trim()||$('payoutRewardUser').value;
  if(!tgId){ msg('payoutTransferMsg','–£–∫–∞–∂–∏—Ç–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞ –∏–ª–∏ Telegram ID',1); return; }
  const amount=parseFloat($('payoutRewardAmount').value);
  if(!amount||amount<=0){ msg('payoutTransferMsg','–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É',1); return; }
  const currency=$('payoutRewardCurrency').value||'PHXPW';
  const description=$('payoutRewardDescription').value.trim()||'–Ω–∞–≥—Ä–∞–¥–∞';
  msg('payoutTransferMsg','–û—Ç–ø—Ä–∞–≤–∫–∞...');
  $('btnPayoutTransfer').disabled=true;
  try{
    const r=await api(ADM+'/transfer',{method:'POST',body:JSON.stringify({telegram_id:tgId,amount,currency,description})});
    msg('payoutTransferMsg',r.message||'–ü–µ—Ä–µ–≤–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω',0);
    $('payoutRewardAmount').value=''; $('payoutRewardDescription').value='';
  }catch(e){ msg('payoutTransferMsg',e.message,1); }
  $('btnPayoutTransfer').disabled=false;
};

$('btnPayoutPenalty').onclick=async()=>{
  const tgId=$('payoutPenaltyTgId').value.trim()||$('payoutPenaltyUser').value;
  if(!tgId){ msg('payoutPenaltyMsg','–£–∫–∞–∂–∏—Ç–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞ –∏–ª–∏ Telegram ID',1); return; }
  const amount=parseFloat($('payoutPenaltyAmount').value);
  if(!amount||amount<=0){ msg('payoutPenaltyMsg','–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É',1); return; }
  const currency=$('payoutPenaltyCurrency').value||'PHXPW';
  const comment=$('payoutPenaltyComment').value.trim();
  const notify_user=$('payoutPenaltyNotify').checked;
  msg('payoutPenaltyMsg','–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...');
  $('btnPayoutPenalty').disabled=true;
  try{
    const r=await api(ADM+'/penalty',{method:'POST',body:JSON.stringify({telegram_id:tgId,amount,currency,comment,notify_user})});
    msg('payoutPenaltyMsg',r.message||'–®—Ç—Ä–∞—Ñ –Ω–∞–ª–æ–∂–µ–Ω',0);
    $('payoutPenaltyAmount').value=''; $('payoutPenaltyComment').value='';
  }catch(e){ msg('payoutPenaltyMsg',e.message,1); }
  $('btnPayoutPenalty').disabled=false;
};

// ‚Äî‚Äî‚Äî Activity ‚Äî‚Äî‚Äî
async function loadActivityStats(){
  try{
    const stats=await api(ADM+'/activity/stats');
    $('actStats').innerHTML=(stats||[]).map(s=>`
      <div class="list-item">
        <div style="flex:1">
          <span class="label">TG: ${s.telegram_id||s.user_id||'?'}</span>
          <span class="meta">–°–æ–æ–±—â–µ–Ω–∏–π: ${s.total_messages_sent||0} | –†–µ–∞–∫—Ü–∏–π: ${s.total_reactions_received||0}</span>
        </div>
      </div>`).join('')||'<p style="opacity:.6">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>';
  }catch(_){}
}
$('btnLoadActivity').onclick=async()=>{
  const tg=$('actTgId').value.trim();
  try{
    const url=ADM+'/activity/log?limit=100'+(tg?'&telegram_id='+tg:'');
    const log=await api(url);
    $('actLog').innerHTML=(log||[]).map(l=>`
      <div style="padding:4px 0;border-bottom:1px solid rgba(255,255,255,.05)">
        <span style="color:#f59e0b">${l.event_type||'?'}</span> TG:${l.telegram_id||'?'}
        <span style="opacity:.5">${l.created_at?new Date(l.created_at).toLocaleString():''}</span>
      </div>`).join('')||'<p style="opacity:.6">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</p>';
  }catch(e){ $('actLog').innerHTML='<p class="msg err">'+esc(e.message)+'</p>'; }
};

// ‚Äî‚Äî‚Äî Game Config ‚Äî‚Äî‚Äî
let _gcData = null;
const GC_LABELS = {
  'checkin': {icon:'‚úÖ', name:'–ß–µ–∫–∏–Ω', desc:'–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–≥–æ —á–µ–∫–∏–Ω–∞ –∏ –ø–æ–ø—ã—Ç–æ–∫'},
  'mine': {icon:'‚õè', name:'–®–∞—Ö—Ç–∞', desc:'–†–∞–∑–º–µ—Ä –ø–æ–ª—è, –ø—Ä–∏–∑–æ–≤—ã–µ —è—á–µ–π–∫–∏, –¥—Ä–æ–ø'},
  'eggs': {icon:'ü•ö', name:'–Ø–π—Ü–∞', desc:'–¶–≤–µ—Ç–∞, —Ä–µ–¥–∫–æ—Å—Ç—å –∏ –≤–µ—Å –≤—ã–ø–∞–¥–µ–Ω–∏—è'},
  'field': {icon:'üèò', name:'–ü–æ–ª–µ / –ó–¥–∞–Ω–∏—è', desc:'–õ–∏–º–∏—Ç—ã –∑–¥–∞–Ω–∏–π –∏ –≤–æ–∑–≤—Ä–∞—Ç –ø—Ä–∏ —Å–Ω–æ—Å–µ'},
  'prize_pool': {icon:'üèÜ', name:'–ü—Ä–∏–∑–æ–≤–æ–π –ø—É–ª', desc:'–í—Ö–æ–¥–Ω–∞—è –ø–ª–∞—Ç–∞ –∏ –∫—É—Ä—Å —Ç–æ–∫–µ–Ω–∞'},
  'fees': {icon:'üí∏', name:'–ö–æ–º–∏—Å—Å–∏–∏', desc:'–ü—Ä–æ—Ü–µ–Ω—Ç—ã –ø–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º –∏ –≤—ã–≤–æ–¥–∞–º'},
  'staking': {icon:'üîí', name:'–°—Ç–µ–π–∫–∏–Ω–≥', desc:'APY, –ø–µ—Ä–∏–æ–¥—ã, –ª–∏–º–∏—Ç—ã —Å—Ç–µ–π–∫–∏–Ω–≥–∞'},
  'quest': {icon:'üî•', name:'–ö–≤–µ—Å—Ç –§–µ–Ω–∏–∫—Å', desc:'–ù–∞–≥—Ä–∞–¥–∞, —É—Å–ª–æ–≤–∏—è –∫–≤–µ—Å—Ç–∞'},
  'general': {icon:'‚öô', name:'–û–±—â–µ–µ', desc:''},
  'holders': {icon:'üë•', name:'NFT –•–æ–ª–¥–µ—Ä—ã', desc:'–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ö–æ–ª–¥–µ—Ä–æ–≤ NFT'},
};
const GC_KEY_INFO = {
  'checkin.cooldown_hours': {lbl:'–ö—É–ª–¥–∞—É–Ω –º–µ–∂–¥—É —á–µ–∫–∏–Ω–∞–º–∏', unit:'—á–∞—Å–æ–≤', hint:'–ß–µ—Ä–µ–∑ —Å–∫–æ–ª—å–∫–æ —á–∞—Å–æ–≤ –º–æ–∂–Ω–æ —á–µ–∫–∏–Ω–∏—Ç—å—Å—è —Å–Ω–æ–≤–∞'},
  'checkin.attempts_per_claim': {lbl:'–ü–æ–ø—ã—Ç–æ–∫ –∑–∞ —á–µ–∫–∏–Ω (–∏–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è)', unit:'—à—Ç', hint:'–°–∫–æ–ª—å–∫–æ –ø–æ–ø—ã—Ç–æ–∫ –¥–∞—ë—Ç—Å—è –∑–∞ —á–µ–∫–∏–Ω –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ (—Å —Ä–µ–∫–ª–∞–º–æ–π)'},
  'checkin.attempts_per_claim_chat': {lbl:'–ü–æ–ø—ã—Ç–æ–∫ –∑–∞ —á–µ–∫–∏–Ω –∏–∑ —á–∞—Ç–∞', unit:'—à—Ç', hint:'–ó–∞ –∫–æ–º–∞–Ω–¥—É –ì–æ–ª–æ—Å/vote/checkin –≤ —á–∞—Ç–µ (–±–µ–∑ —Ä–µ–∫–ª–∞–º—ã)'},
  'checkin.attempts_expiry_days': {lbl:'–ß–µ—Ä–µ–∑ —Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –æ–±–Ω—É–ª—è—Ç—å –ø–æ–ø—ã—Ç–∫–∏', unit:'–¥–Ω–µ–π', hint:'–ù–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ –æ–±–Ω—É–ª—è—é—Ç—Å—è, –µ—Å–ª–∏ –∏–º–∏ –Ω–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è N –¥–Ω–µ–π'},
  'mine.grid_size': {lbl:'–†–∞–∑–º–µ—Ä –ø–æ–ª—è —à–∞—Ö—Ç—ã', unit:'—è—á–µ–µ–∫', hint:'–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —è—á–µ–µ–∫ (6x6 = 36)'},
  'mine.prize_cells_distribution': {lbl:'–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–∏–∑–æ–≤—ã—Ö —è—á–µ–µ–∫', hint:'–®–∞–Ω—Å (%) –Ω–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–∏–∑–æ–≤—ã—Ö —è—á–µ–µ–∫', complex:'prize_dist'},
  'mine.prize_loot': {lbl:'–î—Ä–æ–ø –∏–∑ –ø—Ä–∏–∑–æ–≤–æ–π —è—á–µ–π–∫–∏', hint:'–ü—Ä–æ—Ü–µ–Ω—Ç –¥—Ä–æ–ø–∞ –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ (—Å—É–º–º–∞ ~100%)', complex:'loot_pct'},
  'mine.egg_roll': {lbl:'–®–∞–Ω—Å –¥—Ä–æ–ø–∞ —è–π—Ü–∞', hint:'–ë–∞–∑–æ–≤—ã–π —à–∞–Ω—Å –ø–æ–ª—É—á–µ–Ω–∏—è —è–π—Ü–∞ –ø—Ä–∏ –∫–æ–ø–∞–Ω–∏–∏', complex:'egg_roll'},
  'eggs.colors': {lbl:'–¶–≤–µ—Ç–∞ —è–∏—Ü', hint:'–¶–≤–µ—Ç, —Ä–µ–¥–∫–æ—Å—Ç—å –∏ –≤–µ—Å –∫–∞–∂–¥–æ–≥–æ —è–π—Ü–∞', complex:'egg_colors'},
  'field.max_buildings': {lbl:'–ú–∞–∫—Å. –∑–¥–∞–Ω–∏–π –Ω–∞ –ø–æ–ª–µ', unit:'—à—Ç', hint:'–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–¥–∞–Ω–∏–π –Ω–∞ –ø–æ–ª–µ –∏–≥—Ä–æ–∫–∞'},
  'field.demolish_refund_rate': {lbl:'–í–æ–∑–≤—Ä–∞—Ç –ø—Ä–∏ —Å–Ω–æ—Å–µ –∑–¥–∞–Ω–∏—è', unit:'(0-1)', hint:'–î–æ–ª—è —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –∑–¥–∞–Ω–∏—è, –∫–æ—Ç–æ—Ä–∞—è –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –ø—Ä–∏ —Å–Ω–æ—Å–µ (0.25 = 25%)'},
  'prize_pool.entry_phxpw': {lbl:'–°—Ç–æ–∏–º–æ—Å—Ç—å –≤—Ö–æ–¥–∞', unit:'PHXPW', hint:'–°–∫–æ–ª—å–∫–æ PHXPW –Ω—É–∂–Ω–æ –¥–ª—è –≤—Ö–æ–¥–∞ –≤ –ø—Ä–∏–∑–æ–≤–æ–π –ø—É–ª'},
  'prize_pool.phxpw_price_ton': {lbl:'–¶–µ–Ω–∞ 1 PHXPW', unit:'TON', hint:'–¢–µ–∫—É—â–∏–π –∫—É—Ä—Å PHXPW –∫ TON'},
  'fees.transaction_percent': {lbl:'–ö–æ–º–∏—Å—Å–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π', unit:'%', hint:'–û–±—â–∏–π –ø—Ä–æ—Ü–µ–Ω—Ç –∫–æ–º–∏—Å—Å–∏–∏ –∑–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏'},
  'fees.early_unstake': {lbl:'–®—Ç—Ä–∞—Ñ –∑–∞ —Ä–∞–Ω–Ω–∏–π –∞–Ω—Å—Ç–µ–π–∫', unit:'%', hint:'–ü—Ä–æ—Ü–µ–Ω—Ç —à—Ç—Ä–∞—Ñ–∞ –ø—Ä–∏ –¥–æ—Å—Ä–æ—á–Ω–æ–º –≤—ã–≤–æ–¥–µ —Å—Ç–µ–π–∫–∞'},
  'fees.express_withdrawal': {lbl:'–≠–∫—Å–ø—Ä–µ—Å—Å-–≤—ã–≤–æ–¥', unit:'%', hint:'–ö–æ–º–∏—Å—Å–∏—è –∑–∞ –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –≤—ã–≤–æ–¥'},
  'fees.nft_holders': {lbl:'–î–æ–ª—è NFT-—Ö–æ–ª–¥–µ—Ä–∞–º', unit:'%', hint:'–ß–∞—Å—Ç—å –∫–æ–º–∏—Å—Å–∏–∏, —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º–∞—è NFT-—Ö–æ–ª–¥–µ—Ä–∞–º'},
  'fees.project': {lbl:'–î–æ–ª—è –ø—Ä–æ–µ–∫—Ç—É', unit:'%', hint:'–ß–∞—Å—Ç—å –∫–æ–º–∏—Å—Å–∏–∏, –æ—Å—Ç–∞—é—â–∞—è—Å—è –ø—Ä–æ–µ–∫—Ç—É'},
  'fees.burn': {lbl:'–î–æ–ª—è –Ω–∞ —Å–∂–∏–≥–∞–Ω–∏–µ', unit:'%', hint:'–ß–∞—Å—Ç—å –∫–æ–º–∏—Å—Å–∏–∏, –∫–æ—Ç–æ—Ä–∞—è —Å–∂–∏–≥–∞–µ—Ç—Å—è'},
  'fees.charity': {lbl:'–î–æ–ª—è –Ω–∞ –±–ª–∞–≥–æ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å', unit:'%', hint:'–ß–∞—Å—Ç—å –∫–æ–º–∏—Å—Å–∏–∏ –Ω–∞ –±–ª–∞–≥–æ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å'},
  'staking.enabled': {lbl:'–°—Ç–µ–π–∫–∏–Ω–≥ –≤–∫–ª—é—á—ë–Ω', hint:'–í–∫–ª—é—á–∏—Ç—å –∏–ª–∏ –≤—ã–∫–ª—é—á–∏—Ç—å —Å—Ç–µ–π–∫–∏–Ω–≥'},
  'staking.base_apy': {lbl:'–ë–∞–∑–æ–≤—ã–π APY', unit:'(0-1)', hint:'–ì–æ–¥–æ–≤–∞—è —Å—Ç–∞–≤–∫–∞ —Å—Ç–µ–π–∫–∏–Ω–≥–∞ (0.15 = 15%)'},
  'staking.reward_period_sec': {lbl:'–ü–µ—Ä–∏–æ–¥ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –Ω–∞–≥—Ä–∞–¥', unit:'—Å–µ–∫—É–Ω–¥', hint:'–ö–∞–∫ —á–∞—Å—Ç–æ –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è –Ω–∞–≥—Ä–∞–¥—ã —Å—Ç–µ–π–∫–∏–Ω–≥–∞ (3600 = 1 —á–∞—Å)'},
  'staking.min_stake': {lbl:'–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Å—Ç–µ–π–∫', unit:'PHXPW', hint:'–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –¥–ª—è —Å—Ç–µ–π–∫–∏–Ω–≥–∞'},
  'staking.max_stake': {lbl:'–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Å—Ç–µ–π–∫', unit:'PHXPW', hint:'–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ —Å—Ç–µ–π–∫–∏–Ω–≥–∞'},
  'staking.auto_compound': {lbl:'–ê–≤—Ç–æ-–∫–æ–º–ø–∞—É–Ω–¥', hint:'–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–µ–∏–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–≥—Ä–∞–¥—ã'},
  'quest.reward_amount': {lbl:'–ù–∞–≥—Ä–∞–¥–∞ –∑–∞ –∫–≤–µ—Å—Ç', unit:'PHXPW', hint:'–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ PHXPW –∑–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–≤–µ—Å—Ç–∞ –§–µ–Ω–∏–∫—Å'},
  'quest.min_burn_count': {lbl:'–ú–∏–Ω. —Å–æ–∂–∂–µ–Ω–∏–π –¥–ª—è –∫–≤–µ—Å—Ç–∞', unit:'—à—Ç', hint:'–°–∫–æ–ª—å–∫–æ —Ä–µ–ª–∏–∫–≤–∏–π –Ω—É–∂–Ω–æ —Å–∂–µ—á—å –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–≤–µ—Å—Ç—É'},
  'quest.min_account_age_days': {lbl:'–ú–∏–Ω. –≤–æ–∑—Ä–∞—Å—Ç –∞–∫–∫–∞—É–Ω—Ç–∞', unit:'–¥–Ω–µ–π', hint:'–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –≤–æ–∑—Ä–∞—Å—Ç –∞–∫–∫–∞—É–Ω—Ç–∞ –¥–ª—è –∫–≤–µ—Å—Ç–∞'},
  'quest.submit_rate_limit_sec': {lbl:'–õ–∏–º–∏—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏', unit:'—Å–µ–∫—É–Ω–¥', hint:'–ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –ø–æ–ø—ã—Ç–∫–∞–º–∏ —Å–¥–∞—á–∏ –∫–≤–µ—Å—Ç–∞'},
  'quest.burn_diminishing_after': {lbl:'–£–º–µ–Ω—å—à–µ–Ω–∏–µ –Ω–∞–≥—Ä–∞–¥—ã –ø–æ—Å–ª–µ', unit:'—Å–æ–∂–∂–µ–Ω–∏–π', hint:'–ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å–æ–∂–∂–µ–Ω–∏–π –Ω–∞–≥—Ä–∞–¥—ã —É–º–µ–Ω—å—à–∞—é—Ç—Å—è'},
  'holders.show_detailed_public': {lbl:'–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –¥–µ—Ç–∞–ª–∏ —Ö–æ–ª–¥–µ—Ä–æ–≤ –ø—É–±–ª–∏—á–Ω–æ', hint:'–ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ, –≤—Å–µ –∏–≥—Ä–æ–∫–∏ –≤–∏–¥—è—Ç –∞–¥—Ä–µ—Å–∞, –±–∞–ª–∞–Ω—Å—ã –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É NFT-—Ö–æ–ª–¥–µ—Ä–æ–≤ –≤ PnL'},
};

async function loadGameConfig() {
  $('gcContent').innerHTML = '<p style="opacity:.6">–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫...</p>';
  try {
    const d = await api(ADM + '/game-config');
    _gcData = d;
    renderGameConfig(d);
  } catch(e) { msg('gcMsg', e.message, 1); $('gcContent').innerHTML = '<p class="msg err">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p>'; }
}

function renderGameConfig(d) {
  const groups = d.settings || {};
  let h = '<h2 style="margin-top:0">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–≥—Ä—ã</h2><p style="font-size:12px;opacity:.6;margin-bottom:16px">–í—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –∏ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞</p>';
  for (const [cat, items] of Object.entries(groups)) {
    const catInfo = GC_LABELS[cat] || {icon:'‚öô', name:cat, desc:''};
    h += `<div class="card" style="margin-bottom:12px">
      <h3 style="cursor:pointer;user-select:none;display:flex;align-items:center;gap:8px;margin:0" onclick="this.parentElement.querySelector('.gc-body').classList.toggle('hidden')">
        <span style="font-size:18px">${catInfo.icon}</span>
        <span>${esc(catInfo.name)}</span>
        <span style="font-size:11px;opacity:.4;margin-left:auto">${items.length} –Ω–∞—Å—Ç—Ä. ‚ñæ</span>
      </h3>
      ${catInfo.desc?'<p style="font-size:11px;opacity:.5;margin:4px 0 0">'+esc(catInfo.desc)+'</p>':''}
      <div class="gc-body" style="margin-top:12px">`;

    items.forEach(item => {
      const info = GC_KEY_INFO[item.key] || {};
      const lbl = info.lbl || item.key.split('.').slice(1).join('.').replace(/_/g,' ');
      const val = item.value;
      const def = item.default;
      const isObj = typeof val === 'object' && val !== null;
      const isBool = typeof val === 'boolean';

      h += `<div style="padding:10px 12px;background:rgba(0,0,0,.15);border-radius:8px;margin-bottom:8px">
        <div style="display:flex;justify-content:space-between;align-items:baseline;margin-bottom:4px">
          <label style="font-size:13px;font-weight:600;color:#f59e0b;margin:0">${esc(lbl)}</label>
          ${info.unit?'<span style="font-size:11px;opacity:.4">'+esc(info.unit)+'</span>':''}
        </div>
        ${info.hint?'<div style="font-size:11px;opacity:.45;margin-bottom:6px">'+esc(info.hint)+'</div>':''}`;

      if (isBool) {
        h += `<label class="toggle" style="font-size:13px"><input type="checkbox" data-gckey="${esc(item.key)}" ${val?'checked':''}> ${val?'–í–∫–ª—é—á–µ–Ω–æ':'–í—ã–∫–ª—é—á–µ–Ω–æ'}</label>`;
      } else if (info.complex === 'prize_dist' && Array.isArray(val)) {
        // Prize cells distribution ‚Äî render as a mini table
        h += `<div style="display:grid;grid-template-columns:repeat(${val.length},1fr);gap:6px;margin:6px 0">`;
        val.forEach((entry,i) => {
          h += `<div style="text-align:center;background:rgba(245,158,11,.08);border-radius:6px;padding:6px">
            <div style="font-size:10px;opacity:.5">${entry.cells} —è—á–µ–µ–∫</div>
            <input type="number" data-gckey="${esc(item.key)}" data-idx="${i}" data-field="chancePct" value="${entry.chancePct}" min="0" max="100" step="1" style="width:60px;text-align:center;font-size:14px;font-weight:700">
            <div style="font-size:10px;opacity:.4">% —à–∞–Ω—Å</div>
          </div>`;
        });
        h += `</div><div style="font-size:10px;opacity:.35">–°—É–º–º–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å 100%</div>`;
      } else if (info.complex === 'loot_pct' && typeof val === 'object') {
        // Loot percentages ‚Äî labeled inputs in a grid
        const lootLabels = {relicPct:'–†–µ–ª–∏–∫–≤–∏—è',amuletPct:'–ê–º—É–ª–µ—Ç',coinsPct:'–ú–æ–Ω–µ—Ç—ã',eggPct:'–Ø–π—Ü–æ',projectTokensPct:'–¢–æ–∫–µ–Ω—ã',furnacePct:'–ü–µ—á–∫–∞'};
        h += `<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin:6px 0">`;
        for (const [fk, fv] of Object.entries(val)) {
          h += `<div style="background:rgba(245,158,11,.08);border-radius:6px;padding:6px;text-align:center">
            <div style="font-size:10px;opacity:.6;margin-bottom:2px">${esc(lootLabels[fk]||fk)}</div>
            <input type="number" data-gckey="${esc(item.key)}" data-field="${esc(fk)}" value="${fv}" min="0" max="100" step="0.1" style="width:60px;text-align:center;font-size:13px;font-weight:600">
            <div style="font-size:9px;opacity:.35">%</div>
          </div>`;
        }
        h += `</div><div style="font-size:10px;opacity:.35">–°—É–º–º–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å ~100%</div>`;
      } else if (info.complex === 'egg_roll' && typeof val === 'object') {
        const eggLabels = {targetEggPerClick:'–®–∞–Ω—Å —è–π—Ü–∞ –∑–∞ –∫–ª–∏–∫', derivedEggGivenPrizeCellPct:'–®–∞–Ω—Å –µ—Å–ª–∏ –ø—Ä–∏–∑–æ–≤–∞—è'};
        for (const [fk, fv] of Object.entries(val)) {
          h += `<div style="display:flex;align-items:center;gap:8px;margin:4px 0">
            <span style="font-size:12px;min-width:180px">${esc(eggLabels[fk]||fk)}</span>
            <input type="number" data-gckey="${esc(item.key)}" data-field="${esc(fk)}" value="${fv}" step="0.001" style="width:100px">
          </div>`;
        }
      } else if (info.complex === 'egg_colors' && Array.isArray(val)) {
        h += `<table style="width:100%;font-size:12px;border-collapse:collapse;margin:6px 0">
          <tr style="opacity:.5"><td>–¶–≤–µ—Ç</td><td>–†–µ–¥–∫–æ—Å—Ç—å</td><td>–í–µ—Å</td></tr>`;
        const rarityColors = {common:'#9ca3af',rare:'#8b5cf6',epic:'#f59e0b',legendary:'#ef4444'};
        val.forEach((egg,i) => {
          h += `<tr style="border-top:1px solid rgba(255,255,255,.05)">
            <td style="padding:4px"><span style="display:inline-block;width:12px;height:12px;border-radius:50%;background:${egg.color};vertical-align:middle;margin-right:4px"></span>${esc(egg.color)}</td>
            <td style="padding:4px"><span style="color:${rarityColors[egg.rarity]||'#fff'}">${esc(egg.rarity)}</span></td>
            <td style="padding:4px"><input type="number" data-gckey="${esc(item.key)}" data-idx="${i}" data-field="weight" value="${egg.weight}" min="0" max="100" style="width:60px;text-align:center"></td>
          </tr>`;
        });
        h += `</table>`;
      } else if (isObj) {
        // Fallback for unknown objects ‚Äî JSON textarea
        h += `<textarea data-gckey="${esc(item.key)}" rows="3" style="font-size:11px;font-family:monospace;min-height:50px">${esc(JSON.stringify(val, null, 2))}</textarea>`;
      } else {
        h += `<div style="display:flex;align-items:center;gap:10px">
          <input type="${typeof val==='number'?'number':'text'}" data-gckey="${esc(item.key)}" value="${esc(String(val))}" ${typeof val==='number'?'step="any"':''} style="flex:1">
          <span style="font-size:10px;opacity:.35" title="–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: ${esc(String(def))}">def: ${esc(String(def))}</span>
        </div>`;
      }
      h += `</div>`;
    });

    h += `<div style="display:flex;justify-content:space-between;align-items:center;padding-top:10px">
      <span style="font-size:10px;opacity:.3">–ì—Ä—É–ø–ø–∞: ${esc(cat)}</span>
      <button class="btn btn-sm btn-primary" onclick="saveGameConfigGroup('${esc(cat)}')">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å ${esc(catInfo.name)}</button>
    </div></div></div>`;
  }
  $('gcContent').innerHTML = h;
}

window.saveGameConfigGroup = async (cat) => {
  msg('gcMsg');
  const settings = {};
  // Collect simple inputs
  document.querySelectorAll('input[data-gckey],textarea[data-gckey]').forEach(el => {
    const key = el.dataset.gckey;
    if (!key.startsWith(cat + '.') && cat !== 'general') return;
    if (cat === 'general' && key.includes('.')) return;
    if (el.dataset.field || el.dataset.idx !== undefined) return; // handled separately
    if (el.type === 'checkbox') {
      settings[key] = el.checked;
    } else if (el.tagName === 'TEXTAREA') {
      try { settings[key] = JSON.parse(el.value); } catch(e) { msg('gcMsg', '–û—à–∏–±–∫–∞ JSON –≤ ' + key + ': ' + e.message, 1); return; }
    } else if (el.type === 'number') {
      settings[key] = parseFloat(el.value);
    } else {
      settings[key] = el.value;
    }
  });
  // Collect complex fields (objects with data-field)
  const complexKeys = {};
  document.querySelectorAll('input[data-gckey][data-field]').forEach(el => {
    const key = el.dataset.gckey;
    if (!key.startsWith(cat + '.') && cat !== 'general') return;
    if (!complexKeys[key]) {
      // Get original value from _gcData
      const flat = _gcData?.flat || {};
      complexKeys[key] = JSON.parse(JSON.stringify(flat[key] || {}));
    }
    const idx = el.dataset.idx;
    const field = el.dataset.field;
    const val = el.type === 'number' ? parseFloat(el.value) : el.value;
    if (idx !== undefined && idx !== '') {
      // Array item
      if (Array.isArray(complexKeys[key])) {
        complexKeys[key][parseInt(idx)][field] = val;
      }
    } else {
      // Object field
      complexKeys[key][field] = val;
    }
  });
  Object.assign(settings, complexKeys);

  if (Object.keys(settings).length === 0) { msg('gcMsg', '–ù–µ—á–µ–≥–æ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å'); return; }
  try {
    await api(ADM + '/game-config', { method: 'PUT', body: JSON.stringify({ settings }) });
    msg('gcMsg', '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!');
    // Reload to reflect changes
    setTimeout(() => loadGameConfig(), 500);
  } catch(e) { msg('gcMsg', e.message, 1); }
};

// ‚Äî‚Äî‚Äî Smart Dropdowns (meta) ‚Äî‚Äî‚Äî
let _metaData = null;

async function loadMeta() {
  if (_metaData) return _metaData;
  try {
    _metaData = await api(ADM + '/meta');
    return _metaData;
  } catch(e) { console.warn('loadMeta failed:', e); return null; }
}

async function populateDropdowns() {
  const meta = await loadMeta();
  if (!meta) return;
  // Reward types dropdown
  const rtSel = $('taskRewardType');
  if (rtSel && meta.reward_types) {
    rtSel.innerHTML = meta.reward_types.map(r =>
      `<option value="${esc(r.value || r)}">${esc(r.label || r)}</option>`
    ).join('');
  }
  // Task types dropdown
  const ttSel = $('taskType');
  if (ttSel && meta.task_types) {
    ttSel.innerHTML = meta.task_types.map(t =>
      `<option value="${esc(t.value || t)}">${esc(t.label || t)}</option>`
    ).join('');
  }
}

// ‚Äî‚Äî‚Äî Bot Chats Auto-Detect ‚Äî‚Äî‚Äî
$('btnDetectChats').onclick = async () => {
  msg('chMsg', '–ü–æ–∏—Å–∫ –∫–∞–Ω–∞–ª–æ–≤ –±–æ—Ç–∞...');
  try {
    const d = await api(ADM + '/bot-chats');
    const chats = d.chats || [];
    if (!chats.length) {
      msg('chMsg', '–ë–æ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –Ω–∏ –≤ –æ–¥–Ω–æ–º –∫–∞–Ω–∞–ª–µ/—á–∞—Ç–µ. –î–æ–±–∞–≤—å—Ç–µ –±–æ—Ç–∞ –≤ –∫–∞–Ω–∞–ª –∫–∞–∫ –∞–¥–º–∏–Ω–∞.');
      $('botChatsPreview').style.display = 'none';
      return;
    }
    let h = '<h4 style="margin:0 0 8px;font-size:12px;color:#f59e0b">–ö–∞–Ω–∞–ª—ã –±–æ—Ç–∞ (' + chats.length + ')</h4>';
    chats.forEach(ch => {
      const isAdmin = ch.bot_is_admin ? '‚úÖ –∞–¥–º–∏–Ω' : '‚ö† –Ω–µ –∞–¥–º–∏–Ω';
      const mc = ch.member_count ? ' | ' + ch.member_count + ' —É—á.' : '';
      h += `<div class="list-item" style="padding:8px">
        <div style="flex:1">
          <span class="label">${esc(ch.title || ch.chat_id)}</span>
          <span class="meta">${ch.chat_id} | ${ch.type || ch.channel_type || '?'} | ${isAdmin}${mc}</span>
        </div>
        <button class="btn btn-sm btn-success" onclick="addDetectedChat(${ch.chat_id},'${esc(ch.title||'')}','${esc(ch.type||ch.channel_type||'channel')}')">–î–æ–±–∞–≤–∏—Ç—å</button>
      </div>`;
    });
    $('botChatsPreview').innerHTML = h;
    $('botChatsPreview').style.display = 'block';
    msg('chMsg', '–ù–∞–π–¥–µ–Ω–æ –∫–∞–Ω–∞–ª–æ–≤: ' + chats.length);
  } catch(e) { msg('chMsg', e.message, 1); }
};

window.addDetectedChat = async (chatId, title, type) => {
  msg('chMsg');
  try {
    await api(ADM + '/channels', { method: 'POST', body: JSON.stringify({ chat_id: chatId, title: title, channel_type: type }) });
    msg('chMsg', '–î–æ–±–∞–≤–ª–µ–Ω–æ: ' + title);
    loadChannels();
    _metaData = null; // refresh meta
  } catch(e) { msg('chMsg', e.message, 1); }
};

// ‚Äî‚Äî‚Äî Task add button ‚Äî‚Äî‚Äî
$('btnAddTask').onclick = async () => {
  msg('taskMsg');
  const taskType = $('taskType').value;
  const title = $('taskTitle').value.trim();
  if (!title) { msg('taskMsg', '–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è', 1); return; }
  // Auto-generate unique key from type + timestamp
  const taskKey = taskType + '_' + Date.now().toString(36);
  const body = {
    task_key: taskKey,
    title: title,
    description: $('taskDesc').value.trim(),
    reward_type: $('taskRewardType').value,
    reward_value: parseInt($('taskRewardVal').value) || 0,
  };
  // Build conditions from extra fields
  const conditions = { type: taskType };
  if (taskType === 'subscribe_channel' || taskType === 'subscribe_tg') {
    const ch = $('taskChannel');
    if (ch && ch.value) {
      conditions.chat_id = parseInt(ch.value);
      conditions.channel_title = ch.options[ch.selectedIndex]?.text || '';
    } else {
      msg('taskMsg', '–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞–Ω–∞–ª –¥–ª—è –ø–æ–¥–ø–∏—Å–∫–∏', 1); return;
    }
  } else if (taskType === 'visit_url') {
    const url = $('taskUrl');
    if (url && url.value.trim()) conditions.url = url.value.trim();
    else { msg('taskMsg', '–í–≤–µ–¥–∏—Ç–µ URL', 1); return; }
  } else if (taskType === 'checkin_streak') {
    const v = $('taskMinStreak');
    conditions.min_streak = parseInt(v?.value) || 3;
  } else if (taskType === 'mine_count') {
    const v = $('taskMineCount');
    conditions.count = parseInt(v?.value) || 10;
  } else if (taskType === 'invite_friend') {
    const v = $('taskInviteCount');
    conditions.count = parseInt(v?.value) || 1;
  }
  body.conditions_json = conditions;
  try {
    await api(ADM + '/tasks', { method: 'POST', body: JSON.stringify(body) });
    msg('taskMsg', '–ó–∞–¥–∞–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ!');
    $('taskTitle').value = ''; $('taskDesc').value = '';
    $('taskExtraFields').innerHTML = '';
    loadTasks();
  } catch(e) { msg('taskMsg', e.message, 1); }
};

// Startup
(async () => {
  await init();
  populateDropdowns();
})();
</script>
</body>
</html>
